{"version":3,"file":"CSSValueTraceView.js","sourceRoot":"","sources":["../../../../../../front_end/panels/elements/CSSValueTraceView.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2025 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n/* eslint-disable rulesdir/no-lit-render-outside-of-view */\n\nimport type * as SDK from '../../core/sdk/sdk.js';\nimport * as Lit from '../../third_party/lit/lit.js';\nimport * as UI from '../../ui/legacy/legacy.js';\n\nimport cssValueTraceViewStyles from './cssValueTraceView.css.js';\nimport {\n  Highlighting,\n  type MatchRenderer,\n  Renderer,\n  RenderingContext,\n  TracingContext,\n} from './PropertyRenderer.js';\nimport stylePropertiesTreeOutlineStyles from './stylePropertiesTreeOutline.css.js';\n\nconst {html, render, Directives: {ref, classMap, ifDefined}} = Lit;\n\nexport interface ViewInput {\n  substitutions: Node[][];\n  evaluations: Node[][];\n  onToggle: () => void;\n}\n\nexport interface ViewOutput {\n  defaultFocusedElement?: Element;\n}\n\nexport type View = (\n    input: ViewInput,\n    output: ViewOutput,\n    target: HTMLElement,\n    ) => void;\n\nfunction defaultView(input: ViewInput, output: ViewOutput, target: HTMLElement): void {\n  const substitutions = [...input.substitutions];\n  const evaluations = [...input.evaluations];\n  const finalResult = evaluations.pop() ?? substitutions.pop();\n  const [firstEvaluation, ...intermediateEvaluations] = evaluations;\n\n  const hiddenSummary = !firstEvaluation || intermediateEvaluations.length === 0;\n  const summaryTabIndex = hiddenSummary ? undefined : 0;\n  const singleResult = evaluations.length === 0 && substitutions.length === 0;\n  render(\n      // clang-format off\n    html`\n      <div\n       role=dialog\n       ${ref(e => {\n         output.defaultFocusedElement = (e as HTMLDivElement)?.querySelector('[tabindex]') ?? undefined;\n       })}\n       class=\"css-value-trace monospace\"\n       @keydown=${onKeyDown}\n       >\n        ${substitutions.map(\n          line =>\n            html`<span class=\"trace-line-icon\" aria-label=\"is equal to\">↳</span\n              ><span class=\"trace-line\">${line}</span>`,\n        )}\n        ${firstEvaluation && intermediateEvaluations.length === 0\n          ? html`<span class=\"trace-line-icon\" aria-label=\"is equal to\">↳</span\n              ><span class=\"trace-line\">${firstEvaluation}</span>`\n          : html`<details\n              @toggle=${input.onToggle}\n              ?hidden=${hiddenSummary}\n            >\n              <summary tabindex=${ifDefined(summaryTabIndex)}>\n                <span class=\"trace-line-icon\" aria-label=\"is equal to\">↳</span\n                ><devtools-icon class=\"marker\"></devtools-icon\n                ><span class=\"trace-line\">${firstEvaluation}</span>\n              </summary>\n              <div>\n                ${intermediateEvaluations.map(\n                  evaluation =>\n                    html`<span class=\"trace-line-icon\" aria-label=\"is equal to\"\n                        >↳</span\n                      ><span class=\"trace-line\">${evaluation}</span>`,\n                )}\n              </div>\n            </details>`}\n        ${!finalResult\n          ? ''\n          : html`<span\n                class=\"trace-line-icon\"\n                aria-label=\"is equal to\"\n                ?hidden=${singleResult}\n              >↳</span\n              ><span class=${classMap({ 'trace-line': true, 'full-row': singleResult})}>${finalResult}</span>`}\n      </div>\n    `,\n      // clang-format on\n      target,\n  );\n\n  function onKeyDown(this: HTMLDivElement, e: KeyboardEvent): void {\n    // prevent styles-tab keyboard navigation\n    if (!e.altKey) {\n      if (e.key.startsWith('Arrow') || e.key === ' ' || e.key === 'Enter') {\n        e.consume();\n      }\n    }\n\n    // Capture tab focus within\n    if (e.key === 'Tab') {\n      const tabstops = this.querySelectorAll('[tabindex]') ?? [];\n      const firstTabStop = tabstops[0];\n      const lastTabStop = tabstops[tabstops.length - 1];\n      if (e.target === lastTabStop && !e.shiftKey) {\n        e.consume(true);\n        if (firstTabStop instanceof HTMLElement) {\n          firstTabStop.focus();\n        }\n      }\n      if (e.target === firstTabStop && e.shiftKey) {\n        e.consume(true);\n        if (lastTabStop instanceof HTMLElement) {\n          lastTabStop.focus();\n        }\n      }\n    }\n  }\n}\n\nexport class CSSValueTraceView extends UI.Widget.VBox {\n  #highlighting: Highlighting|undefined;\n  readonly #view: View;\n  #evaluations: Node[][] = [];\n  #substitutions: Node[][] = [];\n\n  constructor(element?: HTMLElement, view: View = defaultView) {\n    super(true, false, element);\n    this.registerRequiredCSS(\n        cssValueTraceViewStyles,\n        stylePropertiesTreeOutlineStyles,\n    );\n    this.#view = view;\n    this.requestUpdate();\n  }\n\n  async showTrace(\n      property: SDK.CSSProperty.CSSProperty,\n      subexpression: string|null,\n      matchedStyles: SDK.CSSMatchedStyles.CSSMatchedStyles,\n      computedStyles: Map<string, string>|null,\n      renderers: Array<MatchRenderer<SDK.CSSPropertyParser.Match>>,\n      expandPercentagesInShorthands: boolean,\n      shorthandPositionOffset: number,\n      ): Promise<void> {\n    const matchedResult = subexpression === null ?\n        property.parseValue(matchedStyles, computedStyles) :\n        property.parseExpression(subexpression, matchedStyles, computedStyles);\n    if (!matchedResult) {\n      return undefined;\n    }\n    return await this.#showTrace(\n        property, matchedResult, renderers, expandPercentagesInShorthands, shorthandPositionOffset);\n  }\n\n  async #showTrace(\n      property: SDK.CSSProperty.CSSProperty,\n      matchedResult: SDK.CSSPropertyParser.BottomUpTreeMatching,\n      renderers: Array<MatchRenderer<SDK.CSSPropertyParser.Match>>,\n      expandPercentagesInShorthands: boolean,\n      shorthandPositionOffset: number,\n      ): Promise<void> {\n    this.#highlighting = new Highlighting();\n    const rendererMap = new Map(renderers.map(r => [r.matchType, r]));\n\n    // Compute all trace lines\n    // 1st: Apply substitutions for var() functions\n    const substitutions = [];\n    const evaluations = [];\n    const tracing =\n        new TracingContext(this.#highlighting, expandPercentagesInShorthands, shorthandPositionOffset, matchedResult);\n    while (tracing.nextSubstitution()) {\n      const context = new RenderingContext(\n          matchedResult.ast,\n          property,\n          rendererMap,\n          matchedResult,\n          /* cssControls */ undefined,\n          /* options */ {},\n          tracing,\n      );\n      substitutions.push(Renderer.render(matchedResult.ast.tree, context).nodes);\n    }\n\n    // 2nd: Apply evaluations for calc, min, max, etc.\n    const asyncCallbackResults = [];\n    while (tracing.nextEvaluation()) {\n      const context = new RenderingContext(\n          matchedResult.ast,\n          property,\n          rendererMap,\n          matchedResult,\n          /* cssControls */ undefined,\n          /* options */ {},\n          tracing,\n      );\n      evaluations.push(Renderer.render(matchedResult.ast.tree, context).nodes);\n      asyncCallbackResults.push(tracing.runAsyncEvaluations());\n    }\n\n    this.#substitutions = substitutions;\n    this.#evaluations = [];\n    for (const [index, success] of (await Promise.all(asyncCallbackResults)).entries()) {\n      if (success) {\n        this.#evaluations.push(evaluations[index]);\n      }\n    }\n\n    if (this.#substitutions.length === 0 && this.#evaluations.length === 0) {\n      const context = new RenderingContext(\n          matchedResult.ast,\n          property,\n          rendererMap,\n          matchedResult,\n      );\n      this.#evaluations.push(Renderer.render(matchedResult.ast.tree, context).nodes);\n    }\n\n    this.requestUpdate();\n  }\n\n  override performUpdate(): void {\n    const viewInput: ViewInput = {\n      substitutions: this.#substitutions,\n      evaluations: this.#evaluations,\n      onToggle: () => this.onResize(),\n    };\n    const viewOutput: ViewOutput = {};\n    this.#view(viewInput, viewOutput, this.contentElement);\n    this.setDefaultFocusedElement(viewOutput.defaultFocusedElement ?? null);\n  }\n}\n"]}