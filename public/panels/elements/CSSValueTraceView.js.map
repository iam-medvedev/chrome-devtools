{"version":3,"file":"CSSValueTraceView.js","sourceRoot":"","sources":["../../../../../../front_end/panels/elements/CSSValueTraceView.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2025 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport type * as SDK from '../../core/sdk/sdk.js';\nimport * as Lit from '../../third_party/lit/lit.js';\nimport * as UI from '../../ui/legacy/legacy.js';\n\nimport cssValueTraceViewStyles from './cssValueTraceView.css.js';\nimport {\n  type MatchRenderer,\n  Renderer,\n  RenderingContext,\n  TracingContext,\n} from './PropertyRenderer.js';\nimport stylePropertiesTreeOutlineStyles from './stylePropertiesTreeOutline.css.js';\n\nconst {html, render} = Lit;\n\nexport interface ViewInput {\n  substitutions: Node[][];\n  evaluations: Node[][];\n  finalResult: Node[]|undefined;\n  onToggle: () => void;\n}\nexport interface ViewOutput {}\n\nexport type View = (\n    input: ViewInput,\n    output: ViewOutput,\n    target: HTMLElement,\n    ) => void;\n\nexport class CSSValueTraceView extends UI.Widget.VBox {\n  #view: View;\n  #finalResult: Node[]|undefined = undefined;\n  #evaluations: Node[][] = [];\n  #substitutions: Node[][] = [];\n\n  constructor(\n      view: View = (input, output, target):\n          void => {\n            const substitutionIcon = html`<span class=trace-line-icon aria-label=\"resolved to\">\\u21B3</span>`;\n            const evalIcon = html`<span class=trace-line-icon aria-label=\"is equal to\">\\u003D</span>`;\n            const [firstEvaluation, ...intermediateEvaluations] = input.evaluations;\n            render(\n                // clang-format off\n        html`\n<div class=\"css-value-trace monospace\">\n  ${input.substitutions.map(line => html`${substitutionIcon}<span class=\"trace-line\">${line}</span>`)}\n  ${\n    firstEvaluation && intermediateEvaluations.length === 0\n      ? html`${evalIcon}<span class=\"trace-line\">${firstEvaluation}</span>`\n      : html`<details\n                  @toggle=${input.onToggle}\n                  ?hidden=${!firstEvaluation || intermediateEvaluations.length === 0}>\n    <summary>\n       ${evalIcon}<devtools-icon class=marker></devtools-icon><span class=\"trace-line\">${firstEvaluation}</span>\n    </summary>\n    <div>\n      ${intermediateEvaluations.map(evaluation => html`${evalIcon}<span class=\"trace-line\">${evaluation}</span>`)}\n    </div>\n  </details>`\n  }\n  ${!input.finalResult ? '' : html`${evalIcon}<span class=\"trace-line\">${input.finalResult}</span>`}\n</div>\n`,\n                // clang-format on\n                target,\n            );\n          },\n  ) {\n    super(true);\n    this.registerRequiredCSS(cssValueTraceViewStyles, stylePropertiesTreeOutlineStyles);\n    this.#view = view;\n    this.requestUpdate();\n  }\n\n  showTrace(\n      property: SDK.CSSProperty.CSSProperty,\n      matchedStyles: SDK.CSSMatchedStyles.CSSMatchedStyles,\n      computedStyles: Map<string, string>|null,\n      renderers: Array<MatchRenderer<SDK.CSSPropertyParser.Match>>,\n      ): void {\n    const matchedResult = property.parseValue(matchedStyles, computedStyles);\n    if (!matchedResult) {\n      return undefined;\n    }\n\n    const rendererMap = new Map(renderers.map(r => [r.matchType, r]));\n\n    // Compute all trace lines\n    // 1st: Apply substitutions for var() functions\n    const substitutions = [];\n    const evaluations = [];\n    const tracing = new TracingContext(matchedResult);\n    while (tracing.nextSubstitution()) {\n      const context = new RenderingContext(\n          matchedResult.ast,\n          rendererMap,\n          matchedResult,\n          /* cssControls */ undefined,\n          /* options */ {},\n          tracing,\n      );\n      substitutions.push(\n          Renderer.render(matchedResult.ast.tree, context).nodes,\n      );\n    }\n\n    // 2nd: Apply evaluations for calc, min, max, etc.\n    while (tracing.nextEvaluation()) {\n      const context = new RenderingContext(\n          matchedResult.ast,\n          rendererMap,\n          matchedResult,\n          /* cssControls */ undefined,\n          /* options */ {},\n          tracing,\n      );\n      evaluations.push(Renderer.render(matchedResult.ast.tree, context).nodes);\n    }\n\n    this.#substitutions = substitutions;\n    this.#finalResult = evaluations.pop();\n    this.#evaluations = evaluations;\n    if (evaluations.length === 0 && !tracing.didApplyEvaluations()) {\n      this.#substitutions.pop();\n    }\n    this.requestUpdate();\n  }\n\n  override performUpdate(): void {\n    const viewInput: ViewInput = {\n      substitutions: this.#substitutions,\n      evaluations: this.#evaluations,\n      finalResult: this.#finalResult,\n      onToggle: () => this.onResize(),\n    };\n    const viewOutput = {};\n    this.#view(viewInput, viewOutput, this.contentElement);\n  }\n}\n"]}