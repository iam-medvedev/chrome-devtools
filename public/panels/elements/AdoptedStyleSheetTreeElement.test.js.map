{"version":3,"file":"AdoptedStyleSheetTreeElement.test.js","sourceRoot":"","sources":["../../../../../../front_end/panels/elements/AdoptedStyleSheetTreeElement.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2026 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as SDK from '../../core/sdk/sdk.js';\nimport * as Protocol from '../../generated/protocol.js';\nimport {renderElementIntoDOM} from '../../testing/DOMHelpers.js';\nimport {createTarget} from '../../testing/EnvironmentHelpers.js';\nimport {describeWithMockConnection} from '../../testing/MockConnection.js';\n\nimport * as Elements from './elements.js';\n\ndescribeWithMockConnection('AdoptedStyleSheetTreeElement highlighting', () => {\n  let domModel: SDK.DOMModel.DOMModel;\n  let treeOutline: Elements.ElementsTreeOutline.ElementsTreeOutline;\n  let containerNode: SDK.DOMModel.DOMNode;\n  let shadowRootNode: SDK.DOMModel.DOMNode;\n  let shadowRootTreeElement: Elements.ElementsTreeElement.ElementsTreeElement;\n  const sheetId = 'sheet-id' as Protocol.DOM.StyleSheetId;\n\n  beforeEach(async () => {\n    const target = createTarget();\n    domModel = target.model(SDK.DOMModel.DOMModel)!;\n\n    const containerPayload = {\n      nodeId: 1 as Protocol.DOM.NodeId,\n      backendNodeId: 2 as Protocol.DOM.BackendNodeId,\n      nodeType: Node.ELEMENT_NODE,\n      nodeName: 'DIV',\n      localName: 'div',\n      nodeValue: '',\n      attributes: [],\n      childNodeCount: 0,\n      shadowRoots: [{\n        nodeId: 3 as Protocol.DOM.NodeId,\n        backendNodeId: 4 as Protocol.DOM.BackendNodeId,\n        parentId: 1 as Protocol.DOM.NodeId,\n        nodeType: Node.DOCUMENT_FRAGMENT_NODE,\n        shadowRootType: Protocol.DOM.ShadowRootType.Open,\n        adoptedStyleSheets: [sheetId],\n        nodeName: 'SHADOW-ROOT',\n        localName: '#shadow-root',\n        nodeValue: '',\n      }],\n    };\n\n    containerNode = SDK.DOMModel.DOMNode.create(domModel, null, false, containerPayload);\n    shadowRootNode = containerNode.shadowRoots()![0];\n\n    treeOutline = new Elements.ElementsTreeOutline.ElementsTreeOutline();\n    treeOutline.wireToDOMModel(domModel);\n\n    const containerTreeElement = new Elements.ElementsTreeElement.ElementsTreeElement(containerNode);\n    shadowRootTreeElement = new Elements.ElementsTreeElement.ElementsTreeElement(shadowRootNode);\n    containerTreeElement.appendChild(shadowRootTreeElement);\n\n    treeOutline.setVisible(true);\n    renderElementIntoDOM(treeOutline.element);\n    containerTreeElement.expand();\n  });\n\n  afterEach(() => {\n    treeOutline.removeChildren();\n    treeOutline.setVisible(false);\n  });\n\n  it('edits an adopted style sheet', async () => {\n    const adoptedSheet = shadowRootNode.adoptedStyleSheetsForNode[0];\n    const initialCSS = '/* comment */';\n\n    let resolveWaitForText: (value: unknown) => void;\n    const waitForText = new Promise(resolve => {\n                          resolveWaitForText = resolve;\n                        })\n                            .then(() => {})\n                            .then(() => {});\n    const getStyleSheetTextStub = sinon.stub(adoptedSheet.cssModel, 'getStyleSheetText');\n    getStyleSheetTextStub.onFirstCall().resolves(initialCSS);\n    getStyleSheetTextStub.onSecondCall().callsFake(() => new Promise(resolve => {\n                                                     resolve(initialCSS);\n                                                     resolveWaitForText(null);\n                                                   }));\n\n    adoptedSheet.cssModel.styleSheetAdded({\n      styleSheetId: sheetId,\n      frameId: '' as Protocol.Page.FrameId,\n      sourceURL: '',\n      title: '',\n      origin: Protocol.CSS.StyleSheetOrigin.Regular,\n      disabled: false,\n      isInline: false,\n      isMutable: true,\n      isConstructed: true,\n      startLine: 0,\n      startColumn: 0,\n      endLine: 0,\n      endColumn: initialCSS.length,\n      length: initialCSS.length,\n      loadingFailed: false,\n    });\n    const adoptedStyleSheetSetTreeElement =\n        new Elements.AdoptedStyleSheetTreeElement.AdoptedStyleSheetSetTreeElement([adoptedSheet]);\n    shadowRootTreeElement.appendChild(adoptedStyleSheetSetTreeElement);\n    await shadowRootTreeElement.onpopulate();\n    shadowRootTreeElement.expand();\n    assert.strictEqual(shadowRootTreeElement.childCount(), 1);\n    assert.strictEqual(shadowRootTreeElement.children()[0], adoptedStyleSheetSetTreeElement);\n    await adoptedStyleSheetSetTreeElement.onpopulate();\n    adoptedStyleSheetSetTreeElement.expand();\n    assert.strictEqual(adoptedStyleSheetSetTreeElement.childCount(), 1);\n    const adoptedStyleSheetTreeElement = adoptedStyleSheetSetTreeElement.children()[0] as\n        Elements.AdoptedStyleSheetTreeElement.AdoptedStyleSheetTreeElement;\n    await adoptedStyleSheetTreeElement.onpopulate();\n    adoptedStyleSheetTreeElement.expand();\n    assert.strictEqual(adoptedStyleSheetTreeElement.childCount(), 1);\n\n    const adoptedStyleSheetContentsTreeElement = adoptedStyleSheetTreeElement.children()[0] as\n        Elements.AdoptedStyleSheetTreeElement.AdoptedStyleSheetContentsTreeElement;\n    const setTextStub = sinon.stub(adoptedSheet.cssModel, 'setStyleSheetText').resolves(null);\n\n    await adoptedStyleSheetContentsTreeElement.onpopulate();\n\n    const textElementDOM =\n        adoptedStyleSheetContentsTreeElement.listItemElement.querySelector('.webkit-html-text-node') as HTMLElement;\n    assert.exists(textElementDOM);\n\n    // Start editing by calling ondblclick\n    const event = new MouseEvent('dblclick', {bubbles: true, cancelable: true});\n    Object.defineProperty(event, 'target', {value: textElementDOM});\n    assert.isFalse(adoptedStyleSheetContentsTreeElement.ondblclick(event));\n    await waitForText;\n    sinon.assert.calledTwice(getStyleSheetTextStub);\n    assert.isTrue(adoptedStyleSheetContentsTreeElement.isEditing());\n\n    assert.strictEqual(textElementDOM.textContent, initialCSS);\n\n    // The inplace editor is now active on textElementDOM.\n    const newCSS = '.foo { color: red; }';\n    textElementDOM.textContent = newCSS;\n\n    // The commit is triggered by blur or enter.\n    textElementDOM.dispatchEvent(new KeyboardEvent('keydown', {key: 'Enter'}));\n\n    assert.isFalse(adoptedStyleSheetContentsTreeElement.isEditing());\n\n    sinon.assert.calledOnce(setTextStub);\n    sinon.assert.calledWith(setTextStub, sheetId, newCSS, false);\n  });\n});\n"]}