{"version":3,"file":"FreestylerChatUi.test.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/freestyler/components/FreestylerChatUi.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Host from '../../../core/host/host.js';\nimport type * as SDK from '../../../core/sdk/sdk.js';\nimport type * as TimelineUtils from '../../../panels/timeline/utils/utils.js';\nimport {renderElementIntoDOM} from '../../../testing/DOMHelpers.js';\nimport {describeWithEnvironment, getGetHostConfigStub} from '../../../testing/EnvironmentHelpers.js';\nimport * as Marked from '../../../third_party/marked/marked.js';\nimport * as MarkdownView from '../../../ui/components/markdown_view/markdown_view.js';\nimport * as Freestyler from '../freestyler.js';\n\nconst {MarkdownRendererWithCodeBlock} = Freestyler.FOR_TEST;\n\ndescribeWithEnvironment('FreestylerChatUi', () => {\n  describe('MarkdownRendererWithCodeBlock', () => {\n    it('should transform code token for multiline code blocks with `css` language written in the first line', () => {\n      const renderer = new MarkdownRendererWithCodeBlock();\n      const templateForTokenStub =\n          sinon.stub(MarkdownView.MarkdownView.MarkdownInsightRenderer.prototype, 'templateForToken');\n      const codeBlock = `\\`\\`\\`\ncss\n* {\n  color: red;\n}\n\\`\\`\\``;\n      const codeToken = Marked.Marked.lexer(codeBlock)[0] as Marked.Marked.Tokens.Code;\n      assert.isEmpty(codeToken.lang);\n      renderer.renderToken(codeToken);\n\n      sinon.assert.calledWith(templateForTokenStub, sinon.match({\n        lang: 'css',\n        text: `* {\n  color: red;\n}`,\n      }));\n    });\n  });\n\n  function getProp(options: Partial<Freestyler.Props>): Freestyler.Props {\n    const noop = () => {};\n    const messages: Freestyler.ChatMessage[] = options.messages ?? [];\n    return {\n      onTextSubmit: noop,\n      onInspectElementClick: noop,\n      onFeedbackSubmit: noop,\n      onCancelClick: noop,\n      onSelectedNetworkRequestClick: noop,\n      onSelectedFileRequestClick: noop,\n      inspectElementToggled: false,\n      state: Freestyler.State.CHAT_VIEW,\n      agentType: Freestyler.AgentType.FREESTYLER,\n      aidaAvailability: Host.AidaClient.AidaAccessPreconditions.AVAILABLE,\n      messages,\n      selectedElement: {} as unknown as SDK.DOMModel.DOMNode,\n      selectedFile: null,\n      selectedNetworkRequest: {} as unknown as SDK.NetworkRequest.NetworkRequest,\n      selectedAiCallTree: {} as unknown as TimelineUtils.AICallTree.AICallTree,\n      isLoading: false,\n      canShowFeedbackForm: false,\n      userInfo: {},\n      ...options,\n    };\n  }\n\n  describe('SideEffects', () => {\n    it('should show SideEffects when the step contains \"sideEffect\" object', async () => {\n      const props = getProp({\n        messages: [\n          {\n            entity: Freestyler.ChatMessageEntity.MODEL,\n            steps: [\n              {\n                isLoading: false,\n                title: 'Updating element styles',\n                thought: 'Updating element styles',\n                code: '$0.style.background = \"blue\";',\n                sideEffect: {\n                  onAnswer: () => {},\n                },\n              },\n            ],\n          },\n        ],\n      });\n      const chat = new Freestyler.FreestylerChatUi(props);\n      renderElementIntoDOM(chat);\n\n      const sideEffect = chat.shadowRoot!.querySelector('.side-effect-confirmation');\n      assert.exists(sideEffect);\n    });\n\n    it('shows the disabled view when the state is CONSENT_VIEW', async () => {\n      const props = getProp({\n        state: Freestyler.State.CONSENT_VIEW,\n      });\n      const chat = new Freestyler.FreestylerChatUi(props);\n      renderElementIntoDOM(chat);\n\n      const optIn = chat.shadowRoot?.querySelector('.disabled-view');\n      assert.strictEqual(\n          optIn?.textContent?.trim(), 'Turn on AI assistance in Settings to get help with understanding CSS styles');\n      const chatInput = chat.shadowRoot?.querySelector('.chat-input') as HTMLTextAreaElement;\n      assert.isTrue(chatInput.disabled);\n      assert.strictEqual(chatInput.placeholder, 'Follow the steps above to ask a question');\n    });\n\n    it('shows the disabled view when the AIDA is not available', async () => {\n      const props = getProp({\n        state: Freestyler.State.CHAT_VIEW,\n        aidaAvailability: Host.AidaClient.AidaAccessPreconditions.NO_INTERNET,\n      });\n      const chat = new Freestyler.FreestylerChatUi(props);\n      renderElementIntoDOM(chat);\n\n      const optIn = chat.shadowRoot?.querySelector('.disabled-view');\n      assert.strictEqual(optIn?.textContent?.trim(), 'Check your internet connection and try again');\n      const chatInput = chat.shadowRoot?.querySelector('.chat-input') as HTMLTextAreaElement;\n      assert.isTrue(chatInput.disabled);\n      assert.strictEqual(chatInput.placeholder, 'Ask a question about the selected element');\n    });\n\n    it('shows usage instructions', async () => {\n      const stub = getGetHostConfigStub({\n        devToolsFreestyler: {\n          enabled: true,\n        },\n        devToolsAiAssistanceNetworkAgent: {\n          enabled: true,\n        },\n        devToolsAiAssistanceFileAgent: {\n          enabled: true,\n        },\n        devToolsAiAssistancePerformanceAgent: {\n          enabled: true,\n        },\n      });\n      const props = getProp({\n        agentType: undefined,\n      });\n      const chat = new Freestyler.FreestylerChatUi(props);\n      renderElementIntoDOM(chat);\n      const instructions = chat.shadowRoot?.querySelectorAll('.instructions strong');\n      assert.isDefined(instructions);\n      assert.strictEqual(instructions?.length, 4);\n      assert.strictEqual(instructions[0].textContent, 'CSS help:');\n      assert.strictEqual(instructions[1].textContent, 'File insights:');\n      assert.strictEqual(instructions[2].textContent, 'Network request insights:');\n      assert.strictEqual(instructions[3].textContent, 'Performance analysis:');\n\n      stub.restore();\n    });\n  });\n});\n"]}