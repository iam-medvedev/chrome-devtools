{"version":3,"file":"DrJonesPerformanceAgent.js","sourceRoot":"","sources":["../../../../../../front_end/panels/freestyler/DrJonesPerformanceAgent.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../core/common/common.js';\nimport * as Host from '../../core/host/host.js';\nimport * as i18n from '../../core/i18n/i18n.js';\nimport type * as Trace from '../../models/trace/trace.js';\n\nimport {\n  AiAgent,\n  type AidaRequestOptions,\n  type ContextDetail,\n  debugLog,\n  ErrorType,\n  isDebugMode,\n  type ResponseData,\n  ResponseType,\n  type ThoughtResponse,\n  type TitleResponse,\n} from './AiAgent.js';\n\nconst preamble = `You are a performance expert deeply integrated with Chrome DevTools.\nYou specialize in analyzing web application behavior captured by Chrome DevTools Performance Panel.\nYou will be provided with a string containing the JSON.stringify representation of a tree of events captured in a Chrome DevTools performance recording.\nThis tree originates from the root task of a specific event that was selected by a user in the Performance panel's flame graph.\nEach node in this tree represents an event and contains the following information:\n* id: A unique identifier for the event.\n* url:  The URL of the JavaScript file where the event originated (if applicable).\n* line: The line number in the JavaScript file where the event originated (if applicable).\n* column: The column number in the JavaScript file where the event originated (if applicable).\n* function: The name of the function associated with this event.\n* start: The start time of the event in milliseconds.\n* totalTime: The total duration of the event, including the time spent in its children, in milliseconds.\n* selfTime:  The duration of the event itself, excluding the time spent in its children, in milliseconds.\n* selected: A boolean value indicating whether this is the event the user selected in the Performance panel.\n* children: An array of child events, each represented as another node with the same structure.\n\nYour task is to analyze this event and its surrounding context within the performance recording. Your analysis may include:\n* Clearly state the name and purpose of the selected event based on its properties (e.g., function name, URL, line number). Explain what the task is broadly doing. You can also mention the function\n* Describe its execution context:\n  * Ancestors: Trace back through the tree to identify the chain of parent events that led to the execution of the selected event. Describe this execution path.\n  * Descendants:  Analyze the children of the selected event. What tasks did it initiate? Did it spawn any long-running or resource-intensive sub-tasks?\n* Quantify performance:\n    * Duration\n    * Relative Cost:  How much did this event contribute to the overall duration of its parent tasks and the entire recorded trace?\n    * Potential Bottlenecks: Analyze the totalTime and selfTime of the selected event and its children to identify any potential performance bottlenecks. Are there any excessively long tasks or periods of idle time?\n4. (Only provide if you have specific suggestions) Based on your analysis, provide specific and actionable suggestions for improving the performance of the selected event and its related tasks.  Are there any resources being acquired or held for longer than necessary?\n\n# Considerations\n* Keep your analysis concise and focused, highlighting only the most critical aspects for a software engineer.\n* Do not mention id of the event in your response.\n\n## Example session\n\nSelected call tree\n'{\"id\":\"1\",\"function\":\"main\",\"start\":0,\"totalTime\":500,\"selfTime\":100,\"children\":[{\"id\":\"2\",\"function\":\"update\",\"start\":100,\"totalTime\":200,\"selfTime\":50,\"children\":[{\"id\":\"3\",\"function\":\"animate\",\"url\":\"[invalid URL removed]\",\"line\":120,\"column\":10,\"start\":150,\"totalTime\":150,\"selfTime\":20,\"selected\":true,\"children\":[{\"id\":\"4\",\"function\":\"calculatePosition\",\"start\":160,\"totalTime\":80,\"selfTime\":80,\"children\":[]},{\"id\":\"5\",\"function\":\"applyStyles\",\"start\":240,\"totalTime\":50,\"selfTime\":50,\"children\":[]}]}]}]}'\nExplain the selected task.\n\n\nIt looks like you've selected the animate function, which is responsible for animating elements on the page.\nThis function took a total of 150ms to execute, but only 20ms of that time was spent within the animate function itself.\nThe remaining 130ms were spent in its child functions, calculatePosition and applyStyles.\nIt seems like a significant portion of the animation time is spent calculating the position of the elements.\nPerhaps there's room for optimization there. You could investigate whether the calculatePosition function can be made more efficient or if the number of calculations can be reduced.\n`;\n\n/*\n* Strings that don't need to be translated at this time.\n*/\nconst UIStringsNotTranslate = {\n  analyzingStackTrace: 'Analyzing stack trace',\n  /**\n   *@description Thought text for thinking step of DrJones Performance agent.\n   */\n  dataUsedToGenerateThisResponse: 'Data used to generate this response',\n};\n\nconst lockedString = i18n.i18n.lockedString;\n\n/**\n * One agent instance handles one conversation. Create a new agent\n * instance for a new conversation.\n */\nexport class DrJonesPerformanceAgent extends AiAgent {\n  readonly preamble = preamble;\n  readonly clientFeature = Host.AidaClient.ClientFeature.CHROME_FREESTYLER;\n  // TODO(b/369822364): use a feature param instead.\n  readonly userTier = 'BETA';\n  get options(): AidaRequestOptions {\n    const config = Common.Settings.Settings.instance().getHostConfig();\n    const temperature = AiAgent.validTemperature(config.devToolsAiAssistancePerformanceAgentDogfood?.temperature);\n    const modelId = config.devToolsAiAssistancePerformanceAgentDogfood?.modelId;\n\n    return {\n      temperature,\n      model_id: modelId,\n    };\n  }\n\n  *\n      handleContextDetails(selectedStackTrace: Trace.Helpers.TreeHelpers.TraceEntryNodeForAI|null):\n          Generator<ThoughtResponse|TitleResponse, void, void> {\n    yield {\n      type: ResponseType.TITLE,\n      title: lockedString(UIStringsNotTranslate.analyzingStackTrace),\n    };\n    yield {\n      type: ResponseType.THOUGHT,\n      thought: lockedString(UIStringsNotTranslate.dataUsedToGenerateThisResponse),\n      contextDetails: createContextDetailsForDrJonesPerformanceAgent(selectedStackTrace),\n    };\n  }\n\n  async enhanceQuery(query: string, selectedStackTrace: Trace.Helpers.TreeHelpers.TraceEntryNodeForAI|null):\n      Promise<string> {\n    const networkEnchantmentQuery =\n        selectedStackTrace ? `# Selected stack trace\\n${JSON.stringify(selectedStackTrace)}\\n\\n# User request\\n\\n` : '';\n    return `${networkEnchantmentQuery}${query}`;\n  }\n\n  #runId = 0;\n  async * run(query: string, options: {\n    signal?: AbortSignal, selectedStackTrace: Trace.Helpers.TreeHelpers.TraceEntryNodeForAI|null,\n  }): AsyncGenerator<ResponseData, void, void> {\n    yield* this.handleContextDetails(options.selectedStackTrace);\n\n    query = await this.enhanceQuery(query, options.selectedStackTrace);\n    const currentRunId = ++this.#runId;\n\n    let response: string;\n    let rpcId: number|undefined;\n    try {\n      const fetchResult = await this.aidaFetch(query, {signal: options.signal});\n      response = fetchResult.response;\n      rpcId = fetchResult.rpcId;\n    } catch (err) {\n      debugLog('Error calling the AIDA API', err);\n      if (err instanceof Host.AidaClient.AidaAbortError) {\n        this.removeHistoryRun(currentRunId);\n        yield {\n          type: ResponseType.ERROR,\n          error: ErrorType.ABORT,\n          rpcId,\n        };\n        return;\n      }\n\n      yield {\n        type: ResponseType.ERROR,\n        error: ErrorType.UNKNOWN,\n        rpcId,\n      };\n      return;\n    }\n\n    this.addToHistory({\n      id: currentRunId,\n      query,\n      output: response,\n    });\n\n    yield {\n      type: ResponseType.ANSWER,\n      text: response,\n      rpcId,\n    };\n    if (isDebugMode()) {\n      window.dispatchEvent(new CustomEvent('freestylerdone'));\n    }\n  }\n}\n\nfunction createContextDetailsForDrJonesPerformanceAgent(\n    selectedStackTrace: Trace.Helpers.TreeHelpers.TraceEntryNodeForAI|null): [ContextDetail, ...ContextDetail[]] {\n  return [\n    {\n      title: 'Selected stack trace',\n      text: JSON.stringify(selectedStackTrace),\n    },\n  ];\n}\n\nfunction setDebugFreestylerEnabled(enabled: boolean): void {\n  if (enabled) {\n    localStorage.setItem('debugFreestylerEnabled', 'true');\n  } else {\n    localStorage.removeItem('debugFreestylerEnabled');\n  }\n}\n\n// @ts-ignore\nglobalThis.setDebugFreestylerEnabled = setDebugFreestylerEnabled;\n"]}