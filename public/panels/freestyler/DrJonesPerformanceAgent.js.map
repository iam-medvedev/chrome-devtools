{"version":3,"file":"DrJonesPerformanceAgent.js","sourceRoot":"","sources":["../../../../../../front_end/panels/freestyler/DrJonesPerformanceAgent.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../core/common/common.js';\nimport * as Host from '../../core/host/host.js';\nimport * as i18n from '../../core/i18n/i18n.js';\nimport * as TimelineUtils from '../../panels/timeline/utils/utils.js';\nimport * as PanelUtils from '../utils/utils.js';\n\nimport {\n  AgentType,\n  AiAgent,\n  type ContextResponse,\n  ConversationContext,\n  type ParsedResponse,\n  type RequestOptions,\n  ResponseType,\n} from './AiAgent.js';\n\n/**\n * Preamble clocks in at ~950 tokens.\n *   The prose is around 4.5 chars per token.\n * The data can be as bad as 1.8 chars per token\n *\n * Check token length in https://aistudio.google.com/\n */\nconst preamble = `You are a performance expert deeply integrated with Chrome DevTools.\nYou specialize in analyzing web application behavior captured by Chrome DevTools Performance Panel and Chrome tracing.\nYou will be provided a text representation of a call tree of native and JavaScript callframes selected by the user from a performance trace's flame chart.\nThis tree originates from the root task of a specific callframe.\n\nThe format of each callframe is:\n\n    Node: $id – $name\n    Selected: true\n    dur: $duration\n    self: $self\n    URL #: $url_number\n    Children:\n      * $child.id – $child.name\n\nThe fields are:\n\n* name:  A short string naming the callframe (e.g. 'Evaluate Script' or the JS function name 'InitializeApp')\n* id:  A numerical identifier for the callframe\n* Selected:  Set to true if this callframe is the one the user selected.\n* url_number:  The number of the URL referenced in the \"All URLs\" list\n* dur:  The total duration of the callframe (includes time spent in its descendants), in milliseconds.\n* self:  The self duration of the callframe (excludes time spent in its descendants), in milliseconds. If omitted, assume the value is 0.\n* children:  An list of child callframes, each denoted by their id and name\n\nYour task is to analyze this callframe and its surrounding context within the performance recording. Your analysis may include:\n* Clearly state the name and purpose of the selected callframe based on its properties (e.g., name, URL). Explain what the task is broadly doing.\n* Describe its execution context:\n  * Ancestors: Trace back through the tree to identify the chain of parent callframes that led to the execution of the selected callframe. Describe this execution path.\n  * Descendants:  Analyze the children of the selected callframe. What tasks did it initiate? Did it spawn any long-running or resource-intensive sub-tasks?\n* Quantify performance:\n    * Duration\n    * Relative Cost:  How much did this callframe contribute to the overall duration of its parent tasks and the entire recorded trace?\n    * Potential Bottlenecks: Analyze the total and self duration of the selected callframe and its children to identify any potential performance bottlenecks. Are there any excessively long tasks or periods of idle time?\n4. Based on your analysis, provide specific and actionable suggestions for improving the performance of the selected callframe and its related tasks.  Are there any resources being acquired or held for longer than necessary? Only provide if you have specific suggestions.\n\n# Considerations\n* Keep your analysis concise and focused, highlighting only the most critical aspects for a software engineer.\n* Do not mention id of the callframe or the URL number in your response.\n* **CRITICAL** If the user asks a question about religion, race, politics, sexuality, gender, or other sensitive topics, answer with \"Sorry, I can't answer that. I'm best at questions about performance of websites.\"\n\n## Example session\n\nAll URL #s:\n\n* 0 – app.js\n\nCall tree:\n\nNode: 1 – main\ndur: 500\nself: 100\nChildren:\n  * 2 – update\n\nNode: 2 – update\ndur: 200\nself: 50\nChildren:\n  * 3 – animate\n\nNode: 3 – animate\nSelected: true\ndur: 150\nself: 20\nURL #: 0\nChildren:\n  * 4 – calculatePosition\n  * 5 – applyStyles\n\nNode: 4 – calculatePosition\ndur: 80\nself: 80\n\nNode: 5 – applyStyles\ndur: 50\nself: 50\n\nExplain the selected task.\n\n\nIt looks like you've selected the animate function, which is responsible for animating elements on the page.\nThis function took a total of 150ms to execute, but only 20ms of that time was spent within the animate function itself.\nThe remaining 130ms were spent in its child functions, calculatePosition and applyStyles.\nIt seems like a significant portion of the animation time is spent calculating the position of the elements.\nPerhaps there's room for optimization there. You could investigate whether the calculatePosition function can be made more efficient or if the number of calculations can be reduced.\n`;\n\n/*\n* Strings that don't need to be translated at this time.\n*/\nconst UIStringsNotTranslate = {\n  analyzingCallTree: 'Analyzing call tree',\n};\n\nconst lockedString = i18n.i18n.lockedString;\n\nexport class CallTreeContext extends ConversationContext<TimelineUtils.AICallTree.AICallTree> {\n  #callTree: TimelineUtils.AICallTree.AICallTree;\n\n  constructor(callTree: TimelineUtils.AICallTree.AICallTree) {\n    super();\n    this.#callTree = callTree;\n  }\n\n  override getOrigin(): string {\n    // TODO: implement cross-origin checks for the PerformanceAgent.\n    return '';\n  }\n\n  override getItem(): TimelineUtils.AICallTree.AICallTree {\n    return this.#callTree;\n  }\n\n  override getIcon(): HTMLElement {\n    const iconData = {\n      iconName: 'performance',\n      color: 'var(--sys-color-on-surface-subtle)',\n    };\n    const icon = PanelUtils.PanelUtils.createIconElement(iconData, 'Performance');\n    icon.classList.add('icon');\n    return icon;\n  }\n\n  override getTitle(): string {\n    const {event} = this.#callTree.selectedNode;\n    if (!event) {\n      return 'unknown';\n    }\n\n    return TimelineUtils.EntryName.nameForEntry(event);\n  }\n}\n\n/**\n * One agent instance handles one conversation. Create a new agent\n * instance for a new conversation.\n */\nexport class DrJonesPerformanceAgent extends AiAgent<TimelineUtils.AICallTree.AICallTree> {\n  override readonly type = AgentType.DRJONES_PERFORMANCE;\n  readonly preamble = preamble;\n  readonly clientFeature = Host.AidaClient.ClientFeature.CHROME_DRJONES_PERFORMANCE_AGENT;\n  get userTier(): string|undefined {\n    const config = Common.Settings.Settings.instance().getHostConfig();\n    return config.devToolsAiAssistancePerformanceAgent?.userTier;\n  }\n  get options(): RequestOptions {\n    const config = Common.Settings.Settings.instance().getHostConfig();\n    const temperature = config.devToolsAiAssistancePerformanceAgent?.temperature;\n    const modelId = config.devToolsAiAssistancePerformanceAgent?.modelId;\n\n    return {\n      temperature,\n      modelId,\n    };\n  }\n\n  async *\n      handleContextDetails(aiCallTree: ConversationContext<TimelineUtils.AICallTree.AICallTree>|null):\n          AsyncGenerator<ContextResponse, void, void> {\n    yield {\n      type: ResponseType.CONTEXT,\n      title: lockedString(UIStringsNotTranslate.analyzingCallTree),\n      details: [\n        {\n          title: 'Selected call tree',\n          text: aiCallTree?.getItem().serialize() ?? '',\n        },\n      ],\n    };\n  }\n\n  override async enhanceQuery(query: string, aiCallTree: ConversationContext<TimelineUtils.AICallTree.AICallTree>|null):\n      Promise<string> {\n    const treeStr = aiCallTree?.getItem().serialize();\n\n    // Collect the queries from previous messages in this session\n    const prevQueries: string[] = [];\n    for await (const data of this.runFromHistory()) {\n      if (data.type === ResponseType.QUERYING) {\n        prevQueries.push(data.query);\n      }\n    }\n    // If this is a followup chat about the same call tree, don't include the call tree serialization again.\n    // We don't need to repeat it and we'd rather have more the context window space.\n    if (prevQueries.length && treeStr && prevQueries.find(q => q.startsWith(treeStr))) {\n      aiCallTree = null;\n    }\n\n    const perfEnhancementQuery = aiCallTree ? `${treeStr}\\n\\n# User request\\n\\n` : '';\n    return `${perfEnhancementQuery}${query}`;\n  }\n\n  override parseResponse(response: string): ParsedResponse {\n    return {\n      answer: response,\n    };\n  }\n}\n"]}