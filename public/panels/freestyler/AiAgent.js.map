{"version":3,"file":"AiAgent.js","sourceRoot":"","sources":["../../../../../../front_end/panels/freestyler/AiAgent.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Host from '../../core/host/host.js';\n\nexport const enum ResponseType {\n  CONTEXT = 'context',\n  TITLE = 'title',\n  THOUGHT = 'thought',\n  ACTION = 'action',\n  SIDE_EFFECT = 'side-effect',\n  ANSWER = 'answer',\n  ERROR = 'error',\n  QUERYING = 'querying',\n  USER_QUERY = 'user-query',\n}\n\nexport const enum ErrorType {\n  UNKNOWN = 'unknown',\n  ABORT = 'abort',\n  MAX_STEPS = 'max-steps',\n}\n\nexport interface AnswerResponse {\n  type: ResponseType.ANSWER;\n  text: string;\n  rpcId?: number;\n  suggestions?: [string, ...string[]];\n}\n\nexport interface ErrorResponse {\n  type: ResponseType.ERROR;\n  error: ErrorType;\n  rpcId?: number;\n}\n\nexport interface ContextDetail {\n  title: string;\n  text: string;\n  codeLang?: string;\n}\nexport interface ContextResponse {\n  type: ResponseType.CONTEXT;\n  title: string;\n  details: [ContextDetail, ...ContextDetail[]];\n}\n\nexport interface TitleResponse {\n  type: ResponseType.TITLE;\n  title: string;\n  rpcId?: number;\n}\n\nexport interface ThoughtResponse {\n  type: ResponseType.THOUGHT;\n  thought: string;\n  rpcId?: number;\n}\n\nexport interface SideEffectResponse {\n  type: ResponseType.SIDE_EFFECT;\n  code: string;\n  confirm: (confirm: boolean) => void;\n  rpcId?: number;\n}\n\nexport interface ActionResponse {\n  type: ResponseType.ACTION;\n  code: string;\n  output: string;\n  canceled: boolean;\n  rpcId?: number;\n}\n\nexport interface QueryResponse {\n  type: ResponseType.QUERYING;\n  query: string;\n}\n\nexport interface UserQuery {\n  type: ResponseType.USER_QUERY;\n  query: string;\n}\n\nexport type ResponseData = AnswerResponse|ErrorResponse|ActionResponse|SideEffectResponse|ThoughtResponse|TitleResponse|\n    QueryResponse|ContextResponse|UserQuery;\n\nexport interface AidaBuildRequestOptions {\n  input: string;\n}\n\nexport interface HistoryChunk {\n  text: string;\n  entity: Host.AidaClient.Entity;\n}\n\nexport interface AidaRequestOptions {\n  temperature?: number;\n  modelId?: string;\n}\n\ninterface AgentOptions {\n  aidaClient: Host.AidaClient.AidaClient;\n  serverSideLoggingEnabled?: boolean;\n}\n\ninterface ParsedResponseAnswer {\n  answer: string;\n  suggestions?: [string, ...string[]];\n}\n\ninterface ParsedResponseStep {\n  thought?: string;\n  title?: string;\n  action?: string;\n}\n\nexport type ParsedResponse = ParsedResponseAnswer|ParsedResponseStep;\n\nexport const enum AgentType {\n  FREESTYLER = 'freestyler',\n  DRJONES_FILE = 'drjones-file',\n  DRJONES_NETWORK_REQUEST = 'drjones-network-request',\n  DRJONES_PERFORMANCE = 'drjones-performance',\n}\n\nconst MAX_STEP = 10;\n\nexport abstract class AiAgent<T> {\n  static validTemperature(temperature: number|undefined): number|undefined {\n    return typeof temperature === 'number' && temperature >= 0 ? temperature : undefined;\n  }\n\n  abstract type: AgentType;\n  readonly #sessionId: string = crypto.randomUUID();\n  #aidaClient: Host.AidaClient.AidaClient;\n  #serverSideLoggingEnabled: boolean;\n  abstract readonly preamble: string;\n  abstract readonly options: AidaRequestOptions;\n  abstract readonly clientFeature: Host.AidaClient.ClientFeature;\n  abstract readonly userTier: string|undefined;\n  abstract handleContextDetails(select: T|null): AsyncGenerator<ContextResponse, void, void>;\n\n  /**\n   * Mapping between the unique request id and\n   * the history chuck it created\n   */\n  #history = new Map<number, ResponseData[]>();\n\n  constructor(opts: AgentOptions) {\n    this.#aidaClient = opts.aidaClient;\n    this.#serverSideLoggingEnabled = opts.serverSideLoggingEnabled ?? false;\n  }\n\n  get chatHistoryForTesting(): Array<HistoryChunk> {\n    return this.#historyEntry;\n  }\n\n  set chatNewHistoryForTesting(history: Map<number, ResponseData[]>) {\n    this.#history = history;\n  }\n\n  get isEmpty(): boolean {\n    return this.#history.size <= 0;\n  }\n\n  get title(): string|undefined {\n    return [...this.#history.values()]\n        .flat()\n        .filter(response => {\n          return response.type === ResponseType.USER_QUERY;\n        })\n        .at(0)\n        ?.query;\n  }\n\n  #structuredLog: Array<{\n    request: Host.AidaClient.AidaRequest,\n    response: string,\n    rawResponse?: Host.AidaClient.AidaResponse,\n  }> = [];\n  async aidaFetch(\n      input: string,\n      options?: {signal?: AbortSignal},\n      ): Promise<{\n    response: string,\n    rpcId?: number,\n  }> {\n    const request = this.buildRequest({\n      input,\n    });\n\n    let rawResponse: Host.AidaClient.AidaResponse|undefined = undefined;\n    let response = '';\n    let rpcId: number|undefined;\n    for await (rawResponse of this.#aidaClient.fetch(request, options)) {\n      response = rawResponse.explanation;\n      rpcId = rawResponse.metadata.rpcGlobalId ?? rpcId;\n      if (rawResponse.metadata.attributionMetadata?.some(\n              meta => meta.attributionAction === Host.AidaClient.RecitationAction.BLOCK)) {\n        throw new Error('Attribution action does not allow providing the response');\n      }\n    }\n\n    debugLog({\n      request,\n      response: rawResponse,\n    });\n\n    this.#structuredLog.push({\n      request: structuredClone(request),\n      response,\n      rawResponse,\n    });\n    localStorage.setItem('freestylerStructuredLog', JSON.stringify(this.#structuredLog));\n\n    return {response, rpcId};\n  }\n\n  buildRequest(opts: AidaBuildRequestOptions): Host.AidaClient.AidaRequest {\n    const request: Host.AidaClient.AidaRequest = {\n      input: opts.input,\n      preamble: this.preamble,\n      // eslint-disable-next-line @typescript-eslint/naming-convention\n      chat_history: this.#history.size ? this.#historyEntry : undefined,\n      client: Host.AidaClient.CLIENT_NAME,\n      options: {\n        temperature: AiAgent.validTemperature(this.options.temperature),\n        // eslint-disable-next-line @typescript-eslint/naming-convention\n        model_id: this.options.modelId,\n      },\n      metadata: {\n        disable_user_content_logging: !(this.#serverSideLoggingEnabled ?? false),\n        string_session_id: this.#sessionId,\n        user_tier: Host.AidaClient.convertToUserTierEnum(this.userTier),\n      },\n      // eslint-disable-next-line @typescript-eslint/naming-convention\n      functionality_type: Host.AidaClient.FunctionalityType.CHAT,\n      // eslint-disable-next-line @typescript-eslint/naming-convention\n      client_feature: this.clientFeature,\n    };\n    return request;\n  }\n\n  handleAction(action: string, rpcId?: number): AsyncGenerator<SideEffectResponse, ActionResponse, void>;\n  handleAction(): never {\n    throw new Error('Unexpected action found');\n  }\n\n  async enhanceQuery(query: string, selected: T|null): Promise<string>;\n  async enhanceQuery(query: string): Promise<string> {\n    return query;\n  }\n\n  parseResponse(response: string): ParsedResponse {\n    return {\n      answer: response,\n    };\n  }\n\n  formatHistoryChunkAnswer(text: string): string {\n    return text;\n  }\n\n  formatHistoryChunkObservation(observation: {\n    title?: string,\n    thought?: string,\n    action?: string,\n  }): string {\n    let text = '';\n    if (observation.thought) {\n      text = `THOUGHT: ${observation.thought}`;\n    }\n    if (observation.title) {\n      text += `\\nTITLE: ${observation.title}`;\n    }\n    if (observation.action) {\n      text += `\\nACTION\n${observation.action}\nSTOP`;\n    }\n\n    return text;\n  }\n\n  get #historyEntry(): HistoryChunk[] {\n    const historyAll = new Map<number, HistoryChunk[]>();\n    for (const [id, entry] of this.#history.entries()) {\n      const history: HistoryChunk[] = [];\n      historyAll.set(id, history);\n      let response: {\n        title?: string,\n        thought?: string,\n        action?: string,\n      } = {};\n      for (const data of entry) {\n        switch (data.type) {\n          case ResponseType.CONTEXT:\n          case ResponseType.SIDE_EFFECT:\n          case ResponseType.USER_QUERY:\n            continue;\n          case ResponseType.QUERYING: {\n            const observation = this.formatHistoryChunkObservation(response);\n            if (observation) {\n              history.push({\n                entity: Host.AidaClient.Entity.SYSTEM,\n                text: observation,\n              });\n              response = {};\n            }\n\n            history.push({\n              entity: Host.AidaClient.Entity.USER,\n              text: data.query,\n            });\n            break;\n          }\n          case ResponseType.ANSWER:\n            history.push({\n              entity: Host.AidaClient.Entity.SYSTEM,\n              text: this.formatHistoryChunkAnswer(data.text),\n            });\n            break;\n          case ResponseType.TITLE:\n            response.title = data.title;\n            break;\n          case ResponseType.THOUGHT:\n            response.thought = data.thought;\n            break;\n          case ResponseType.ACTION:\n            response.action = data.code;\n            break;\n          case ResponseType.ERROR:\n            historyAll.delete(id);\n            break;\n        }\n      }\n      const observation = this.formatHistoryChunkObservation(response);\n      if (observation) {\n        history.push({\n          entity: Host.AidaClient.Entity.USER,\n          text: observation,\n        });\n      }\n    }\n\n    return [...historyAll.values()].flat();\n  }\n\n  #addHistory(id: number, data: ResponseData): void {\n    const currentRunEntries = this.#history.get(id);\n    if (currentRunEntries) {\n      currentRunEntries.push(data);\n      return;\n    }\n    this.#history.set(id, [data]);\n  }\n\n  #runId = 0;\n  async * run(query: string, options: {\n    signal?: AbortSignal, selected: T|null,\n  }): AsyncGenerator<ResponseData, void, void> {\n    const id = this.#runId++;\n\n    const response = {\n      type: ResponseType.USER_QUERY,\n      query,\n    } as const;\n    this.#addHistory(id, response);\n    yield response;\n\n    for await (const response of this.handleContextDetails(options.selected)) {\n      this.#addHistory(id, response);\n      yield response;\n    }\n\n    query = await this.enhanceQuery(query, options.selected);\n\n    for (let i = 0; i < MAX_STEP; i++) {\n      const queryResponse = {\n        type: ResponseType.QUERYING,\n        query,\n      } as const;\n      this.#addHistory(id, queryResponse);\n      yield queryResponse;\n      let response: string;\n      let rpcId: number|undefined;\n      try {\n        const fetchResult = await this.aidaFetch(\n            query,\n            {signal: options.signal},\n        );\n        response = fetchResult.response;\n        rpcId = fetchResult.rpcId;\n      } catch (err) {\n        debugLog('Error calling the AIDA API', err);\n\n        if (err instanceof Host.AidaClient.AidaAbortError) {\n          const response = {\n            type: ResponseType.ERROR,\n            error: ErrorType.ABORT,\n            rpcId,\n          } as const;\n          this.#addHistory(id, response);\n          yield response;\n          break;\n        }\n\n        const response = {\n          type: ResponseType.ERROR,\n          error: ErrorType.UNKNOWN,\n          rpcId,\n        } as const;\n        Host.userMetrics.actionTaken(Host.UserMetrics.Action.AiAssistanceError);\n        this.#addHistory(id, response);\n        yield response;\n\n        break;\n      }\n\n      const parsedResponse = this.parseResponse(response);\n\n      if ('answer' in parsedResponse) {\n        const {\n          answer,\n          suggestions,\n        } = parsedResponse;\n        if (answer) {\n          const response = {\n            type: ResponseType.ANSWER,\n            text: answer,\n            rpcId,\n            suggestions,\n          } as const;\n          Host.userMetrics.actionTaken(Host.UserMetrics.Action.AiAssistanceAnswerReceived);\n          this.#addHistory(id, response);\n          yield response;\n        } else {\n          const response = {\n            type: ResponseType.ERROR,\n            error: ErrorType.UNKNOWN,\n            rpcId,\n          } as const;\n          Host.userMetrics.actionTaken(Host.UserMetrics.Action.AiAssistanceError);\n          this.#addHistory(id, response);\n          yield response;\n        }\n\n        break;\n      }\n\n      const {\n        title,\n        thought,\n        action,\n      } = parsedResponse;\n\n      if (title) {\n        const response = {\n          type: ResponseType.TITLE,\n          title,\n          rpcId,\n        } as const;\n        this.#addHistory(id, response);\n        yield response;\n      }\n\n      if (thought) {\n        const response = {\n          type: ResponseType.THOUGHT,\n          thought,\n          rpcId,\n        } as const;\n        this.#addHistory(id, response);\n        yield response;\n      }\n\n      if (action) {\n        const result = yield* this.handleAction(action, rpcId);\n        this.#addHistory(id, result);\n        yield result;\n        query = `OBSERVATION: ${result.output}`;\n      }\n\n      if (i === MAX_STEP - 1) {\n        const response = {\n          type: ResponseType.ERROR,\n          error: ErrorType.MAX_STEPS,\n        } as const;\n        Host.userMetrics.actionTaken(Host.UserMetrics.Action.AiAssistanceError);\n        this.#addHistory(id, response);\n        yield response;\n        break;\n      }\n    }\n    if (isDebugMode()) {\n      window.dispatchEvent(new CustomEvent('freestylerdone'));\n    }\n  }\n\n  async * runFromHistory(): AsyncGenerator<ResponseData, void, void> {\n    for (const historyChunk of this.#history.values()) {\n      for (const entry of historyChunk) {\n        yield entry;\n      }\n    }\n  }\n}\n\nexport function isDebugMode(): boolean {\n  return Boolean(localStorage.getItem('debugFreestylerEnabled'));\n}\n\nexport function debugLog(...log: unknown[]): void {\n  if (!isDebugMode()) {\n    return;\n  }\n\n  // eslint-disable-next-line no-console\n  console.log(...log);\n}\n\nfunction setDebugFreestylerEnabled(enabled: boolean): void {\n  if (enabled) {\n    localStorage.setItem('debugFreestylerEnabled', 'true');\n  } else {\n    localStorage.removeItem('debugFreestylerEnabled');\n  }\n}\n// @ts-ignore\nglobalThis.setDebugFreestylerEnabled = setDebugFreestylerEnabled;\n"]}