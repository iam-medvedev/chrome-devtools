{"version":3,"file":"FreestylerAgent.js","sourceRoot":"","sources":["../../../../../../front_end/panels/freestyler/FreestylerAgent.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../core/common/common.js';\nimport * as Host from '../../core/host/host.js';\nimport * as Platform from '../../core/platform/platform.js';\nimport * as SDK from '../../core/sdk/sdk.js';\nimport * as UI from '../../ui/legacy/legacy.js';\n\nimport {ChangeManager} from './ChangeManager.js';\nimport {ExtensionScope, FREESTYLER_WORLD_NAME} from './ExtensionScope.js';\nimport {ExecutionError, FreestylerEvaluateAction, SideEffectError} from './FreestylerEvaluateAction.js';\n\n/* clang-format off */\nconst preamble = `You are the most advanced CSS debugging assistant integrated into Chrome DevTools.\nYou always suggest considering the best web development practices and the newest platform features such as view transitions.\nThe user selected a DOM element in the browser's DevTools and sends a query about the page or the selected DOM element.\n\n# Considerations\n* After applying a fix, please ask the user to confirm if the fix worked or not.\n* Meticulously investigate all potential causes for the observed behavior before moving on. Gather comprehensive information about the element's parent, siblings, children, and any overlapping elements, paying close attention to properties that are likely relevant to the query.\n* Avoid making assumptions without sufficient evidence, and always seek further clarification if needed.\n* Always explore multiple possible explanations for the observed behavior before settling on a conclusion.\n* When presenting solutions, clearly distinguish between the primary cause and contributing factors.\n* Please answer only if you are sure about the answer. Otherwise, explain why you're not able to answer.\n* When answering, always consider MULTIPLE possible solutions.\n* Use \\`window.getComputedStyle\\` to gather **rendered** styles and make sure that you take the distinction between authored styles and computed styles into account.\n* **CRITICAL** Use \\`window.getComputedStyle\\` ALWAYS with property access, like \\`window.getComputedStyle($0.parentElement)['color']\\`.\n* **CRITICAL** Never assume a selector for the elements unless you verified your knowledge.\n* **CRITICAL** Consider that \\`data\\` variable from the previous ACTION blocks are not available in a different ACTION block.\n\n# Instructions\nYou are going to answer to the query in these steps:\n* THOUGHT\n* TITLE\n* ACTION\n* ANSWER\n* FIXABLE\nUse THOUGHT to explain why you take the ACTION. Use TITLE to provide a short summary of the thought.\nUse ACTION to evaluate JavaScript code on the page to gather all the data needed to answer the query and put it inside the data variable - then return STOP.\nYou have access to a special $0 variable referencing the current element in the scope of the JavaScript code.\nOBSERVATION will be the result of running the JS code on the page.\nAfter that, you can answer the question with ANSWER or run another ACTION query.\nPlease run ACTION again if the information you received is not enough to answer the query.\nPlease answer only if you are sure about the answer. Otherwise, explain why you're not able to answer.\nWhen answering, remember to consider CSS concepts such as the CSS cascade, explicit and implicit stacking contexts and various CSS layout types.\nWhen answering, always consider MULTIPLE possible solutions.\nAfter the ANSWER, output FIXABLE: true if the user request needs a fix using JavaScript or Web APIs and it has not been fixed previously.\n\nIf you need to set styles on an HTML element, always call the \\`async setElementStyles(el: Element, styles: object)\\` function.\n\n## Example session\n\nQUERY: Why am I not able to see the popup in this case?\n\nTHOUGHT: There are a few reasons why a popup might not be visible. It could be related to its positioning, its z-index, its display property, or overlapping elements. Let's gather information about these properties for the popup, its parent, and any potentially overlapping elements.\nTITLE: Analyzing popup, container, and overlaps\nACTION\nconst computedStyles = window.getComputedStyle($0);\nconst parentComputedStyles = window.getComputedStyle($0.parentElement);\nconst data = {\n  numberOfChildren: $0.children.length,\n  numberOfSiblings: $0.parentElement.children.length,\n  hasPreviousSibling: !!$0.previousElementSibling,\n  hasNextSibling: !!$0.nextElementSibling,\n  elementStyles: {\n    display: computedStyles['display'],\n    visibility: computedStyles['visibility'],\n    position: computedStyles['position'],\n    clipPath: computedStyles['clip-path'],\n    zIndex: computedStyles['z-index']\n  },\n  parentStyles: {\n    display: parentComputedStyles['display'],\n    visibility: parentComputedStyles['visibility'],\n    position: parentComputedStyles['position'],\n    clipPath: parentComputedStyles['clip-path'],\n    zIndex: parentComputedStyles['z-index']\n  },\n  overlappingElements: Array.from(document.querySelectorAll('*'))\n    .filter(el => {\n      const rect = el.getBoundingClientRect();\n      const popupRect = $0.getBoundingClientRect();\n      return (\n        el !== $0 &&\n        rect.left < popupRect.right &&\n        rect.right > popupRect.left &&\n        rect.top < popupRect.bottom &&\n        rect.bottom > popupRect.top\n      );\n    })\n    .map(el => ({\n      tagName: el.tagName,\n      id: el.id,\n      className: el.className,\n      zIndex: window.getComputedStyle(el)['z-index']\n    }))\n};\nSTOP\n\nOBSERVATION: {\"elementStyles\":{\"display\":\"block\",\"visibility\":\"visible\",\"position\":\"absolute\",\"zIndex\":\"3\",\"opacity\":\"1\"},\"parentStyles\":{\"display\":\"block\",\"visibility\":\"visible\",\"position\":\"relative\",\"zIndex\":\"1\",\"opacity\":\"1\"},\"overlappingElements\":[{\"tagName\":\"HTML\",\"id\":\"\",\"className\":\"\",\"zIndex\":\"auto\"},{\"tagName\":\"BODY\",\"id\":\"\",\"className\":\"\",\"zIndex\":\"auto\"},{\"tagName\":\"DIV\",\"id\":\"\",\"className\":\"container\",\"zIndex\":\"auto\"},{\"tagName\":\"DIV\",\"id\":\"\",\"className\":\"background\",\"zIndex\":\"2\"}]}\"\n\nANSWER: Even though the popup itself has a z-index of 3, its parent container has position: relative and z-index: 1. This creates a new stacking context for the popup. Because the \"background\" div has a z-index of 2, which is higher than the stacking context of the popup, it is rendered on top, obscuring the popup.\nFIXABLE: true\n`;\n/* clang-format on */\n\nexport const FIX_THIS_ISSUE_PROMPT = 'Fix this issue using JavaScript code execution';\n\nexport enum ResponseType {\n  TITLE = 'title',\n  THOUGHT = 'thought',\n  ACTION = 'action',\n  SIDE_EFFECT = 'side-effect',\n  ANSWER = 'answer',\n  ERROR = 'error',\n  QUERYING = 'querying',\n}\n\nexport interface AnswerResponse {\n  type: ResponseType.ANSWER;\n  text: string;\n  rpcId?: number;\n  fixable: boolean;\n}\n\nexport const enum ErrorType {\n  UNKNOWN = 'unknown',\n  ABORT = 'abort',\n  MAX_STEPS = 'max-steps',\n}\n\nexport interface ErrorResponse {\n  type: ResponseType.ERROR;\n  error: ErrorType;\n  rpcId?: number;\n}\n\nexport interface TitleResponse {\n  type: ResponseType.TITLE;\n  title: string;\n  rpcId?: number;\n}\n\nexport interface ThoughtResponse {\n  type: ResponseType.THOUGHT;\n  thought: string;\n  rpcId?: number;\n}\n\nexport interface SideEffectResponse {\n  type: ResponseType.SIDE_EFFECT;\n  code: string;\n  confirm: (confirm: boolean) => void;\n  rpcId?: number;\n}\n\nexport interface ActionResponse {\n  type: ResponseType.ACTION;\n  code: string;\n  output: string;\n  canceled: boolean;\n  rpcId?: number;\n}\n\nexport interface QueryResponse {\n  type: ResponseType.QUERYING;\n}\n\nexport type ResponseData =\n    AnswerResponse|ErrorResponse|ActionResponse|SideEffectResponse|ThoughtResponse|TitleResponse|QueryResponse;\n\nasync function executeJsCode(code: string, {throwOnSideEffect}: {throwOnSideEffect: boolean}): Promise<string> {\n  const selectedNode = UI.Context.Context.instance().flavor(SDK.DOMModel.DOMNode);\n  const target = selectedNode?.domModel().target() ?? UI.Context.Context.instance().flavor(SDK.Target.Target);\n\n  if (!target) {\n    throw new Error('Target is not found for executing code');\n  }\n\n  const resourceTreeModel = target.model(SDK.ResourceTreeModel.ResourceTreeModel);\n  const frameId = selectedNode?.frameId() ?? resourceTreeModel?.mainFrame?.id;\n\n  if (!frameId) {\n    throw new Error('Main frame is not found for executing code');\n  }\n\n  const runtimeModel = target.model(SDK.RuntimeModel.RuntimeModel);\n  const pageAgent = target.pageAgent();\n\n  // This returns previously created world if it exists for the frame.\n  const {executionContextId} = await pageAgent.invoke_createIsolatedWorld({frameId, worldName: FREESTYLER_WORLD_NAME});\n  const executionContext = runtimeModel?.executionContext(executionContextId);\n  if (!executionContext) {\n    throw new Error('Execution context is not found for executing code');\n  }\n\n  try {\n    return await FreestylerEvaluateAction.execute(code, executionContext, {throwOnSideEffect});\n  } catch (err) {\n    if (err instanceof ExecutionError) {\n      return `Error: ${err.message}`;\n    }\n\n    throw err;\n  }\n}\n\ntype HistoryChunk = {\n  text: string,\n  entity: Host.AidaClient.Entity,\n};\n\nconst MAX_STEPS = 10;\nconst MAX_OBSERVATION_BYTE_LENGTH = 25_000;\n\ntype CreateExtensionScopeFunction = (changes: ChangeManager) => {\n  install(): Promise<void>, uninstall(): Promise<void>,\n};\n\ntype AgentOptions = {\n  aidaClient: Host.AidaClient.AidaClient,\n  changeManager?: ChangeManager,\n  confirmSideEffectForTest?: typeof Promise.withResolvers,\n  serverSideLoggingEnabled?: boolean,\n  createExtensionScope?: CreateExtensionScopeFunction,\n  execJs?: typeof executeJsCode,\n};\n\ninterface AidaRequestOptions {\n  input: string;\n  preamble?: string;\n  chatHistory?: Host.AidaClient.Chunk[];\n  /**\n   * @default false\n   */\n  serverSideLoggingEnabled?: boolean;\n  sessionId?: string;\n}\n\n/**\n * One agent instance handles one conversation. Create a new agent\n * instance for a new conversation.\n */\nexport class FreestylerAgent {\n  static buildRequest(opts: AidaRequestOptions): Host.AidaClient.AidaRequest {\n    const config = Common.Settings.Settings.instance().getHostConfig();\n    const request: Host.AidaClient.AidaRequest = {\n      input: opts.input,\n      preamble: opts.preamble,\n      // eslint-disable-next-line @typescript-eslint/naming-convention\n      chat_history: opts.chatHistory,\n      client: Host.AidaClient.CLIENT_NAME,\n      options: {\n        temperature: config.devToolsFreestylerDogfood?.temperature ?? 0,\n        model_id: config.devToolsFreestylerDogfood?.modelId ?? undefined,\n      },\n      metadata: {\n        // TODO: disable logging based on query params.\n        disable_user_content_logging: !(opts.serverSideLoggingEnabled ?? false),\n        string_session_id: opts.sessionId,\n        user_tier: Host.AidaClient.convertToUserTierEnum(config.devToolsFreestylerDogfood?.userTier),\n      },\n      // eslint-disable-next-line @typescript-eslint/naming-convention\n      functionality_type: Host.AidaClient.FunctionalityType.CHAT,\n      // eslint-disable-next-line @typescript-eslint/naming-convention\n      client_feature: Host.AidaClient.ClientFeature.CHROME_FREESTYLER,\n    };\n    return request;\n  }\n\n  static parseResponse(response: string):\n      {thought?: string, title?: string, action?: string, answer?: string, fixable: boolean} {\n    const lines = response.split('\\n');\n    let thought: string|undefined;\n    let title: string|undefined;\n    let action: string|undefined;\n    let answer: string|undefined;\n    let fixable = false;\n    let i = 0;\n    const isInstructionStart = (line: string): boolean => {\n      const trimmed = line.trim();\n      return trimmed.startsWith('THOUGHT:') || trimmed.startsWith('OBSERVATION:') || trimmed.startsWith('TITLE:') ||\n          trimmed.startsWith('ACTION') || trimmed.startsWith('ANSWER:') || trimmed.startsWith('FIXABLE:');\n    };\n    while (i < lines.length) {\n      const trimmed = lines[i].trim();\n      if (trimmed.startsWith('THOUGHT:') && !thought) {\n        // TODO: multiline thoughts.\n        thought = trimmed.substring('THOUGHT:'.length).trim();\n        i++;\n      } else if (trimmed.startsWith('TITLE:')) {\n        title = trimmed.substring('TITLE:'.length).trim();\n        i++;\n      } else if (trimmed.startsWith('ACTION') && !action) {\n        const actionLines = [];\n        i++;\n        while (i < lines.length) {\n          if (lines[i].trim() === 'STOP') {\n            i++;\n            break;\n          }\n          if (isInstructionStart(lines[i])) {\n            break;\n          }\n          // Sometimes the code block is in the form of \"`````\\njs\\n{code}`````\"\n          if (lines[i].trim() !== 'js') {\n            actionLines.push(lines[i]);\n          }\n          i++;\n        }\n        // TODO: perhaps trying to parse with a Markdown parser would\n        // yield more reliable results.\n        action = actionLines.join('\\n').replaceAll('```', '').replaceAll('``', '').trim();\n      } else if (trimmed.startsWith('ANSWER:') && !answer) {\n        const answerLines = [\n          trimmed.substring('ANSWER:'.length).trim(),\n        ];\n        let j = i + 1;\n        while (j < lines.length) {\n          const line = lines[j].trim();\n          if (isInstructionStart(line)) {\n            break;\n          }\n          answerLines.push(lines[j]);\n          j++;\n        }\n        answer = answerLines.join('\\n').trim();\n        i = j;\n      } else if (trimmed.startsWith('FIXABLE: true')) {\n        fixable = true;\n        i++;\n      } else {\n        i++;\n      }\n    }\n    // If we could not parse the parts, consider the response to be an\n    // answer.\n    if (!answer && !thought && !action) {\n      answer = response;\n    }\n    return {thought, title, action, answer, fixable};\n  }\n\n  #aidaClient: Host.AidaClient.AidaClient;\n  #chatHistory: Map<number, HistoryChunk[]> = new Map();\n  #serverSideLoggingEnabled: boolean;\n\n  #execJs: typeof executeJsCode;\n\n  #confirmSideEffect: typeof Promise.withResolvers;\n  readonly #sessionId = crypto.randomUUID();\n  #changes: ChangeManager;\n  #createExtensionScope: CreateExtensionScopeFunction;\n\n  constructor(opts: AgentOptions) {\n    this.#aidaClient = opts.aidaClient;\n    this.#changes = opts.changeManager || new ChangeManager();\n    this.#execJs = opts.execJs ?? executeJsCode;\n    this.#createExtensionScope = opts.createExtensionScope ?? ((changes: ChangeManager) => {\n                                   return new ExtensionScope(changes);\n                                 });\n    this.#serverSideLoggingEnabled = opts.serverSideLoggingEnabled ?? false;\n    this.#confirmSideEffect = opts.confirmSideEffectForTest ?? (() => Promise.withResolvers());\n    SDK.TargetManager.TargetManager.instance().addModelListener(\n        SDK.ResourceTreeModel.ResourceTreeModel, SDK.ResourceTreeModel.Events.PrimaryPageChanged,\n        this.onPrimaryPageChanged, this);\n  }\n\n  onPrimaryPageChanged(): void {\n    void this.#changes.clear();\n  }\n\n  get #getHistoryEntry(): Array<HistoryChunk> {\n    return [...this.#chatHistory.values()].flat();\n  }\n\n  get chatHistoryForTesting(): Array<HistoryChunk> {\n    return this.#getHistoryEntry;\n  }\n\n  async #aidaFetch(\n      request: Host.AidaClient.AidaRequest,\n      options?: {signal?: AbortSignal},\n      ): Promise<{\n    response: string,\n    rpcId: number|undefined,\n    rawResponse: Host.AidaClient.AidaResponse|undefined,\n  }> {\n    let rawResponse: Host.AidaClient.AidaResponse|undefined = undefined;\n    let response = '';\n    let rpcId;\n    for await (rawResponse of this.#aidaClient.fetch(request, options)) {\n      response = rawResponse.explanation;\n      rpcId = rawResponse.metadata.rpcGlobalId ?? rpcId;\n      if (rawResponse.metadata.attributionMetadata?.some(\n              meta => meta.attributionAction === Host.AidaClient.RecitationAction.BLOCK)) {\n        throw new Error('Attribution action does not allow providing the response');\n      }\n    }\n\n    return {response, rpcId, rawResponse};\n  }\n\n  async #generateObservation(\n      action: string,\n      {\n        throwOnSideEffect,\n        confirmExecJs: confirm,\n      }: {\n        throwOnSideEffect: boolean,\n        confirmExecJs?: Promise<boolean>,\n      },\n      ): Promise<{\n    observation: string,\n    sideEffect: boolean,\n    canceled: boolean,\n  }> {\n    const actionExpression = `{\n      const scope = {$0, $1, getEventListeners};\n      with (scope) {\n        ${action}\n        ;((typeof data !== \"undefined\") ? data : undefined)\n      }\n    }`;\n    try {\n      const runConfirmed = await confirm ?? Promise.resolve(true);\n      if (!runConfirmed) {\n        return {\n          observation: 'Error: User denied code execution with side effects.',\n          sideEffect: false,\n          canceled: true,\n        };\n      }\n      const result = await this.#execJs(\n          actionExpression,\n          {throwOnSideEffect},\n      );\n      const byteCount = Platform.StringUtilities.countWtf8Bytes(result);\n      if (byteCount > MAX_OBSERVATION_BYTE_LENGTH) {\n        throw new Error('Output exceeded the maximum allowed length.');\n      }\n      return {\n        observation: result,\n        sideEffect: false,\n        canceled: false,\n      };\n    } catch (error) {\n      if (error instanceof SideEffectError) {\n        return {\n          observation: error.message,\n          sideEffect: true,\n          canceled: false,\n        };\n      }\n\n      return {\n        observation: `Error: ${error.message}`,\n        sideEffect: false,\n        canceled: false,\n      };\n    }\n  }\n\n  static async describeElement(element: SDK.DOMModel.DOMNode): Promise<string> {\n    let output = `* Its selector is \\`${element.simpleSelector()}\\``;\n    const childNodes = await element.getChildNodesPromise();\n    if (childNodes) {\n      const textChildNodes = childNodes.filter(childNode => childNode.nodeType() === Node.TEXT_NODE);\n      const elementChildNodes = childNodes.filter(childNode => childNode.nodeType() === Node.ELEMENT_NODE);\n      switch (elementChildNodes.length) {\n        case 0:\n          output += '\\n* It doesn\\'t have any child element nodes';\n          break;\n        case 1:\n          output += `\\n* It only has 1 child element node: \\`${elementChildNodes[0].simpleSelector()}\\``;\n          break;\n        default:\n          output += `\\n* It has ${elementChildNodes.length} child element nodes: ${\n              elementChildNodes.map(node => `\\`${node.simpleSelector()}\\``).join(', ')}`;\n      }\n\n      switch (textChildNodes.length) {\n        case 0:\n          output += '\\n* It doesn\\'t have any child text nodes';\n          break;\n        case 1:\n          output += '\\n* It only has 1 child text node';\n          break;\n        default:\n          output += `\\n* It has ${textChildNodes.length} child text nodes`;\n      }\n    }\n\n    if (element.nextSibling) {\n      const elementOrNodeElementNodeText =\n          element.nextSibling.nodeType() === Node.ELEMENT_NODE ? 'an element' : 'a non element';\n      output += `\\n* It has a next sibling and it is ${elementOrNodeElementNodeText} node`;\n    }\n\n    if (element.previousSibling) {\n      const elementOrNodeElementNodeText =\n          element.previousSibling.nodeType() === Node.ELEMENT_NODE ? 'an element' : 'a non element';\n      output += `\\n* It has a previous sibling and it is ${elementOrNodeElementNodeText} node`;\n    }\n\n    const parentNode = element.parentNode;\n    if (parentNode) {\n      const parentChildrenNodes = await parentNode.getChildNodesPromise();\n      output += `\\n* Its parent's selector is \\`${parentNode.simpleSelector()}\\``;\n      if (parentChildrenNodes) {\n        const childElementNodes =\n            parentChildrenNodes.filter(siblingNode => siblingNode.nodeType() === Node.ELEMENT_NODE);\n        switch (childElementNodes.length) {\n          case 0:\n            break;\n          case 1:\n            output += '\\n* Its parent has only 1 child element node';\n            break;\n          default:\n            output += `\\n* Its parent has ${childElementNodes.length} child element nodes: ${\n                childElementNodes.map(node => `\\`${node.simpleSelector()}\\``).join(', ')}`;\n            break;\n        }\n\n        const siblingTextNodes = parentChildrenNodes.filter(siblingNode => siblingNode.nodeType() === Node.TEXT_NODE);\n        switch (siblingTextNodes.length) {\n          case 0:\n            break;\n          case 1:\n            output += '\\n* Its parent has only 1 child text node';\n            break;\n          default:\n            output += `\\n* Its parent has ${siblingTextNodes.length} child text nodes: ${\n                siblingTextNodes.map(node => `\\`${node.simpleSelector()}\\``).join(', ')}`;\n            break;\n        }\n      }\n    }\n\n    return output;\n  }\n\n  #runId = 0;\n  async * run(query: string, options: {\n    signal?: AbortSignal, selectedElement: SDK.DOMModel.DOMNode|null, isFixQuery: boolean,\n  }): AsyncGenerator<ResponseData, void, void> {\n    const structuredLog = [];\n    const elementEnchantmentQuery = options.selectedElement ?\n        `# Inspected element\\n\\n${\n            await FreestylerAgent.describeElement(options.selectedElement)}\\n\\n# User request\\n\\n` :\n        '';\n    query = `${elementEnchantmentQuery}QUERY: ${query}`;\n    const currentRunId = ++this.#runId;\n\n    options.signal?.addEventListener('abort', () => {\n      this.#chatHistory.delete(currentRunId);\n    });\n\n    for (let i = 0; i < MAX_STEPS; i++) {\n      yield {\n        type: ResponseType.QUERYING,\n      };\n\n      const request = FreestylerAgent.buildRequest({\n        input: query,\n        preamble,\n        chatHistory: this.#chatHistory.size ? this.#getHistoryEntry : undefined,\n        serverSideLoggingEnabled: this.#serverSideLoggingEnabled,\n        sessionId: this.#sessionId,\n      });\n      let response: string;\n      let rpcId: number|undefined;\n      let rawResponse: Host.AidaClient.AidaResponse|undefined;\n      try {\n        const fetchResult = await this.#aidaFetch(\n            request,\n            {signal: options.signal},\n        );\n        response = fetchResult.response;\n        rpcId = fetchResult.rpcId;\n        rawResponse = fetchResult.rawResponse;\n      } catch (err) {\n        debugLog('Error calling the AIDA API', err);\n\n        if (err instanceof Host.AidaClient.AidaAbortError) {\n          yield {\n            type: ResponseType.ERROR,\n            error: ErrorType.ABORT,\n            rpcId,\n          };\n          break;\n        }\n\n        yield {\n          type: ResponseType.ERROR,\n          error: ErrorType.UNKNOWN,\n          rpcId,\n        };\n        break;\n      }\n\n      if (options.signal?.aborted) {\n        break;\n      }\n\n      debugLog({\n        iteration: i,\n        request,\n        response: rawResponse,\n      });\n\n      structuredLog.push({\n        request: structuredClone(request),\n        response,\n      });\n\n      const addToHistory = (text: string): void => {\n        this.#chatHistory.set(currentRunId, [\n          ...currentRunEntries,\n          {\n            text: query,\n            entity: Host.AidaClient.Entity.USER,\n          },\n          {\n            text,\n            entity: Host.AidaClient.Entity.SYSTEM,\n          },\n        ]);\n      };\n      const currentRunEntries = this.#chatHistory.get(currentRunId) ?? [];\n      const {thought, title, action, answer, fixable} = FreestylerAgent.parseResponse(response);\n      // Sometimes the answer will follow an action and a thought. In\n      // that case, we only use the action and the thought (if present)\n      // since the answer is not based on the observation resulted from\n      // the action.\n      if (action) {\n        if (title) {\n          yield {\n            type: ResponseType.TITLE,\n            title,\n            rpcId,\n          };\n        }\n\n        if (thought) {\n          addToHistory(`THOUGHT: ${thought}\nTITLE: ${title}\nACTION\n${action}\nSTOP`);\n          yield {\n            type: ResponseType.THOUGHT,\n            thought,\n            rpcId,\n          };\n        } else {\n          addToHistory(`ACTION\n${action}\nSTOP`);\n        }\n        debugLog(`Action to execute: ${action}`);\n        const scope = this.#createExtensionScope(this.#changes);\n        await scope.install();\n        try {\n          let result = await this.#generateObservation(action, {throwOnSideEffect: !options.isFixQuery});\n          debugLog(`Action result: ${JSON.stringify(result)}`);\n          if (result.sideEffect) {\n            const sideEffectConfirmationPromiseWithResolvers = this.#confirmSideEffect<boolean>();\n            if (isDebugMode()) {\n              window.dispatchEvent(new CustomEvent(\n                  'freestylersideeffect', {detail: {confirm: sideEffectConfirmationPromiseWithResolvers.resolve}}));\n            }\n\n            yield {\n              type: ResponseType.SIDE_EFFECT,\n              code: action,\n              confirm: sideEffectConfirmationPromiseWithResolvers.resolve,\n              rpcId,\n            };\n\n            result = await this.#generateObservation(action, {\n              throwOnSideEffect: false,\n              confirmExecJs: sideEffectConfirmationPromiseWithResolvers.promise,\n            });\n          }\n          yield {\n            type: ResponseType.ACTION,\n            code: action,\n            output: result.observation,\n            canceled: result.canceled,\n            rpcId,\n          };\n\n          query = `OBSERVATION: ${result.observation}`;\n        } finally {\n          await scope.uninstall();\n        }\n      } else if (answer) {\n        addToHistory(`ANSWER: ${answer}`);\n        yield {\n          type: ResponseType.ANSWER,\n          text: answer,\n          rpcId,\n          fixable,\n        };\n        break;\n      } else {\n        addToHistory(response);\n        yield {\n          type: ResponseType.ERROR,\n          error: ErrorType.UNKNOWN,\n          rpcId,\n        };\n        break;\n      }\n\n      if (i === MAX_STEPS - 1) {\n        yield {\n          type: ResponseType.ERROR,\n          error: ErrorType.MAX_STEPS,\n        };\n        break;\n      }\n    }\n    if (isDebugMode()) {\n      localStorage.setItem('freestylerStructuredLog', JSON.stringify(structuredLog));\n      window.dispatchEvent(new CustomEvent('freestylerdone'));\n    }\n  }\n}\n\nfunction isDebugMode(): boolean {\n  return Boolean(localStorage.getItem('debugFreestylerEnabled'));\n}\n\nfunction debugLog(...log: unknown[]): void {\n  if (!isDebugMode()) {\n    return;\n  }\n\n  // eslint-disable-next-line no-console\n  console.log(...log);\n}\n\nfunction setDebugFreestylerEnabled(enabled: boolean): void {\n  if (enabled) {\n    localStorage.setItem('debugFreestylerEnabled', 'true');\n  } else {\n    localStorage.removeItem('debugFreestylerEnabled');\n  }\n}\n\n// @ts-ignore\nglobalThis.setDebugFreestylerEnabled = setDebugFreestylerEnabled;\n"]}