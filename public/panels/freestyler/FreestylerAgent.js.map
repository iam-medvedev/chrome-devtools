{"version":3,"file":"FreestylerAgent.js","sourceRoot":"","sources":["../../../../../../front_end/panels/freestyler/FreestylerAgent.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../core/common/common.js';\nimport * as Host from '../../core/host/host.js';\nimport * as SDK from '../../core/sdk/sdk.js';\nimport * as UI from '../../ui/legacy/legacy.js';\n\nimport {ExecutionError, FreestylerEvaluateAction} from './FreestylerEvaluateAction.js';\n\nconst preamble = `You are a CSS debugging agent integrated into Chrome DevTools.\nYou are going to receive a query about the CSS on the page and you are going to answer to this query in these steps:\n* THOUGHT\n* ACTION\n* ANSWER\nUse ACTION to evaluate JS code (without markdown) on the page to gather all the data needed to answer the query and put it inside the data variable - then return STOP.\nOBSERVATION will be the result of running the JS code on the page.\nYou can then answer the question with ANSWER or run another ACTION query.\nPlease run ACTION again if the information you got is not enough to answer the query.\n\nExample:\nACTION\nconst data = {\n  hoverStyles: window.getComputedStyle($0, 'hover') // USING 'hover' NOT ':hover'\n}\nSTOP\n\nYou have access to $0 variable to denote the currently inspected element while executing JS code.\n\nExample session:\nQUERY: Why is this element centered in its container?\nTHOUGHT: Let's check the layout properties of the container.\nACTION\n/* COLLECT_INFORMATION_HERE */\nconst data = {\n  /* THE RESULT YOU ARE GOING TO USE AS INFORMATION */\n}\nSTOP\n\nYou will be called again with this:\nOBSERVATION\n/* OBJECT_CONTAINING_YOUR_DATA */\n\nYou then output:\nANSWER: The element is centered on the page because the parent is a flex container with justify-content set to center.\n\nPlease answer only if you are sure about the answer. Otherwise, explain why you're not able to answer.`;\n\nexport enum Step {\n  THOUGHT = 'thought',\n  ACTION = 'action',\n  ANSWER = 'answer',\n  ERROR = 'error',\n}\n\nexport type StepData = {\n  step: Step.THOUGHT|Step.ANSWER|Step.ERROR,\n  text: string,\n  rpcId?: number,\n}|{\n  step: Step.ACTION,\n  code: string,\n  output: string,\n  rpcId?: number,\n};\n\nasync function executeJsCode(code: string): Promise<string> {\n  const target = UI.Context.Context.instance().flavor(SDK.Target.Target);\n  if (!target) {\n    throw new Error('Target is not found for executing code');\n  }\n\n  const resourceTreeModel = target.model(SDK.ResourceTreeModel.ResourceTreeModel);\n  const runtimeModel = target.model(SDK.RuntimeModel.RuntimeModel);\n  const pageAgent = target.pageAgent();\n  if (!resourceTreeModel?.mainFrame) {\n    throw new Error('Main frame is not found for executing code');\n  }\n\n  // This returns previously created world if it exists for the frame.\n  const {executionContextId} = await pageAgent.invoke_createIsolatedWorld(\n      {frameId: resourceTreeModel.mainFrame.id, worldName: 'devtools_freestyler'});\n  const executionContext = runtimeModel?.executionContext(executionContextId);\n  if (!executionContext) {\n    throw new Error('Execution context is not found for executing code');\n  }\n\n  try {\n    return await FreestylerEvaluateAction.execute(code, executionContext);\n  } catch (err) {\n    if (err instanceof ExecutionError) {\n      return `Error: ${err.message}`;\n    }\n\n    throw err;\n  }\n}\n\ntype HistoryChunk = {\n  text: string,\n  entity: Host.AidaClient.Entity,\n};\n\nconst MAX_STEPS = 5;\nexport class FreestylerAgent {\n  #aidaClient: Host.AidaClient.AidaClient;\n  #chatHistory: Array<HistoryChunk> = [];\n  #execJs: typeof executeJsCode;\n\n  constructor({aidaClient, execJs}: {aidaClient: Host.AidaClient.AidaClient, execJs?: typeof executeJsCode}) {\n    this.#aidaClient = aidaClient;\n    this.#execJs = execJs ?? executeJsCode;\n  }\n\n  static buildRequest(input: string, preamble?: string, chatHistory?: Host.AidaClient.Chunk[]):\n      Host.AidaClient.AidaRequest {\n    const config = Common.Settings.Settings.instance().getHostConfig();\n    const request: Host.AidaClient.AidaRequest = {\n      input,\n      preamble,\n      // eslint-disable-next-line @typescript-eslint/naming-convention\n      chat_history: chatHistory,\n      client: 'CHROME_DEVTOOLS',\n      options: {\n        temperature: config?.devToolsFreestylerDogfood.aidaTemperature ?? 0,\n        model_id: config?.devToolsFreestylerDogfood.aidaModelId ?? undefined,\n      },\n      metadata: {\n        // TODO: enable logging later.\n        disable_user_content_logging: true,\n      },\n    };\n    return request;\n  }\n\n  get chatHistoryForTesting(): Array<HistoryChunk> {\n    return this.#chatHistory;\n  }\n\n  static parseResponse(response: string): {thought?: string, action?: string, answer?: string} {\n    const lines = response.split('\\n');\n    let thought: string|undefined;\n    let action: string|undefined;\n    let answer: string|undefined;\n    let i = 0;\n    while (i < lines.length) {\n      const trimmed = lines[i].trim();\n      if (trimmed.startsWith('THOUGHT:') && !thought) {\n        // TODO: multiline thoughts.\n        thought = trimmed.substring('THOUGHT:'.length).trim();\n        i++;\n      } else if (trimmed.startsWith('ACTION') && !action) {\n        const actionLines = [];\n        let j = i + 1;\n        while (j < lines.length && lines[j].trim() !== 'STOP') {\n          // Sometimes the code block is in the form of \"`````\\njs\\n{code}`````\"\n          if (lines[j].trim() !== 'js') {\n            actionLines.push(lines[j]);\n          }\n          j++;\n        }\n        // TODO: perhaps trying to parse with a Markdown parser would\n        // yield more reliable results.\n        action = actionLines.join('\\n').replaceAll('```', '').replaceAll('``', '').trim();\n        i = j + 1;\n      } else if (trimmed.startsWith('ANSWER:') && !answer) {\n        const answerLines = [\n          trimmed.substring('ANSWER:'.length).trim(),\n        ];\n        let j = i + 1;\n        while (j < lines.length) {\n          const line = lines[j].trim();\n          if (line.startsWith('ACTION') || line.startsWith('OBSERVATION:') || line.startsWith('THOUGHT:')) {\n            break;\n          }\n          answerLines.push(lines[j]);\n          j++;\n        }\n        answer = answerLines.join('\\n').trim();\n        i = j;\n      } else {\n        i++;\n      }\n    }\n    return {thought, action, answer};\n  }\n\n  async #aidaFetch(request: Host.AidaClient.AidaRequest): Promise<{response: string, rpcId: number|undefined}> {\n    let response = '';\n    let rpcId;\n    for await (const lastResult of this.#aidaClient.fetch(request)) {\n      response = lastResult.explanation;\n      rpcId = lastResult.metadata.rpcGlobalId ?? rpcId;\n    }\n\n    return {response, rpcId};\n  }\n\n  resetHistory(): void {\n    this.#chatHistory = [];\n  }\n\n  async * run(query: string): AsyncGenerator<StepData, void, void> {\n    const structuredLog = [];\n    query = `QUERY: ${query}`;\n    for (let i = 0; i < MAX_STEPS; i++) {\n      const request =\n          FreestylerAgent.buildRequest(query, preamble, this.#chatHistory.length ? this.#chatHistory : undefined);\n      let response: string;\n      let rpcId: number|undefined;\n      try {\n        const fetchResult = await this.#aidaFetch(request);\n        response = fetchResult.response;\n        rpcId = fetchResult.rpcId;\n      } catch (err) {\n        yield {step: Step.ERROR, text: err.message, rpcId};\n        break;\n      }\n\n      debugLog(`Iteration: ${i}`, 'Request', request, 'Response', response);\n      structuredLog.push({\n        request: structuredClone(request),\n        response: response,\n      });\n\n      this.#chatHistory.push(\n          {\n            text: query,\n            entity: Host.AidaClient.Entity.USER,\n          },\n          {\n            text: response,\n            entity: Host.AidaClient.Entity.SYSTEM,\n          });\n\n      const {thought, action, answer} = FreestylerAgent.parseResponse(response);\n\n      if (!thought && !action && !answer) {\n        yield {step: Step.ANSWER, text: 'Sorry, I could not help you with this query.', rpcId};\n        break;\n      }\n\n      if (answer) {\n        yield {step: Step.ANSWER, text: answer, rpcId};\n        break;\n      }\n\n      if (thought) {\n        yield {step: Step.THOUGHT, text: thought, rpcId};\n      }\n\n      if (action) {\n        debugLog(`Action to execute: ${action}`);\n        const observation = await this.#execJs(`{${action};((typeof data !== \"undefined\") ? data : undefined)}`);\n        debugLog(`Action result: ${observation}`);\n        yield {step: Step.ACTION, code: action, output: observation, rpcId};\n        query = `OBSERVATION: ${observation}`;\n      }\n\n      if (i === MAX_STEPS - 1) {\n        yield {step: Step.ERROR, text: 'Max steps reached, please try again.'};\n      }\n    }\n    if (isDebugMode()) {\n      localStorage.setItem('freestylerStructuredLog', JSON.stringify(structuredLog));\n      window.dispatchEvent(new CustomEvent('freestylerdone'));\n    }\n  }\n}\n\nfunction isDebugMode(): boolean {\n  return Boolean(localStorage.getItem('debugFreestylerEnabled'));\n}\n\nfunction debugLog(...log: unknown[]): void {\n  if (!isDebugMode()) {\n    return;\n  }\n\n  // eslint-disable-next-line no-console\n  console.log(...log);\n}\n\nfunction setDebugFreestylerEnabled(enabled: boolean): void {\n  if (enabled) {\n    localStorage.setItem('debugFreestylerEnabled', 'true');\n  } else {\n    localStorage.removeItem('debugFreestylerEnabled');\n  }\n}\n\n// @ts-ignore\nglobalThis.setDebugFreestylerEnabled = setDebugFreestylerEnabled;\n"]}