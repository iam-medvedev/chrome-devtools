{"version":3,"file":"FreestylerAgent.js","sourceRoot":"","sources":["../../../../../../front_end/panels/freestyler/FreestylerAgent.ts"],"names":[],"mappings":"AAAA,4DAA4D;AAC5D,yEAAyE;AACzE,6BAA6B;AAE7B,OAAO,KAAK,MAAM,MAAM,6BAA6B,CAAC;AACtD,OAAO,KAAK,IAAI,MAAM,yBAAyB,CAAC;AAChD,OAAO,KAAK,QAAQ,MAAM,iCAAiC,CAAC;AAC5D,OAAO,KAAK,GAAG,MAAM,uBAAuB,CAAC;AAC7C,OAAO,KAAK,EAAE,MAAM,2BAA2B,CAAC;AAEhD,OAAO,EAAC,aAAa,EAAC,MAAM,oBAAoB,CAAC;AACjD,OAAO,EAAC,cAAc,EAAE,qBAAqB,EAAC,MAAM,qBAAqB,CAAC;AAC1E,OAAO,EAAC,cAAc,EAAE,wBAAwB,EAAE,eAAe,EAAC,MAAM,+BAA+B,CAAC;AAExG,MAAM,QAAQ,GAAG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;+BAiDc,CAAC;AAEhC,MAAM,CAAC,MAAM,qBAAqB,GAAG,gDAAgD,CAAC;AAEtF,MAAM,CAAN,IAAY,YAOX;AAPD,WAAY,YAAY;IACtB,mCAAmB,CAAA;IACnB,iCAAiB,CAAA;IACjB,2CAA2B,CAAA;IAC3B,iCAAiB,CAAA;IACjB,+BAAe,CAAA;IACf,qCAAqB,CAAA;AACvB,CAAC,EAPW,YAAY,KAAZ,YAAY,QAOvB;AA0CD,mEAAmE;AACnE,QAAQ;AACR,KAAK,UAAU,aAAa,CAAC,IAAY,EAAE,EAAC,iBAAiB,EAA+B;IAC1F,MAAM,MAAM,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC,MAAM,CAAC,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;IACvE,IAAI,CAAC,MAAM,EAAE,CAAC;QACZ,MAAM,IAAI,KAAK,CAAC,wCAAwC,CAAC,CAAC;IAC5D,CAAC;IAED,MAAM,iBAAiB,GAAG,MAAM,CAAC,KAAK,CAAC,GAAG,CAAC,iBAAiB,CAAC,iBAAiB,CAAC,CAAC;IAChF,MAAM,YAAY,GAAG,MAAM,CAAC,KAAK,CAAC,GAAG,CAAC,YAAY,CAAC,YAAY,CAAC,CAAC;IACjE,MAAM,SAAS,GAAG,MAAM,CAAC,SAAS,EAAE,CAAC;IACrC,IAAI,CAAC,iBAAiB,EAAE,SAAS,EAAE,CAAC;QAClC,MAAM,IAAI,KAAK,CAAC,4CAA4C,CAAC,CAAC;IAChE,CAAC;IAED,oEAAoE;IACpE,MAAM,EAAC,kBAAkB,EAAC,GAAG,MAAM,SAAS,CAAC,0BAA0B,CACnE,EAAC,OAAO,EAAE,iBAAiB,CAAC,SAAS,CAAC,EAAE,EAAE,SAAS,EAAE,qBAAqB,EAAC,CAAC,CAAC;IACjF,MAAM,gBAAgB,GAAG,YAAY,EAAE,gBAAgB,CAAC,kBAAkB,CAAC,CAAC;IAC5E,IAAI,CAAC,gBAAgB,EAAE,CAAC;QACtB,MAAM,IAAI,KAAK,CAAC,mDAAmD,CAAC,CAAC;IACvE,CAAC;IAED,IAAI,CAAC;QACH,OAAO,MAAM,wBAAwB,CAAC,OAAO,CAAC,IAAI,EAAE,gBAAgB,EAAE,EAAC,iBAAiB,EAAC,CAAC,CAAC;IAC7F,CAAC;IAAC,OAAO,GAAG,EAAE,CAAC;QACb,IAAI,GAAG,YAAY,cAAc,EAAE,CAAC;YAClC,OAAO,UAAU,GAAG,CAAC,OAAO,EAAE,CAAC;QACjC,CAAC;QAED,MAAM,GAAG,CAAC;IACZ,CAAC;AACH,CAAC;AAOD,MAAM,SAAS,GAAG,EAAE,CAAC;AACrB,MAAM,2BAA2B,GAAG,MAAM,CAAC;AA0B3C;;;GAGG;AACH,MAAM,OAAO,eAAe;IAC1B,MAAM,CAAC,YAAY,CAAC,IAAwB;QAC1C,MAAM,MAAM,GAAG,MAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC,QAAQ,EAAE,CAAC,aAAa,EAAE,CAAC;QACnE,MAAM,OAAO,GAAgC;YAC3C,KAAK,EAAE,IAAI,CAAC,KAAK;YACjB,QAAQ,EAAE,IAAI,CAAC,QAAQ;YACvB,gEAAgE;YAChE,YAAY,EAAE,IAAI,CAAC,WAAW;YAC9B,MAAM,EAAE,IAAI,CAAC,UAAU,CAAC,WAAW;YACnC,OAAO,EAAE;gBACP,WAAW,EAAE,MAAM,CAAC,yBAAyB,EAAE,WAAW,IAAI,CAAC;gBAC/D,QAAQ,EAAE,MAAM,CAAC,yBAAyB,EAAE,OAAO,IAAI,SAAS;aACjE;YACD,QAAQ,EAAE;gBACR,+CAA+C;gBAC/C,4BAA4B,EAAE,CAAC,CAAC,IAAI,CAAC,wBAAwB,IAAI,KAAK,CAAC;gBACvE,iBAAiB,EAAE,IAAI,CAAC,SAAS;aAClC;YACD,gEAAgE;YAChE,kBAAkB,EAAE,IAAI,CAAC,UAAU,CAAC,iBAAiB,CAAC,IAAI;YAC1D,gEAAgE;YAChE,cAAc,EAAE,IAAI,CAAC,UAAU,CAAC,aAAa,CAAC,iBAAiB;SAChE,CAAC;QACF,OAAO,OAAO,CAAC;IACjB,CAAC;IAED,MAAM,CAAC,aAAa,CAAC,QAAgB;QAEnC,MAAM,KAAK,GAAG,QAAQ,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;QACnC,IAAI,OAAyB,CAAC;QAC9B,IAAI,KAAuB,CAAC;QAC5B,IAAI,MAAwB,CAAC;QAC7B,IAAI,MAAwB,CAAC;QAC7B,IAAI,OAAO,GAAG,KAAK,CAAC;QACpB,IAAI,CAAC,GAAG,CAAC,CAAC;QACV,OAAO,CAAC,GAAG,KAAK,CAAC,MAAM,EAAE,CAAC;YACxB,MAAM,OAAO,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC,IAAI,EAAE,CAAC;YAChC,IAAI,OAAO,CAAC,UAAU,CAAC,UAAU,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC;gBAC/C,4BAA4B;gBAC5B,OAAO,GAAG,OAAO,CAAC,SAAS,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC,IAAI,EAAE,CAAC;gBACtD,CAAC,EAAE,CAAC;YACN,CAAC;iBAAM,IAAI,OAAO,CAAC,UAAU,CAAC,QAAQ,CAAC,EAAE,CAAC;gBACxC,KAAK,GAAG,OAAO,CAAC,SAAS,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,IAAI,EAAE,CAAC;gBAClD,CAAC,EAAE,CAAC;YACN,CAAC;iBAAM,IAAI,OAAO,CAAC,UAAU,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,EAAE,CAAC;gBACnD,MAAM,WAAW,GAAG,EAAE,CAAC;gBACvB,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;gBACd,OAAO,CAAC,GAAG,KAAK,CAAC,MAAM,IAAI,KAAK,CAAC,CAAC,CAAC,CAAC,IAAI,EAAE,KAAK,MAAM,EAAE,CAAC;oBACtD,sEAAsE;oBACtE,IAAI,KAAK,CAAC,CAAC,CAAC,CAAC,IAAI,EAAE,KAAK,IAAI,EAAE,CAAC;wBAC7B,WAAW,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC;oBAC7B,CAAC;oBACD,CAAC,EAAE,CAAC;gBACN,CAAC;gBACD,6DAA6D;gBAC7D,+BAA+B;gBAC/B,MAAM,GAAG,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,UAAU,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC,UAAU,CAAC,IAAI,EAAE,EAAE,CAAC,CAAC,IAAI,EAAE,CAAC;gBAClF,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;YACZ,CAAC;iBAAM,IAAI,OAAO,CAAC,UAAU,CAAC,SAAS,CAAC,IAAI,CAAC,MAAM,EAAE,CAAC;gBACpD,MAAM,WAAW,GAAG;oBAClB,OAAO,CAAC,SAAS,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC,IAAI,EAAE;iBAC3C,CAAC;gBACF,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;gBACd,OAAO,CAAC,GAAG,KAAK,CAAC,MAAM,EAAE,CAAC;oBACxB,MAAM,IAAI,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC,IAAI,EAAE,CAAC;oBAC7B,IAAI,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC,IAAI,IAAI,CAAC,UAAU,CAAC,cAAc,CAAC,IAAI,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC;wBAC3F,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC,EAAE,CAAC;wBAChC,MAAM;oBACR,CAAC;oBACD,WAAW,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC;oBAC3B,CAAC,EAAE,CAAC;gBACN,CAAC;gBACD,MAAM,GAAG,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,IAAI,EAAE,CAAC;gBACvC,CAAC,GAAG,CAAC,CAAC;YACR,CAAC;iBAAM,IAAI,OAAO,CAAC,UAAU,CAAC,eAAe,CAAC,EAAE,CAAC;gBAC/C,OAAO,GAAG,IAAI,CAAC;gBACf,CAAC,EAAE,CAAC;YACN,CAAC;iBAAM,CAAC;gBACN,CAAC,EAAE,CAAC;YACN,CAAC;QACH,CAAC;QACD,kEAAkE;QAClE,UAAU;QACV,IAAI,CAAC,MAAM,IAAI,CAAC,OAAO,IAAI,CAAC,MAAM,EAAE,CAAC;YACnC,MAAM,GAAG,QAAQ,CAAC;QACpB,CAAC;QACD,OAAO,EAAC,OAAO,EAAE,KAAK,EAAE,MAAM,EAAE,MAAM,EAAE,OAAO,EAAC,CAAC;IACnD,CAAC;IAED,WAAW,CAA6B;IACxC,YAAY,GAAgC,IAAI,GAAG,EAAE,CAAC;IACtD,yBAAyB,CAAU;IAEnC,OAAO,CAAuB;IAE9B,kBAAkB,CAA+B;IACxC,UAAU,GAAG,MAAM,CAAC,UAAU,EAAE,CAAC;IAC1C,QAAQ,CAAgB;IACxB,qBAAqB,CAA+B;IAEpD,YAAY,IAAkB;QAC5B,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC,UAAU,CAAC;QACnC,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,aAAa,IAAI,IAAI,aAAa,EAAE,CAAC;QAC1D,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC,MAAM,IAAI,aAAa,CAAC;QAC5C,IAAI,CAAC,qBAAqB,GAAG,IAAI,CAAC,oBAAoB,IAAI,CAAC,CAAC,OAAsB,EAAE,EAAE;YACvD,OAAO,IAAI,cAAc,CAAC,OAAO,CAAC,CAAC;QACrC,CAAC,CAAC,CAAC;QAChC,IAAI,CAAC,yBAAyB,GAAG,IAAI,CAAC,wBAAwB,IAAI,KAAK,CAAC;QACxE,IAAI,CAAC,kBAAkB,GAAG,IAAI,CAAC,wBAAwB,IAAI,CAAC,GAAG,EAAE,CAAC,OAAO,CAAC,aAAa,EAAE,CAAC,CAAC;QAC3F,GAAG,CAAC,aAAa,CAAC,aAAa,CAAC,QAAQ,EAAE,CAAC,gBAAgB,CACvD,GAAG,CAAC,iBAAiB,CAAC,iBAAiB,EAAE,GAAG,CAAC,iBAAiB,CAAC,MAAM,CAAC,kBAAkB,EACxF,IAAI,CAAC,oBAAoB,EAAE,IAAI,CAAC,CAAC;IACvC,CAAC;IAED,oBAAoB;QAClB,KAAK,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAC;IAC7B,CAAC;IAED,IAAI,gBAAgB;QAClB,OAAO,CAAC,GAAG,IAAI,CAAC,YAAY,CAAC,MAAM,EAAE,CAAC,CAAC,IAAI,EAAE,CAAC;IAChD,CAAC;IAED,IAAI,qBAAqB;QACvB,OAAO,IAAI,CAAC,gBAAgB,CAAC;IAC/B,CAAC;IAED,KAAK,CAAC,UAAU,CAAC,OAAoC;QACnD,IAAI,QAAQ,GAAG,EAAE,CAAC;QAClB,IAAI,KAAK,CAAC;QACV,IAAI,KAAK,EAAE,MAAM,UAAU,IAAI,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,OAAO,CAAC,EAAE,CAAC;YAC/D,QAAQ,GAAG,UAAU,CAAC,WAAW,CAAC;YAClC,KAAK,GAAG,UAAU,CAAC,QAAQ,CAAC,WAAW,IAAI,KAAK,CAAC;YACjD,IAAI,UAAU,CAAC,QAAQ,CAAC,mBAAmB,EAAE,IAAI,CACzC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,iBAAiB,KAAK,IAAI,CAAC,UAAU,CAAC,gBAAgB,CAAC,KAAK,CAAC,EAAE,CAAC;gBACnF,MAAM,IAAI,KAAK,CAAC,0DAA0D,CAAC,CAAC;YAC9E,CAAC;QACH,CAAC;QAED,OAAO,EAAC,QAAQ,EAAE,KAAK,EAAC,CAAC;IAC3B,CAAC;IAED,KAAK,CAAC,oBAAoB,CACtB,MAAc,EACd,EACE,iBAAiB,EACjB,aAAa,EAAE,OAAO,EACtB,mBAAmB,EAAE,gBAAgB,GAKtC;QAKH,MAAM,gBAAgB,GAAG,6DACrB,MAAM,uDAAuD,CAAC;QAClE,IAAI,CAAC;YACH,MAAM,YAAY,GAAG,MAAM,OAAO,IAAI,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;YAC5D,IAAI,CAAC,YAAY,EAAE,CAAC;gBAClB,MAAM,IAAI,KAAK,CAAC,gBAAgB,IAAI,+BAA+B,CAAC,CAAC;YACvE,CAAC;YACD,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,OAAO,CAC7B,gBAAgB,EAChB,EAAC,iBAAiB,EAAC,CACtB,CAAC;YACF,MAAM,SAAS,GAAG,QAAQ,CAAC,eAAe,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC;YAClE,IAAI,SAAS,GAAG,2BAA2B,EAAE,CAAC;gBAC5C,MAAM,IAAI,KAAK,CAAC,6CAA6C,CAAC,CAAC;YACjE,CAAC;YACD,OAAO;gBACL,WAAW,EAAE,MAAM;gBACnB,UAAU,EAAE,KAAK;aAClB,CAAC;QACJ,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,IAAI,KAAK,YAAY,eAAe,EAAE,CAAC;gBACrC,OAAO;oBACL,WAAW,EAAE,KAAK,CAAC,OAAO;oBAC1B,UAAU,EAAE,IAAI;iBACjB,CAAC;YACJ,CAAC;YAED,OAAO;gBACL,WAAW,EAAE,UAAU,KAAK,CAAC,OAAO,EAAE;gBACtC,UAAU,EAAE,KAAK;aAClB,CAAC;QACJ,CAAC;IACH,CAAC;IAED,MAAM,GAAG,CAAC,CAAC;IACX,KAAK,CAAC,CACF,GAAG,CAAC,KAAa,EAAE,UAAuD,EAAC,UAAU,EAAE,KAAK,EAAC;QAE/F,MAAM,mBAAmB,GAAG,8CAA8C,CAAC;QAC3E,MAAM,aAAa,GAAG,EAAE,CAAC;QACzB,KAAK,GAAG,UAAU,KAAK,EAAE,CAAC;QAC1B,MAAM,YAAY,GAAG,EAAE,IAAI,CAAC,MAAM,CAAC;QAEnC,OAAO,CAAC,MAAM,EAAE,gBAAgB,CAAC,OAAO,EAAE,GAAG,EAAE;YAC7C,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC;QACzC,CAAC,CAAC,CAAC;QAEH,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,SAAS,EAAE,CAAC,EAAE,EAAE,CAAC;YACnC,MAAM;gBACJ,IAAI,EAAE,YAAY,CAAC,QAAQ;aAC5B,CAAC;YAEF,MAAM,OAAO,GAAG,eAAe,CAAC,YAAY,CAAC;gBAC3C,KAAK,EAAE,KAAK;gBACZ,QAAQ;gBACR,WAAW,EAAE,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC,CAAC,SAAS;gBACvE,wBAAwB,EAAE,IAAI,CAAC,yBAAyB;gBACxD,SAAS,EAAE,IAAI,CAAC,UAAU;aAC3B,CAAC,CAAC;YACH,IAAI,QAAgB,CAAC;YACrB,IAAI,KAAuB,CAAC;YAC5B,IAAI,CAAC;gBACH,MAAM,WAAW,GAAG,MAAM,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,CAAC;gBACnD,QAAQ,GAAG,WAAW,CAAC,QAAQ,CAAC;gBAChC,KAAK,GAAG,WAAW,CAAC,KAAK,CAAC;YAC5B,CAAC;YAAC,OAAO,GAAG,EAAE,CAAC;gBACb,QAAQ,CAAC,4BAA4B,EAAE,GAAG,CAAC,CAAC;gBAE5C,IAAI,OAAO,CAAC,MAAM,EAAE,OAAO,EAAE,CAAC;oBAC5B,MAAM;gBACR,CAAC;gBAED,MAAM;oBACJ,IAAI,EAAE,YAAY,CAAC,KAAK;oBACxB,KAAK,EAAE,mBAAmB;oBAC1B,KAAK;iBACN,CAAC;gBACF,MAAM;YACR,CAAC;YAED,IAAI,OAAO,CAAC,MAAM,EAAE,OAAO,EAAE,CAAC;gBAC5B,MAAM;YACR,CAAC;YAED,QAAQ,CAAC,cAAc,CAAC,EAAE,EAAE,SAAS,EAAE,OAAO,EAAE,UAAU,EAAE,QAAQ,CAAC,CAAC;YACtE,aAAa,CAAC,IAAI,CAAC;gBACjB,OAAO,EAAE,eAAe,CAAC,OAAO,CAAC;gBACjC,QAAQ,EAAE,QAAQ;aACnB,CAAC,CAAC;YACH,MAAM,iBAAiB,GAAG,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,YAAY,CAAC,IAAI,EAAE,CAAC;YACpE,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,YAAY,EAAE;gBAClC,GAAG,iBAAiB;gBACpB;oBACE,IAAI,EAAE,KAAK;oBACX,MAAM,EAAE,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,IAAI;iBACpC;gBACD;oBACE,IAAI,EAAE,QAAQ;oBACd,MAAM,EAAE,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,MAAM;iBACtC;aACF,CAAC,CAAC;YAEH,MAAM,EAAC,OAAO,EAAE,KAAK,EAAE,MAAM,EAAE,MAAM,EAAE,OAAO,EAAC,GAAG,eAAe,CAAC,aAAa,CAAC,QAAQ,CAAC,CAAC;YAC1F,+DAA+D;YAC/D,iEAAiE;YACjE,iEAAiE;YACjE,cAAc;YACd,IAAI,MAAM,EAAE,CAAC;gBACX,IAAI,OAAO,EAAE,CAAC;oBACZ,MAAM;wBACJ,IAAI,EAAE,YAAY,CAAC,OAAO;wBAC1B,OAAO;wBACP,KAAK;wBACL,KAAK;qBACN,CAAC;gBACJ,CAAC;gBACD,QAAQ,CAAC,sBAAsB,MAAM,EAAE,CAAC,CAAC;gBACzC,MAAM,KAAK,GAAG,IAAI,CAAC,qBAAqB,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;gBACxD,MAAM,KAAK,CAAC,OAAO,EAAE,CAAC;gBACtB,IAAI,CAAC;oBACH,IAAI,MAAM,GAAG,MAAM,IAAI,CAAC,oBAAoB,CAAC,MAAM,EAAE,EAAC,iBAAiB,EAAE,CAAC,OAAO,CAAC,UAAU,EAAC,CAAC,CAAC;oBAC/F,QAAQ,CAAC,kBAAkB,MAAM,EAAE,CAAC,CAAC;oBACrC,IAAI,MAAM,CAAC,UAAU,EAAE,CAAC;wBACtB,MAAM,0CAA0C,GAAG,IAAI,CAAC,kBAAkB,EAAW,CAAC;wBAEtF,MAAM;4BACJ,IAAI,EAAE,YAAY,CAAC,WAAW;4BAC9B,IAAI,EAAE,MAAM;4BACZ,OAAO,EAAE,0CAA0C,CAAC,OAAO;4BAC3D,KAAK;yBACN,CAAC;wBAEF,MAAM,GAAG,MAAM,IAAI,CAAC,oBAAoB,CAAC,MAAM,EAAE;4BAC/C,iBAAiB,EAAE,KAAK;4BACxB,aAAa,EAAE,0CAA0C,CAAC,OAAO;4BACjE,mBAAmB,EAAE,MAAM,CAAC,WAAW;yBACxC,CAAC,CAAC;oBACL,CAAC;oBACD,MAAM;wBACJ,IAAI,EAAE,YAAY,CAAC,MAAM;wBACzB,IAAI,EAAE,MAAM;wBACZ,MAAM,EAAE,MAAM,CAAC,WAAW;wBAC1B,KAAK;qBACN,CAAC;oBAEF,KAAK,GAAG,gBAAgB,MAAM,CAAC,WAAW,EAAE,CAAC;gBAC/C,CAAC;wBAAS,CAAC;oBACT,MAAM,KAAK,CAAC,SAAS,EAAE,CAAC;gBAC1B,CAAC;YACH,CAAC;iBAAM,IAAI,MAAM,EAAE,CAAC;gBAClB,MAAM;oBACJ,IAAI,EAAE,YAAY,CAAC,MAAM;oBACzB,IAAI,EAAE,MAAM;oBACZ,KAAK;oBACL,OAAO;iBACR,CAAC;gBACF,MAAM;YACR,CAAC;iBAAM,CAAC;gBACN,MAAM;oBACJ,IAAI,EAAE,YAAY,CAAC,KAAK;oBACxB,KAAK,EAAE,mBAAmB;oBAC1B,KAAK;iBACN,CAAC;gBACF,MAAM;YACR,CAAC;YAED,IAAI,CAAC,KAAK,SAAS,GAAG,CAAC,EAAE,CAAC;gBACxB,MAAM;oBACJ,IAAI,EAAE,YAAY,CAAC,KAAK;oBACxB,KAAK,EAAE,sCAAsC;iBAC9C,CAAC;gBACF,MAAM;YACR,CAAC;QACH,CAAC;QACD,IAAI,WAAW,EAAE,EAAE,CAAC;YAClB,YAAY,CAAC,OAAO,CAAC,yBAAyB,EAAE,IAAI,CAAC,SAAS,CAAC,aAAa,CAAC,CAAC,CAAC;YAC/E,MAAM,CAAC,aAAa,CAAC,IAAI,WAAW,CAAC,gBAAgB,CAAC,CAAC,CAAC;QAC1D,CAAC;IACH,CAAC;CACF;AAED,SAAS,WAAW;IAClB,OAAO,OAAO,CAAC,YAAY,CAAC,OAAO,CAAC,wBAAwB,CAAC,CAAC,CAAC;AACjE,CAAC;AAED,SAAS,QAAQ,CAAC,GAAG,GAAc;IACjC,IAAI,CAAC,WAAW,EAAE,EAAE,CAAC;QACnB,OAAO;IACT,CAAC;IAED,sCAAsC;IACtC,OAAO,CAAC,GAAG,CAAC,GAAG,GAAG,CAAC,CAAC;AACtB,CAAC;AAED,SAAS,yBAAyB,CAAC,OAAgB;IACjD,IAAI,OAAO,EAAE,CAAC;QACZ,YAAY,CAAC,OAAO,CAAC,wBAAwB,EAAE,MAAM,CAAC,CAAC;IACzD,CAAC;SAAM,CAAC;QACN,YAAY,CAAC,UAAU,CAAC,wBAAwB,CAAC,CAAC;IACpD,CAAC;AACH,CAAC;AAED,aAAa;AACb,UAAU,CAAC,yBAAyB,GAAG,yBAAyB,CAAC","sourcesContent":["// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../core/common/common.js';\nimport * as Host from '../../core/host/host.js';\nimport * as Platform from '../../core/platform/platform.js';\nimport * as SDK from '../../core/sdk/sdk.js';\nimport * as UI from '../../ui/legacy/legacy.js';\n\nimport {ChangeManager} from './ChangeManager.js';\nimport {ExtensionScope, FREESTYLER_WORLD_NAME} from './ExtensionScope.js';\nimport {ExecutionError, FreestylerEvaluateAction, SideEffectError} from './FreestylerEvaluateAction.js';\n\nconst preamble = `You are a CSS debugging assistant integrated into Chrome DevTools.\nThe user selected a DOM element in the browser's DevTools and sends a CSS-related\nquery about the selected DOM element. You are going to answer to the query in these steps:\n* THOUGHT\n* TITLE\n* ACTION\n* ANSWER\n* FIXABLE\nUse THOUGHT to explain why you take the ACTION. Use TITLE to provide a short summary of the thought.\nUse ACTION to evaluate JavaScript code on the page to gather all the data needed to answer the query and put it inside the data variable - then return STOP.\nYou have access to a special $0 variable referencing the current element in the scope of the JavaScript code.\nOBSERVATION will be the result of running the JS code on the page.\nAfter that, you can answer the question with ANSWER or run another ACTION query.\nPlease run ACTION again if the information you received is not enough to answer the query.\nPlease answer only if you are sure about the answer. Otherwise, explain why you're not able to answer.\nWhen answering, remember to consider CSS concepts such as the CSS cascade, explicit and implicit stacking contexts and various CSS layout types.\nWhen answering, always consider MULTIPLE possible solutions.\nAfter the ANSWER, output FIXABLE: true if the user request needs a fix using JavaScript or Web APIs and it has not been fixed previously.\n\nIf you need to set styles on an HTML element, always call the \\`async setElementStyles(el: Element, styles: object)\\` function.\n\nExample:\nACTION\nconst data = {\n  color: window.getComputedStyle($0)['color'],\n  backgroundColor: window.getComputedStyle($0)['backgroundColor'],\n}\nSTOP\n\nExample session:\n\nQUERY: Why is this element centered in its container?\nTHOUGHT: Let's check the layout properties of the container.\nTITLE: Checking layout properties\nACTION\n/* COLLECT_INFORMATION_HERE */\nconst data = {\n  /* THE RESULT YOU ARE GOING TO USE AS INFORMATION */\n}\nSTOP\n\nYou will be called again with this:\nOBSERVATION\n/* OBJECT_CONTAINING_YOUR_DATA */\n\nYou then output:\nANSWER: The element is centered on the page because the parent is a flex container with justify-content set to center.\nFIXABLE: true\n\nThe example session ends here.`;\n\nexport const FIX_THIS_ISSUE_PROMPT = 'Fix this issue using JavaScript code execution';\n\nexport enum ResponseType {\n  THOUGHT = 'thought',\n  ACTION = 'action',\n  SIDE_EFFECT = 'side-effect',\n  ANSWER = 'answer',\n  ERROR = 'error',\n  QUERYING = 'querying',\n}\n\nexport interface AnswerResponse {\n  type: ResponseType.ANSWER;\n  text: string;\n  rpcId?: number;\n  fixable: boolean;\n}\n\nexport interface ErrorResponse {\n  type: ResponseType.ERROR;\n  error: string;\n  rpcId?: number;\n}\n\nexport interface ThoughtResponse {\n  type: ResponseType.THOUGHT;\n  thought: string;\n  title?: string;\n  rpcId?: number;\n}\n\nexport interface SideEffectResponse {\n  type: ResponseType.SIDE_EFFECT;\n  code: string;\n  confirm: (confirm: boolean) => void;\n  rpcId?: number;\n}\n\nexport interface ActionResponse {\n  type: ResponseType.ACTION;\n  code: string;\n  output: string;\n  rpcId?: number;\n}\n\nexport interface QueryResponse {\n  type: ResponseType.QUERYING;\n}\n\nexport type ResponseData = AnswerResponse|ErrorResponse|ActionResponse|SideEffectResponse|ThoughtResponse|QueryResponse;\n\n// TODO: this should use the current execution context pased on the\n// node.\nasync function executeJsCode(code: string, {throwOnSideEffect}: {throwOnSideEffect: boolean}): Promise<string> {\n  const target = UI.Context.Context.instance().flavor(SDK.Target.Target);\n  if (!target) {\n    throw new Error('Target is not found for executing code');\n  }\n\n  const resourceTreeModel = target.model(SDK.ResourceTreeModel.ResourceTreeModel);\n  const runtimeModel = target.model(SDK.RuntimeModel.RuntimeModel);\n  const pageAgent = target.pageAgent();\n  if (!resourceTreeModel?.mainFrame) {\n    throw new Error('Main frame is not found for executing code');\n  }\n\n  // This returns previously created world if it exists for the frame.\n  const {executionContextId} = await pageAgent.invoke_createIsolatedWorld(\n      {frameId: resourceTreeModel.mainFrame.id, worldName: FREESTYLER_WORLD_NAME});\n  const executionContext = runtimeModel?.executionContext(executionContextId);\n  if (!executionContext) {\n    throw new Error('Execution context is not found for executing code');\n  }\n\n  try {\n    return await FreestylerEvaluateAction.execute(code, executionContext, {throwOnSideEffect});\n  } catch (err) {\n    if (err instanceof ExecutionError) {\n      return `Error: ${err.message}`;\n    }\n\n    throw err;\n  }\n}\n\ntype HistoryChunk = {\n  text: string,\n  entity: Host.AidaClient.Entity,\n};\n\nconst MAX_STEPS = 10;\nconst MAX_OBSERVATION_BYTE_LENGTH = 25_000;\n\ntype CreateExtensionScopeFunction = (changes: ChangeManager) => {\n  install(): Promise<void>, uninstall(): Promise<void>,\n};\n\ntype AgentOptions = {\n  aidaClient: Host.AidaClient.AidaClient,\n  changeManager?: ChangeManager,\n  confirmSideEffectForTest?: typeof Promise.withResolvers,\n  serverSideLoggingEnabled?: boolean,\n  createExtensionScope?: CreateExtensionScopeFunction,\n  execJs?: typeof executeJsCode,\n};\n\ninterface AidaRequestOptions {\n  input: string;\n  preamble?: string;\n  chatHistory?: Host.AidaClient.Chunk[];\n  /**\n   * @default false\n   */\n  serverSideLoggingEnabled?: boolean;\n  sessionId?: string;\n}\n\n/**\n * One agent instance handles one conversation. Create a new agent\n * instance for a new conversation.\n */\nexport class FreestylerAgent {\n  static buildRequest(opts: AidaRequestOptions): Host.AidaClient.AidaRequest {\n    const config = Common.Settings.Settings.instance().getHostConfig();\n    const request: Host.AidaClient.AidaRequest = {\n      input: opts.input,\n      preamble: opts.preamble,\n      // eslint-disable-next-line @typescript-eslint/naming-convention\n      chat_history: opts.chatHistory,\n      client: Host.AidaClient.CLIENT_NAME,\n      options: {\n        temperature: config.devToolsFreestylerDogfood?.temperature ?? 0,\n        model_id: config.devToolsFreestylerDogfood?.modelId ?? undefined,\n      },\n      metadata: {\n        // TODO: disable logging based on query params.\n        disable_user_content_logging: !(opts.serverSideLoggingEnabled ?? false),\n        string_session_id: opts.sessionId,\n      },\n      // eslint-disable-next-line @typescript-eslint/naming-convention\n      functionality_type: Host.AidaClient.FunctionalityType.CHAT,\n      // eslint-disable-next-line @typescript-eslint/naming-convention\n      client_feature: Host.AidaClient.ClientFeature.CHROME_FREESTYLER,\n    };\n    return request;\n  }\n\n  static parseResponse(response: string):\n      {thought?: string, title?: string, action?: string, answer?: string, fixable: boolean} {\n    const lines = response.split('\\n');\n    let thought: string|undefined;\n    let title: string|undefined;\n    let action: string|undefined;\n    let answer: string|undefined;\n    let fixable = false;\n    let i = 0;\n    while (i < lines.length) {\n      const trimmed = lines[i].trim();\n      if (trimmed.startsWith('THOUGHT:') && !thought) {\n        // TODO: multiline thoughts.\n        thought = trimmed.substring('THOUGHT:'.length).trim();\n        i++;\n      } else if (trimmed.startsWith('TITLE:')) {\n        title = trimmed.substring('TITLE:'.length).trim();\n        i++;\n      } else if (trimmed.startsWith('ACTION') && !action) {\n        const actionLines = [];\n        let j = i + 1;\n        while (j < lines.length && lines[j].trim() !== 'STOP') {\n          // Sometimes the code block is in the form of \"`````\\njs\\n{code}`````\"\n          if (lines[j].trim() !== 'js') {\n            actionLines.push(lines[j]);\n          }\n          j++;\n        }\n        // TODO: perhaps trying to parse with a Markdown parser would\n        // yield more reliable results.\n        action = actionLines.join('\\n').replaceAll('```', '').replaceAll('``', '').trim();\n        i = j + 1;\n      } else if (trimmed.startsWith('ANSWER:') && !answer) {\n        const answerLines = [\n          trimmed.substring('ANSWER:'.length).trim(),\n        ];\n        let j = i + 1;\n        while (j < lines.length) {\n          const line = lines[j].trim();\n          if (line.startsWith('ACTION') || line.startsWith('OBSERVATION:') || line.startsWith('THOUGHT:') ||\n              line.startsWith('FIXABLE:')) {\n            break;\n          }\n          answerLines.push(lines[j]);\n          j++;\n        }\n        answer = answerLines.join('\\n').trim();\n        i = j;\n      } else if (trimmed.startsWith('FIXABLE: true')) {\n        fixable = true;\n        i++;\n      } else {\n        i++;\n      }\n    }\n    // If we could not parse the parts, consider the response to be an\n    // answer.\n    if (!answer && !thought && !action) {\n      answer = response;\n    }\n    return {thought, title, action, answer, fixable};\n  }\n\n  #aidaClient: Host.AidaClient.AidaClient;\n  #chatHistory: Map<number, HistoryChunk[]> = new Map();\n  #serverSideLoggingEnabled: boolean;\n\n  #execJs: typeof executeJsCode;\n\n  #confirmSideEffect: typeof Promise.withResolvers;\n  readonly #sessionId = crypto.randomUUID();\n  #changes: ChangeManager;\n  #createExtensionScope: CreateExtensionScopeFunction;\n\n  constructor(opts: AgentOptions) {\n    this.#aidaClient = opts.aidaClient;\n    this.#changes = opts.changeManager || new ChangeManager();\n    this.#execJs = opts.execJs ?? executeJsCode;\n    this.#createExtensionScope = opts.createExtensionScope ?? ((changes: ChangeManager) => {\n                                   return new ExtensionScope(changes);\n                                 });\n    this.#serverSideLoggingEnabled = opts.serverSideLoggingEnabled ?? false;\n    this.#confirmSideEffect = opts.confirmSideEffectForTest ?? (() => Promise.withResolvers());\n    SDK.TargetManager.TargetManager.instance().addModelListener(\n        SDK.ResourceTreeModel.ResourceTreeModel, SDK.ResourceTreeModel.Events.PrimaryPageChanged,\n        this.onPrimaryPageChanged, this);\n  }\n\n  onPrimaryPageChanged(): void {\n    void this.#changes.clear();\n  }\n\n  get #getHistoryEntry(): Array<HistoryChunk> {\n    return [...this.#chatHistory.values()].flat();\n  }\n\n  get chatHistoryForTesting(): Array<HistoryChunk> {\n    return this.#getHistoryEntry;\n  }\n\n  async #aidaFetch(request: Host.AidaClient.AidaRequest): Promise<{response: string, rpcId: number|undefined}> {\n    let response = '';\n    let rpcId;\n    for await (const lastResult of this.#aidaClient.fetch(request)) {\n      response = lastResult.explanation;\n      rpcId = lastResult.metadata.rpcGlobalId ?? rpcId;\n      if (lastResult.metadata.attributionMetadata?.some(\n              meta => meta.attributionAction === Host.AidaClient.RecitationAction.BLOCK)) {\n        throw new Error('Attribution action does not allow providing the response');\n      }\n    }\n\n    return {response, rpcId};\n  }\n\n  async #generateObservation(\n      action: string,\n      {\n        throwOnSideEffect,\n        confirmExecJs: confirm,\n        execJsDeniedMessage: denyErrorMessage,\n      }: {\n        throwOnSideEffect: boolean,\n        confirmExecJs?: Promise<boolean>,\n        execJsDeniedMessage?: string,\n      },\n      ): Promise<{\n    observation: string,\n    sideEffect: boolean,\n  }> {\n    const actionExpression = `{const scope = {$0, $1, getEventListeners}; with (scope) {${\n        action};((typeof data !== \"undefined\") ? data : undefined)}}`;\n    try {\n      const runConfirmed = await confirm ?? Promise.resolve(true);\n      if (!runConfirmed) {\n        throw new Error(denyErrorMessage ?? 'Code execution is not allowed');\n      }\n      const result = await this.#execJs(\n          actionExpression,\n          {throwOnSideEffect},\n      );\n      const byteCount = Platform.StringUtilities.countWtf8Bytes(result);\n      if (byteCount > MAX_OBSERVATION_BYTE_LENGTH) {\n        throw new Error('Output exceeded the maximum allowed length.');\n      }\n      return {\n        observation: result,\n        sideEffect: false,\n      };\n    } catch (error) {\n      if (error instanceof SideEffectError) {\n        return {\n          observation: error.message,\n          sideEffect: true,\n        };\n      }\n\n      return {\n        observation: `Error: ${error.message}`,\n        sideEffect: false,\n      };\n    }\n  }\n\n  #runId = 0;\n  async *\n      run(query: string, options: {signal?: AbortSignal, isFixQuery: boolean} = {isFixQuery: false}):\n          AsyncGenerator<ResponseData, void, void> {\n    const genericErrorMessage = 'Sorry, I could not help you with this query.';\n    const structuredLog = [];\n    query = `QUERY: ${query}`;\n    const currentRunId = ++this.#runId;\n\n    options.signal?.addEventListener('abort', () => {\n      this.#chatHistory.delete(currentRunId);\n    });\n\n    for (let i = 0; i < MAX_STEPS; i++) {\n      yield {\n        type: ResponseType.QUERYING,\n      };\n\n      const request = FreestylerAgent.buildRequest({\n        input: query,\n        preamble,\n        chatHistory: this.#chatHistory.size ? this.#getHistoryEntry : undefined,\n        serverSideLoggingEnabled: this.#serverSideLoggingEnabled,\n        sessionId: this.#sessionId,\n      });\n      let response: string;\n      let rpcId: number|undefined;\n      try {\n        const fetchResult = await this.#aidaFetch(request);\n        response = fetchResult.response;\n        rpcId = fetchResult.rpcId;\n      } catch (err) {\n        debugLog('Error calling the AIDA API', err);\n\n        if (options.signal?.aborted) {\n          break;\n        }\n\n        yield {\n          type: ResponseType.ERROR,\n          error: genericErrorMessage,\n          rpcId,\n        };\n        break;\n      }\n\n      if (options.signal?.aborted) {\n        break;\n      }\n\n      debugLog(`Iteration: ${i}`, 'Request', request, 'Response', response);\n      structuredLog.push({\n        request: structuredClone(request),\n        response: response,\n      });\n      const currentRunEntries = this.#chatHistory.get(currentRunId) ?? [];\n      this.#chatHistory.set(currentRunId, [\n        ...currentRunEntries,\n        {\n          text: query,\n          entity: Host.AidaClient.Entity.USER,\n        },\n        {\n          text: response,\n          entity: Host.AidaClient.Entity.SYSTEM,\n        },\n      ]);\n\n      const {thought, title, action, answer, fixable} = FreestylerAgent.parseResponse(response);\n      // Sometimes the answer will follow an action and a thought. In\n      // that case, we only use the action and the thought (if present)\n      // since the answer is not based on the observation resulted from\n      // the action.\n      if (action) {\n        if (thought) {\n          yield {\n            type: ResponseType.THOUGHT,\n            thought,\n            title,\n            rpcId,\n          };\n        }\n        debugLog(`Action to execute: ${action}`);\n        const scope = this.#createExtensionScope(this.#changes);\n        await scope.install();\n        try {\n          let result = await this.#generateObservation(action, {throwOnSideEffect: !options.isFixQuery});\n          debugLog(`Action result: ${result}`);\n          if (result.sideEffect) {\n            const sideEffectConfirmationPromiseWithResolvers = this.#confirmSideEffect<boolean>();\n\n            yield {\n              type: ResponseType.SIDE_EFFECT,\n              code: action,\n              confirm: sideEffectConfirmationPromiseWithResolvers.resolve,\n              rpcId,\n            };\n\n            result = await this.#generateObservation(action, {\n              throwOnSideEffect: false,\n              confirmExecJs: sideEffectConfirmationPromiseWithResolvers.promise,\n              execJsDeniedMessage: result.observation,\n            });\n          }\n          yield {\n            type: ResponseType.ACTION,\n            code: action,\n            output: result.observation,\n            rpcId,\n          };\n\n          query = `OBSERVATION: ${result.observation}`;\n        } finally {\n          await scope.uninstall();\n        }\n      } else if (answer) {\n        yield {\n          type: ResponseType.ANSWER,\n          text: answer,\n          rpcId,\n          fixable,\n        };\n        break;\n      } else {\n        yield {\n          type: ResponseType.ERROR,\n          error: genericErrorMessage,\n          rpcId,\n        };\n        break;\n      }\n\n      if (i === MAX_STEPS - 1) {\n        yield {\n          type: ResponseType.ERROR,\n          error: 'Max steps reached, please try again.',\n        };\n        break;\n      }\n    }\n    if (isDebugMode()) {\n      localStorage.setItem('freestylerStructuredLog', JSON.stringify(structuredLog));\n      window.dispatchEvent(new CustomEvent('freestylerdone'));\n    }\n  }\n}\n\nfunction isDebugMode(): boolean {\n  return Boolean(localStorage.getItem('debugFreestylerEnabled'));\n}\n\nfunction debugLog(...log: unknown[]): void {\n  if (!isDebugMode()) {\n    return;\n  }\n\n  // eslint-disable-next-line no-console\n  console.log(...log);\n}\n\nfunction setDebugFreestylerEnabled(enabled: boolean): void {\n  if (enabled) {\n    localStorage.setItem('debugFreestylerEnabled', 'true');\n  } else {\n    localStorage.removeItem('debugFreestylerEnabled');\n  }\n}\n\n// @ts-ignore\nglobalThis.setDebugFreestylerEnabled = setDebugFreestylerEnabled;\n"]}