{"version":3,"file":"FreestylerPanel.js","sourceRoot":"","sources":["../../../../../../front_end/panels/freestyler/FreestylerPanel.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\nimport * as Common from '../../core/common/common.js';\nimport * as Host from '../../core/host/host.js';\nimport * as i18n from '../../core/i18n/i18n.js';\nimport * as SDK from '../../core/sdk/sdk.js';\nimport * as UI from '../../ui/legacy/legacy.js';\nimport * as LitHtml from '../../ui/lit-html/lit-html.js';\n\nimport {\n  type ChatMessage,\n  ChatMessageEntity,\n  FreestylerChatUi,\n  type Props as FreestylerChatUiProps,\n  State as FreestylerChatUiState,\n} from './components/FreestylerChatUi.js';\nimport {FreestylerAgent, Step} from './FreestylerAgent.js';\nimport freestylerPanelStyles from './freestylerPanel.css.js';\n\n/*\n  * TODO(nvitkov): b/346933425\n  * Temporary string that should not be translated\n  * as they may change often during development.\n  */\nconst TempUIStrings = {\n  /**\n   *@description Freestyler UI text for clearing messages.\n   */\n  clearMessages: 'Clear messages',\n  /**\n   *@description Freestyler UI text for sending feedback.\n   */\n  sendFeedback: 'Send feedback',\n  /**\n   *@description Freestyelr UI text for the help button.\n   */\n  help: 'Help',\n  /**\n   *@description Displayed when the user stop the response\n   */\n  stoppedResponse: 'You stopped this response',\n};\n\n// TODO(nvitkov): b/346933425\n// const str_ = i18n.i18n.registerUIStrings('panels/freestyler/FreestylerPanel.ts', UIStrings);\n// const i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\n/* eslint-disable  rulesdir/l10n_i18nString_call_only_with_uistrings */\nconst i18nString = i18n.i18n.lockedString;\n\ntype ViewOutput = {\n  freestylerChatUi?: FreestylerChatUi,\n};\ntype View = (input: FreestylerChatUiProps, output: ViewOutput, target: HTMLElement) => void;\n\n// TODO(ergunsh): Use the WidgetElement instead of separately creating the toolbar.\nfunction createToolbar(target: HTMLElement, {onClearClick}: {onClearClick: () => void}): void {\n  const toolbarContainer = target.createChild('div', 'freestyler-toolbar-container');\n  const leftToolbar = new UI.Toolbar.Toolbar('', toolbarContainer);\n  const rightToolbar = new UI.Toolbar.Toolbar('freestyler-right-toolbar', toolbarContainer);\n\n  const clearButton =\n      new UI.Toolbar.ToolbarButton(i18nString(TempUIStrings.clearMessages), 'clear', undefined, 'freestyler.clear');\n  clearButton.addEventListener(UI.Toolbar.ToolbarButton.Events.Click, onClearClick);\n  leftToolbar.appendToolbarItem(clearButton);\n\n  rightToolbar.appendSeparator();\n  const feedbackButton =\n      new UI.Toolbar.ToolbarButton(i18nString(TempUIStrings.sendFeedback), 'bug', undefined, 'freestyler.feedback');\n  const helpButton = new UI.Toolbar.ToolbarButton(i18nString(TempUIStrings.help), 'help', undefined, 'freestyler.help');\n  rightToolbar.appendToolbarItem(feedbackButton);\n  rightToolbar.appendToolbarItem(helpButton);\n}\n\nfunction defaultView(input: FreestylerChatUiProps, output: ViewOutput, target: HTMLElement): void {\n  // clang-format off\n  LitHtml.render(LitHtml.html`\n    <${FreestylerChatUi.litTagName} .props=${input} ${LitHtml.Directives.ref((el: Element|undefined) => {\n      if (!el || !(el instanceof FreestylerChatUi)) {\n        return;\n      }\n\n      output.freestylerChatUi = el;\n    })}></${FreestylerChatUi.litTagName}>\n  `, target, {host: input}); // eslint-disable-line rulesdir/lit_html_host_this\n  // clang-format on\n}\n\nlet freestylerPanelInstance: FreestylerPanel;\nexport class FreestylerPanel extends UI.Panel.Panel {\n  static panelName = 'freestyler';\n\n  #toggleSearchElementAction: UI.ActionRegistration.Action;\n  #selectedNode: SDK.DOMModel.DOMNode|null;\n  #contentContainer: HTMLElement;\n  #aidaClient: Host.AidaClient.AidaClient;\n  #agent: FreestylerAgent;\n  #viewProps: FreestylerChatUiProps;\n  #viewOutput: ViewOutput = {};\n  #consentViewAcceptedSetting =\n      Common.Settings.Settings.instance().createLocalSetting('freestyler-dogfood-consent-onboarding-finished', false);\n  constructor(private view: View = defaultView, {aidaClient, aidaAvailability}: {\n    aidaClient: Host.AidaClient.AidaClient,\n    aidaAvailability: Host.AidaClient.AidaAvailability,\n  }) {\n    super(FreestylerPanel.panelName);\n\n    createToolbar(this.contentElement, {onClearClick: this.#clearMessages.bind(this)});\n    this.#toggleSearchElementAction =\n        UI.ActionRegistry.ActionRegistry.instance().getAction('elements.toggle-element-search');\n    this.#aidaClient = aidaClient;\n    this.#contentContainer = this.contentElement.createChild('div', 'freestyler-chat-ui-container');\n    this.#agent = new FreestylerAgent({aidaClient: this.#aidaClient});\n    this.#selectedNode = UI.Context.Context.instance().flavor(SDK.DOMModel.DOMNode);\n    this.#viewProps = {\n      state: this.#consentViewAcceptedSetting.get() ? FreestylerChatUiState.CHAT_VIEW :\n                                                      FreestylerChatUiState.CONSENT_VIEW,\n      aidaAvailability,\n      messages: [],\n      inspectElementToggled: this.#toggleSearchElementAction.toggled(),\n      selectedNode: this.#selectedNode,\n      isLoading: false,\n      onTextSubmit: this.#handleTextSubmit.bind(this),\n      onInspectElementClick: this.#handleSelectElementClick.bind(this),\n      onRateClick: this.#handleRateClick.bind(this),\n      onAcceptConsentClick: this.#handleAcceptConsentClick.bind(this),\n      onCancelClick: this.#cancel.bind(this),\n    };\n    this.#toggleSearchElementAction.addEventListener(UI.ActionRegistration.Events.Toggled, ev => {\n      this.#viewProps.inspectElementToggled = ev.data;\n      this.doUpdate();\n    });\n\n    UI.Context.Context.instance().addFlavorChangeListener(SDK.DOMModel.DOMNode, ev => {\n      if (this.#viewProps.selectedNode === ev.data) {\n        return;\n      }\n\n      this.#viewProps.selectedNode = ev.data;\n      this.#clearMessages();\n    });\n    this.doUpdate();\n  }\n\n  static async instance(opts: {\n    forceNew: boolean|null,\n  }|undefined = {forceNew: null}): Promise<FreestylerPanel> {\n    const {forceNew} = opts;\n    if (!freestylerPanelInstance || forceNew) {\n      const aidaAvailability = await Host.AidaClient.AidaClient.getAidaClientAvailability();\n      const aidaClient = new Host.AidaClient.AidaClient();\n      freestylerPanelInstance = new FreestylerPanel(defaultView, {aidaClient, aidaAvailability});\n    }\n\n    return freestylerPanelInstance;\n  }\n\n  override wasShown(): void {\n    this.registerCSSFiles([freestylerPanelStyles]);\n    this.#viewOutput.freestylerChatUi?.focusTextInput();\n  }\n\n  doUpdate(): void {\n    this.view(this.#viewProps, this.#viewOutput, this.#contentContainer);\n  }\n\n  #handleSelectElementClick(): void {\n    void this.#toggleSearchElementAction.execute();\n  }\n\n  #handleRateClick(): void {\n    // TODO(348145480): Handle this -- e.g. there be dragons.\n  }\n\n  #handleAcceptConsentClick(): void {\n    this.#consentViewAcceptedSetting.set(true);\n    this.#viewProps.state = FreestylerChatUiState.CHAT_VIEW;\n    this.doUpdate();\n  }\n\n  handleAction(actionId: string): void {\n    switch (actionId) {\n      case 'freestyler.element-panel-context': {\n        Host.userMetrics.actionTaken(Host.UserMetrics.Action.FreestylerOpenedFromElementsPanel);\n        this.#clearMessages();\n        break;\n      }\n      case 'freestyler.style-tab-context': {\n        Host.userMetrics.actionTaken(Host.UserMetrics.Action.FreestylerOpenedFromStylesTab);\n        this.#clearMessages();\n        break;\n      }\n    }\n  }\n\n  #clearMessages(): void {\n    this.#viewProps.messages = [];\n    this.#viewProps.isLoading = false;\n    this.#agent.resetHistory();\n    this.#cancel();\n    this.doUpdate();\n  }\n\n  #runAbortController = new AbortController();\n  #cancel(): void {\n    this.#runAbortController.abort();\n    this.#runAbortController = new AbortController();\n    this.#viewProps.isLoading = false;\n    this.doUpdate();\n  }\n\n  async #handleTextSubmit(text: string): Promise<void> {\n    this.#viewProps.messages.push({\n      entity: ChatMessageEntity.USER,\n      text,\n    });\n    this.#viewProps.isLoading = true;\n    const systemMessage: ChatMessage = {\n      entity: ChatMessageEntity.MODEL,\n      steps: [],\n    };\n    this.#viewProps.messages.push(systemMessage);\n    this.doUpdate();\n\n    this.#runAbortController = new AbortController();\n\n    const signal = this.#runAbortController.signal;\n    signal.addEventListener('abort', () => {\n      systemMessage.steps.push({step: Step.ERROR, text: i18nString(TempUIStrings.stoppedResponse)});\n    });\n    for await (const data of this.#agent.run(text, {signal})) {\n      if (data.step === Step.ANSWER || data.step === Step.ERROR) {\n        this.#viewProps.isLoading = false;\n      }\n\n      // There can be multiple steps from the same call from the agent.\n      // We want to show `rate answer` buttons for the full response.\n      // That's why we're removing the `rpcId` from the previous step\n      // if there is a new incoming step from the call with the same rpcId.\n      const lastStep = systemMessage.steps.at(-1);\n      if (lastStep && lastStep.rpcId && lastStep.rpcId === data.rpcId) {\n        delete lastStep.rpcId;\n      }\n\n      systemMessage.steps.push(data);\n      this.doUpdate();\n    }\n  }\n}\n\nexport class ActionDelegate implements UI.ActionRegistration.ActionDelegate {\n  handleAction(\n      _context: UI.Context.Context,\n      actionId: string,\n      ): boolean {\n    switch (actionId) {\n      case 'freestyler.element-panel-context':\n      case 'freestyler.style-tab-context': {\n        void (async () => {\n          const view = UI.ViewManager.ViewManager.instance().view(\n              FreestylerPanel.panelName,\n          );\n\n          if (view) {\n            await UI.ViewManager.ViewManager.instance().showView(\n                FreestylerPanel.panelName,\n            );\n            const widget = (await view.widget()) as FreestylerPanel;\n            widget.handleAction(actionId);\n          }\n        })();\n        return true;\n      }\n    }\n\n    return false;\n  }\n}\n"]}