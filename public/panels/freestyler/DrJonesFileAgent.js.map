{"version":3,"file":"DrJonesFileAgent.js","sourceRoot":"","sources":["../../../../../../front_end/panels/freestyler/DrJonesFileAgent.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../core/common/common.js';\nimport * as Host from '../../core/host/host.js';\nimport * as i18n from '../../core/i18n/i18n.js';\nimport type * as Workspace from '../../models/workspace/workspace.js';\n\nimport {\n  AiAgent,\n  type AidaRequestOptions,\n  type ContextDetail,\n  debugLog,\n  ErrorType,\n  isDebugMode,\n  type ResponseData,\n  ResponseType,\n  type ThoughtResponse,\n  type TitleResponse,\n} from './AiAgent.js';\n\nconst preamble =\n    `You are a highly skilled software engineer with expertise in various programming languages and frameworks.\nYou are provided with the content of a file from the Chrome DevTools Sources panel.\n\n**Important Note:** The provided code may represent an incomplete fragment of a larger file.\n\nAnalyze the code and provide the following information:\n* Describe the primary functionality of the code. What does it do? Be specific and concise.\n* If possible, identify the framework or library the code is associated with (e.g., React, Angular, jQuery). List any key technologies, APIs, or patterns used in the code (e.g., Fetch API, WebSockets, object-oriented programming).\n* (Only provide if available and accessible externally) External Resources: Suggest relevant documentation that could help a developer understand the code better. Prioritize official documentation if available. Do not provide any internal resources.\n\n# Considerations\n* Keep your analysis concise and focused, highlighting only the most critical aspects for a software engineer.\n* **CRITICAL** If the user asks a question about religion, race, politics, sexuality, gender, or other sensitive topics, answer with \"Sorry, I can't answer that. I'm best at questions about files.\"\n\n## Example session\n\n**User:** (Selects a file containing the following JavaScript code)\n\nfunction calculateTotal(price, quantity) {\n  const total = price * quantity;\n  return total;\n}\nExplain this file.\n\n\nThis code defines a function called calculateTotal that calculates the total cost by multiplying the price and quantity arguments.\nThis code is written in JavaScript and doesn't seem to be associated with a specific framework. It's likely a utility function.\nRelevant Technologies: JavaScript, functions, arithmetic operations.\nExternal Resources:\nMDN Web Docs: JavaScript Functions: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Functions\n`;\n\n/*\n* Strings that don't need to be translated at this time.\n*/\nconst UIStringsNotTranslate = {\n  /**\n   *@description Title for thinking step of DrJones File agent.\n   */\n  analyzingFile: 'Analyzing file',\n  /**\n   *@description Thought text for thinking step of DrJones File agent.\n   */\n  dataUsedToGenerateThisResponse: 'Data used to generate this response',\n};\n\nconst lockedString = i18n.i18n.lockedString;\n\nconst MAX_FILE_SIZE = 50000;\n\n/**\n * One agent instance handles one conversation. Create a new agent\n * instance for a new conversation.\n */\nexport class DrJonesFileAgent extends AiAgent {\n  readonly preamble = preamble;\n  readonly clientFeature = Host.AidaClient.ClientFeature.CHROME_DRJONES_FILE_AGENT;\n  // TODO(b/369822364): use a feature param instead.\n  readonly userTier = 'BETA';\n  get options(): AidaRequestOptions {\n    const config = Common.Settings.Settings.instance().getHostConfig();\n    const temperature = AiAgent.validTemperature(config.devToolsAiAssistanceFileAgentDogfood?.temperature);\n    const modelId = config.devToolsAiAssistanceFileAgentDogfood?.modelId;\n\n    return {\n      temperature,\n      model_id: modelId,\n    };\n  }\n\n  *\n      handleContextDetails(selectedFile: Workspace.UISourceCode.UISourceCode|null):\n          Generator<ThoughtResponse|TitleResponse, void, void> {\n    if (!selectedFile) {\n      return;\n    }\n\n    yield {\n      type: ResponseType.TITLE,\n      title: lockedString(UIStringsNotTranslate.analyzingFile),\n    };\n    yield {\n      type: ResponseType.THOUGHT,\n      thought: lockedString(UIStringsNotTranslate.dataUsedToGenerateThisResponse),\n      contextDetails: createContextDetailsForDrJonesFileAgent(selectedFile),\n    };\n  }\n\n  async enhanceQuery(query: string, selectedFile: Workspace.UISourceCode.UISourceCode|null): Promise<string> {\n    const fileEnchantmentQuery =\n        selectedFile ? `# Selected file\\n${formatFile(selectedFile)}\\n\\n# User request\\n\\n` : '';\n    return `${fileEnchantmentQuery}${query}`;\n  }\n\n  #runId = 0;\n  async * run(query: string, options: {\n    signal?: AbortSignal, selectedFile: Workspace.UISourceCode.UISourceCode|null,\n  }): AsyncGenerator<ResponseData, void, void> {\n    yield* this.handleContextDetails(options.selectedFile);\n\n    query = await this.enhanceQuery(query, options.selectedFile);\n    const currentRunId = ++this.#runId;\n\n    let response: string;\n    let rpcId: number|undefined;\n    try {\n      const fetchResult = await this.aidaFetch(query, {signal: options.signal});\n      response = fetchResult.response;\n      rpcId = fetchResult.rpcId;\n    } catch (err) {\n      debugLog('Error calling the AIDA API', err);\n      if (err instanceof Host.AidaClient.AidaAbortError) {\n        this.removeHistoryRun(currentRunId);\n        yield {\n          type: ResponseType.ERROR,\n          error: ErrorType.ABORT,\n          rpcId,\n        };\n        return;\n      }\n\n      yield {\n        type: ResponseType.ERROR,\n        error: ErrorType.UNKNOWN,\n        rpcId,\n      };\n      return;\n    }\n\n    this.addToHistory({\n      id: currentRunId,\n      query,\n      output: response,\n    });\n\n    yield {\n      type: ResponseType.ANSWER,\n      text: response,\n      rpcId,\n    };\n    if (isDebugMode()) {\n      window.dispatchEvent(new CustomEvent('freestylerdone'));\n    }\n  }\n}\n\nfunction createContextDetailsForDrJonesFileAgent(selectedFile: Workspace.UISourceCode.UISourceCode):\n    [ContextDetail, ...ContextDetail[]] {\n  return [\n    {\n      title: 'Selected file',\n      text: formatFile(selectedFile),\n    },\n  ];\n}\n\nfunction formatFile(selectedFile: Workspace.UISourceCode.UISourceCode): string {\n  return `File Name: ${selectedFile.displayName()}\nURL: ${selectedFile.url()}\nFile Content:\n${selectedFile.content().slice(0, MAX_FILE_SIZE)}`;\n}\n\nfunction setDebugFreestylerEnabled(enabled: boolean): void {\n  if (enabled) {\n    localStorage.setItem('debugFreestylerEnabled', 'true');\n  } else {\n    localStorage.removeItem('debugFreestylerEnabled');\n  }\n}\n\n// @ts-ignore\nglobalThis.setDebugFreestylerEnabled = setDebugFreestylerEnabled;\n"]}