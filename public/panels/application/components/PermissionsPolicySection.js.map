{"version":3,"file":"PermissionsPolicySection.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/application/components/PermissionsPolicySection.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2021 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport '../../../ui/components/icon_button/icon_button.js';\nimport '../../../ui/components/report_view/report_view.js';\n\nimport * as Common from '../../../core/common/common.js';\nimport * as i18n from '../../../core/i18n/i18n.js';\nimport type * as Platform from '../../../core/platform/platform.js';\nimport * as SDK from '../../../core/sdk/sdk.js';\nimport * as Protocol from '../../../generated/protocol.js';\nimport * as NetworkForward from '../../../panels/network/forward/forward.js';\nimport * as Buttons from '../../../ui/components/buttons/buttons.js';\nimport * as RenderCoordinator from '../../../ui/components/render_coordinator/render_coordinator.js';\nimport * as Lit from '../../../ui/lit/lit.js';\nimport * as VisualLogging from '../../../ui/visual_logging/visual_logging.js';\n\nimport permissionsPolicySectionStylesRaw from './permissionsPolicySection.css.js';\n\n// TODO(crbug.com/391381439): Fully migrate off of constructed style sheets.\nconst permissionsPolicySectionStyles = new CSSStyleSheet();\npermissionsPolicySectionStyles.replaceSync(permissionsPolicySectionStylesRaw.cssContent);\n\nconst {html} = Lit;\n\nconst UIStrings = {\n  /**\n   *@description Label for a button. When clicked more details (for the content this button refers to) will be shown.\n   */\n  showDetails: 'Show details',\n  /**\n   *@description Label for a button. When clicked some details (for the content this button refers to) will be hidden.\n   */\n  hideDetails: 'Hide details',\n  /**\n   *@description Label for a list of features which are allowed according to the current Permissions policy\n   *(a mechanism that allows developers to enable/disable browser features and APIs (e.g. camera, geolocation, autoplay))\n   */\n  allowedFeatures: 'Allowed Features',\n  /**\n   *@description Label for a list of features which are disabled according to the current Permissions policy\n   *(a mechanism that allows developers to enable/disable browser features and APIs (e.g. camera, geolocation, autoplay))\n   */\n  disabledFeatures: 'Disabled Features',\n  /**\n   *@description Tooltip text for a link to a specific request's headers in the Network panel.\n   */\n  clickToShowHeader: 'Click to reveal the request whose \"`Permissions-Policy`\" HTTP header disables this feature.',\n  /**\n   *@description Tooltip text for a link to a specific iframe in the Elements panel (Iframes can be nested, the link goes\n   *  to the outer-most iframe which blocks a certain feature).\n   */\n  clickToShowIframe: 'Click to reveal the top-most iframe which does not allow this feature in the elements panel.',\n  /**\n   *@description Text describing that a specific feature is blocked by not being included in the iframe's \"allow\" attribute.\n   */\n  disabledByIframe: 'missing in iframe \"`allow`\" attribute',\n  /**\n   *@description Text describing that a specific feature is blocked by a Permissions Policy specified in a request header.\n   */\n  disabledByHeader: 'disabled by \"`Permissions-Policy`\" header',\n  /**\n   *@description Text describing that a specific feature is blocked by virtue of being inside a fenced frame tree.\n   */\n  disabledByFencedFrame: 'disabled inside a `fencedframe`',\n} as const;\nconst str_ = i18n.i18n.registerUIStrings('panels/application/components/PermissionsPolicySection.ts', UIStrings);\nconst i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\n\nexport interface PermissionsPolicySectionData {\n  policies: Protocol.Page.PermissionsPolicyFeatureState[];\n  showDetails: boolean;\n}\n\nexport function renderIconLink(\n    iconName: string, title: Platform.UIString.LocalizedString, clickHandler: (() => void)|(() => Promise<void>),\n    jsLogContext: string): Lit.TemplateResult {\n  // Disabled until https://crbug.com/1079231 is fixed.\n  // clang-format off\n  return html`\n  <devtools-button\n    .iconName=${iconName}\n    title=${title}\n    .variant=${Buttons.Button.Variant.ICON}\n    .size=${Buttons.Button.Size.SMALL}\n    @click=${clickHandler}\n    jslog=${VisualLogging.action().track({click: true}).context(jsLogContext)}></devtools-button>\n  `;\n  // clang-format on\n}\n\nexport class PermissionsPolicySection extends HTMLElement {\n  readonly #shadow = this.attachShadow({mode: 'open'});\n  #permissionsPolicySectionData: PermissionsPolicySectionData = {policies: [], showDetails: false};\n\n  set data(data: PermissionsPolicySectionData) {\n    this.#permissionsPolicySectionData = data;\n    void this.#render();\n  }\n\n  connectedCallback(): void {\n    this.#shadow.adoptedStyleSheets = [permissionsPolicySectionStyles];\n  }\n\n  #toggleShowPermissionsDisallowedDetails(): void {\n    this.#permissionsPolicySectionData.showDetails = !this.#permissionsPolicySectionData.showDetails;\n    void this.#render();\n  }\n\n  #renderAllowed(): Lit.LitTemplate {\n    const allowed = this.#permissionsPolicySectionData.policies.filter(p => p.allowed).map(p => p.feature).sort();\n    if (!allowed.length) {\n      return Lit.nothing;\n    }\n    return html`\n      <devtools-report-key>${i18nString(UIStrings.allowedFeatures)}</devtools-report-key>\n      <devtools-report-value>\n        ${allowed.join(', ')}\n      </devtools-report-value>\n    `;\n  }\n\n  async #renderDisallowed(): Promise<Lit.LitTemplate> {\n    const disallowed = this.#permissionsPolicySectionData.policies.filter(p => !p.allowed)\n                           .sort((a, b) => a.feature.localeCompare(b.feature));\n    if (!disallowed.length) {\n      return Lit.nothing;\n    }\n    if (!this.#permissionsPolicySectionData.showDetails) {\n      return html`\n        <devtools-report-key>${i18nString(UIStrings.disabledFeatures)}</devtools-report-key>\n        <devtools-report-value>\n          ${disallowed.map(p => p.feature).join(', ')}\n          <devtools-button\n          .variant=${Buttons.Button.Variant.OUTLINED}\n          @click=${() => this.#toggleShowPermissionsDisallowedDetails()}\n          jslog=${VisualLogging.action('show-disabled-features-details').track({\n        click: true,\n      })}>${i18nString(UIStrings.showDetails)}\n        </devtools-button>\n        </devtools-report-value>\n      `;\n    }\n\n    const frameManager = SDK.FrameManager.FrameManager.instance();\n    const featureRows = await Promise.all(disallowed.map(async policy => {\n      const frame = policy.locator ? frameManager.getFrame(policy.locator.frameId) : null;\n      const blockReason = policy.locator?.blockReason;\n      const linkTargetDOMNode = await (blockReason === Protocol.Page.PermissionsPolicyBlockReason.IframeAttribute &&\n                                       frame?.getOwnerDOMNodeOrDocument());\n      const resource = frame?.resourceForURL(frame.url);\n      const linkTargetRequest = blockReason === Protocol.Page.PermissionsPolicyBlockReason.Header && resource?.request;\n      const blockReasonText = (() => {\n        switch (blockReason) {\n          case Protocol.Page.PermissionsPolicyBlockReason.IframeAttribute:\n            return i18nString(UIStrings.disabledByIframe);\n          case Protocol.Page.PermissionsPolicyBlockReason.Header:\n            return i18nString(UIStrings.disabledByHeader);\n          case Protocol.Page.PermissionsPolicyBlockReason.InFencedFrameTree:\n            return i18nString(UIStrings.disabledByFencedFrame);\n          default:\n            return '';\n        }\n      })();\n      const revealHeader = async(): Promise<void> => {\n        if (!linkTargetRequest) {\n          return;\n        }\n        const headerName =\n            linkTargetRequest.responseHeaderValue('permissions-policy') ? 'permissions-policy' : 'feature-policy';\n        const requestLocation = NetworkForward.UIRequestLocation.UIRequestLocation.responseHeaderMatch(\n            linkTargetRequest,\n            {name: headerName, value: ''},\n        );\n        await Common.Revealer.reveal(requestLocation);\n      };\n\n      // Disabled until https://crbug.com/1079231 is fixed.\n      // clang-format off\n      return html`\n        <div class=\"permissions-row\">\n          <div>\n            <devtools-icon class=\"allowed-icon\"\n              .data=${{\n                color: 'var(--icon-error)',\n                iconName: 'cross-circle',\n                width: '20px', height: '20px',\n              }}>\n            </devtools-icon>\n          </div>\n          <div class=\"feature-name text-ellipsis\">\n            ${policy.feature}\n          </div>\n          <div class=\"block-reason\">${blockReasonText}</div>\n          <div>\n            ${\n          linkTargetDOMNode ? renderIconLink(\n                                  'code-circle', i18nString(UIStrings.clickToShowIframe),\n                                  () => Common.Revealer.reveal(linkTargetDOMNode), 'reveal-in-elements') :\n                              Lit.nothing}\n            ${\n          linkTargetRequest ? renderIconLink(\n                                  'arrow-up-down-circle',\n                                  i18nString(UIStrings.clickToShowHeader),\n                                  revealHeader,\n                                  'reveal-in-network') :\n                              Lit.nothing}\n          </div>\n        </div>\n      `;\n              // clang-format on\n    }));\n\n    return html`\n      <devtools-report-key>${i18nString(UIStrings.disabledFeatures)}</devtools-report-key>\n      <devtools-report-value class=\"policies-list\">\n        ${featureRows}\n        <div class=\"permissions-row\">\n        <devtools-button\n          .variant=${Buttons.Button.Variant.OUTLINED}\n          @click=${() => this.#toggleShowPermissionsDisallowedDetails()}\n          jslog=${VisualLogging.action('hide-disabled-features-details').track({\n      click: true,\n    })}>${i18nString(UIStrings.hideDetails)}\n        </devtools-button>\n        </div>\n      </devtools-report-value>\n    `;\n  }\n\n  async #render(): Promise<void> {\n    await RenderCoordinator.write('PermissionsPolicySection render', () => {\n      // Disabled until https://crbug.com/1079231 is fixed.\n      // clang-format off\n      Lit.render(\n        html`\n          <devtools-report-section-header>${i18n.i18n.lockedString('Permissions Policy')}</devtools-report-section-header>\n          ${this.#renderAllowed()}\n          ${Lit.Directives.until(this.#renderDisallowed(), Lit.nothing)}\n          <devtools-report-divider></devtools-report-divider>\n        `,\n        this.#shadow, {host: this},\n      );\n      // clang-format on\n    });\n  }\n}\n\ncustomElements.define('devtools-resources-permissions-policy-section', PermissionsPolicySection);\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'devtools-resources-permissions-policy-section': PermissionsPolicySection;\n  }\n}\n"]}