{"version":3,"file":"BounceTrackingMitigationsView.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/application/components/BounceTrackingMitigationsView.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2023 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport '../../../ui/components/report_view/report_view.js';\nimport '../../../ui/legacy/components/data_grid/data_grid.js';\n\nimport * as i18n from '../../../core/i18n/i18n.js';\nimport type * as Platform from '../../../core/platform/platform.js';\nimport * as SDK from '../../../core/sdk/sdk.js';\nimport * as Buttons from '../../../ui/components/buttons/buttons.js';\nimport * as ChromeLink from '../../../ui/components/chrome_link/chrome_link.js';\nimport * as LegacyWrapper from '../../../ui/components/legacy_wrapper/legacy_wrapper.js';\nimport * as Lit from '../../../ui/lit/lit.js';\nimport * as VisualLogging from '../../../ui/visual_logging/visual_logging.js';\n\nimport bounceTrackingMitigationsViewStylesRaw from './bounceTrackingMitigationsView.css.js';\n\n// TODO(crbug.com/391381439): Fully migrate off of constructed style sheets.\nconst bounceTrackingMitigationsViewStyles = new CSSStyleSheet();\nbounceTrackingMitigationsViewStyles.replaceSync(bounceTrackingMitigationsViewStylesRaw.cssContent);\n\nconst {html} = Lit;\n\nconst UIStrings = {\n  /**\n   * @description Title text in bounce tracking mitigations view of the Application panel.\n   */\n  bounceTrackingMitigationsTitle: 'Bounce tracking mitigations',\n  /**\n   * @description Label for the button to force bounce tracking mitigations to run.\n   */\n  forceRun: 'Force run',\n  /**\n   * @description Label for the disabled button while bounce tracking mitigations are running\n   */\n  runningMitigations: 'Running',\n  /**\n   * @description Heading of table which displays sites whose state was deleted by bounce tracking mitigations.\n   */\n  stateDeletedFor: 'State was deleted for the following sites:',\n  /**\n   * @description Text shown once the deletion command has been sent to the browser process.\n   */\n  checkingPotentialTrackers: 'Checking for potential bounce tracking sites.',\n  /**\n   * @description Link text about explanation of Bounce Tracking Mitigations.\n   */\n  learnMore: 'Learn more: Bounce Tracking Mitigations',\n  /**\n   * @description Text shown when bounce tracking mitigations have been forced to run and\n   * identified no potential bounce tracking sites to delete state for. This may also\n   * indicate that bounce tracking mitigations are disabled or third-party cookies aren't being blocked.\n   */\n  noPotentialBounceTrackersIdentified:\n      'State was not cleared for any potential bounce tracking sites. Either none were identified or third-party cookies are not blocked.',\n  /**\n   * @description Text shown when bounce tracking mitigations bounce tracking mitigations are disabled. Has a link.\n   * @example {Bounce Tracking Mitigations Feature Flag} PH1\n   */\n  featureDisabled:\n      'Bounce tracking mitigations are disabled. To enable them, set the flag at {PH1} to \"Enabled With Deletion\".',\n  /**\n   * @description Text for link to Bounce Tracking Mitigations feature flag entry in the chrome://flags page.\n   */\n  featureFlag: 'Bounce Tracking Mitigations Feature Flag',\n} as const;\n\nconst str_ = i18n.i18n.registerUIStrings('panels/application/components/BounceTrackingMitigationsView.ts', UIStrings);\nexport const i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\n\nconst enum ScreenStatusType {\n  RUNNING = 'Running',\n  RESULT = 'Result',\n  DISABLED = 'Disabled',\n}\n\nexport interface BounceTrackingMitigationsViewData {\n  trackingSites: string[];\n}\n\nexport class BounceTrackingMitigationsView extends LegacyWrapper.LegacyWrapper.WrappableComponent {\n  readonly #shadow = this.attachShadow({mode: 'open'});\n  #trackingSites: string[] = [];\n  #screenStatus = ScreenStatusType.RESULT;\n  #checkedFeature = false;\n  #seenButtonClick = false;\n\n  connectedCallback(): void {\n    this.#shadow.adoptedStyleSheets = [bounceTrackingMitigationsViewStyles];\n    void this.#render();\n  }\n\n  async #render(): Promise<void> {\n    // clang-format off\n    Lit.render(html`\n      <devtools-report .data=${{reportTitle: i18nString(UIStrings.bounceTrackingMitigationsTitle)}}\n                       jslog=${VisualLogging.pane('bounce-tracking-mitigations')}>\n        ${await this.#renderMainFrameInformation()}\n      </devtools-report>\n    `, this.#shadow, {host: this});\n    // clang-format on\n  }\n\n  async #renderMainFrameInformation(): Promise<Lit.TemplateResult> {\n    if (!this.#checkedFeature) {\n      await this.#checkFeatureState();\n    }\n\n    if (this.#screenStatus === ScreenStatusType.DISABLED) {\n      const mitigationsFlagLink = new ChromeLink.ChromeLink.ChromeLink();\n      mitigationsFlagLink.href = 'chrome://flags/#bounce-tracking-mitigations' as Platform.DevToolsPath.UrlString;\n      mitigationsFlagLink.textContent = i18nString(UIStrings.featureFlag);\n\n      // clang-format off\n      return html`\n        <devtools-report-section>\n          ${i18n.i18n.getFormatLocalizedString(\n              str_, UIStrings.featureDisabled,\n              {PH1: mitigationsFlagLink})}\n        </devtools-report-section>\n      `;\n      // clang-format on\n    }\n\n    // clang-format off\n    return html`\n      <devtools-report-section>\n        ${this.#renderForceRunButton()}\n      </devtools-report-section>\n      ${this.#renderDeletedSitesOrNoSitesMessage()}\n      <devtools-report-divider>\n      </devtools-report-divider>\n      <devtools-report-section>\n        <x-link href=\"https://privacycg.github.io/nav-tracking-mitigations/#bounce-tracking-mitigations\" class=\"link\"\n        jslog=${VisualLogging.link('learn-more').track({click: true})}>\n          ${i18nString(UIStrings.learnMore)}\n        </x-link>\n      </devtools-report-section>\n    `;\n    // clang-format on\n  }\n\n  #renderForceRunButton(): Lit.TemplateResult {\n    const isMitigationRunning = (this.#screenStatus === ScreenStatusType.RUNNING);\n\n    // clang-format off\n    return html`\n      <devtools-button\n        aria-label=${i18nString(UIStrings.forceRun)}\n        .disabled=${isMitigationRunning}\n        .spinner=${isMitigationRunning}\n        .variant=${Buttons.Button.Variant.PRIMARY}\n        @click=${this.#runMitigations}\n        jslog=${VisualLogging.action('force-run').track({click: true})}>\n        ${isMitigationRunning ? html`\n          ${i18nString(UIStrings.runningMitigations)}`:`\n          ${i18nString(UIStrings.forceRun)}\n        `}\n      </devtools-button>\n    `;\n    // clang-format on\n  }\n\n  #renderDeletedSitesOrNoSitesMessage(): Lit.TemplateResult {\n    if (!this.#seenButtonClick) {\n      return html``;\n    }\n\n    if (this.#trackingSites.length === 0) {\n      // clang-format off\n      return html`\n        <devtools-report-section>\n        ${(this.#screenStatus === ScreenStatusType.RUNNING) ? html`\n          ${i18nString(UIStrings.checkingPotentialTrackers)}`:`\n          ${i18nString(UIStrings.noPotentialBounceTrackersIdentified)}\n        `}\n        </devtools-report-section>\n      `;\n      // clang-format on\n    }\n\n    // clang-format off\n    return html`\n      <devtools-report-section>\n        <devtools-data-grid striped inline>\n          <table>\n            <tr>\n              <th id=\"sites\" weight=\"10\" sortable>\n                ${i18nString(UIStrings.stateDeletedFor)}\n              </th>\n            </tr>\n            ${this.#trackingSites.map(site => html`\n              <tr><td>${site}</td></tr>`)}\n          </table>\n        </devtools-data-grid>\n      </devtools-report-section>\n    `;\n    // clang-format on\n  }\n\n  async #runMitigations(): Promise<void> {\n    const mainTarget = SDK.TargetManager.TargetManager.instance().primaryPageTarget();\n    if (!mainTarget) {\n      return;\n    }\n\n    this.#seenButtonClick = true;\n    this.#screenStatus = ScreenStatusType.RUNNING;\n\n    void this.#render();\n\n    const response = await mainTarget.storageAgent().invoke_runBounceTrackingMitigations();\n    this.#trackingSites = [];\n    response.deletedSites.forEach(element => {\n      this.#trackingSites.push(element);\n    });\n\n    this.#renderMitigationsResult();\n  }\n\n  #renderMitigationsResult(): void {\n    this.#screenStatus = ScreenStatusType.RESULT;\n    void this.#render();\n  }\n\n  async #checkFeatureState(): Promise<void> {\n    this.#checkedFeature = true;\n\n    const mainTarget = SDK.TargetManager.TargetManager.instance().primaryPageTarget();\n    if (!mainTarget) {\n      return;\n    }\n\n    if (!(await mainTarget.systemInfo().invoke_getFeatureState({featureState: 'DIPS'})).featureEnabled) {\n      this.#screenStatus = ScreenStatusType.DISABLED;\n    }\n  }\n}\n\ncustomElements.define('devtools-bounce-tracking-mitigations-view', BounceTrackingMitigationsView);\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'devtools-bounce-tracking-mitigations-view': BounceTrackingMitigationsView;\n  }\n}\n"]}