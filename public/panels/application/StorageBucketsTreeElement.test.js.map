{"version":3,"file":"StorageBucketsTreeElement.test.js","sourceRoot":"","sources":["../../../../../../front_end/panels/application/StorageBucketsTreeElement.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2023 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport {assertNotNullOrUndefined} from '../../core/platform/platform.js';\nimport * as Root from '../../core/root/root.js';\nimport * as SDK from '../../core/sdk/sdk.js';\nimport * as Protocol from '../../generated/protocol.js';\nimport {\n  createTarget,\n  stubNoopSettings,\n} from '../../testing/EnvironmentHelpers.js';\nimport {describeWithMockConnection} from '../../testing/MockConnection.js';\nimport * as UI from '../../ui/legacy/legacy.js';\n\nimport * as Application from './application.js';\n\nconst {assert} = chai;\n\ndescribeWithMockConnection('StorageBucketsTreeElement', function() {\n  const tests = (targetFactory: () => SDK.Target.Target) => {\n    let target: SDK.Target.Target;\n    let storageKeyManager: SDK.StorageKeyManager.StorageKeyManager;\n    let storageBucketsModel: SDK.StorageBucketsModel.StorageBucketsModel|null;\n\n    const STORAGE_KEYS: string[] = [\n      'storagekey1',\n      'storagekey2',\n      'storagekey3',\n    ];\n\n    const STORAGE_BUCKET_INFOS: Protocol.Storage.StorageBucketInfo[] = [\n      {\n        bucket: {\n          storageKey: STORAGE_KEYS[0],\n        },\n        id: '0',\n        expiration: 0,\n        quota: 0,\n        persistent: false,\n        durability: Protocol.Storage.StorageBucketsDurability.Strict,\n      },\n      {\n        bucket: {\n          storageKey: STORAGE_KEYS[0],\n          name: 'bucket1',\n        },\n        id: '1',\n        expiration: 0,\n        quota: 0,\n        persistent: false,\n        durability: Protocol.Storage.StorageBucketsDurability.Strict,\n      },\n      {\n        bucket: {\n          storageKey: STORAGE_KEYS[1],\n          name: 'bucket2',\n        },\n        id: '2',\n        expiration: 0,\n        quota: 0,\n        persistent: false,\n        durability: Protocol.Storage.StorageBucketsDurability.Strict,\n      },\n      {\n        bucket: {\n          storageKey: STORAGE_KEYS[2],\n          name: 'bucket3',\n        },\n        id: '3',\n        expiration: 0,\n        quota: 0,\n        persistent: false,\n        durability: Protocol.Storage.StorageBucketsDurability.Strict,\n      },\n    ];\n\n    const getBucketsForStorageKeys = (...storageKeys: string[]) => {\n      return STORAGE_BUCKET_INFOS.filter(({bucket}) => storageKeys.includes(bucket.storageKey));\n    };\n\n    const getNonDefaultBuckets = () => {\n      return STORAGE_BUCKET_INFOS.filter(({bucket}) => bucket.name !== undefined);\n    };\n\n    const setStorageBucketTrackingStub = ({storageKey}: {storageKey: string}) => {\n      assertNotNullOrUndefined(storageBucketsModel);\n      for (const bucketInfo of getBucketsForStorageKeys(storageKey)) {\n        storageBucketsModel.storageBucketCreatedOrUpdated({bucketInfo});\n      }\n      return Promise.resolve({\n        getError: () => undefined,\n      });\n    };\n\n    beforeEach(async () => {\n      stubNoopSettings();\n      target = targetFactory();\n      Root.Runtime.experiments.register(Root.Runtime.ExperimentName.PRELOADING_STATUS_PANEL, '', false);\n      Root.Runtime.experiments.register(Root.Runtime.ExperimentName.STORAGE_BUCKETS_TREE, '', false);\n\n      storageKeyManager =\n          target.model(SDK.StorageKeyManager.StorageKeyManager) as SDK.StorageKeyManager.StorageKeyManager;\n      storageBucketsModel = target.model(SDK.StorageBucketsModel.StorageBucketsModel);\n    });\n\n    it('adds bucket tree elements on non default buckets added', async () => {\n      assertNotNullOrUndefined(storageBucketsModel);\n\n      sinon.stub(storageBucketsModel.storageAgent, 'invoke_setStorageBucketTracking')\n          .callsFake(setStorageBucketTrackingStub);\n      storageKeyManager.updateStorageKeys(new Set(STORAGE_KEYS));\n      storageBucketsModel.enable();\n\n      const panel = Application.ResourcesPanel.ResourcesPanel.instance({forceNew: true});\n      panel.markAsRoot();\n      panel.show(document.body);\n\n      const parentTreeElement = new Application.StorageBucketsTreeElement.StorageBucketsTreeParentElement(panel);\n      const appendChildSpy = sinon.spy(parentTreeElement, 'appendChild');\n      parentTreeElement.initialize();\n\n      assert.strictEqual(appendChildSpy.callCount, getNonDefaultBuckets().length);\n\n      panel.detach();\n    });\n\n    it('shows view on select', async () => {\n      assertNotNullOrUndefined(storageBucketsModel);\n\n      const panel = Application.ResourcesPanel.ResourcesPanel.instance({forceNew: true});\n      panel.markAsRoot();\n      panel.show(document.body);\n\n      const treeElement = new Application.StorageBucketsTreeElement.StorageBucketsTreeElement(\n          panel, storageBucketsModel, STORAGE_BUCKET_INFOS[0]);\n\n      const showViewSpy = sinon.spy(treeElement, 'showView');\n\n      document.body.appendChild(treeElement.listItemNode);\n      treeElement.treeOutline = new UI.TreeOutline.TreeOutlineInShadow();\n      treeElement.selectable = true;\n      treeElement.select();\n\n      assert.isTrue(showViewSpy.calledOnce);\n\n      panel.detach();\n    });\n  };\n  describe('without tab target', () => tests(() => createTarget()));\n  describe('with tab target', () => tests(() => {\n                                const tabTarget = createTarget({type: SDK.Target.Type.Tab});\n                                createTarget({parentTarget: tabTarget, subtype: 'prerender'});\n                                return createTarget({parentTarget: tabTarget});\n                              }));\n});\n"]}