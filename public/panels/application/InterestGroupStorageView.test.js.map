{"version":3,"file":"InterestGroupStorageView.test.js","sourceRoot":"","sources":["../../../../../../front_end/panels/application/InterestGroupStorageView.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2022 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Protocol from '../../generated/protocol.js';\nimport {raf} from '../../testing/DOMHelpers.js';\nimport {expectCall} from '../../testing/ExpectStubCall.js';\nimport {describeWithMockConnection} from '../../testing/MockConnection.js';\nimport * as UI from '../../ui/legacy/legacy.js';\n\nimport * as Resources from './application.js';\n\nimport View = Resources.InterestGroupStorageView;\n\nconst events = [\n  {\n    accessTime: 0,\n    type: Protocol.Storage.InterestGroupAccessType.Bid,\n    ownerOrigin: 'https://owner1.com',\n    name: 'cars',\n  },\n  {\n    accessTime: 10,\n    type: Protocol.Storage.InterestGroupAccessType.Join,\n    ownerOrigin: 'https://owner2.com',\n    name: 'trucks',\n  },\n];\n\nclass InterestGroupDetailsGetter {\n  async getInterestGroupDetails(owner: string, name: string): Promise<object|null> {\n    return {\n      ownerOrigin: owner,\n      name,\n      expirationTime: 2,\n      joiningOrigin: 'https://joiner.com',\n      trustedBiddingSignalsKeys: [],\n      ads: [],\n      adComponents: [],\n    };\n  }\n}\n\nclass InterestGroupDetailsGetterFails {\n  async getInterestGroupDetails(_owner: string, _name: string): Promise<object|null> {\n    return null;\n  }\n}\n\ndescribeWithMockConnection('InterestGroupStorageView', () => {\n  it('records events', () => {\n    const view = new View.InterestGroupStorageView(new InterestGroupDetailsGetter());\n    events.forEach(event => {\n      view.addEvent(event);\n    });\n    assert.deepEqual(view.getEventsForTesting(), events);\n  });\n\n  it('ignores duplicates', () => {\n    const view = new View.InterestGroupStorageView(new InterestGroupDetailsGetter());\n    events.forEach(event => {\n      view.addEvent(event);\n    });\n    view.addEvent(events[0]);\n    assert.deepEqual(view.getEventsForTesting(), events);\n  });\n\n  it('initially has placeholder sidebar', () => {\n    const view = new View.InterestGroupStorageView(new InterestGroupDetailsGetter());\n    assert.notInstanceOf(view.sidebarWidget(), UI.SearchableView.SearchableView);\n\n    const placeholder = view.sidebarWidget()?.contentElement;\n    assert.deepEqual(\n        placeholder?.textContent,\n        'No interest group selectedSelect any interest group event to display the group\\'s current state');\n  });\n\n  it(\n      'updates sidebarWidget upon receiving cellFocusedEvent when InterestGroupGetter succeeds', async function() {\n        const view = new View.InterestGroupStorageView(new InterestGroupDetailsGetter());\n        events.forEach(event => {\n          view.addEvent(event);\n        });\n        const grid = view.getInterestGroupGridForTesting();\n        const spy = sinon.spy(view, 'setSidebarWidget');\n        sinon.assert.notCalled(spy);\n        grid.dispatchEvent(new CustomEvent('select', {detail: events[0]}));\n        await raf();\n        sinon.assert.calledOnce(spy);\n        assert.instanceOf(view.sidebarWidget(), UI.SearchableView.SearchableView);\n      });\n\n  it('Clears sidebarWidget upon receiving cellFocusedEvent on an additionalBid-type events', async function() {\n    if (this.timeout() > 0) {\n      this.timeout(10000);\n    }\n\n    for (const eventType\n             of [Protocol.Storage.InterestGroupAccessType.AdditionalBid,\n                 Protocol.Storage.InterestGroupAccessType.AdditionalBidWin,\n                 Protocol.Storage.InterestGroupAccessType.TopLevelAdditionalBid]) {\n      const view = new View.InterestGroupStorageView(new InterestGroupDetailsGetter());\n      events.forEach(event => {\n        view.addEvent(event);\n      });\n      const grid = view.getInterestGroupGridForTesting();\n      const sideBarUpdateDone = expectCall(sinon.stub(view, 'sidebarUpdatedForTesting'));\n      const spy = sinon.spy(view, 'setSidebarWidget');\n      sinon.assert.notCalled(spy);\n      grid.dispatchEvent(new CustomEvent('select', {detail: {...events[0], type: eventType}}));\n      await sideBarUpdateDone;\n      sinon.assert.calledOnce(spy);\n      assert.notInstanceOf(view.sidebarWidget(), UI.SearchableView.SearchableView);\n      assert.isTrue(view.sidebarWidget()?.contentElement.firstChild?.textContent?.includes('No details'));\n    }\n  });\n\n  it('updates sidebarWidget upon receiving cellFocusedEvent when InterestGroupDetailsGetter failsupdates sidebarWidget upon receiving cellFocusedEvent when InterestGroupDetailsGetter fails',\n     async function() {\n       if (this.timeout() > 0) {\n         this.timeout(10000);\n       }\n\n       const view = new View.InterestGroupStorageView(new InterestGroupDetailsGetterFails());\n       events.forEach(event => {\n         view.addEvent(event);\n       });\n       const grid = view.getInterestGroupGridForTesting();\n       const spy = sinon.spy(view, 'setSidebarWidget');\n       sinon.assert.notCalled(spy);\n       grid.dispatchEvent(new CustomEvent('select', {detail: events[0]}));\n       await raf();\n       sinon.assert.calledOnce(spy);\n       assert.notInstanceOf(view.sidebarWidget(), UI.SearchableView.SearchableView);\n       assert.isTrue(view.sidebarWidget()?.contentElement.firstChild?.textContent?.includes('No details'));\n     });\n\n  it('clears sidebarWidget upon clearEvents', async function() {\n    const view = new View.InterestGroupStorageView(new InterestGroupDetailsGetter());\n    events.forEach(event => {\n      view.addEvent(event);\n    });\n    const grid = view.getInterestGroupGridForTesting();\n    const spy = sinon.spy(view, 'setSidebarWidget');\n    sinon.assert.notCalled(spy);\n    grid.dispatchEvent(new CustomEvent('select', {detail: events[0]}));\n    await raf();\n    sinon.assert.calledOnce(spy);\n    assert.instanceOf(view.sidebarWidget(), UI.SearchableView.SearchableView);\n    view.clearEvents();\n    sinon.assert.calledTwice(spy);\n    assert.notInstanceOf(view.sidebarWidget(), UI.SearchableView.SearchableView);\n    assert.isTrue(view.sidebarWidget()?.contentElement.textContent?.includes(\n        'No interest group selectedSelect any interest group event to display the group\\'s current state'));\n  });\n});\n"]}