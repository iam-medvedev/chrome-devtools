{"version":3,"file":"ScreenshotUtils.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/recorder/models/ScreenshotUtils.ts"],"names":[],"mappings":"AAAA,sCAAsC;AACtC,yEAAyE;AACzE,6BAA6B;AAE7B,OAAO,KAAK,GAAG,MAAM,0BAA0B,CAAC;AAIhD,MAAM,gBAAgB,GAAG,GAAG,CAAC,CAAO,KAAK;AACzC,MAAM,qBAAqB,GAAG,GAAG,CAAC,CAAE,KAAK;AAEzC,KAAK,UAAU,iBAAiB;IAC9B,MAAM,UAAU,GAAG,GAAG,CAAC,aAAa,CAAC,aAAa,CAAC,QAAQ,EAAE,CAAC,iBAAiB,EAAE,CAAC;IAClF,IAAI,CAAC,UAAU,EAAE,CAAC;QAChB,MAAM,IAAI,KAAK,CAAC,4BAA4B,CAAC,CAAC;IAChD,CAAC;IAED,MAAM,EAAC,IAAI,EAAC,GAAG,MAAM,UAAU,CAAC,SAAS,EAAE,CAAC,wBAAwB,CAAC,EAAE,CAAC,CAAC;IACzE,IAAI,CAAC,IAAI,EAAE,CAAC;QACV,sBAAsB;QACtB,OAAO,gFAA8F,CAAC;IACxG,CAAC;IACD,OAAO,CAAC,wBAAwB,GAAG,IAAI,CAAe,CAAC;AACzD,CAAC;AAED,MAAM,CAAC,KAAK,UAAU,gBAAgB,CAAC,IAAgB;IACrD,MAAM,GAAG,GAAG,IAAI,KAAK,EAAE,CAAC;IACxB,MAAM,WAAW,GAAG,IAAI,OAAO,CAAC,OAAO,CAAC,EAAE;QACxC,GAAG,CAAC,MAAM,GAAG,OAAO,CAAC;IACvB,CAAC,CAAC,CAAC;IACH,GAAG,CAAC,GAAG,GAAG,IAAI,CAAC;IACf,MAAM,WAAW,CAAC;IAElB,MAAM,WAAW,GAAG,GAAG,CAAC,KAAK,GAAG,GAAG,CAAC,MAAM,CAAC;IAC3C,MAAM,MAAM,GAAG,IAAI,eAAe,CAC9B,gBAAgB,EAChB,IAAI,CAAC,GAAG,CACJ,qBAAqB,EACrB,gBAAgB,GAAG,WAAW,CAC7B,CAAC,CAAC;IACX,MAAM,OAAO,GAAG,MAAM,CAAC,UAAU,CAAC,IAAI,EAAE,EAAC,kBAAkB,EAAE,IAAI,EAAC,CAAC,CAAC;IACpE,IAAI,CAAC,OAAO,EAAE,CAAC;QACb,MAAM,IAAI,KAAK,CAAC,2BAA2B,CAAC,CAAC;IAC/C,CAAC;IACD,MAAM,MAAM,GAAG,MAAM,iBAAiB,CAAC,GAAG,EAAE;QAC1C,WAAW,EAAE,gBAAgB;QAC7B,aAAa,EAAE,MAAM;KACtB,CAAC,CAAC;IACH,OAAO,CAAC,SAAS,CAAC,MAAM,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC;IAEhC,MAAM,IAAI,GAAG,MAAM,MAAM,CAAC,aAAa,CAAC,EAAC,IAAI,EAAE,WAAW,EAAC,CAAC,CAAC;IAC7D,MAAM,OAAO,GAAG,MAAM,IAAI,OAAO,CAAS,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE;QAC5D,MAAM,MAAM,GAAG,IAAI,UAAU,EAAE,CAAC;QAChC,MAAM,CAAC,SAAS,GAAG,GAAG,EAAE,CAAC,OAAO,CAAC,MAAM,CAAC,MAAgB,CAAC,CAAC;QAC1D,MAAM,CAAC,OAAO,GAAG,MAAM,CAAC;QACxB,MAAM,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC;IAC7B,CAAC,CAAC,CAAC;IACH,OAAO,OAAqB,CAAC;AAC/B,CAAC;AAED,MAAM,CAAC,KAAK,UAAU,cAAc;IAClC,MAAM,IAAI,GAAG,MAAM,iBAAiB,EAAE,CAAC;IACvC,OAAO,MAAM,gBAAgB,CAAC,IAAI,CAAC,CAAC;AACtC,CAAC","sourcesContent":["// Copyright 2023 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as SDK from '../../../core/sdk/sdk.js';\n\nimport type {Screenshot} from './ScreenshotStorage.js';\n\nconst SCREENSHOT_WIDTH = 160;       // px\nconst SCREENSHOT_MAX_HEIGHT = 240;  // px\n\nasync function captureScreenshot(): Promise<Screenshot> {\n  const mainTarget = SDK.TargetManager.TargetManager.instance().primaryPageTarget();\n  if (!mainTarget) {\n    throw new Error('Could not find main target');\n  }\n\n  const {data} = await mainTarget.pageAgent().invoke_captureScreenshot({});\n  if (!data) {\n    // 1x1 px empty image.\n    return 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7' as Screenshot;\n  }\n  return ('data:image/png;base64,' + data) as Screenshot;\n}\n\nexport async function resizeScreenshot(data: Screenshot): Promise<Screenshot> {\n  const img = new Image();\n  const imageLoaded = new Promise(resolve => {\n    img.onload = resolve;\n  });\n  img.src = data;\n  await imageLoaded;\n\n  const aspectRatio = img.width / img.height;\n  const canvas = new OffscreenCanvas(\n      SCREENSHOT_WIDTH,\n      Math.min(\n          SCREENSHOT_MAX_HEIGHT,\n          SCREENSHOT_WIDTH / aspectRatio,\n          ));\n  const context = canvas.getContext('2d', {willReadFrequently: true});\n  if (!context) {\n    throw new Error('Could not create context.');\n  }\n  const bitmap = await createImageBitmap(img, {\n    resizeWidth: SCREENSHOT_WIDTH,\n    resizeQuality: 'high',\n  });\n  context.drawImage(bitmap, 0, 0);\n\n  const blob = await canvas.convertToBlob({type: 'image/png'});\n  const dataUrl = await new Promise<string>((resolve, reject) => {\n    const reader = new FileReader();\n    reader.onloadend = () => resolve(reader.result as string);\n    reader.onerror = reject;\n    reader.readAsDataURL(blob);\n  });\n  return dataUrl as Screenshot;\n}\n\nexport async function takeScreenshot(): Promise<Screenshot> {\n  const data = await captureScreenshot();\n  return await resizeScreenshot(data);\n}\n"]}