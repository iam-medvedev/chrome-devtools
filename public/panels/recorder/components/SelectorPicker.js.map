{"version":3,"file":"SelectorPicker.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/recorder/components/SelectorPicker.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../../core/common/common.js';\nimport * as i18n from '../../../core/i18n/i18n.js';\nimport * as Platform from '../../../core/platform/platform.js';\nimport * as SDK from '../../../core/sdk/sdk.js';\nimport type * as Protocol from '../../../generated/protocol.js';\nimport * as Buttons from '../../../ui/components/buttons/buttons.js';\nimport * as UI from '../../../ui/legacy/legacy.js';\nimport * as Lit from '../../../ui/lit/lit.js';\nimport * as VisualLogging from '../../../ui/visual_logging/visual_logging.js';\nimport * as Models from '../models/models.js';\nimport * as Util from '../util/util.js';\n\nimport selectorPickerStyles from './selectorPicker.css.js';\n\nconst {html} = Lit;\n\nconst BINDING_NAME = 'captureSelectors';\n\nexport class RequestSelectorAttributeEvent extends Event {\n  static readonly eventName = 'requestselectorattribute';\n  send: (attribute?: string) => void;\n\n  constructor(send: (attribute?: string) => void) {\n    super(RequestSelectorAttributeEvent.eventName, {\n      bubbles: true,\n      composed: true,\n    });\n    this.send = send;\n  }\n}\n\nconst UIStrings = {\n  /**\n   * @description The title of a button that allows you to select an element on the page and update CSS/ARIA selectors.\n   */\n  selectorPicker: 'Select an element in the page to update selectors',\n} as const;\nconst str_ = i18n.i18n.registerUIStrings('panels/recorder/components/SelectorPicker.ts', UIStrings);\nconst i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\n\nexport interface ViewInput {\n  active: boolean;\n  disabled: boolean;\n  onClick: (event: MouseEvent) => void;\n}\n\nexport type ViewOutput = object;\n\nexport const DEFAULT_VIEW = (input: ViewInput, _output: ViewOutput, target: HTMLElement): void => {\n  const {active, disabled, onClick} = input;\n  Lit.render(\n      html`\n      <style>${selectorPickerStyles}</style>\n      <devtools-button\n        @click=${onClick}\n        .title=${i18nString(UIStrings.selectorPicker)}\n        class=\"selector-picker\"\n        .size=${Buttons.Button.Size.SMALL}\n        .iconName=${'select-element'}\n        .active=${active}\n        .disabled=${disabled}\n        .variant=${Buttons.Button.Variant.ICON}\n        jslog=${VisualLogging.toggle('selector-picker').track({\n        click: true,\n      })}\n      ></devtools-button>\n    `,\n      target,\n  );\n};\n\nexport class SelectorPicker extends UI.Widget.Widget implements SDK.TargetManager.Observer {\n  #view: typeof DEFAULT_VIEW;\n  #disabled = false;\n  #active = false;\n  #selectorAttribute?: string;\n  readonly #activeMutex = new Common.Mutex.Mutex();\n  readonly #targetMutexes = new Map<SDK.Target.Target, Common.Mutex.Mutex>();\n  readonly #scriptIdentifier = new Map<SDK.Target.Target, Protocol.Page.ScriptIdentifier>();\n\n  onSelectorPicked?: (data: Models.Schema.StepWithSelectors&\n                      Pick<Models.Schema.ClickAttributes, 'offsetX'|'offsetY'>) => void;\n  onAttributeRequested?: (send: (attribute?: string) => void) => void;\n\n  constructor(element?: HTMLElement, view?: typeof DEFAULT_VIEW) {\n    super(element, {useShadowDom: true});\n    this.#view = view || DEFAULT_VIEW;\n  }\n\n  static get #targetManager(): SDK.TargetManager.TargetManager {\n    return SDK.TargetManager.TargetManager.instance();\n  }\n\n  set disabled(disabled: boolean) {\n    this.#disabled = disabled;\n    this.requestUpdate();\n  }\n\n  override performUpdate(): void {\n    this.#view(\n        {\n          active: this.#active,\n          disabled: this.#disabled,\n          onClick: this.#handleClickEvent.bind(this),\n        },\n        {},\n        this.contentElement,\n    );\n  }\n\n  #handleClickEvent(event: MouseEvent): void {\n    event.preventDefault();\n    event.stopPropagation();\n    void this.#toggle();\n  }\n\n  async #toggle(): Promise<void> {\n    if (!this.#active) {\n      return await this.#start();\n    }\n    return await this.#stop();\n  }\n\n  #start = (): Promise<void> => {\n    return this.#activeMutex.run(async () => {\n      if (this.#active) {\n        return;\n      }\n      this.#active = true;\n\n      this.#selectorAttribute = await new Promise<string|undefined>(\n          (resolve, reject) => {\n            const timeout = setTimeout(reject, 1000);\n            if (this.onAttributeRequested) {\n              this.onAttributeRequested(attribute => {\n                clearTimeout(timeout);\n                resolve(attribute);\n              });\n            } else {\n              clearTimeout(timeout);\n              resolve(undefined);\n            }\n          },\n      );\n\n      SelectorPicker.#targetManager.observeTargets(this);\n      this.requestUpdate();\n    });\n  };\n\n  #stop = (): Promise<void> => {\n    return this.#activeMutex.run(async () => {\n      if (!this.#active) {\n        return;\n      }\n      this.#active = false;\n\n      SelectorPicker.#targetManager.unobserveTargets(this);\n      SelectorPicker.#targetManager.targets().map(this.targetRemoved.bind(this));\n\n      this.#selectorAttribute = undefined;\n      this.requestUpdate();\n    });\n  };\n\n  targetAdded(target: SDK.Target.Target): void {\n    if (target.type() !== SDK.Target.Type.FRAME) {\n      return;\n    }\n    let mutex = this.#targetMutexes.get(target);\n    if (!mutex) {\n      mutex = new Common.Mutex.Mutex();\n      this.#targetMutexes.set(target, mutex);\n    }\n    void mutex.run(async () => {\n      await this.#addBindings(target);\n      await this.#injectApplicationScript(target);\n    });\n  }\n\n  targetRemoved(target: SDK.Target.Target): void {\n    const mutex = this.#targetMutexes.get(target);\n    if (!mutex) {\n      return;\n    }\n    void mutex.run(async () => {\n      try {\n        await this.#injectCleanupScript(target);\n        await this.#removeBindings(target);\n      } catch {\n      }\n    });\n  }\n\n  #handleBindingCalledEvent = (\n      event: Common.EventTarget.EventTargetEvent<Protocol.Runtime.BindingCalledEvent>,\n      ): void => {\n    if (event.data.name !== BINDING_NAME) {\n      return;\n    }\n    const contextId = event.data.executionContextId;\n    const frames = SDK.TargetManager.TargetManager.instance().targets();\n    const contextTarget = Models.SDKUtils.findTargetByExecutionContext(\n        frames,\n        contextId,\n    );\n    const frameId = Models.SDKUtils.findFrameIdByExecutionContext(\n        frames,\n        contextId,\n    );\n    if (!contextTarget || !frameId) {\n      throw new Error(\n          `No execution context found for the binding call + ${\n              JSON.stringify(\n                  event.data,\n                  )}`,\n      );\n    }\n    const model = contextTarget.model(SDK.ResourceTreeModel.ResourceTreeModel);\n    if (!model) {\n      throw new Error(\n          `ResourceTreeModel instance is missing for the target: ${contextTarget.id()}`,\n      );\n    }\n    const frame = model.frameForId(frameId);\n    if (!frame) {\n      throw new Error('Frame is not found');\n    }\n    if (this.onSelectorPicked) {\n      this.onSelectorPicked({\n        ...JSON.parse(event.data.payload),\n        ...Models.SDKUtils.getTargetFrameContext(contextTarget, frame),\n      });\n    }\n    void this.#stop();\n  };\n\n  async #injectApplicationScript(target: SDK.Target.Target): Promise<void> {\n    const injectedScript = await Util.InjectedScript.get();\n    const script = `${injectedScript};DevToolsRecorder.startSelectorPicker({getAccessibleName, getAccessibleRole}, ${\n        JSON.stringify(this.#selectorAttribute ? this.#selectorAttribute : undefined)}, ${Util.isDebugBuild})`;\n    const [{identifier}] = await Promise.all([\n      target.pageAgent().invoke_addScriptToEvaluateOnNewDocument({\n        source: script,\n        worldName: Util.DEVTOOLS_RECORDER_WORLD_NAME,\n        includeCommandLineAPI: true,\n      }),\n      Models.SDKUtils.evaluateInAllFrames(Util.DEVTOOLS_RECORDER_WORLD_NAME, target, script),\n    ]);\n    this.#scriptIdentifier.set(target, identifier);\n  }\n\n  async #injectCleanupScript(target: SDK.Target.Target): Promise<void> {\n    const identifier = this.#scriptIdentifier.get(target);\n    Platform.assertNotNullOrUndefined(identifier);\n    this.#scriptIdentifier.delete(target);\n    await target.pageAgent().invoke_removeScriptToEvaluateOnNewDocument({identifier});\n    const script = 'DevToolsRecorder.stopSelectorPicker()';\n    await Models.SDKUtils.evaluateInAllFrames(Util.DEVTOOLS_RECORDER_WORLD_NAME, target, script);\n  }\n\n  async #addBindings(target: SDK.Target.Target): Promise<void> {\n    const model = target.model(SDK.RuntimeModel.RuntimeModel);\n    Platform.assertNotNullOrUndefined(model);\n    model.addEventListener(SDK.RuntimeModel.Events.BindingCalled, this.#handleBindingCalledEvent);\n    await model.addBinding({\n      name: BINDING_NAME,\n      executionContextName: Util.DEVTOOLS_RECORDER_WORLD_NAME,\n    });\n  }\n\n  async #removeBindings(target: SDK.Target.Target): Promise<void> {\n    await target.runtimeAgent().invoke_removeBinding({name: BINDING_NAME});\n    const model = target.model(SDK.RuntimeModel.RuntimeModel);\n    Platform.assertNotNullOrUndefined(model);\n    model.removeEventListener(SDK.RuntimeModel.Events.BindingCalled, this.#handleBindingCalledEvent);\n  }\n\n  override wasShown(): void {\n    super.wasShown();\n    this.requestUpdate();\n  }\n\n  override wasHidden(): void {\n    super.wasHidden();\n    void this.#stop();\n  }\n}\n"]}