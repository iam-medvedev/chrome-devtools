{"version":3,"file":"RecordingView.test.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/recorder/components/RecordingView.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2023 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Host from '../../../core/host/host.js';\nimport {\n  describeWithEnvironment,\n  setupActionRegistry,\n} from '../../../testing/EnvironmentHelpers.js';\nimport {expectCall} from '../../../testing/ExpectStubCall.js';\nimport {createViewFunctionStub, type ViewFunctionStub} from '../../../testing/ViewFunctionHelpers.js';\nimport * as Menus from '../../../ui/components/menus/menus.js';\nimport * as Converters from '../converters/converters.js';\nimport * as Models from '../models/models.js';\n\nimport * as Components from './components.js';\n\ndescribeWithEnvironment('RecordingView', () => {\n  setupActionRegistry();\n\n  const step = {type: Models.Schema.StepType.Scroll as const};\n  const section = {title: 'test', steps: [step], url: 'https://example.com'};\n  const userFlow = {title: 'test', steps: [step]};\n  const recorderSettingsMock = {\n    preferredCopyFormat: Models.ConverterIds.ConverterIds.JSON,\n  } as Models.RecorderSettings.RecorderSettings;\n  const views: Components.RecordingView.RecordingView[] = [];\n\n  afterEach(() => {\n    // Unregister global listeners in willHide to prevent leaks.\n    for (const view of views) {\n      view.willHide();\n    }\n  });\n\n  async function createView(output?: Components.RecordingView.ViewOutput): Promise<\n      [ViewFunctionStub<typeof Components.RecordingView.RecordingView>, Components.RecordingView.RecordingView]> {\n    const view = createViewFunctionStub(Components.RecordingView.RecordingView, output);\n    const component = new Components.RecordingView.RecordingView(undefined, view);\n    Object.assign(component, {\n      replayState: {isPlaying: false, isPausedOnBreakpoint: false},\n      isRecording: false,\n      recordingTogglingInProgress: false,\n      recording: userFlow,\n      currentStep: undefined,\n      currentError: undefined,\n      sections: [section],\n      settings: undefined,\n      recorderSettings: recorderSettingsMock,\n      lastReplayResult: undefined,\n      replayAllowed: true,\n      breakpointIndexes: new Set(),\n      builtInConverters: [\n        new Converters.JSONConverter.JSONConverter('  '),\n        new Converters.PuppeteerReplayConverter.PuppeteerReplayConverter('  '),\n      ],\n      extensionConverters: [],\n      replayExtensions: [],\n    });\n    component.wasShown();\n    views.push(component);\n    await view.nextInput;\n    return [view, component];\n  }\n\n  it('should show code and highlight on hover', async () => {\n    const output = {\n      highlightLinesInEditor: sinon.stub(),\n    };\n    const [view] = await createView(output);\n    view.input.showCodeToggle();\n    const input = await view.nextInput;\n    assert.deepEqual(input.editorState?.selection.toJSON(), {\n      ranges: [{anchor: 0, head: 0}],\n      main: 0,\n    });\n    const highlightCalled = expectCall(output.highlightLinesInEditor);\n    view.input.onStepHover({\n      target: {\n        step,\n      },\n    } as unknown as MouseEvent);\n    const [line, length, scroll] = await highlightCalled;\n    assert.strictEqual(line, 3);\n    assert.strictEqual(length, 3);\n    assert.isFalse(scroll);\n  });\n\n  it('should close code view', async () => {\n    const [view] = await createView();\n\n    view.input.showCodeToggle();\n    {\n      const input = await view.nextInput;\n      assert.isOk(input.showCodeView);\n    }\n\n    view.input.showCodeToggle();\n    {\n      const input = await view.nextInput;\n      assert.isNotOk(input.showCodeView);\n    }\n  });\n\n  it('should copy the recording to clipboard via copy event', async () => {\n    await createView();\n    const clipboardData = new DataTransfer();\n    const copyText = expectCall(sinon.stub(\n        Host.InspectorFrontendHost.InspectorFrontendHostInstance,\n        'copyText',\n        ));\n    const event = new ClipboardEvent('copy', {clipboardData, bubbles: true});\n\n    document.body.dispatchEvent(event);\n\n    const [text] = await copyText;\n\n    assert.strictEqual(JSON.stringify(userFlow, null, 2) + '\\n', text);\n  });\n\n  it('should copy a step to clipboard via copy event', async () => {\n    const [view] = await createView();\n    view.input.onStepClick({\n      target: {\n        step,\n      },\n      stopPropagation: sinon.stub(),\n    } as unknown as MouseEvent);\n\n    const clipboardData = new DataTransfer();\n    const isCalled = sinon.promise();\n    const copyText = sinon\n                         .stub(\n                             Host.InspectorFrontendHost.InspectorFrontendHostInstance,\n                             'copyText',\n                             )\n                         .callsFake(() => {\n                           void isCalled.resolve(true);\n                         });\n    const event = new ClipboardEvent('copy', {clipboardData, bubbles: true});\n\n    document.body.dispatchEvent(event);\n\n    await isCalled;\n\n    sinon.assert.calledWith(copyText, JSON.stringify(step, null, 2) + '\\n');\n  });\n\n  it('should copy a step to clipboard via custom event', async () => {\n    const [view] = await createView();\n    const isCalled = sinon.promise();\n    const copyText = sinon\n                         .stub(\n                             Host.InspectorFrontendHost.InspectorFrontendHostInstance,\n                             'copyText',\n                             )\n                         .callsFake(() => {\n                           void isCalled.resolve(true);\n                         });\n    const event = new Components.StepView.CopyStepEvent(step);\n\n    view.input.onCopyStep(event);\n\n    await isCalled;\n\n    sinon.assert.calledWith(copyText, JSON.stringify(step, null, 2) + '\\n');\n  });\n\n  it('should show code and change preferred copy method', async () => {\n    const [view] = await createView();\n\n    view.input.showCodeToggle();\n    {\n      const input = await view.nextInput;\n      assert.isOk(input.showCodeView);\n    }\n\n    view.input.onCodeFormatChange(\n        new Menus.SelectMenu.SelectMenuItemSelectedEvent(Models.ConverterIds.ConverterIds.REPLAY));\n    {\n      const input = await view.nextInput;\n      assert.strictEqual(input.recorderSettings?.preferredCopyFormat, Models.ConverterIds.ConverterIds.REPLAY);\n      assert.strictEqual(recorderSettingsMock.preferredCopyFormat, Models.ConverterIds.ConverterIds.REPLAY);\n    }\n  });\n});\n"]}