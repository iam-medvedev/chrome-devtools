{"version":3,"file":"PromptBuilder.js","sourceRoot":"","sources":["../../../../../../front_end/panels/explain/PromptBuilder.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2023 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Root from '../../core/root/root.js';\nimport * as SDK from '../../core/sdk/sdk.js';\nimport * as Bindings from '../../models/bindings/bindings.js';\nimport * as Formatter from '../../models/formatter/formatter.js';\nimport * as Logs from '../../models/logs/logs.js';\nimport * as Components from '../../ui/legacy/components/utils/utils.js';\nimport type * as Console from '../console/console.js';\n\nconst MAX_CODE_SIZE = 1000;\n\n// TODO(crbug.com/1167717): Make this a const enum again\n// eslint-disable-next-line rulesdir/const_enum\nexport enum SourceType {\n  MESSAGE = 'message',\n  STACKTRACE = 'stacktrace',\n  NETWORK_REQUEST = 'networkRequest',\n  RELATED_CODE = 'relatedCode',\n  SEARCH_ANSWERS = 'searchAnswers',\n}\n\nexport interface Source {\n  type: SourceType;\n  value: string;\n}\n\nexport class PromptBuilder {\n  #consoleMessage: Console.ConsoleViewMessage.ConsoleViewMessage;\n  #cachedSearchResults?: string;\n\n  constructor(consoleMessage: Console.ConsoleViewMessage.ConsoleViewMessage) {\n    this.#consoleMessage = consoleMessage;\n  }\n\n  async getSearchAnswers(): Promise<string> {\n    if (this.#cachedSearchResults !== undefined) {\n      return this.#cachedSearchResults;\n    }\n    const apiKey = Root.Runtime.Runtime.queryParam('aidaApiKey');\n    if (!apiKey) {\n      return '';\n    }\n    const consoleMessage = this.#consoleMessage.consoleMessage().messageText;\n    const response = await fetch(`https://customsearch.googleapis.com/customsearch/v1?cx=f499de4cd70e644b1&key=${\n        apiKey}&q=\"${encodeURIComponent(consoleMessage)}\"`);\n    const parsedResponse = await response.json();\n    const result = [];\n    for (const item of parsedResponse.items || []) {\n      if (!item.pagemap?.question?.length || !item.pagemap?.answer) {\n        continue;\n      }\n      for (let i = 0; i < Math.min(item.pagemap?.answer?.length, 3); ++i) {\n        result.push('  * ' + item.pagemap?.answer[i].text);\n      }\n      if (result.length >= 4) {\n        break;\n      }\n    }\n    this.#cachedSearchResults = result.join('\\n');\n    return this.#cachedSearchResults;\n  }\n\n  async getNetworkRequest(): Promise<SDK.NetworkRequest.NetworkRequest|undefined> {\n    const requestId = this.#consoleMessage.consoleMessage().getAffectedResources()?.requestId;\n    if (!requestId) {\n      return;\n    }\n    const log = Logs.NetworkLog.NetworkLog.instance();\n    // TODO: we might try handling redirect requests too later.\n    return log.requestsForId(requestId)[0];\n  }\n\n  /**\n   * Gets the source file associated with the top of the message's stacktrace.\n   * Returns an empty string if the source is not available for any reasons.\n   */\n  async getMessageSourceCode(): Promise<{text: string, columnNumber: number, lineNumber: number}> {\n    const callframe = this.#consoleMessage.consoleMessage().stackTrace?.callFrames[0];\n    const runtimeModel = this.#consoleMessage.consoleMessage().runtimeModel();\n    const debuggerModel = runtimeModel?.debuggerModel();\n    if (!debuggerModel || !runtimeModel || !callframe) {\n      return {text: '', columnNumber: 0, lineNumber: 0};\n    }\n    const rawLocation =\n        new SDK.DebuggerModel.Location(debuggerModel, callframe.scriptId, callframe.lineNumber, callframe.columnNumber);\n    const mappedLocation =\n        await Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().rawLocationToUILocation(\n            rawLocation);\n    const content = await mappedLocation?.uiSourceCode.requestContent();\n    const text = !content?.isEncoded && content?.content ? content.content : '';\n    const firstNewline = text.indexOf('\\n');\n    if (text.length > MAX_CODE_SIZE && (firstNewline < 0 || firstNewline > MAX_CODE_SIZE)) {\n      // Use formatter\n      const {formattedContent, formattedMapping} = await Formatter.ScriptFormatter.formatScriptContent(\n          mappedLocation?.uiSourceCode.mimeType() ?? 'text/javascript', text);\n      const [lineNumber, columnNumber] =\n          formattedMapping.originalToFormatted(mappedLocation?.lineNumber ?? 0, mappedLocation?.columnNumber ?? 0);\n      return {text: formattedContent, columnNumber, lineNumber};\n    }\n    return {text, columnNumber: mappedLocation?.columnNumber ?? 0, lineNumber: mappedLocation?.lineNumber ?? 0};\n  }\n\n  async buildPrompt(sourcesTypes: SourceType[] = Object.values(SourceType)):\n      Promise<{prompt: string, sources: Source[]}> {\n    const [sourceCode, request, searchAnswers] = await Promise.all([\n      sourcesTypes.includes(SourceType.RELATED_CODE) ? this.getMessageSourceCode() : undefined,\n      sourcesTypes.includes(SourceType.NETWORK_REQUEST) ? this.getNetworkRequest() : undefined,\n      sourcesTypes.includes(SourceType.SEARCH_ANSWERS) ? this.getSearchAnswers() : '',\n    ]);\n\n    const relatedCode = sourceCode?.text ? formatRelatedCode(sourceCode) : '';\n    const relatedRequest = request ? formatNetworkRequest(request) : '';\n    const stacktrace = sourcesTypes.includes(SourceType.STACKTRACE) ? formatStackTrace(this.#consoleMessage) : '';\n\n    const message = formatConsoleMessage(this.#consoleMessage);\n\n    const prompt = this.formatPrompt({\n      message: [message, stacktrace].join('\\n').trim(),\n      relatedCode,\n      relatedRequest,\n      searchAnswers,\n    });\n\n    const sources = [\n      {\n        type: SourceType.MESSAGE,\n        value: message,\n      },\n    ];\n\n    if (stacktrace) {\n      sources.push({\n        type: SourceType.STACKTRACE,\n        value: stacktrace,\n      });\n    }\n\n    if (relatedCode) {\n      sources.push({\n        type: SourceType.RELATED_CODE,\n        value: relatedCode,\n      });\n    }\n\n    if (relatedRequest) {\n      sources.push({\n        type: SourceType.NETWORK_REQUEST,\n        value: relatedRequest,\n      });\n    }\n\n    if (searchAnswers) {\n      sources.push({\n        type: SourceType.SEARCH_ANSWERS,\n        value: searchAnswers,\n      });\n    }\n\n    return {\n      prompt,\n      sources,\n    };\n  }\n\n  formatPrompt({message, relatedCode, relatedRequest, searchAnswers}:\n                   {message: string, relatedCode: string, relatedRequest: string, searchAnswers: string}): string {\n    const messageHeader = '### Console message:';\n    const relatedCodeHeader = '### Code that generated the error:';\n    const relatedRequestHeader = '### Related network request:';\n    const searchAnswersHeader = '### Suggestions:';\n    const explanationHeader = '### Summary:';\n\n    const preamble = `\nYou are an expert software engineer looking at a console message in DevTools.\n\nYou will follow these rules strictly:\n- Answer the question as truthfully as possible using the provided context\n- if you don't have the answer, say \"I don't know\" and suggest looking for this information\n  elsewhere\n- Start with the explanation immediately without repeating the given console message.\n- Always wrap code with three backticks (\\`\\`\\`)`;\n\n    const fewShotExamples = [\n      {\n        message: `Uncaught TypeError: Cannot read properties of undefined (reading 'setState') at home.jsx:15\n    at delta (home.jsx:15:14)\n    at Object.Dc (react-dom.production.min.js:54:317)\n    at Fc (react-dom.production.min.js:54:471)\n    at jc (react-dom.production.min.js:55:35)\n    at ai (react-dom.production.min.js:105:68)\n    at Ks (react-dom.production.min.js:106:380)\n    at react-dom.production.min.js:117:104\n    at Pu (react-dom.production.min.js:274:42)\n    at vs (react-dom.production.min.js:52:375)\n    at Dl (react-dom.production.min.js:109:469)\ndelta @ home.jsx:15\n\n\nDc @ react-dom.production.min.js:54\nFc @ react-dom.production.min.js:54\njc @ react-dom.production.min.js:55\nai @ react-dom.production.min.js:105\nKs @ react-dom.production.min.js:106\n(anonymous) @ react-dom.production.min.js:117\nPu @ react-dom.production.min.js:274\nvs @ react-dom.production.min.js:52\nDl @ react-dom.production.min.js:109\neu @ react-dom.production.min.js:74\nbc @ react-dom.production.min.js:73`,\n\n        relatedCode: `class Counter extends React.Component {\n    constructor(props) {\n        super(props);\n\n        this.state = {\n            count : 1\n        };\n\n        this.delta.bind(this);\n    }\n\n    delta() {\n        this.setState({\n            count : this.state.count++\n        });\n    }\n\n    render() {\n        return (\n            <div>\n                <h1>{this.state.count}</h1>\n                <button onClick={this.delta}>+</button>\n            </div>\n        );\n    }\n}`,\n        searchAnswers:\n            `- This is due to this.delta not being bound to this. In order to bind set this.delta = this.delta.bind(this) in the constructor: constructor(props) { super(props); this.state = { count : 1 };...\n- In ES7+ (ES2016) you can use the experimental function bind syntax operator :: to bind. It is a syntactic sugar and will do the same as Davin Tryon's answer. You can then rewrite this.delta...\n- There is a difference of context between ES5 and ES6 class. So, there will be a little difference between the implementations as well. Here is the ES5 version: var Counter = React.createClass({...\n- You dont have to bind anything, Just use Arrow functions like this: class Counter extends React.Component { constructor(props) { super(props); this.state = { count: 1 }; } //ARROW FUNCTION...`,\n\n        explanation:\n            'The error occurs because this.delta is not bound to the instance of the Counter component. The fix is it to change the code to be ` this.delta = this.delta.bind(this);`',\n\n      },\n      {\n        message: `Uncaught TypeError: Cannot set properties of null(setting 'innerHTML')\n        at(index): 57: 49(anonymous) @(index): 57 `,\n\n        relatedCode: `<script>\n      document.getElementById(\"test\").innerHTML = \"Element does not exist\";\n    </script>\n    <div id=\"test\"></div>`,\n\n        searchAnswers:\n            `- You have to place the hello div before the script, so that it exists when the script is loaded.\n- Let us first try to understand the root cause as to why it is happening in first place. Why do I get an error or Uncaught TypeError: Cannot set property 'innerHTML' of null? The browser always...\n- You could tell javascript to perform the action \\\"onload\\\"... Try with this: \\u003cscript type =\\\"text/javascript\\\"\\u003e window.onload = function what(){ document.getElementById('hello').innerHTML = 'hi';...\n- Just put your JS in window.onload window.onload = function() { what(); function what() { document.getElementById('hello').innerHTML = 'hi'; }; }`,\n\n        explanation:\n            'The error means that getElementById returns null instead of the div element. This happens because the script runs before the element is added to the DOM.',\n      },\n      {\n        message: 'Uncaught SyntaxError: Unexpected token \\')\\' (at script.js:39:14)',\n\n        relatedCode: `if (10 < 120)) {\n  console.log('test')\n}`,\n\n        searchAnswers:\n            `- this is the way to re export default import as default export, export {default} from './Component'\n- In your index.js. export default from './component'\"\n- Unexpected token errors in ESLint parsing occur due to incompatibility between your development environment and ESLint's current parsing capabilities with the ongoing changes with JavaScripts...\n- In my case (im using Firebase Cloud Functions) i opened .eslintrc.json and changed: \\\"parserOptions\\\": { // Required for certain syntax usages \\\"ecmaVersion\\\": 2017 }, to: \\\"parserOptions\\\": { //...\"`,\n\n        explanation: 'There is an extra closing `)`. Remove it to fix the issue.',\n      },\n    ];\n\n    const formatExample = (example: {\n      message: string,\n      relatedCode?: string,\n      relatedRequest?: string,\n      searchAnswers?: string, explanation: string,\n    }): string => {\n      const result = [];\n      result.push(messageHeader, example.message);\n      if (relatedCode) {\n        result.push(relatedCodeHeader, '```', example.relatedCode, '```');\n      }\n      if (relatedRequest && example.relatedRequest) {\n        result.push(relatedRequestHeader, example.relatedRequest);\n      }\n      if (searchAnswers) {\n        result.push(searchAnswersHeader, example.searchAnswers);\n      }\n      result.push(explanationHeader, example.explanation);\n      return result.join('\\n');\n    };\n\n    return `${preamble}\n\n${fewShotExamples.map(formatExample).join('\\n\\n')}\n\n${formatExample({message, relatedCode, relatedRequest, searchAnswers, explanation: ''})}`;\n  }\n}\n\nexport function allowHeader(header: SDK.NetworkRequest.NameValue): boolean {\n  const normalizedName = header.name.toLowerCase().trim();\n  // Skip custom headers.\n  if (normalizedName.startsWith('x-')) {\n    return false;\n  }\n  // Skip cookies as they might contain auth.\n  if (normalizedName === 'cookie' || normalizedName === 'set-cookie') {\n    return false;\n  }\n  if (normalizedName === 'authorization') {\n    return false;\n  }\n  return true;\n}\n\nexport function lineWhitespace(line: string): string|null {\n  const matches = /^\\s*/.exec(line);\n  if (!matches || !matches.length) {\n    // This should not happen\n    return null;\n  }\n  const whitespace = matches[0];\n  if (whitespace === line) {\n    return null;\n  }\n  return whitespace;\n}\n\nexport function formatRelatedCode(\n    {text, columnNumber, lineNumber}: {text: string, columnNumber: number, lineNumber: number},\n    maxCodeSize = MAX_CODE_SIZE): string {\n  const lines = text.split('\\n');\n  if (lines[lineNumber].length >= maxCodeSize / 2) {\n    const start = Math.max(columnNumber - maxCodeSize / 2, 0);\n    const end = Math.min(columnNumber + maxCodeSize / 2, lines[lineNumber].length);\n    return lines[lineNumber].substring(start, end);\n  }\n  let relatedCodeSize = 0;\n  let currentLineNumber = lineNumber;\n  let currentWhitespace = lineWhitespace(lines[lineNumber]);\n  const startByPrefix: Map<string, number> = new Map();\n  while (lines[currentLineNumber] !== undefined &&\n         (relatedCodeSize + lines[currentLineNumber].length <= maxCodeSize / 2)) {\n    const whitespace = lineWhitespace(lines[currentLineNumber]);\n    if (whitespace !== null && currentWhitespace !== null &&\n        (whitespace === currentWhitespace || !whitespace.startsWith(currentWhitespace))) {\n      // Don't start on a line that begins with a closing character\n      if (!/^\\s*[\\}\\)\\]]/.exec(lines[currentLineNumber])) {\n        // Update map of where code should start based on its indentation\n        startByPrefix.set(whitespace, currentLineNumber);\n      }\n      currentWhitespace = whitespace;\n    }\n    relatedCodeSize += lines[currentLineNumber].length + 1;\n    currentLineNumber--;\n  }\n  currentLineNumber = lineNumber + 1;\n  let startLine = lineNumber;\n  let endLine = lineNumber;\n  currentWhitespace = lineWhitespace(lines[lineNumber]);\n  while (lines[currentLineNumber] !== undefined && (relatedCodeSize + lines[currentLineNumber].length <= maxCodeSize)) {\n    relatedCodeSize += lines[currentLineNumber].length;\n    const whitespace = lineWhitespace(lines[currentLineNumber]);\n    if (whitespace !== null && currentWhitespace !== null &&\n        (whitespace === currentWhitespace || !whitespace.startsWith(currentWhitespace))) {\n      // We shouldn't end on a line if it is followed by an indented line\n      const nextLine = lines[currentLineNumber + 1];\n      const nextWhitespace = nextLine ? lineWhitespace(nextLine) : null;\n      if (!nextWhitespace || nextWhitespace === whitespace || !nextWhitespace.startsWith(whitespace)) {\n        // Look up where code should start based on its indentation\n        if (startByPrefix.has(whitespace)) {\n          startLine = startByPrefix.get(whitespace) ?? 0;\n          endLine = currentLineNumber;\n        }\n      }\n      currentWhitespace = whitespace;\n    }\n    currentLineNumber++;\n  }\n  return lines.slice(startLine, endLine + 1).join('\\n');\n}\n\nexport function formatNetworkRequest(\n    request:\n        Pick<SDK.NetworkRequest.NetworkRequest, 'url'|'requestHeaders'|'responseHeaders'|'statusCode'|'statusText'>):\n    string {\n  // TODO: anything else that might be relavant?\n  // TODO: handle missing headers\n  return `Request: ${request.url()}\n\nRequest headers:\n${request.requestHeaders().filter(allowHeader).map(header => `${header.name}: ${header.value}`).join('\\n')}\n\nResponse headers:\n${request.responseHeaders.filter(allowHeader).map(header => `${header.name}: ${header.value}`).join('\\n')}\n\nResponse status: ${request.statusCode} ${request.statusText}`;\n}\n\nexport function formatConsoleMessage(message: Console.ConsoleViewMessage.ConsoleViewMessage): string {\n  return message.toMessageTextString();\n}\n\n/**\n * This formats the stacktrace from the console message which might or might not\n * match the content of stacktrace(s) in the console message arguments.\n */\nexport function formatStackTrace(message: Console.ConsoleViewMessage.ConsoleViewMessage): string {\n  const previewContainer = message.contentElement().querySelector('.stack-preview-container');\n\n  if (!previewContainer) {\n    return '';\n  }\n\n  const preview = previewContainer.shadowRoot?.querySelector('.stack-preview-container') as HTMLElement;\n\n  const nodes = preview.childTextNodes();\n  // Gets application-level source mapped stack trace taking the ignore list\n  // into account.\n  const messageContent = nodes\n                             .filter(n => {\n                               return !n.parentElement?.closest('.show-all-link,.show-less-link,.hidden-row');\n                             })\n                             .map(Components.Linkifier.Linkifier.untruncatedNodeText)\n                             .join('');\n  return messageContent.trim();\n}\n"]}