{"version":3,"file":"TimelineDetailsView.test.js","sourceRoot":"","sources":["../../../../../../front_end/panels/timeline/TimelineDetailsView.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2021 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Root from '../../core/root/root.js';\nimport * as Trace from '../../models/trace/trace.js';\nimport {doubleRaf} from '../../testing/DOMHelpers.js';\nimport {describeWithEnvironment} from '../../testing/EnvironmentHelpers.js';\nimport {TraceLoader} from '../../testing/TraceLoader.js';\n\nimport * as Timeline from './timeline.js';\n\nclass MockViewDelegate implements Timeline.TimelinePanel.TimelineModeViewDelegate {\n  select(_selection: Timeline.TimelineSelection.TimelineSelection|null): void {\n  }\n  selectEntryAtTime(_events: Trace.Types.Events.Event[]|null, _time: number): void {\n  }\n  highlightEvent(_event: Trace.Types.Events.Event|null): void {\n  }\n  element = document.createElement('div');\n}\n\ndescribeWithEnvironment('TimelineDetailsView', function() {\n  const mockViewDelegate = new MockViewDelegate();\n\n  it('displays the details of a network request event correctly', async function() {\n    const {parsedTrace, insights} = await TraceLoader.traceEngine(this, 'lcp-web-font.json.gz');\n    const detailsView = new Timeline.TimelineDetailsView.TimelineDetailsView(mockViewDelegate);\n\n    const networkRequests = parsedTrace.NetworkRequests.byTime;\n    const cssRequest = networkRequests.find(request => {\n      return request.args.data.url === 'https://chromedevtools.github.io/performance-stories/lcp-web-font/app.css';\n    });\n    if (!cssRequest) {\n      throw new Error('Could not find expected network request.');\n    }\n    const selection = Timeline.TimelineSelection.selectionFromEvent(cssRequest);\n\n    await detailsView.setModel(\n        {parsedTrace, selectedEvents: null, traceInsightsSets: insights, eventToRelatedInsightsMap: null});\n    await detailsView.setSelection(selection);\n\n    const detailsContentElement = detailsView.getDetailsContentElementForTest();\n    // NetworkRequestDetails and RelatedInsightsChips nodes.\n    assert.strictEqual(detailsContentElement.childNodes.length, 2);\n  });\n\n  it('displays the details for a frame correctly', async function() {\n    const {parsedTrace} = await TraceLoader.traceEngine(this, 'web-dev-with-commit.json.gz');\n    const detailsView = new Timeline.TimelineDetailsView.TimelineDetailsView(mockViewDelegate);\n    await detailsView.setModel(\n        {parsedTrace, selectedEvents: null, traceInsightsSets: null, eventToRelatedInsightsMap: null});\n\n    const frame = parsedTrace.Frames.frames.at(0);\n    assert.isOk(frame);\n    const selection = Timeline.TimelineSelection.selectionFromEvent(frame);\n    await detailsView.setSelection(selection);\n    await doubleRaf();  // to let the image be fetched + rendered.\n    const detailsContentElement = detailsView.getDetailsContentElementForTest();\n    const frameImg = detailsContentElement.querySelector('.timeline-filmstrip-preview img');\n    assert.instanceOf(frameImg, HTMLImageElement);\n    assert.isDefined(frameImg.src);\n\n    const duration = detailsContentElement.querySelector<HTMLElement>('[data-row-title=\"Duration\"]');\n    assert.isOk(duration);\n    assert.strictEqual(duration.innerText, 'Duration37.85 ms (at 109.82 ms)');\n  });\n\n  it('renders the layout shift component for a single layout shift', async function() {\n    Root.Runtime.experiments.enableForTest(Root.Runtime.ExperimentName.TIMELINE_INSIGHTS);\n\n    const {parsedTrace} = await TraceLoader.traceEngine(this, 'shift-attribution.json.gz');\n    const detailsView = new Timeline.TimelineDetailsView.TimelineDetailsView(mockViewDelegate);\n    await detailsView.setModel(\n        {parsedTrace, selectedEvents: null, traceInsightsSets: null, eventToRelatedInsightsMap: null});\n\n    const layoutShift = parsedTrace.LayoutShifts.clusters.at(0)?.events.at(0);\n    assert.isOk(layoutShift);\n    const selection = Timeline.TimelineSelection.selectionFromEvent(layoutShift);\n    await detailsView.setSelection(selection);\n    const detailsContentElement = detailsView.getDetailsContentElementForTest();\n    // Assert that the right component is rendered. This component has its own\n    // tests for its contents so no need to duplicate those here.\n    const layoutShiftDetails = detailsContentElement.querySelector('devtools-performance-layout-shift-details');\n    assert.isNotNull(layoutShiftDetails);\n  });\n\n  it('renders the layout shift component for a selected cluster', async function() {\n    Root.Runtime.experiments.enableForTest(Root.Runtime.ExperimentName.TIMELINE_INSIGHTS);\n\n    const {parsedTrace} = await TraceLoader.traceEngine(this, 'shift-attribution.json.gz');\n    const detailsView = new Timeline.TimelineDetailsView.TimelineDetailsView(mockViewDelegate);\n    await detailsView.setModel(\n        {parsedTrace, selectedEvents: null, traceInsightsSets: null, eventToRelatedInsightsMap: null});\n\n    const layoutShiftCluster = parsedTrace.LayoutShifts.clusters.at(0);\n    assert.isOk(layoutShiftCluster);\n    const selection = Timeline.TimelineSelection.selectionFromEvent(layoutShiftCluster);\n    await detailsView.setSelection(selection);\n    const detailsContentElement = detailsView.getDetailsContentElementForTest();\n    // Assert that the right component is rendered. This component has its own\n    // tests for its contents so no need to duplicate those here.\n    const layoutShiftDetails = detailsContentElement.querySelector('devtools-performance-layout-shift-details');\n    assert.isNotNull(layoutShiftDetails);\n  });\n\n  it('updates the range details when the user has a range selected', async function() {\n    const {parsedTrace} = await TraceLoader.traceEngine(this, 'web-dev-with-commit.json.gz');\n    const detailsView = new Timeline.TimelineDetailsView.TimelineDetailsView(mockViewDelegate);\n    await detailsView.setModel({\n      parsedTrace,\n      // We have to set selected events for the range selection UI to be drawn\n      // (without the set of events we can't generate the range stats)\n      selectedEvents: parsedTrace.Renderer.allTraceEntries,\n      traceInsightsSets: null,\n      eventToRelatedInsightsMap: null,\n    });\n    const bounds = Trace.Helpers.Timing.traceWindowMilliSeconds(parsedTrace.Meta.traceBounds);\n    const selection = Timeline.TimelineSelection.selectionFromRangeMilliSeconds(\n        bounds.min,\n        bounds.max,\n    );\n    await detailsView.setSelection(selection);\n    const detailsContentElement = detailsView.getDetailsContentElementForTest();\n    const component = detailsContentElement.querySelector<HTMLElement>('devtools-performance-timeline-summary');\n    const range = component?.shadowRoot?.querySelector<HTMLElement>('.summary-range');\n    assert.strictEqual(range?.innerText, 'Range:  0 ms – 5.39 s');\n  });\n});\n"]}