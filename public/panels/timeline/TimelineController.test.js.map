{"version":3,"file":"TimelineController.test.js","sourceRoot":"","sources":["../../../../../../front_end/panels/timeline/TimelineController.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2023 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport {renderElementIntoDOM} from '../../../test/unittests/front_end/helpers/DOMHelpers.js';\nimport {describeWithRealConnection} from '../../../test/unittests/front_end/helpers/RealConnection.js';\nimport * as SDK from '../../core/sdk/sdk.js';\nimport type * as TraceEngine from '../../models/trace/trace.js';\n\nimport * as Timeline from './timeline.js';\n\ndescribeWithRealConnection('TimelineController', () => {\n  it('calls the callback methods on the client in the expected order', async function() {\n    // The test needs at least 0.5s to have progress events be sent. Set a higher timeout to avoid flakiness.\n    if (this.timeout() !== 0) {\n      this.timeout(5_000);\n    }\n    const stubs = {\n      recordingProgress: sinon.stub(),\n      loadingStarted: sinon.stub(),\n      processingStarted: sinon.stub(),\n      loadingProgress: sinon.stub(),\n      loadingComplete: sinon.stub().callsFake(function(\n          _collectedEvents: TraceEngine.Types.TraceEvents.TraceEventData[],\n          _tracingModel: TraceEngine.Legacy.TracingModel|null) {}),\n    };\n    const client: Timeline.TimelineController.Client = {\n      recordingProgress(usage) {\n        stubs.recordingProgress(usage);\n      },\n      loadingStarted() {\n        stubs.loadingStarted();\n      },\n      processingStarted() {\n        stubs.processingStarted();\n      },\n      loadingProgress() {\n        stubs.loadingProgress();\n      },\n      async loadingComplete(collectedEvents, tracingModel, _exclusiveFilter) {\n        stubs.loadingComplete(collectedEvents, tracingModel);\n      },\n      loadingCompleteForTest() {},\n    };\n\n    const primaryPage = SDK.TargetManager.TargetManager.instance().primaryPageTarget();\n    if (!primaryPage) {\n      throw new Error('Could not find primary page');\n    }\n    const root = SDK.TargetManager.TargetManager.instance().rootTarget();\n    if (!root) {\n      throw new Error('Could not find root target');\n    }\n\n    const controller = new Timeline.TimelineController.TimelineController(root, primaryPage, client);\n\n    class TestTracingComponent extends HTMLElement {\n      connectedCallback() {\n        const newDiv = document.createElement('div');\n        newDiv.innerHTML = 'testing';\n        this.appendChild(newDiv);\n      }\n    }\n    customElements.define('test-tracing-component', TestTracingComponent);\n    const component = new TestTracingComponent();\n\n    // Start a recording and inject the test component to trigger some trace events.\n    await controller.startRecording({});\n    renderElementIntoDOM(component);\n    // Run the test for at least 0.5s to have progress events be sent.\n    await new Promise(resolve => setTimeout(resolve, 1500));\n    await controller.stopRecording();\n    assert.strictEqual(stubs.processingStarted.callCount, 1);\n    // Depending on the speed of the machine you might get more than 1 progress\n    // call, hence we assert that there is at least one.\n    assert.isAtLeast(stubs.recordingProgress.callCount, 1);\n    assert.strictEqual(stubs.loadingStarted.callCount, 1);\n    assert.isAtLeast(stubs.loadingProgress.callCount, 1);\n    assert.strictEqual(stubs.loadingComplete.callCount, 1);\n    const [collectedEvents, tracingModel] =\n        stubs.loadingComplete.getCall(0)\n            .args as [TraceEngine.Types.TraceEvents.TraceEventData[], TraceEngine.Legacy.TracingModel];\n    assert.isDefined(tracingModel);\n    // Sanity check: ensure that we saw some events during the trace.\n    assert.isTrue(tracingModel.allRawEvents().length > 0);\n    assert.isTrue(collectedEvents.length > 0);\n    assert.strictEqual(collectedEvents.length, tracingModel.allRawEvents().length);\n  });\n});\n"]}