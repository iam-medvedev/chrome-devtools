{"version":3,"file":"Initiators.test.js","sourceRoot":"","sources":["../../../../../../front_end/panels/timeline/Initiators.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2023 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nconst {assert} = chai;\n\nimport {assertNotNullOrUndefined} from '../../core/platform/platform.js';\nimport * as TraceEngine from '../../models/trace/trace.js';\nimport {TraceLoader} from '../../../test/unittests/front_end/helpers/TraceLoader.js';\nimport * as Timeline from './timeline.js';\n\ndescribe('Initiators', () => {\n  it('returns the pair of initiators', async function() {\n    const traceData = await TraceLoader.traceEngine(this, 'set-timeout-long-task.json.gz');\n\n    const timerFireEvent = Array.from(traceData.Initiators.eventToInitiator.keys())\n                               .find(TraceEngine.Types.TraceEvents.isTraceEventTimerFire);\n    assertNotNullOrUndefined(timerFireEvent);\n    const timerInstallEvent = traceData.Initiators.eventToInitiator.get(timerFireEvent);\n    assertNotNullOrUndefined(timerInstallEvent);\n    const initiatorPairs = Timeline.Initiators.eventInitiatorPairsToDraw(traceData, timerFireEvent);\n\n    assert.deepEqual(initiatorPairs, [{\n                       event: timerFireEvent,\n                       initiator: timerInstallEvent,\n                     }]);\n  });\n\n  it('can walk up the tree to find the first parent with an initiator', async function() {\n    const traceData = await TraceLoader.traceEngine(this, 'set-timeout-long-task.json.gz');\n\n    // Find any of the fibonnaci() calls; they have a parent\n    // event (TimerFire) that has an initiator.\n    const fibonacciCall = traceData.Renderer.allTraceEntries.find(entry => {\n      return TraceEngine.Types.TraceEvents.isProfileCall(entry) && entry.callFrame.functionName === 'fibonacci';\n    });\n    assertNotNullOrUndefined(fibonacciCall);\n\n    const timerFireEvent = Array.from(traceData.Initiators.eventToInitiator.keys())\n                               .find(TraceEngine.Types.TraceEvents.isTraceEventTimerFire);\n    assertNotNullOrUndefined(timerFireEvent);\n    const timerInstallEvent = traceData.Initiators.eventToInitiator.get(timerFireEvent);\n    assertNotNullOrUndefined(timerInstallEvent);\n\n    // Find the initator pairs but starting at the fibonacci()\n    // call.\n    const initiatorPairs = Timeline.Initiators.eventInitiatorPairsToDraw(traceData, fibonacciCall);\n\n    assert.deepEqual(initiatorPairs, [{\n                       event: timerFireEvent,\n                       initiator: timerInstallEvent,\n                     }]);\n  });\n\n  it('will walk back through the initiators to find the entire chain', async function() {\n    const traceData = await TraceLoader.traceEngine(this, 'nested-initiators.json.gz');\n\n    // Find any of the fibonnaci() calls; they have a parent\n    // event (TimerFire) that has an initiator.\n    const fibonacciCall = traceData.Renderer.allTraceEntries.find(entry => {\n      return TraceEngine.Types.TraceEvents.isProfileCall(entry) && entry.callFrame.functionName === 'fibonacci';\n    });\n    assertNotNullOrUndefined(fibonacciCall);\n\n    // Find the initator pairs but starting at the fibonacci()\n    // call. We expect to find two pairs here:\n    // 1. fibonacci() ===> TimerFire caused by TimerInstall\n    // 2. The TimerInstall from (1), caused by a prior TimerInstall.\n    const initiatorPairs = Timeline.Initiators.eventInitiatorPairsToDraw(traceData, fibonacciCall);\n\n    assert.lengthOf(initiatorPairs, 2);\n    for (const pair of initiatorPairs) {\n      // Ensure each pair is a TimerInstall>TimerFire pair.\n      assert.strictEqual(pair.event.name, TraceEngine.Types.TraceEvents.KnownEventName.TimerFire);\n      assert.strictEqual(pair.initiator.name, TraceEngine.Types.TraceEvents.KnownEventName.TimerInstall);\n    }\n  });\n\n  it('will walk forward to find the events initiated by the selected entry', async function() {\n    const traceData = await TraceLoader.traceEngine(this, 'nested-initiators.json.gz');\n\n    // Find any of the InstallTimer calls; they initiate other events.\n    const timerInstall = traceData.Renderer.allTraceEntries.find(entry => {\n      return entry.name === TraceEngine.Types.TraceEvents.KnownEventName.TimerInstall;\n    });\n    assertNotNullOrUndefined(timerInstall);\n\n    // Find the initator pairs starting at the TimerInstall\n    // call. We expect to find one pair here:\n    // TimerFire that was initiated by the entry we found - TimerInstall\n\n    const initiatorPairs = Timeline.Initiators.eventInitiatorPairsToDraw(traceData, timerInstall);\n\n    assert.lengthOf(initiatorPairs, 1);\n    for (const pair of initiatorPairs) {\n      // Ensure the pair is a TimerInstall>TimerFire pair.\n      assert.strictEqual(pair.event.name, TraceEngine.Types.TraceEvents.KnownEventName.TimerFire);\n      assert.strictEqual(pair.initiator.name, TraceEngine.Types.TraceEvents.KnownEventName.TimerInstall);\n    }\n  });\n});\n"]}