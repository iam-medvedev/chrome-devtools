{"version":3,"file":"SidebarAnnotationsTab.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/timeline/components/SidebarAnnotationsTab.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../../core/common/common.js';\nimport * as Host from '../../../core/host/host.js';\nimport * as i18n from '../../../core/i18n/i18n.js';\nimport * as Platform from '../../../core/platform/platform.js';\nimport * as Trace from '../../../models/trace/trace.js';\nimport * as TraceBounds from '../../../services/trace_bounds/trace_bounds.js';\nimport * as ComponentHelpers from '../../../ui/components/helpers/helpers.js';\nimport * as IconButton from '../../../ui/components/icon_button/icon_button.js';\nimport * as Settings from '../../../ui/components/settings/settings.js';\nimport * as LitHtml from '../../../ui/lit-html/lit-html.js';\n\nimport {nameForEntry} from './EntryName.js';\nimport {RemoveAnnotation, RevealAnnotation} from './Sidebar.js';\nimport sidebarAnnotationsTabStyles from './sidebarAnnotationsTab.css.js';\n\nconst diagramImageUrl = new URL('../../../Images/performance-panel-diagram.svg', import.meta.url).toString();\nconst entryLabelImageUrl = new URL('../../../Images/performance-panel-entry-label.svg', import.meta.url).toString();\nconst timeRangeImageUrl = new URL('../../../Images/performance-panel-time-range.svg', import.meta.url).toString();\n\nconst UIStrings = {\n  /**\n   * @description Title for entry label.\n   */\n  entryLabel: 'Entry label',\n  /**\n   * @description Text for how to create an entry label.\n   */\n  entryLabelDescription: 'Double click on an entry to create an entry label. Press Esc or Enter to complete.',\n  /**\n   * @description  Title for diagram.\n   */\n  diagram: 'Diagram',\n  /**\n   * @description Text for how to create a diagram between entries.\n   */\n  diagramDescription: 'Double click on an entry to create a diagram.',\n  /**\n   * @description  Title for time range.\n   */\n  timeRange: 'Time range',\n  /**\n   * @description Text for how to create a time range selection and add note.\n   */\n  timeRangeDescription:\n      'Shift and drag on the canvas to create a time range and add a label. Press Esc or Enter to complete.',\n};\n\nconst str_ = i18n.i18n.registerUIStrings('panels/timeline/components/SidebarAnnotationsTab.ts', UIStrings);\nconst i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\n\nexport class SidebarAnnotationsTab extends HTMLElement {\n  static readonly litTagName = LitHtml.literal`devtools-performance-sidebar-annotations`;\n  readonly #shadow = this.attachShadow({mode: 'open'});\n  readonly #boundRender = this.#render.bind(this);\n  #annotations: Trace.Types.File.Annotation[] = [];\n  // A map with annotated entries and the colours that are used to display them in the FlameChart.\n  // We need this map to display the entries in the sidebar with the same colours.\n  #annotationEntryToColorMap: Map<Trace.Types.Events.Event|Trace.Types.Events.LegacyTimelineFrame, string> = new Map();\n\n  readonly #annotationsHiddenSetting: Common.Settings.Setting<boolean>;\n\n  constructor() {\n    super();\n    this.#annotationsHiddenSetting = Common.Settings.Settings.instance().moduleSetting('annotations-hidden');\n  }\n\n  set annotations(annotations: Trace.Types.File.Annotation[]) {\n    this.#annotations = annotations;\n    void ComponentHelpers.ScheduledRender.scheduleRender(this, this.#boundRender);\n  }\n\n  set annotationEntryToColorMap(annotationEntryToColorMap: Map<Trace.Types.Events.Event, string>) {\n    this.#annotationEntryToColorMap = annotationEntryToColorMap;\n  }\n\n  connectedCallback(): void {\n    this.#shadow.adoptedStyleSheets = [sidebarAnnotationsTabStyles];\n    void ComponentHelpers.ScheduledRender.scheduleRender(this, this.#boundRender);\n  }\n\n  /**\n   * Renders the Annotation 'identifier' or 'name' in the annotations list.\n   * This is the text rendered before the annotation label that we use to indentify the annotation.\n   *\n   * Annotations identifiers for different annotations:\n   * Entry label -> Entry name\n   * Labelled range -> Start to End Range of the label in ms\n   * Connected entries -> Connected entries names\n   *\n   * All identifiers have a different colour background.\n   */\n  #renderAnnotationIdentifier(annotation: Trace.Types.File.Annotation): LitHtml.LitTemplate {\n    switch (annotation.type) {\n      case 'ENTRY_LABEL': {\n        const entryName = nameForEntry(annotation.entry);\n        const color = this.#annotationEntryToColorMap.get(annotation.entry);\n\n        return LitHtml.html`\n              <span class=\"annotation-identifier\" style=\"background-color: ${color}\">\n                ${entryName}\n              </span>\n        `;\n      }\n      case 'TIME_RANGE': {\n        const minTraceBoundsMilli =\n            TraceBounds.TraceBounds.BoundsManager.instance().state()?.milli.entireTraceBounds.min ?? 0;\n\n        const timeRangeStartInMs =\n            Math.round(Trace.Helpers.Timing.microSecondsToMilliseconds(annotation.bounds.min) - minTraceBoundsMilli);\n        const timeRangeEndInMs =\n            Math.round(Trace.Helpers.Timing.microSecondsToMilliseconds(annotation.bounds.max) - minTraceBoundsMilli);\n\n        return LitHtml.html`\n              <span class=\"annotation-identifier time-range\">\n                ${timeRangeStartInMs} - ${timeRangeEndInMs} ms\n              </span>\n        `;\n      }\n      case 'ENTRIES_LINK': {\n        const entryFromName = nameForEntry(annotation.entryFrom);\n        const fromColor = this.#annotationEntryToColorMap.get(annotation.entryFrom);\n\n        const entryToName = annotation.entryTo ? nameForEntry(annotation.entryTo) : '';\n        const toColor = annotation.entryTo ? this.#annotationEntryToColorMap.get(annotation.entryTo) : '';\n\n        // clang-format off\n        return LitHtml.html`\n          <div class=\"entries-link\">\n            <span class=\"annotation-identifier\"  style=\"background-color: ${fromColor}\">\n              ${entryFromName}\n            </span>\n            <${IconButton.Icon.Icon.litTagName} class=\"inline-icon\" .data=${{\n              iconName: 'arrow-forward',\n              color: 'var(--icon-default)',\n              width: '18px',\n              height: '18px',\n            } as IconButton.Icon.IconData}>\n            </${IconButton.Icon.Icon.litTagName}>\n            ${(entryToName !== '' ?\n              LitHtml.html`<span class=\"annotation-identifier\" style=\"background-color: ${toColor}\" >${entryToName}</span>`\n            : '')}\n          </div>\n      `;\n        // clang-format on\n      }\n      default:\n        Platform.assertNever(annotation, 'Unsupported annotation type');\n    }\n  }\n\n  #revealAnnotation(annotation: Trace.Types.File.Annotation): void {\n    this.dispatchEvent(new RevealAnnotation(annotation));\n  }\n\n  #renderTutorialCard(): LitHtml.TemplateResult {\n    return LitHtml.html`\n      <div class=\"annotation-tutorial-container\">\n        Try the new annotation feature:\n        <div class=\"tutorial-card\">\n          <div class=\"tutorial-image\"> <img src=${entryLabelImageUrl}></img></div>\n          <div class=\"tutorial-title\">${i18nString(UIStrings.entryLabel)}</div>\n          <div class=\"tutorial-description\">${i18nString(UIStrings.entryLabelDescription)}</div>\n          <div class=\"tutorial-shortcut\">${Host.Platform.isMac() ? 'Cmd' : 'Ctrl'} + Click</div>\n        </div>\n        <div class=\"tutorial-card\">\n          <div class=\"tutorial-image\"> <img src=${diagramImageUrl}></img></div>\n          <div class=\"tutorial-title\">${i18nString(UIStrings.diagram)}</div>\n          <div class=\"tutorial-description\">${i18nString(UIStrings.diagramDescription)}</div>\n          <div class=\"tutorial-shortcut\">\n            <div class=\"keybinds-shortcut\">\n              <span class=\"keybinds-key\">${Host.Platform.isMac() ? 'Cmd' : 'Ctrl'} + Click</span>\n            </div>\n          </div>\n        </div>\n        <div class=\"tutorial-card\">\n          <div class=\"tutorial-image\"> <img src=${timeRangeImageUrl}></img></div>\n          <div class=\"tutorial-title\">${i18nString(UIStrings.timeRange)}</div>\n          <div class=\"tutorial-description\">${i18nString(UIStrings.timeRangeDescription)}</div>\n        </div>\n      </div>\n    `;\n  }\n\n  #render(): void {\n    // clang-format off\n    LitHtml.render(\n      LitHtml.html`\n        <span class=\"annotations\">\n          ${this.#annotations.length === 0 ?\n            this.#renderTutorialCard() :\n            LitHtml.html`\n              ${this.#annotations.map(annotation =>\n                LitHtml.html`\n                  <div class=\"annotation-container\" @click=${() => this.#revealAnnotation(annotation)}>\n                    <div class=\"annotation\">\n                      ${this.#renderAnnotationIdentifier(annotation)}\n                      <span class=\"label\">\n                        ${(annotation.type === 'ENTRY_LABEL' || annotation.type === 'TIME_RANGE') ? annotation.label : ''}\n                      </span>\n                    </div>\n                    <${IconButton.Icon.Icon.litTagName} class=\"bin-icon\" .data=${{\n                            iconName: 'bin',\n                            color: 'var(--icon-default)',\n                            width: '20px',\n                            height: '20px',\n                          } as IconButton.Icon.IconData} @click=${(event: Event) => {\n                            // Stop propagation to not zoom into the annotation when the delete button is clicked\n                            event.stopPropagation();\n                            this.dispatchEvent(new RemoveAnnotation(annotation));\n                    }}>\n                  </div>`,\n              )}\n              <${Settings.SettingCheckbox.SettingCheckbox.litTagName} class=\"visibility-setting\" .data=${{\n                setting: this.#annotationsHiddenSetting,\n                textOverride: 'Hide annotations',\n              } as Settings.SettingCheckbox.SettingCheckboxData}>\n              </${Settings.SettingCheckbox.SettingCheckbox.litTagName}>\n        </span>`\n      }`,\n    this.#shadow, {host: this});\n    // clang-format on\n  }\n}\n\ncustomElements.define('devtools-performance-sidebar-annotations', SidebarAnnotationsTab);\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'devtools-performance-sidebar-annotations': SidebarAnnotationsTab;\n  }\n}\n"]}