{"version":3,"file":"SidebarSingleInsightSet.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/timeline/components/SidebarSingleInsightSet.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as i18n from '../../../core/i18n/i18n.js';\nimport * as Trace from '../../../models/trace/trace.js';\nimport * as ComponentHelpers from '../../../ui/components/helpers/helpers.js';\nimport * as LitHtml from '../../../ui/lit-html/lit-html.js';\n\nimport {type BaseInsight} from './insights/Helpers.js';\nimport * as Insights from './insights/insights.js';\nimport {type ActiveInsight, EventReferenceClick} from './Sidebar.js';\nimport styles from './sidebarSingleInsightSet.css.js';\n\nexport interface SidebarSingleInsightSetData {\n  parsedTrace: Trace.Handlers.Types.ParsedTrace|null;\n  insights: Trace.Insights.Types.TraceInsightSets|null;\n  insightSetKey: string|null;\n  activeCategory: Insights.Types.Category;\n  activeInsight: ActiveInsight|null;\n}\n\nexport class SidebarSingleInsightSet extends HTMLElement {\n  static readonly litTagName = LitHtml.literal`devtools-performance-sidebar-single-navigation`;\n  readonly #shadow = this.attachShadow({mode: 'open'});\n  #renderBound = this.#render.bind(this);\n\n  #data: SidebarSingleInsightSetData = {\n    parsedTrace: null,\n    insights: null,\n    insightSetKey: null,\n    activeCategory: Insights.Types.Category.ALL,\n    activeInsight: null,\n  };\n\n  set data(data: SidebarSingleInsightSetData) {\n    this.#data = data;\n    void ComponentHelpers.ScheduledRender.scheduleRender(this, this.#renderBound);\n  }\n  connectedCallback(): void {\n    this.#shadow.adoptedStyleSheets = [styles];\n    this.#render();\n  }\n\n  #metricIsVisible(label: 'LCP'|'CLS'|'INP'): boolean {\n    if (this.#data.activeCategory === Insights.Types.Category.ALL) {\n      return true;\n    }\n    return label === this.#data.activeCategory;\n  }\n\n  #onClickMetric(event: Trace.Types.Events.Event, insightComponentName: string): void {\n    const el = this.shadowRoot?.querySelector(insightComponentName) as BaseInsight;\n    if (el && this.#data.insightSetKey) {\n      this.dispatchEvent(new Insights.SidebarInsight.InsightActivated(\n          el.internalName,\n          this.#data.insightSetKey,\n          el.getInitialOverlays(),\n          ));\n    }\n\n    this.dispatchEvent(new EventReferenceClick(event));\n  }\n\n  #renderMetricValue(\n      label: 'LCP'|'CLS'|'INP', value: string,\n      classification: Trace.Handlers.ModelHandlers.PageLoadMetrics.ScoreClassification,\n      event: Trace.Types.Events.Event|null): LitHtml.LitTemplate {\n    const insightComponentName = {\n      LCP: Insights.LCPPhases.LCPPhases.litTagName.value as string,\n      CLS: Insights.CLSCulprits.CLSCulprits.litTagName.value as string,\n      INP: Insights.InteractionToNextPaint.InteractionToNextPaint.litTagName.value as string,\n    }[label];\n\n    // clang-format off\n    return this.#metricIsVisible(label) ? LitHtml.html`\n      <div class=\"metric\" @click=${event ? this.#onClickMetric.bind(this, event, insightComponentName) : null}>\n        <div class=\"metric-value metric-value-${classification}\">${value}</div>\n        <div class=\"metric-label\">${label}</div>\n      </div>\n    ` : LitHtml.nothing;\n    // clang-format on\n  }\n\n  #getINP(insightSetKey: string):\n      {value: Trace.Types.Timing.MicroSeconds, event: Trace.Types.Events.SyntheticInteractionPair}|null {\n    const insight = Trace.Insights.Common.getInsight('InteractionToNextPaint', this.#data.insights, insightSetKey);\n    if (!insight?.longestInteractionEvent?.dur) {\n      return null;\n    }\n\n    const value = insight.longestInteractionEvent.dur;\n    return {value, event: insight.longestInteractionEvent};\n  }\n\n  #getLCP(insightSetKey: string):\n      {value: Trace.Types.Timing.MicroSeconds, event: Trace.Types.Events.LargestContentfulPaintCandidate}|null {\n    const insight = Trace.Insights.Common.getInsight('LargestContentfulPaint', this.#data.insights, insightSetKey);\n    if (!insight || !insight.lcpMs || !insight.lcpEvent) {\n      return null;\n    }\n\n    const value = Trace.Helpers.Timing.millisecondsToMicroseconds(insight.lcpMs);\n    return {value, event: insight.lcpEvent};\n  }\n\n  #getCLS(insightSetKey: string): {value: number, worstShiftEvent: Trace.Types.Events.Event|null} {\n    const insight = Trace.Insights.Common.getInsight('CumulativeLayoutShift', this.#data.insights, insightSetKey);\n    if (!insight) {\n      // Unlike the other metrics, there is still a value for this metric even with no data.\n      // This means this view will always display a CLS score.\n      return {value: 0, worstShiftEvent: null};\n    }\n\n    // TODO(crbug.com/366049346): buildLayoutShiftsClusters is dropping non-nav clusters,\n    //                            so `insight.clusters` is always empty for non-navs.\n    // TODO(cjamcl): the CLS insight be doing this for us.\n    let maxScore = 0;\n    let worstCluster;\n    for (const cluster of insight.clusters) {\n      if (cluster.clusterCumulativeScore > maxScore) {\n        maxScore = cluster.clusterCumulativeScore;\n        worstCluster = cluster;\n      }\n    }\n\n    return {value: maxScore, worstShiftEvent: worstCluster?.worstShiftEvent ?? null};\n  }\n\n  #renderMetrics(insightSetKey: string): LitHtml.TemplateResult {\n    const lcp = this.#getLCP(insightSetKey);\n    const cls = this.#getCLS(insightSetKey);\n    const inp = this.#getINP(insightSetKey);\n\n    return LitHtml.html`\n    <div class=\"metrics-row\">\n    ${\n        lcp ? this.#renderMetricValue(\n                  'LCP', i18n.TimeUtilities.formatMicroSecondsAsSeconds(lcp.value),\n                  Trace.Handlers.ModelHandlers.PageLoadMetrics.scoreClassificationForLargestContentfulPaint(lcp.value),\n                  lcp.event ?? null) :\n              LitHtml.nothing}\n    ${\n        this.#renderMetricValue(\n            'CLS', cls.value.toFixed(2),\n            Trace.Handlers.ModelHandlers.LayoutShifts.scoreClassificationForLayoutShift(cls.value),\n            cls.worstShiftEvent)}\n    ${\n        inp ? this.#renderMetricValue(\n                  'INP', i18n.TimeUtilities.formatMicroSecondsAsMillisFixed(inp.value),\n                  Trace.Handlers.ModelHandlers.UserInteractions.scoreClassificationForInteractionToNextPaint(inp.value),\n                  inp.event) :\n              LitHtml.nothing}\n    </div>\n    `;\n  }\n\n  #renderInsights(\n      insights: Trace.Insights.Types.TraceInsightSets|null,\n      insightSetKey: string,\n      ): LitHtml.TemplateResult {\n    // TODO(crbug.com/368135130): sort this in a smart way!\n    const insightComponents = [\n      Insights.InteractionToNextPaint.InteractionToNextPaint,\n      Insights.LCPPhases.LCPPhases,\n      Insights.LCPDiscovery.LCPDiscovery,\n      Insights.CLSCulprits.CLSCulprits,\n      Insights.RenderBlocking.RenderBlockingRequests,\n      Insights.DocumentLatency.DocumentLatency,\n      Insights.FontDisplay.FontDisplay,\n      Insights.Viewport.Viewport,\n      Insights.ThirdParties.ThirdParties,\n      Insights.SlowCSSSelector.SlowCSSSelector,\n    ];\n    // clang-format off\n    return LitHtml.html`${insightComponents.map(component => {\n      return LitHtml.html`<div data-single-insight-wrapper>\n        <${component.litTagName}\n          .insights=${insights}\n          .insightSetKey=${insightSetKey}\n          .activeInsight=${this.#data.activeInsight}\n          .activeCategory=${this.#data.activeCategory}>\n        </${component.litTagName}>\n      </div>`;\n    })}`;\n    // clang-format on\n  }\n\n  #render(): void {\n    const {\n      parsedTrace,\n      insights,\n      insightSetKey,\n    } = this.#data;\n    if (!parsedTrace || !insights || !insightSetKey) {\n      LitHtml.render(LitHtml.html``, this.#shadow, {host: this});\n      return;\n    }\n\n    // clang-format off\n    LitHtml.render(LitHtml.html`\n      <div class=\"navigation\">\n        ${this.#renderMetrics(insightSetKey)}\n        ${this.#renderInsights(insights, insightSetKey)}\n        </div>\n      `, this.#shadow, {host: this});\n    // clang-format on\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'devtools-performance-sidebar-single-navigation': SidebarSingleInsightSet;\n  }\n}\n\ncustomElements.define('devtools-performance-sidebar-single-navigation', SidebarSingleInsightSet);\n"]}