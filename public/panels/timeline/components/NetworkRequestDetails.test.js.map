{"version":3,"file":"NetworkRequestDetails.test.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/timeline/components/NetworkRequestDetails.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport {cleanTextContent} from '../../../testing/DOMHelpers.js';\nimport {describeWithMockConnection} from '../../../testing/MockConnection.js';\nimport {TraceLoader} from '../../../testing/TraceLoader.js';\nimport * as Components from '../../../ui/legacy/components/utils/utils.js';\nimport * as Timeline from '../timeline.js';\n\nimport * as TimelineComponents from './components.js';\n\ndescribeWithMockConnection('NetworkRequestDetails', () => {\n  it('renders the right details for a network event from Trace', async function() {\n    const {parsedTrace} = await TraceLoader.traceEngine(this, 'lcp-web-font.json.gz');\n    const entityMapper = new Timeline.Utils.EntityMapper.EntityMapper(parsedTrace);\n    const networkRequests = parsedTrace.NetworkRequests.byTime;\n    const cssRequest = networkRequests.find(request => {\n      return request.args.data.url === 'https://chromedevtools.github.io/performance-stories/lcp-web-font/app.css';\n    });\n    if (!cssRequest) {\n      throw new Error('Could not find expected network request.');\n    }\n\n    const details =\n        new TimelineComponents.NetworkRequestDetails.NetworkRequestDetails(new Components.Linkifier.Linkifier());\n    await details.setData(\n        parsedTrace, cssRequest, Timeline.TargetForEvent.targetForEvent(parsedTrace, cssRequest), entityMapper);\n\n    if (!details.shadowRoot) {\n      throw new Error('Could not find expected element to test.');\n    }\n\n    const titleSwatch: HTMLElement|null = details.shadowRoot.querySelector('.network-request-details-title div');\n    // css request is in 'Css' category, which will use `--app-color-css: var(--ref-palette-purple60)` colour\n    assert.strictEqual(titleSwatch?.style.backgroundColor, 'rgb(191, 103, 255)');\n\n    const rowData = getRowDataForDetailsElement(details.shadowRoot);\n    const durationInnerText = 'Duration 12.58 ms ' +\n        'Queuing and connecting 1.83 ms ' +\n        'Request sent and waiting 4.80 ms ' +\n        'Content downloading 1.66 ms ' +\n        'Waiting on main thread 4.29 ms';\n    assert.deepEqual(\n        rowData,\n        [\n          {title: undefined, value: 'chromedevtools.github.io/performance-stories/lcp-web-font/app.css'},\n          {title: 'Request method', value: 'GET'},\n          {title: 'Protocol', value: 'unknown'},\n          {title: 'Priority', value: 'Highest'},\n          {title: 'MIME type', value: 'text/css'},\n          {title: 'Encoded data', value: '(from cache)'},\n          {title: 'Decoded body', value: '96 B'},\n          {\n            title: 'Blocking',\n            value: 'Render blocking',\n          },\n          {title: 'From cache', value: 'Yes'},\n          {title: '3rd party', value: 'GitHub'},\n          {title: undefined, value: durationInnerText},\n          {\n            title: 'Initiated by',\n            value: 'chromedevtools.github.io/performance-stories/lcp-web-font/index.html',\n          },\n        ],\n    );\n  });\n  it('renders the server timing details for a network event', async function() {\n    const {parsedTrace} = await TraceLoader.traceEngine(this, 'server-timings.json.gz');\n    const entityMapper = new Timeline.Utils.EntityMapper.EntityMapper(parsedTrace);\n    const networkRequests = parsedTrace.NetworkRequests.byTime;\n    const htmlRequest = networkRequests.find(request => {\n      return request.args.data.url === 'https://node-server-tan.vercel.app/waste-time';\n    });\n    if (!htmlRequest) {\n      throw new Error('Could not find expected network request.');\n    }\n\n    const details =\n        new TimelineComponents.NetworkRequestDetails.NetworkRequestDetails(new Components.Linkifier.Linkifier());\n    await details.setData(\n        parsedTrace, htmlRequest, Timeline.TargetForEvent.targetForEvent(parsedTrace, htmlRequest), entityMapper);\n\n    if (!details.shadowRoot) {\n      throw new Error('Could not find expected element to test.');\n    }\n\n    const titleSwatch: HTMLElement|null = details.shadowRoot.querySelector('.network-request-details-title div');\n    assert.strictEqual(titleSwatch?.style.backgroundColor, 'rgb(76, 141, 246)');\n\n    const rowData = getServerTimingDataDetailsElement(details.shadowRoot);\n    assert.deepEqual(\n        rowData,\n        [\n          [\n            'Server timing',\n            'Time',\n            'Description',\n          ],\n          [\n            'Secondleveltask1',\n            '904.2932819999987',\n            'Description of second level task 1',\n          ],\n          [\n            'Topleveltask1',\n            '1004.2932819999987',\n            'Description of top level task 1',\n          ],\n          [\n            'Topleveltask2',\n            '1000.0925859999988',\n            '-',\n          ],\n        ],\n    );\n  });\n});\n\nfunction getRowDataForDetailsElement(details: ShadowRoot) {\n  return Array\n      .from(details.querySelectorAll<HTMLDivElement>(\n          '.network-request-details-item, .network-request-details-row, .timing-rows'))\n      .map(row => {\n        const title = row.querySelector<HTMLDivElement>('.title')?.innerText;\n        let value = cleanTextContent(row.querySelector<HTMLDivElement>('.value')?.innerText || '');\n        if (!title && !value) {\n          value = cleanTextContent(row.innerText || '');\n        }\n        return {title, value};\n      });\n}\n\nfunction getServerTimingDataDetailsElement(details: ShadowRoot) {\n  return Array.from(details.querySelectorAll<HTMLDivElement>('.server-timings > .value, .server-timing-column-header'))\n      .map(row => cleanTextContent(row.innerText))\n      .reduce((result, current, i) => {\n        // group items by rows of three items\n        const rowNumber = Math.floor(i / 3);\n        const row: string[] = result[rowNumber] = result[rowNumber] || [];\n        row.push(current);\n        return result;\n      }, []);\n}\n"]}