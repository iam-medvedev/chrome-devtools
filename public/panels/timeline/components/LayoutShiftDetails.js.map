{"version":3,"file":"LayoutShiftDetails.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/timeline/components/LayoutShiftDetails.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as i18n from '../../../core/i18n/i18n.js';\nimport type * as Platform from '../../../core/platform/platform.js';\nimport * as SDK from '../../../core/sdk/sdk.js';\nimport type * as Protocol from '../../../generated/protocol.js';\nimport * as Helpers from '../../../models/trace/helpers/helpers.js';\nimport * as Trace from '../../../models/trace/trace.js';\nimport * as LegacyComponents from '../../../ui/legacy/components/utils/utils.js';\nimport * as UI from '../../../ui/legacy/legacy.js';\nimport * as LitHtml from '../../../ui/lit-html/lit-html.js';\n\nimport {NodeLink} from './insights/insights.js';\nimport layoutShiftDetailsStyles from './layoutShiftDetails.css.js';\n\nconst MAX_URL_LENGTH = 20;\n\nconst UIStrings = {\n  /**\n   * @description Text for a Layout Shift event indictating that it is an insight.\n   */\n  insight: 'Insight',\n  /**\n   * @description Title for a Layout shift event insight.\n   */\n  layoutShiftCulprits: 'Layout shift culprits',\n  /**\n   * @description Text indicating a Layout shift.\n   */\n  layoutShift: 'Layout shift',\n  /**\n   * @description Text for a table header referring to the start time of a Layout Shift event.\n   */\n  startTime: 'Start time',\n  /**\n   * @description Text for a table header referring to the score of a Layout Shift event.\n   */\n  shiftScore: 'Shift score',\n  /**\n   * @description Text for a table header referring to the elements shifted for a Layout Shift event.\n   */\n  elementsShifted: 'Elements shifted',\n  /**\n   * @description Text for a table header referring to the culprit of a Layout Shift event.\n   */\n  culprit: 'Culprit',\n  /**\n   * @description Text for a culprit type of Injected iframe.\n   */\n  injectedIframe: 'Injected iframe',\n  /**\n   * @description Text for a culprit type of Font request.\n   */\n  fontRequest: 'Font request',\n};\n\nconst str_ = i18n.i18n.registerUIStrings('panels/timeline/components/LayoutShiftDetails.ts', UIStrings);\nconst i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\n\nexport class LayoutShiftDetails extends HTMLElement {\n  static readonly litTagName = LitHtml.literal`devtools-performance-layout-shift-details`;\n  readonly #shadow = this.attachShadow({mode: 'open'});\n\n  #layoutShift?: Trace.Types.Events.SyntheticLayoutShift|null;\n  #traceInsightsSets: Trace.Insights.Types.TraceInsightSets|null = null;\n  #parsedTrace: Trace.Handlers.Types.ParsedTrace|null = null;\n  #isFreshRecording: Boolean = false;\n\n  connectedCallback(): void {\n    this.#shadow.adoptedStyleSheets = [layoutShiftDetailsStyles];\n    // Styles for linkifier button.\n    UI.UIUtils.injectTextButtonStyles(this.#shadow);\n    this.#render();\n  }\n\n  setData(\n      layoutShift: Trace.Types.Events.SyntheticLayoutShift,\n      traceInsightsSets: Trace.Insights.Types.TraceInsightSets|null, parsedTrace: Trace.Handlers.Types.ParsedTrace|null,\n      isFreshRecording: Boolean): void {\n    if (this.#layoutShift === layoutShift) {\n      return;\n    }\n    this.#layoutShift = layoutShift;\n    this.#traceInsightsSets = traceInsightsSets;\n    this.#parsedTrace = parsedTrace;\n    this.#isFreshRecording = isFreshRecording;\n    this.#render();\n  }\n\n  #renderInsightChip(): LitHtml.TemplateResult|null {\n    if (!this.#layoutShift) {\n      return null;\n    }\n\n    // clang-format off\n    return LitHtml.html`\n      <div class=\"insight-chip\">\n        <div class=\"insight-keyword\">${i18nString(UIStrings.insight)} </div>${i18nString(UIStrings.layoutShiftCulprits)}\n      </div>\n    `;\n    // clang-format on\n  }\n\n  #renderTitle(): LitHtml.TemplateResult {\n    return LitHtml.html`\n      <div class=\"layout-shift-details-title\">\n        <div class=\"layout-shift-event-title\"></div>\n        ${i18nString(UIStrings.layoutShift)}\n      </div>\n    `;\n  }\n\n  #renderShiftedElements(elementsShifted: Trace.Types.Events.TraceImpactedNode[]|undefined): LitHtml.LitTemplate {\n    // clang-format off\n    return LitHtml.html`\n      ${elementsShifted?.map(el => {\n        if (el.node_id !== undefined) {\n          return LitHtml.html`\n            <${NodeLink.NodeLink.litTagName}\n              .data=${{\n                backendNodeId: el.node_id,\n              } as NodeLink.NodeLinkData}>\n            </${NodeLink.NodeLink.litTagName}>`;\n        }\n          return LitHtml.nothing;\n      })}`;\n    // clang-format on\n  }\n\n  #renderIframe(iframeId: string): LitHtml.TemplateResult|null {\n    const domLoadingId = iframeId as Protocol.Page.FrameId;\n    if (!domLoadingId) {\n      return null;\n    }\n\n    const domLoadingFrame = SDK.FrameManager.FrameManager.instance().getFrame(domLoadingId);\n    if (!domLoadingFrame) {\n      return null;\n    }\n    const el = LegacyComponents.Linkifier.Linkifier.linkifyRevealable(domLoadingFrame, domLoadingFrame.displayName());\n    // clang-format off\n    return LitHtml.html`\n    <div class=\"culprit\"><div class=\"culprit-type\">${i18nString(UIStrings.injectedIframe)}:</div><div class=\"culprit-value\">${el}</div></div>`;\n    // clang-format on\n  }\n\n  #renderFontRequest(request: Trace.Types.Events.SyntheticNetworkRequest): LitHtml.TemplateResult|null {\n    const options = {\n      tabStop: true,\n      showColumnNumber: false,\n      inlineFrameIndex: 0,\n      maxLength: MAX_URL_LENGTH,\n    };\n\n    const linkifiedURL = LegacyComponents.Linkifier.Linkifier.linkifyURL(\n        request.args.data.url as Platform.DevToolsPath.UrlString, options);\n\n    // clang-format off\n    return LitHtml.html`\n    <div class=\"culprit\"><div class=\"culprit-type\">${i18nString(UIStrings.fontRequest)}:</div><div class=\"culprit-value\">${linkifiedURL}</div></div>`;\n    // clang-format on\n  }\n\n  #renderRootCauseValues(rootCauses: Trace.Insights.InsightRunners.CumulativeLayoutShift.LayoutShiftRootCausesData|\n                         undefined): LitHtml.TemplateResult|null {\n    return LitHtml.html`\n      ${rootCauses?.fontRequests.map(fontReq => this.#renderFontRequest(fontReq))}\n      ${rootCauses?.iframeIds.map(iframe => this.#renderIframe(iframe))}\n    `;\n  }\n\n  #renderDetailsTable(\n      layoutShift: Trace.Types.Events.SyntheticLayoutShift,\n      traceInsightsSets: Trace.Insights.Types.TraceInsightSets,\n      parsedTrace: Trace.Handlers.Types.ParsedTrace,\n      ): LitHtml.TemplateResult|null {\n    const score = layoutShift.args.data?.weighted_score_delta;\n    if (!score) {\n      return null;\n    }\n\n    const ts = Trace.Types.Timing.MicroSeconds(layoutShift.ts - parsedTrace.Meta.traceBounds.min);\n    const insightsId = layoutShift.args.data?.navigationId ?? Trace.Insights.Types.NO_NAVIGATION;\n    const clsInsight = traceInsightsSets.get(insightsId)?.data.CumulativeLayoutShift;\n    if (clsInsight instanceof Error) {\n      return null;\n    }\n\n    const rootCauses = clsInsight?.shifts?.get(layoutShift);\n    const elementsShifted = layoutShift.args.data?.impacted_nodes;\n    const hasCulprits = rootCauses && (rootCauses.fontRequests.length > 0 || rootCauses.iframeIds.length > 0);\n    const hasShiftedElements = elementsShifted && elementsShifted.length > 0;\n\n    // clang-format off\n    return LitHtml.html`\n      <table class=\"layout-shift-details-table\">\n        <thead class=\"table-title\">\n          <tr>\n            <th>${i18nString(UIStrings.startTime)}</th>\n            <th>${i18nString(UIStrings.shiftScore)}</th>\n            ${hasShiftedElements && this.#isFreshRecording ? LitHtml.html`\n              <th>${i18nString(UIStrings.elementsShifted)}</th>` : LitHtml.nothing}\n            ${hasCulprits && this.#isFreshRecording ? LitHtml.html`\n              <th>${i18nString(UIStrings.culprit)}</th> ` : LitHtml.nothing}\n          </tr>\n        </thead>\n        <tbody>\n          <tr>\n            <td>${i18n.TimeUtilities.preciseMillisToString(Helpers.Timing.microSecondsToMilliseconds(ts))}</td>\n            <td>${(score.toPrecision(4))}</td>\n            ${this.#isFreshRecording ? LitHtml.html`\n              <td>\n                <div class=\"elements-shifted\">\n                  ${this.#renderShiftedElements(elementsShifted)}\n                </div>\n              </td>` : LitHtml.nothing\n            }\n            ${this.#isFreshRecording ? LitHtml.html`\n              <td class=\"culprits\">\n                ${this.#renderRootCauseValues(rootCauses)}\n              </td>`: LitHtml.nothing}\n          </tr>\n        </tbody>\n      </table>\n    `;\n    // clang-format on\n  }\n\n  #render(): void {\n    if (!this.#layoutShift || !this.#traceInsightsSets || !this.#parsedTrace) {\n      return;\n    }\n    // clang-format off\n    const output = LitHtml.html`\n      <div class=\"layout-shift-summary-details\">\n        <div class=\"event-details\">\n          ${this.#renderTitle()}\n          ${this.#renderDetailsTable(this.#layoutShift, this.#traceInsightsSets, this.#parsedTrace)}\n        </div>\n        <div class=\"insight-categories\">\n          ${this.#renderInsightChip()}\n        </div>\n      </div>\n    `;\n    // clang-format on\n    LitHtml.render(output, this.#shadow, {host: this});\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'devtools-performance-layout-shift-details': LayoutShiftDetails;\n  }\n}\n\ncustomElements.define('devtools-performance-layout-shift-details', LayoutShiftDetails);\n"]}