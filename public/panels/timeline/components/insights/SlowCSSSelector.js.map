{"version":3,"file":"SlowCSSSelector.js","sourceRoot":"","sources":["../../../../../../../../front_end/panels/timeline/components/insights/SlowCSSSelector.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport './Table.js';\nimport '../../../../ui/components/linkifier/linkifier.js';\n\nimport * as i18n from '../../../../core/i18n/i18n.js';\nimport * as Platform from '../../../../core/platform/platform.js';\nimport * as SDK from '../../../../core/sdk/sdk.js';\nimport type * as Protocol from '../../../../generated/protocol.js';\nimport type {SlowCSSSelectorInsightModel} from '../../../../models/trace/insights/SlowCSSSelector.js';\nimport * as Trace from '../../../../models/trace/trace.js';\nimport type * as Linkifier from '../../../../ui/components/linkifier/linkifier.js';\nimport * as Lit from '../../../../ui/lit/lit.js';\nimport type * as Overlays from '../../overlays/overlays.js';\n\nimport {BaseInsightComponent} from './BaseInsightComponent.js';\nimport type {TableData} from './Table.js';\n\nconst {UIStrings, i18nString} = Trace.Insights.Models.SlowCSSSelector;\n\nconst {html} = Lit;\n\nexport class SlowCSSSelector extends BaseInsightComponent<SlowCSSSelectorInsightModel> {\n  static override readonly litTagName = Lit.StaticHtml.literal`devtools-performance-slow-css-selector`;\n  override internalName = 'slow-css-selector';\n  #selectorLocations = new Map<string, Protocol.CSS.SourceRange[]>();\n\n  override createOverlays(): Overlays.Overlays.TimelineOverlay[] {\n    return [];\n  }\n\n  private async toSourceFileLocation(cssModel: SDK.CSSModel.CSSModel, selector: Trace.Types.Events.SelectorTiming):\n      Promise<Linkifier.Linkifier.LinkifierData[]|undefined> {\n    if (!cssModel) {\n      return undefined;\n    }\n    const styleSheetHeader = cssModel.styleSheetHeaderForId(selector.style_sheet_id as Protocol.CSS.StyleSheetId);\n    if (!styleSheetHeader || !styleSheetHeader.resourceURL()) {\n      return undefined;\n    }\n\n    // get the locations from cache if available\n    const key: string = JSON.stringify({selectorText: selector.selector, styleSheetId: selector.style_sheet_id});\n    let ranges = this.#selectorLocations.get(key);\n    if (!ranges) {\n      const result = await cssModel.agent.invoke_getLocationForSelector(\n          {selectorText: selector.selector, styleSheetId: selector.style_sheet_id as Protocol.CSS.StyleSheetId});\n      if (result.getError() || !result.ranges) {\n        return undefined;\n      }\n      ranges = result.ranges;\n      this.#selectorLocations.set(key, ranges);\n    }\n\n    const locations = ranges.map((range, itemIndex) => {\n      return {\n        url: styleSheetHeader.resourceURL(),\n        lineNumber: range.startLine,\n        columnNumber: range.startColumn,\n        linkText: `[${itemIndex + 1}]`,\n        title: `${styleSheetHeader.id} line ${range.startLine + 1}:${range.startColumn + 1}`,\n      } as Linkifier.Linkifier.LinkifierData;\n    });\n    return locations;\n  }\n\n  private async getSelectorLinks(\n      cssModel: SDK.CSSModel.CSSModel|null|undefined,\n      selector: Trace.Types.Events.SelectorTiming): Promise<Lit.LitTemplate> {\n    if (!cssModel) {\n      return Lit.nothing;\n    }\n\n    if (!selector.style_sheet_id) {\n      return Lit.nothing;\n    }\n\n    const locations = await this.toSourceFileLocation(cssModel, selector);\n    if (!locations) {\n      return Lit.nothing;\n    }\n\n    const links = html`\n    ${locations.map((location, itemIndex) => {\n      const divider = itemIndex !== locations.length - 1 ? ', ' : '';\n      return html`<devtools-linkifier .data=${location}></devtools-linkifier>${divider}`;\n    })}`;\n\n    return links;\n  }\n\n  override renderContent(): Lit.LitTemplate {\n    if (!this.model) {\n      return Lit.nothing;\n    }\n\n    const target = SDK.TargetManager.TargetManager.instance().primaryPageTarget();\n    const cssModel = target?.model(SDK.CSSModel.CSSModel);\n    const time = (us: Trace.Types.Timing.Micro): string =>\n        i18n.TimeUtilities.millisToString(Platform.Timing.microSecondsToMilliSeconds(us));\n\n    if (!this.model.topMatchAttempts.length && !this.model.topElapsedMs.length) {\n      return html`<div class=\"insight-section\">${i18nString(UIStrings.enableSelectorData)}</div>`;\n    }\n\n    // clang-format off\n    const sections = [html`\n      <div class=\"insight-section\">\n        <devtools-performance-table\n          .data=${{\n            insight: this,\n            headers: [i18nString(UIStrings.total), ''],\n            rows: [\n              {values: [i18nString(UIStrings.elapsed), i18n.TimeUtilities.millisToString(this.model.totalElapsedMs)]},\n              {values: [i18nString(UIStrings.matchAttempts), this.model.totalMatchAttempts]},\n              {values: [i18nString(UIStrings.matchCount), this.model.totalMatchCount]},\n            ],\n          } as TableData}>\n        </devtools-performance-table>\n      </div>\n    `];\n    // clang-format on\n\n    if (this.model.topElapsedMs.length) {\n      // clang-format off\n      sections.push(html`\n        <div class=\"insight-section\">\n          <devtools-performance-table\n            .data=${{\n              insight: this,\n              headers: [i18nString(UIStrings.topSelectors), i18nString(UIStrings.elapsed)],\n              rows: this.model.topElapsedMs.map(selector => {\n                return {\n                  values: [\n                  html`${selector.selector} ${Lit.Directives.until(this.getSelectorLinks(cssModel, selector))}`,\n                  time(Trace.Types.Timing.Micro(selector['elapsed (us)']))],\n                };\n              }),\n            } as TableData}>\n          </devtools-performance-table>\n        </div>\n      `);\n      // clang-format on\n    }\n\n    if (this.model.topMatchAttempts.length) {\n      // clang-format off\n      sections.push(html`\n        <div class=\"insight-section\">\n          <devtools-performance-table\n            .data=${{\n              insight: this,\n              headers: [i18nString(UIStrings.topSelectors), i18nString(UIStrings.matchAttempts)],\n              rows: this.model.topMatchAttempts.map(selector => {\n                return {\n                  values: [\n                  html`${selector.selector} ${Lit.Directives.until(this.getSelectorLinks(cssModel, selector))}` as unknown as string,\n                  selector['match_attempts']],\n                };\n              }),\n            } as TableData}>\n          </devtools-performance-table>\n        </div>\n      `);\n      // clang-format on\n    }\n\n    return html`${sections}`;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'devtools-performance-slow-css-selector': SlowCSSSelector;\n  }\n}\n\ncustomElements.define('devtools-performance-slow-css-selector', SlowCSSSelector);\n"]}