{"version":3,"file":"SidebarSingleInsightSet.test.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/timeline/components/SidebarSingleInsightSet.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Trace from '../../../models/trace/trace.js';\nimport {getCleanTextContentFromElements, renderElementIntoDOM} from '../../../testing/DOMHelpers.js';\nimport {describeWithEnvironment} from '../../../testing/EnvironmentHelpers.js';\nimport {getInsightSetOrError} from '../../../testing/InsightHelpers.js';\nimport {TraceLoader} from '../../../testing/TraceLoader.js';\nimport type * as UI from '../../../ui/legacy/legacy.js';\n\nimport * as Components from './components.js';\nimport type * as InsightComponents from './insights/insights.js';\n\ntype BaseInsightComponent =\n    InsightComponents.BaseInsightComponent.BaseInsightComponent<Trace.Insights.Types.InsightModel>;\ntype BaseInsightWidget = UI.Widget.WidgetElement<BaseInsightComponent>;\n\nfunction getUserVisibleInsights(component: Components.SidebarSingleInsightSet.SidebarSingleInsightSet): string[] {\n  assert.isOk(component.element.shadowRoot);\n  return [\n    ...component.element.shadowRoot.querySelectorAll<BaseInsightWidget>('[data-insight-name]')\n  ].flatMap(component => getCleanTextContentFromElements(component.getWidget()?.element.shadowRoot!, '.insight-title'))\n      .filter(Boolean);\n}\n\nfunction getPassedInsights(component: Components.SidebarSingleInsightSet.SidebarSingleInsightSet): string[] {\n  assert.isOk(component.element.shadowRoot);\n  const passedInsightsSection =\n      component.element.shadowRoot.querySelector<HTMLDetailsElement>('.passed-insights-section');\n  assert.isOk(passedInsightsSection);\n  passedInsightsSection.open = true;\n  return [\n    ...passedInsightsSection.querySelectorAll<BaseInsightWidget>('.passed-insights-section [data-insight-name]')\n  ].flatMap(component => getCleanTextContentFromElements(component.getWidget()?.element.shadowRoot!, '.insight-title'));\n}\n\ndescribeWithEnvironment('SidebarSingleInsightSet', () => {\n  it('renders a list of insights', async function() {\n    const parsedTrace = await TraceLoader.traceEngine(this, 'web-dev-with-commit.json.gz');\n\n    assert.isOk(parsedTrace.insights);\n    // only one navigation in this trace.\n    assert.strictEqual(parsedTrace.insights.size, 1);\n    const insightSet = getInsightSetOrError(parsedTrace.insights, '8463DF94CD61B265B664E7F768183DE3');\n\n    const component = new Components.SidebarSingleInsightSet.SidebarSingleInsightSet();\n    renderElementIntoDOM(component);\n    component.data = {\n      insightSetKey: insightSet.id,\n      activeCategory: Trace.Insights.Types.InsightCategory.ALL,\n      activeInsight: null,\n      parsedTrace,\n    };\n    await component.updateComplete;\n\n    const userVisibleTitles = getUserVisibleInsights(component);\n    assert.deepEqual(userVisibleTitles, [\n      'LCP breakdown',\n      'LCP request discovery',\n      'Render blocking requests',\n      'Document request latency',\n      '3rd parties',\n    ]);\n\n    const passedInsightTitles = getPassedInsights(component);\n    assert.deepEqual(passedInsightTitles, [\n      'INP breakdown',\n      'Layout shift culprits',\n      'Network dependency tree',\n      'Improve image delivery',\n      'Font display',\n      'Optimize viewport for mobile',\n      'Optimize DOM size',\n      'Duplicated JavaScript',\n      'CSS Selector costs',\n      'Forced reflow',\n      'Use efficient cache lifetimes',\n      'Modern HTTP',\n      'Legacy JavaScript',\n    ]);\n  });\n\n  it('does not render experimental insights by default', async function() {\n    const parsedTrace = await TraceLoader.traceEngine(this, 'font-display.json.gz');\n    assert.isOk(parsedTrace.insights);\n\n    const component = new Components.SidebarSingleInsightSet.SidebarSingleInsightSet();\n    renderElementIntoDOM(component);\n    const firstNavigation = parsedTrace.data.Meta.mainFrameNavigations.at(0);\n    const insightSet = getInsightSetOrError(parsedTrace.insights, firstNavigation);\n    component.data = {\n      insightSetKey: insightSet.id,\n      activeCategory: Trace.Insights.Types.InsightCategory.ALL,\n      activeInsight: null,\n      parsedTrace,\n    };\n    await component.updateComplete;\n    const userVisibleTitles = getUserVisibleInsights(component);\n    // Does not include \"font display\", which is experimental.\n    assert.deepEqual(userVisibleTitles, [\n      'LCP breakdown',\n      'Layout shift culprits',\n      'Network dependency tree',\n      'Improve image delivery',\n      'Font display',\n      '3rd parties',\n      'Use efficient cache lifetimes',\n    ]);\n\n    const passedInsightTitles = getPassedInsights(component);\n    // Does not include \"font display\", which is experimental.\n    assert.deepEqual(passedInsightTitles, [\n      'INP breakdown',\n      'LCP request discovery',\n      'Render blocking requests',\n      'Document request latency',\n      'Optimize viewport for mobile',\n      'Optimize DOM size',\n      'Duplicated JavaScript',\n      'CSS Selector costs',\n      'Forced reflow',\n      'Modern HTTP',\n      'Legacy JavaScript',\n    ]);\n  });\n\n  it('will render the active insight fully', async function() {\n    const parsedTrace = await TraceLoader.traceEngine(this, 'web-dev-with-commit.json.gz');\n\n    assert.isOk(parsedTrace.insights);\n    // only one navigation in this trace.\n    assert.strictEqual(parsedTrace.insights.size, 1);\n    const insightSet = getInsightSetOrError(parsedTrace.insights, '8463DF94CD61B265B664E7F768183DE3');\n\n    const model = insightSet.model.LCPBreakdown;\n    if (!model) {\n      throw new Error('missing LCPBreakdown model');\n    }\n\n    const component = new Components.SidebarSingleInsightSet.SidebarSingleInsightSet();\n    renderElementIntoDOM(component);\n    component.data = {\n      insightSetKey: insightSet.id,\n      activeCategory: Trace.Insights.Types.InsightCategory.ALL,\n      activeInsight: {\n        model,\n        insightSetKey: insightSet.id,\n      },\n      parsedTrace,\n    };\n    await component.updateComplete;\n\n    const expandedInsight =\n        [...component.element.shadowRoot!.querySelectorAll<BaseInsightWidget>('[data-insight-name]')].find(el => {\n          return el.getWidget()?.selected;\n        });\n    assert.isOk(expandedInsight);\n    assert.strictEqual(expandedInsight.getWidget()?.model?.title, 'LCP breakdown');\n  });\n});\n"]}