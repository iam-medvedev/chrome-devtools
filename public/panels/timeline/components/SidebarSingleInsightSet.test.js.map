{"version":3,"file":"SidebarSingleInsightSet.test.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/timeline/components/SidebarSingleInsightSet.test.ts"],"names":[],"mappings":"AAAA,sCAAsC;AACtC,yEAAyE;AACzE,6BAA6B;AAE7B,OAAO,KAAK,KAAK,MAAM,gCAAgC,CAAC;AACxD,OAAO,EAAC,+BAA+B,EAAE,oBAAoB,EAAC,MAAM,gCAAgC,CAAC;AACrG,OAAO,EAAC,uBAAuB,EAAC,MAAM,wCAAwC,CAAC;AAC/E,OAAO,EAAC,WAAW,EAAC,MAAM,iCAAiC,CAAC;AAC5D,OAAO,KAAK,iBAAiB,MAAM,iEAAiE,CAAC;AAErG,OAAO,KAAK,UAAU,MAAM,iBAAiB,CAAC;AAM9C,SAAS,sBAAsB,CAAC,SAAqE;IACnG,MAAM,CAAC,IAAI,CAAC,SAAS,CAAC,UAAU,CAAC,CAAC;IAClC,OAAO,CAAC,GAAG,SAAS,CAAC,UAAU,CAAC,gBAAgB,CAAuB,qBAAqB,CAAC,CAAC;SACzF,OAAO,CAAC,SAAS,CAAC,EAAE,CAAC,+BAA+B,CAAC,SAAS,CAAC,UAAW,EAAE,gBAAgB,CAAC,CAAC;SAC9F,MAAM,CAAC,OAAO,CAAC,CAAC;AACvB,CAAC;AAED,SAAS,iBAAiB,CAAC,SAAqE;IAC9F,MAAM,CAAC,IAAI,CAAC,SAAS,CAAC,UAAU,CAAC,CAAC;IAClC,MAAM,qBAAqB,GAAG,SAAS,CAAC,UAAU,CAAC,aAAa,CAAqB,0BAA0B,CAAC,CAAC;IACjH,MAAM,CAAC,IAAI,CAAC,qBAAqB,CAAC,CAAC;IACnC,qBAAqB,CAAC,IAAI,GAAG,IAAI,CAAC;IAClC,OAAO;QACL,GAAG,qBAAqB,CAAC,gBAAgB,CAAuB,8CAA8C,CAAC;KAChH,CAAC,OAAO,CAAC,SAAS,CAAC,EAAE,CAAC,+BAA+B,CAAC,SAAS,CAAC,UAAW,EAAE,gBAAgB,CAAC,CAAC,CAAC;AACnG,CAAC;AAED,uBAAuB,CAAC,yBAAyB,EAAE,GAAG,EAAE;IACtD,EAAE,CAAC,4BAA4B,EAAE,KAAK;QACpC,MAAM,WAAW,GAAG,MAAM,WAAW,CAAC,WAAW,CAAC,IAAI,EAAE,6BAA6B,CAAC,CAAC;QAEvF,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC;QAClC,qCAAqC;QACrC,MAAM,CAAC,WAAW,CAAC,WAAW,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAC,CAAC,CAAC;QACjD,4CAA4C;QAC5C,MAAM,YAAY,GAAG,kCAAkC,CAAC;QACxD,MAAM,CAAC,MAAM,CAAC,WAAW,CAAC,QAAQ,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC,CAAC;QAEtD,MAAM,SAAS,GAAG,IAAI,UAAU,CAAC,uBAAuB,CAAC,uBAAuB,EAAE,CAAC;QACnF,oBAAoB,CAAC,SAAS,CAAC,CAAC;QAChC,SAAS,CAAC,IAAI,GAAG;YACf,aAAa,EAAE,YAAY;YAC3B,cAAc,EAAE,KAAK,CAAC,QAAQ,CAAC,KAAK,CAAC,eAAe,CAAC,GAAG;YACxD,aAAa,EAAE,IAAI;YACnB,WAAW;SACZ,CAAC;QACF,MAAM,iBAAiB,CAAC,IAAI,EAAE,CAAC;QAE/B,MAAM,iBAAiB,GAAG,sBAAsB,CAAC,SAAS,CAAC,CAAC;QAC5D,MAAM,CAAC,SAAS,CAAC,iBAAiB,EAAE;YAClC,eAAe;YACf,uBAAuB;YACvB,0BAA0B;YAC1B,0BAA0B;YAC1B,aAAa;SACd,CAAC,CAAC;QAEH,MAAM,mBAAmB,GAAG,iBAAiB,CAAC,SAAS,CAAC,CAAC;QACzD,MAAM,CAAC,SAAS,CAAC,mBAAmB,EAAE;YACpC,eAAe;YACf,uBAAuB;YACvB,yBAAyB;YACzB,wBAAwB;YACxB,cAAc;YACd,8BAA8B;YAC9B,mBAAmB;YACnB,uBAAuB;YACvB,oBAAoB;YACpB,eAAe;YACf,+BAA+B;YAC/B,aAAa;YACb,mBAAmB;SACpB,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,kDAAkD,EAAE,KAAK;QAC1D,MAAM,WAAW,GAAG,MAAM,WAAW,CAAC,WAAW,CAAC,IAAI,EAAE,sBAAsB,CAAC,CAAC;QAChF,MAAM,SAAS,GAAG,IAAI,UAAU,CAAC,uBAAuB,CAAC,uBAAuB,EAAE,CAAC;QACnF,oBAAoB,CAAC,SAAS,CAAC,CAAC;QAChC,MAAM,eAAe,GAAG,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,oBAAoB,CAAC,EAAE,CAAC,CAAC,CAAC,EAAE,IAAI,CAAC,IAAI,EAAE,YAAY,CAAC;QAClG,MAAM,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;QAC7B,SAAS,CAAC,IAAI,GAAG;YACf,aAAa,EAAE,eAAe;YAC9B,cAAc,EAAE,KAAK,CAAC,QAAQ,CAAC,KAAK,CAAC,eAAe,CAAC,GAAG;YACxD,aAAa,EAAE,IAAI;YACnB,WAAW;SACZ,CAAC;QACF,MAAM,iBAAiB,CAAC,IAAI,EAAE,CAAC;QAC/B,MAAM,iBAAiB,GAAG,sBAAsB,CAAC,SAAS,CAAC,CAAC;QAC5D,0DAA0D;QAC1D,MAAM,CAAC,SAAS,CAAC,iBAAiB,EAAE;YAClC,eAAe;YACf,uBAAuB;YACvB,yBAAyB;YACzB,wBAAwB;YACxB,cAAc;YACd,aAAa;YACb,+BAA+B;SAChC,CAAC,CAAC;QAEH,MAAM,mBAAmB,GAAG,iBAAiB,CAAC,SAAS,CAAC,CAAC;QACzD,0DAA0D;QAC1D,MAAM,CAAC,SAAS,CAAC,mBAAmB,EAAE;YACpC,eAAe;YACf,uBAAuB;YACvB,0BAA0B;YAC1B,0BAA0B;YAC1B,8BAA8B;YAC9B,mBAAmB;YACnB,uBAAuB;YACvB,oBAAoB;YACpB,eAAe;YACf,aAAa;YACb,mBAAmB;SACpB,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,sCAAsC,EAAE,KAAK;QAC9C,MAAM,WAAW,GAAG,MAAM,WAAW,CAAC,WAAW,CAAC,IAAI,EAAE,6BAA6B,CAAC,CAAC;QAEvF,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC;QAClC,qCAAqC;QACrC,MAAM,CAAC,WAAW,CAAC,WAAW,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAC,CAAC,CAAC;QACjD,4CAA4C;QAC5C,MAAM,YAAY,GAAG,kCAAkC,CAAC;QACxD,MAAM,CAAC,MAAM,CAAC,WAAW,CAAC,QAAQ,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC,CAAC;QAEtD,MAAM,KAAK,GAAG,WAAW,CAAC,QAAQ,CAAC,GAAG,CAAC,YAAY,CAAC,EAAE,KAAK,CAAC,YAAY,CAAC;QACzE,IAAI,CAAC,KAAK,EAAE,CAAC;YACX,MAAM,IAAI,KAAK,CAAC,4BAA4B,CAAC,CAAC;QAChD,CAAC;QAED,MAAM,SAAS,GAAG,IAAI,UAAU,CAAC,uBAAuB,CAAC,uBAAuB,EAAE,CAAC;QACnF,oBAAoB,CAAC,SAAS,CAAC,CAAC;QAChC,SAAS,CAAC,IAAI,GAAG;YACf,aAAa,EAAE,YAAY;YAC3B,cAAc,EAAE,KAAK,CAAC,QAAQ,CAAC,KAAK,CAAC,eAAe,CAAC,GAAG;YACxD,aAAa,EAAE;gBACb,KAAK;gBACL,aAAa,EAAE,YAAY;aAC5B;YACD,WAAW;SACZ,CAAC;QACF,MAAM,iBAAiB,CAAC,IAAI,EAAE,CAAC;QAE/B,MAAM,eAAe,GACjB,CAAC,GAAG,SAAS,CAAC,UAAW,CAAC,gBAAgB,CAAuB,qBAAqB,CAAC,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE;YACtG,OAAO,OAAO,CAAC,QAAQ,CAAC;QAC1B,CAAC,CAAC,CAAC;QACP,MAAM,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;QAC7B,MAAM,CAAC,WAAW,CAAC,eAAe,CAAC,KAAK,EAAE,KAAK,EAAE,eAAe,CAAC,CAAC;IACpE,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","sourcesContent":["// Copyright 2024 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Trace from '../../../models/trace/trace.js';\nimport {getCleanTextContentFromElements, renderElementIntoDOM} from '../../../testing/DOMHelpers.js';\nimport {describeWithEnvironment} from '../../../testing/EnvironmentHelpers.js';\nimport {TraceLoader} from '../../../testing/TraceLoader.js';\nimport * as RenderCoordinator from '../../../ui/components/render_coordinator/render_coordinator.js';\n\nimport * as Components from './components.js';\nimport type * as InsightComponents from './insights/insights.js';\n\ntype BaseInsightComponent =\n    InsightComponents.BaseInsightComponent.BaseInsightComponent<Trace.Insights.Types.InsightModel>;\n\nfunction getUserVisibleInsights(component: Components.SidebarSingleInsightSet.SidebarSingleInsightSet): string[] {\n  assert.isOk(component.shadowRoot);\n  return [...component.shadowRoot.querySelectorAll<BaseInsightComponent>('[data-insight-name]')]\n      .flatMap(component => getCleanTextContentFromElements(component.shadowRoot!, '.insight-title'))\n      .filter(Boolean);\n}\n\nfunction getPassedInsights(component: Components.SidebarSingleInsightSet.SidebarSingleInsightSet): string[] {\n  assert.isOk(component.shadowRoot);\n  const passedInsightsSection = component.shadowRoot.querySelector<HTMLDetailsElement>('.passed-insights-section');\n  assert.isOk(passedInsightsSection);\n  passedInsightsSection.open = true;\n  return [\n    ...passedInsightsSection.querySelectorAll<BaseInsightComponent>('.passed-insights-section [data-insight-name]')\n  ].flatMap(component => getCleanTextContentFromElements(component.shadowRoot!, '.insight-title'));\n}\n\ndescribeWithEnvironment('SidebarSingleInsightSet', () => {\n  it('renders a list of insights', async function() {\n    const parsedTrace = await TraceLoader.traceEngine(this, 'web-dev-with-commit.json.gz');\n\n    assert.isOk(parsedTrace.insights);\n    // only one navigation in this trace.\n    assert.strictEqual(parsedTrace.insights.size, 1);\n    // This is the navigationID from this trace.\n    const navigationId = '8463DF94CD61B265B664E7F768183DE3';\n    assert.isTrue(parsedTrace.insights.has(navigationId));\n\n    const component = new Components.SidebarSingleInsightSet.SidebarSingleInsightSet();\n    renderElementIntoDOM(component);\n    component.data = {\n      insightSetKey: navigationId,\n      activeCategory: Trace.Insights.Types.InsightCategory.ALL,\n      activeInsight: null,\n      parsedTrace,\n    };\n    await RenderCoordinator.done();\n\n    const userVisibleTitles = getUserVisibleInsights(component);\n    assert.deepEqual(userVisibleTitles, [\n      'LCP breakdown',\n      'LCP request discovery',\n      'Render blocking requests',\n      'Document request latency',\n      '3rd parties',\n    ]);\n\n    const passedInsightTitles = getPassedInsights(component);\n    assert.deepEqual(passedInsightTitles, [\n      'INP breakdown',\n      'Layout shift culprits',\n      'Network dependency tree',\n      'Improve image delivery',\n      'Font display',\n      'Optimize viewport for mobile',\n      'Optimize DOM size',\n      'Duplicated JavaScript',\n      'CSS Selector costs',\n      'Forced reflow',\n      'Use efficient cache lifetimes',\n      'Modern HTTP',\n      'Legacy JavaScript',\n    ]);\n  });\n\n  it('does not render experimental insights by default', async function() {\n    const parsedTrace = await TraceLoader.traceEngine(this, 'font-display.json.gz');\n    const component = new Components.SidebarSingleInsightSet.SidebarSingleInsightSet();\n    renderElementIntoDOM(component);\n    const firstNavigation = parsedTrace.data.Meta.mainFrameNavigations.at(0)?.args.data?.navigationId;\n    assert.isOk(firstNavigation);\n    component.data = {\n      insightSetKey: firstNavigation,\n      activeCategory: Trace.Insights.Types.InsightCategory.ALL,\n      activeInsight: null,\n      parsedTrace,\n    };\n    await RenderCoordinator.done();\n    const userVisibleTitles = getUserVisibleInsights(component);\n    // Does not include \"font display\", which is experimental.\n    assert.deepEqual(userVisibleTitles, [\n      'LCP breakdown',\n      'Layout shift culprits',\n      'Network dependency tree',\n      'Improve image delivery',\n      'Font display',\n      '3rd parties',\n      'Use efficient cache lifetimes',\n    ]);\n\n    const passedInsightTitles = getPassedInsights(component);\n    // Does not include \"font display\", which is experimental.\n    assert.deepEqual(passedInsightTitles, [\n      'INP breakdown',\n      'LCP request discovery',\n      'Render blocking requests',\n      'Document request latency',\n      'Optimize viewport for mobile',\n      'Optimize DOM size',\n      'Duplicated JavaScript',\n      'CSS Selector costs',\n      'Forced reflow',\n      'Modern HTTP',\n      'Legacy JavaScript',\n    ]);\n  });\n\n  it('will render the active insight fully', async function() {\n    const parsedTrace = await TraceLoader.traceEngine(this, 'web-dev-with-commit.json.gz');\n\n    assert.isOk(parsedTrace.insights);\n    // only one navigation in this trace.\n    assert.strictEqual(parsedTrace.insights.size, 1);\n    // This is the navigationID from this trace.\n    const navigationId = '8463DF94CD61B265B664E7F768183DE3';\n    assert.isTrue(parsedTrace.insights.has(navigationId));\n\n    const model = parsedTrace.insights.get(navigationId)?.model.LCPBreakdown;\n    if (!model) {\n      throw new Error('missing LCPBreakdown model');\n    }\n\n    const component = new Components.SidebarSingleInsightSet.SidebarSingleInsightSet();\n    renderElementIntoDOM(component);\n    component.data = {\n      insightSetKey: navigationId,\n      activeCategory: Trace.Insights.Types.InsightCategory.ALL,\n      activeInsight: {\n        model,\n        insightSetKey: navigationId,\n      },\n      parsedTrace,\n    };\n    await RenderCoordinator.done();\n\n    const expandedInsight =\n        [...component.shadowRoot!.querySelectorAll<BaseInsightComponent>('[data-insight-name]')].find(insight => {\n          return insight.selected;\n        });\n    assert.isOk(expandedInsight);\n    assert.strictEqual(expandedInsight.model?.title, 'LCP breakdown');\n  });\n});\n"]}