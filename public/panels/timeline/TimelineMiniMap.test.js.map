{"version":3,"file":"TimelineMiniMap.test.js","sourceRoot":"","sources":["../../../../../../front_end/panels/timeline/TimelineMiniMap.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2023 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Trace from '../../models/trace/trace.js';\nimport * as TraceBounds from '../../services/trace_bounds/trace_bounds.js';\nimport {assertScreenshot, raf, renderElementIntoDOM} from '../../testing/DOMHelpers.js';\nimport {describeWithEnvironment} from '../../testing/EnvironmentHelpers.js';\nimport {getMainThread} from '../../testing/TraceHelpers.js';\nimport {TraceLoader} from '../../testing/TraceLoader.js';\nimport * as UI from '../../ui/legacy/legacy.js';\n\nimport * as TimelineComponents from './components/components.js';\nimport * as Timeline from './timeline.js';\n\ndescribeWithEnvironment('TimelineMiniMap', function() {\n  async function renderMiniMapForScreenshot(parsedTrace: Trace.Handlers.Types.ParsedTrace): Promise<void> {\n    const container = document.createElement('div');\n    container.style.flex = 'none';\n    container.style.display = 'flex';\n    container.style.position = 'relative';\n    container.style.width = '600px';\n    container.style.height = '200px';\n    container.innerHTML = `<style>${UI.inspectorCommonStyles}</style>`;\n    renderElementIntoDOM(container);\n\n    const minimap = new Timeline.TimelineMiniMap.TimelineMiniMap();\n    minimap.markAsRoot();\n    minimap.show(container);\n    minimap.setData({\n      parsedTrace,\n      settings: {\n        showMemory: true,\n        showScreenshots: true,\n      },\n    });\n    // Now we can zoom into the main thread activity; this means the resize handles are\n    // not both on the edge of the screen, so it's a more representative screenshot.\n    const mainThread = getMainThread(parsedTrace.Renderer);\n    const zoomedWindow = Trace.Extras.MainThreadActivity.calculateWindow(\n        parsedTrace.Meta.traceBounds,\n        mainThread.entries,\n    );\n    TraceBounds.TraceBounds.BoundsManager.instance().setTimelineVisibleWindow(zoomedWindow);\n    await raf();\n  }\n\n  it('always shows the responsiveness, CPU activity and network panel', async function() {\n    const {parsedTrace} = await TraceLoader.traceEngine(this, 'web-dev.json.gz');\n\n    const container = document.createElement('div');\n    renderElementIntoDOM(container);\n\n    const minimap = new Timeline.TimelineMiniMap.TimelineMiniMap();\n    minimap.markAsRoot();\n    minimap.show(container);\n\n    minimap.setData({\n      parsedTrace,\n      settings: {\n        showMemory: false,\n        showScreenshots: false,\n      },\n    });\n\n    await raf();\n    assert.exists(container.querySelector('#timeline-overview-responsiveness'));\n    assert.exists(container.querySelector('#timeline-overview-cpu-activity'));\n    assert.exists(container.querySelector('#timeline-overview-network'));\n    assert.isNull(container.querySelector('#timeline-overview-filmstrip'));\n    assert.isNull(container.querySelector('#timeline-overview-memory'));\n  });\n\n  it('shows memory and screenshots also if they are set to be visible', async function() {\n    const {parsedTrace} = await TraceLoader.traceEngine(this, 'web-dev.json.gz');\n    await renderMiniMapForScreenshot(parsedTrace);\n    await assertScreenshot('timeline/minimap_with_memory_and_screenshots.png');\n  });\n\n  it('highlights long tasks in red', async function() {\n    const {parsedTrace} = await TraceLoader.traceEngine(this, 'one-second-interaction.json.gz');\n    await renderMiniMapForScreenshot(parsedTrace);\n    await assertScreenshot('timeline/minimap_long_task.png');\n  });\n\n  it('creates the first breadcrumb', async function() {\n    const {parsedTrace} = await TraceLoader.traceEngine(this, 'web-dev.json.gz');\n\n    const container = document.createElement('div');\n    renderElementIntoDOM(container);\n\n    const minimap = new Timeline.TimelineMiniMap.TimelineMiniMap();\n    minimap.markAsRoot();\n    minimap.show(container);\n\n    minimap.setData({\n      parsedTrace,\n      settings: {\n        showMemory: true,\n        showScreenshots: true,\n      },\n    });\n\n    await raf();\n\n    if (!minimap.breadcrumbs) {\n      throw new Error('The MiniMap unexpectedly did not create any breadcrumbs');\n    }\n\n    assert.lengthOf(TimelineComponents.Breadcrumbs.flattenBreadcrumbs(minimap.breadcrumbs.initialBreadcrumb), 1);\n    assert.deepEqual(minimap.breadcrumbs.initialBreadcrumb, {window: parsedTrace.Meta.traceBounds, child: null});\n  });\n\n  it('stores breadcrumbs to be serialized', async function() {\n    const {parsedTrace} = await TraceLoader.traceEngine(this, 'web-dev.json.gz');\n    const minimap = new Timeline.TimelineMiniMap.TimelineMiniMap();\n    minimap.setData({\n      parsedTrace,\n      settings: {\n        showMemory: true,\n        showScreenshots: true,\n      },\n    });\n    const entireTraceBounds = parsedTrace.Meta.traceBounds;\n    const newBounds = {\n      ...entireTraceBounds,\n      min: Trace.Types.Timing.Micro((entireTraceBounds.max + entireTraceBounds.min) / 2),\n    };\n    minimap.breadcrumbs?.add(newBounds);\n    const serializableModifications = Timeline.ModificationsManager.ModificationsManager.activeManager()?.toJSON();\n    assert.deepEqual(\n        serializableModifications?.initialBreadcrumb.child,\n        {window: {min: 1020035455504, max: 1020036087961, range: 1264914}, child: null} as Trace.Types.File.Breadcrumb);\n  });\n});\n"]}