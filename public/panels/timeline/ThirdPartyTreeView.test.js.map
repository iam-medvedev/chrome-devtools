{"version":3,"file":"ThirdPartyTreeView.test.js","sourceRoot":"","sources":["../../../../../../front_end/panels/timeline/ThirdPartyTreeView.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Trace from '../../models/trace/trace.js';\nimport {renderElementIntoDOM} from '../../testing/DOMHelpers.js';\nimport {describeWithEnvironment} from '../../testing/EnvironmentHelpers.js';\nimport {TraceLoader} from '../../testing/TraceLoader.js';\nimport * as UI from '../../ui/legacy/legacy.js';\n\nimport * as Timeline from './timeline.js';\n\ndescribeWithEnvironment('Third party tree', function() {\n  it('does not select the first row by default', async function() {\n    const parsedTrace = await TraceLoader.traceEngine(this, 'web-dev-with-commit.json.gz');\n    const treeView = new Timeline.ThirdPartyTreeView.ThirdPartyTreeViewWidget();\n    const mapper = new Trace.EntityMapper.EntityMapper(parsedTrace);\n    const events = [...mapper.mappings().eventsByEntity.values()].flat().sort((a, b) => a.ts - b.ts);\n    treeView.setModelWithEvents(events, parsedTrace, mapper);\n    const sel: Timeline.TimelineSelection.TimeRangeSelection = {\n      bounds: parsedTrace.data.Meta.traceBounds,\n    };\n    const box = new UI.Widget.VBox();\n    treeView.show(box.element);\n    treeView.updateContents(sel);\n    assert.isNull(treeView.dataGrid.selectedNode);\n  });\n\n  it('hides the table if there are no events', async function() {\n    const parsedTrace = await TraceLoader.traceEngine(this, 'web-dev-with-commit.json.gz');\n    const mapper = new Trace.EntityMapper.EntityMapper(parsedTrace);\n    const treeView = new Timeline.ThirdPartyTreeView.ThirdPartyTreeViewWidget();\n    renderElementIntoDOM(treeView);\n    treeView.setModelWithEvents(null, parsedTrace, mapper);\n    assert.isTrue(treeView.element.classList.contains('empty-table'));\n\n    const events = [...mapper.mappings().eventsByEntity.values()].flat().sort((a, b) => a.ts - b.ts);\n    treeView.setModelWithEvents(events, parsedTrace, mapper);\n    assert.isFalse(treeView.element.classList.contains('empty-table'));\n\n    treeView.setModelWithEvents([], parsedTrace, mapper);\n    assert.isTrue(treeView.element.classList.contains('empty-table'));\n  });\n\n  it('includes 1p and extension badges', async function() {\n    // This trace creates 2 nodes in the tree. One representing the first party entity, and one for\n    // a chrome extension.\n    const parsedTrace = await TraceLoader.traceEngine(this, 'extension-tracks-and-marks.json.gz');\n    const treeView = new Timeline.ThirdPartyTreeView.ThirdPartyTreeViewWidget();\n    const mapper = new Trace.EntityMapper.EntityMapper(parsedTrace);\n    const events = [...mapper.mappings().eventsByEntity.values()].flat().sort((a, b) => a.ts - b.ts);\n\n    treeView.setModelWithEvents(events, parsedTrace, mapper);\n    const sel: Timeline.TimelineSelection.TimeRangeSelection = {\n      bounds: parsedTrace.data.Meta.traceBounds,\n    };\n    treeView.updateContents(sel);\n    const tree = treeView.buildTree() as Trace.Extras.TraceTree.BottomUpRootNode;\n    const topNodesIterator = [...tree.children().values()].flat().sort((a, b) => b.selfTime - a.selfTime);\n\n    // Node with first party\n    let node = topNodesIterator[0];\n    assert.strictEqual(node.id.toString(), 'localhost');\n    assert.strictEqual(node.selfTime, 1008.3260016441345);\n    let gridNode =\n        new Timeline.TimelineTreeView.TreeGridNode(node, node.totalTime, node.selfTime, node.totalTime, treeView);\n    let entity = gridNode?.createCell('site');\n    let gotBadgeName = entity.querySelector<HTMLTableRowElement>('.entity-badge')?.textContent || '';\n    assert.strictEqual(gotBadgeName, '1st party');\n\n    // Node for third party origin\n    node = topNodesIterator[1];\n    assert.strictEqual(node.id.toString(), 'wikimedia.org');\n    assert.strictEqual(node.selfTime, 148.06499981880188);\n    gridNode =\n        new Timeline.TimelineTreeView.TreeGridNode(node, node.totalTime, node.selfTime, node.totalTime, treeView);\n    entity = gridNode?.createCell('site');\n    gotBadgeName = entity.querySelector<HTMLTableRowElement>('.entity-badge')?.textContent || '';\n    assert.strictEqual(gotBadgeName, '');  // no badge\n\n    // Node with ext\n    node = topNodesIterator[2];\n    assert.strictEqual(node.id.toString(), 'ienfalfjdbdpebioblfackkekamfmbnh');\n    assert.strictEqual(node.selfTime, 2.5320003032684326);\n    gridNode =\n        new Timeline.TimelineTreeView.TreeGridNode(node, node.totalTime, node.selfTime, node.totalTime, treeView);\n    entity = gridNode?.createCell('site');\n    gotBadgeName = entity.querySelector<HTMLTableRowElement>('.entity-badge')?.textContent || '';\n    assert.strictEqual(gotBadgeName, 'Extension');\n  });\n});\n"]}