{"version":3,"file":"ImageCache.test.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/timeline/utils/ImageCache.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Trace from '../../../models/trace/trace.js';\nimport {defaultTraceEvent} from '../../../testing/TraceHelpers.js';\n\nimport * as Utils from './utils.js';\n\nconst {cacheForTesting, emitter, getOrQueue, loadImageForTesting: loadImage, preload} = Utils.ImageCache;\n\ndescribe('ImageCache', () => {\n  // Generate at https://yulvil.github.io/gopherjs/02/ with 1,1,1,jpeg in the form fields\n  const validJpegData =\n      'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAEElEQVR4nGISWfUPEAAA//8CmgG/YtkszwAAAABJRU5ErkJggg==';\n\n  const rawSourceEvent: Trace.Types.Events.LegacyScreenshot = {\n    ...defaultTraceEvent,\n    id: '0x1',\n    args: {snapshot: validJpegData},\n    name: Trace.Types.Events.Name.SCREENSHOT,\n    cat: 'disabled-by-default-devtools.screenshot',\n    ph: Trace.Types.Events.Phase.OBJECT_SNAPSHOT,\n  };\n\n  Trace.Handlers.ModelHandlers.Screenshots.reset();\n  Trace.Handlers.ModelHandlers.Screenshots.handleEvent(rawSourceEvent);\n  void Trace.Handlers.ModelHandlers.Screenshots.finalize();\n\n  const syntheticScreenshot1 = Trace.Handlers.ModelHandlers.Screenshots.data().legacySyntheticScreenshots?.at(0);\n  assert.isOk(syntheticScreenshot1);\n  const syntheticScreenshot2 = structuredClone(syntheticScreenshot1);\n  syntheticScreenshot2.rawSourceEvent.id = '0x2';\n  const badDataUriScreenshot = structuredClone(syntheticScreenshot1);\n  badDataUriScreenshot.args.dataUri = 'INVALIDDATA';\n\n  beforeEach(() => {\n    const cache = cacheForTesting;\n    cache.delete(syntheticScreenshot1);\n    cache.delete(syntheticScreenshot2);\n    cache.delete(badDataUriScreenshot);\n  });\n\n  it('loadImage resolves valid images', async () => {\n    const datauri = `data:image/jpg;base64,${validJpegData}`;\n    const res = await loadImage(datauri);\n    assert.instanceOf(res, HTMLImageElement);\n  });\n  it('loadImage resolves invalid images to null', async () => {\n    const datauri = 'data:image/jpg;base64,INVALIDDATA';\n    const res = await loadImage(datauri);\n    assert.isNull(res);\n  });\n\n  it('getOrQueue should return null for a new screenshot', () => {\n    assert.isNull(getOrQueue(syntheticScreenshot1));\n  });\n\n  it('getOrQueue should return the same image for the same screenshot', async () => {\n    // Preload to ensure image is loaded for both reads.\n    await preload([syntheticScreenshot1]);\n\n    const image1 = getOrQueue(syntheticScreenshot1);\n    const image2 = getOrQueue(syntheticScreenshot1);\n    assert.strictEqual(image2, image1);\n    assert.instanceOf(image1, HTMLImageElement);\n  });\n\n  it('emitter should emit an event when a screenshot is updated', async () => {\n    const {promise, resolve} = Promise.withResolvers();\n    emitter.addEventListener('screenshot-loaded', ev => {\n      const event = ev as CustomEvent;\n      assert.strictEqual(event.detail.screenshot, syntheticScreenshot1);\n      assert.instanceOf(event.detail.image, HTMLImageElement);\n      // Cache is updated too.\n      assert.instanceOf(getOrQueue(syntheticScreenshot1), HTMLImageElement);\n      resolve(null);\n    }, {once: true});\n\n    assert.isNull(getOrQueue(syntheticScreenshot1));\n    return await promise;\n  });\n\n  it('getOrQueue should return null (immediately and eventually) for an invalid image', async () => {\n    // First attempt is null because empty cache.\n    assert.isNull(getOrQueue(badDataUriScreenshot));\n\n    const {promise, resolve} = Promise.withResolvers();\n    emitter.addEventListener('screenshot-loaded', ev => {\n      const event = ev as CustomEvent;\n      assert.strictEqual(event.detail.screenshot, badDataUriScreenshot);\n      // Loaded but invalid, so null.\n      assert.isNull(event.detail.image);\n      // Null stored in the cache\n      assert.isNull(getOrQueue(badDataUriScreenshot));\n\n      resolve(null);\n    }, {once: true});\n    return await promise;\n  });\n\n  it('preload should load all screenshots', async () => {\n    await preload([syntheticScreenshot1, syntheticScreenshot2]);\n    assert.instanceOf(getOrQueue(syntheticScreenshot1), HTMLImageElement);\n    assert.instanceOf(getOrQueue(syntheticScreenshot2), HTMLImageElement);\n  });\n});\n"]}