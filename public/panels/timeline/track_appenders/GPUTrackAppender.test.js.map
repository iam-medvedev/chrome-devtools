{"version":3,"file":"GPUTrackAppender.test.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/timeline/track_appenders/GPUTrackAppender.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2023 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport type * as TimelineModel from '../../../models/timeline_model/timeline_model.js';\nimport * as TraceEngine from '../../../models/trace/trace.js';\nimport {describeWithEnvironment} from '../../../testing/EnvironmentHelpers.js';\nimport {TraceLoader} from '../../../testing/TraceLoader.js';\nimport * as PerfUI from '../../../ui/legacy/components/perf_ui/perf_ui.js';\nimport * as Timeline from '../timeline.js';\n\nconst {assert} = chai;\n\nfunction initTrackAppender(\n    flameChartData: PerfUI.FlameChart.FlameChartTimelineData,\n    traceParsedData: TraceEngine.Handlers.Types.TraceParseData,\n    entryData: Timeline.TimelineFlameChartDataProvider.TimelineFlameChartEntry[],\n    entryTypeByLevel: Timeline.TimelineFlameChartDataProvider.EntryType[],\n    timelineModel: TimelineModel.TimelineModel.TimelineModelImpl): Timeline.GPUTrackAppender.GPUTrackAppender {\n  const compatibilityTracksAppender = new Timeline.CompatibilityTracksAppender.CompatibilityTracksAppender(\n      flameChartData, traceParsedData, entryData, entryTypeByLevel, timelineModel);\n  return compatibilityTracksAppender.gpuTrackAppender();\n}\n\ndescribeWithEnvironment('GPUTrackAppender', function() {\n  let traceParsedData: TraceEngine.Handlers.Types.TraceParseData;\n  let timelineModel: TimelineModel.TimelineModel.TimelineModelImpl;\n  let gpuTrackAppender: Timeline.GPUTrackAppender.GPUTrackAppender;\n  let entryData: Timeline.TimelineFlameChartDataProvider.TimelineFlameChartEntry[] = [];\n  let flameChartData = PerfUI.FlameChart.FlameChartTimelineData.createEmpty();\n  let entryTypeByLevel: Timeline.TimelineFlameChartDataProvider.EntryType[] = [];\n\n  beforeEach(async function() {\n    const data = await TraceLoader.allModels(this, 'threejs-gpu.json.gz');\n    traceParsedData = data.traceParsedData;\n    timelineModel = data.timelineModel;\n    gpuTrackAppender = initTrackAppender(flameChartData, traceParsedData, entryData, entryTypeByLevel, timelineModel);\n    gpuTrackAppender.appendTrackAtLevel(0);\n  });\n\n  afterEach(() => {\n    entryData = [];\n    flameChartData = PerfUI.FlameChart.FlameChartTimelineData.createEmpty();\n    entryTypeByLevel = [];\n  });\n\n  describe('appendTrackAtLevel', () => {\n    it('marks all levels used by the track with the `TrackAppender` type', () => {\n      // One levels should be taken: 1 for the GPU tasks.\n      const levelCount = 1;\n      assert.strictEqual(entryTypeByLevel.length, levelCount);\n      const allEntriesAreTrackAppender =\n          entryTypeByLevel.every(type => type === Timeline.TimelineFlameChartDataProvider.EntryType.TrackAppender);\n      assert.isTrue(allEntriesAreTrackAppender);\n    });\n\n    it('creates a flamechart group for the GPU track', () => {\n      assert.strictEqual(flameChartData.groups.length, 1);\n      assert.strictEqual(flameChartData.groups[0].name, 'GPU');\n    });\n\n    it('adds start times correctly', () => {\n      const gpuEvents = traceParsedData.GPU.mainGPUThreadTasks;\n      for (const event of gpuEvents) {\n        const index = entryData.indexOf(event);\n        assert.isDefined(index);\n        assert.strictEqual(\n            flameChartData.entryStartTimes[index], TraceEngine.Helpers.Timing.microSecondsToMilliseconds(event.ts));\n      }\n    });\n\n    it('adds total times correctly', () => {\n      const gpuEvents = traceParsedData.GPU.mainGPUThreadTasks;\n      for (const event of gpuEvents) {\n        const index = entryData.indexOf(event);\n        assert.isDefined(index);\n        if (TraceEngine.Handlers.ModelHandlers.PageLoadMetrics.isTraceEventMarkerEvent(event)) {\n          assert.isNaN(flameChartData.entryTotalTimes[index]);\n          continue;\n        }\n        const expectedTotalTimeForEvent = event.dur ?\n            TraceEngine.Helpers.Timing.microSecondsToMilliseconds(event.dur as TraceEngine.Types.Timing.MicroSeconds) :\n            Timeline.TimelineFlameChartDataProvider.InstantEventVisibleDurationMs;\n        assert.strictEqual(flameChartData.entryTotalTimes[index], expectedTotalTimeForEvent);\n      }\n    });\n  });\n\n  describe('colorForEvent and titleForEvent', () => {\n    before(() => {\n      // Rather than use the real colours here and burden the test with having to\n      // inject loads of CSS, we fake out the colours. this is fine for our tests as\n      // the exact value of the colours is not important; we just make sure that it\n      // parses them out correctly. Each variable is given a different rgb() value to\n      // ensure we know the code is working and using the right one.\n      const styleElement = document.createElement('style');\n      styleElement.id = 'fake-perf-panel-colors';\n      styleElement.textContent = `\n        :root {\n          --app-color-painting: rgb(6 6 6);\n        }\n      `;\n      document.documentElement.appendChild(styleElement);\n    });\n\n    after(() => {\n      const styleElementToRemove = document.documentElement.querySelector('#fake-perf-panel-colors');\n      if (styleElementToRemove) {\n        document.documentElement.removeChild(styleElementToRemove);\n      }\n    });\n    it('returns the correct color and title for GPU tasks', () => {\n      const gpuEvents = traceParsedData.GPU.mainGPUThreadTasks;\n      for (const event of gpuEvents) {\n        assert.strictEqual(gpuTrackAppender.titleForEvent(event), 'GPU');\n        assert.strictEqual(gpuTrackAppender.colorForEvent(event), 'rgb(6 6 6)');\n      }\n    });\n  });\n\n  describe('highlightedEntryInfo', () => {\n    it('returns the info for a entry correctly', () => {\n      const gpuEvents = traceParsedData.GPU.mainGPUThreadTasks;\n      const highlightedEntryInfo = gpuTrackAppender.highlightedEntryInfo(gpuEvents[0]);\n      // The i18n encodes spaces using the u00A0 unicode character.\n      assert.strictEqual(highlightedEntryInfo.formattedTime, '52.37\\u00A0ms');\n    });\n  });\n});\n"]}