{"version":3,"file":"TimelineHistoryManager.test.js","sourceRoot":"","sources":["../../../../../../front_end/panels/timeline/TimelineHistoryManager.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2023 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Root from '../../core/root/root.js';\nimport {\n  describeWithEnvironment,\n  registerNoopActions,\n} from '../../testing/EnvironmentHelpers.js';\nimport {TraceLoader} from '../../testing/TraceLoader.js';\nimport * as UI from '../../ui/legacy/legacy.js';\n\nimport * as Timeline from './timeline.js';\n\ndescribeWithEnvironment('TimelineHistoryManager', function() {\n  let historyManager: Timeline.TimelineHistoryManager.TimelineHistoryManager;\n  beforeEach(() => {\n    registerNoopActions(['timeline.show-history']);\n    historyManager = new Timeline.TimelineHistoryManager.TimelineHistoryManager();\n  });\n\n  afterEach(() => {\n    UI.ActionRegistry.ActionRegistry.reset();\n    Root.Runtime.experiments.disableForTest(Root.Runtime.ExperimentName.TIMELINE_OBSERVATIONS);\n  });\n\n  it('shows the dropdown including a landing page link if the observations experiment is enabled', async function() {\n    Root.Runtime.experiments.enableForTest(Root.Runtime.ExperimentName.TIMELINE_OBSERVATIONS);\n    const {traceData} = await TraceLoader.traceEngine(this, 'web-dev-with-commit.json.gz');\n    historyManager.addRecording(\n        {\n          data: {\n            traceParseDataIndex: 1,\n            type: 'TRACE_INDEX',\n          },\n          filmStripForPreview: null,\n          traceParsedData: traceData,\n          startTime: null,\n        },\n    );\n\n    const showPromise = historyManager.showHistoryDropDown();\n    const glassPane = document.querySelector('div[data-devtools-glass-pane]');\n    const dropdown =\n        glassPane?.shadowRoot?.querySelector('.widget')?.shadowRoot?.querySelector<HTMLElement>('.drop-down');\n    assert.isOk(dropdown);\n\n    const menuItemText = Array.from(dropdown.querySelectorAll<HTMLDivElement>('[role=\"menuitem\"]'), elem => {\n      return elem.innerText.replaceAll('\\n', '');\n    });\n    assert.deepEqual(menuItemText, ['Local metrics', 'web.dev5.39 s']);\n\n    // Cancel the dropdown, which also resolves the show() promise, meaning we\n    // don't leak it into other tests.\n    historyManager.cancelIfShowing();\n    await showPromise;\n  });\n\n  it('does not show if observations experiment is disabled + the user has not imported 2 traces', async function() {\n    const {traceData} = await TraceLoader.traceEngine(this, 'web-dev-with-commit.json.gz');\n    historyManager.addRecording(\n        {\n          data: {\n            traceParseDataIndex: 1,\n            type: 'TRACE_INDEX',\n          },\n          filmStripForPreview: null,\n          traceParsedData: traceData,\n          startTime: null,\n        },\n    );\n\n    const promise = historyManager.showHistoryDropDown();\n    const glassPane = document.querySelector('div[data-devtools-glass-pane]');\n    assert.isNull(glassPane);  // check that no DOM for the dropdown got created\n    // check the result of calling showHistoryDropDown which should be `null` if it didn't show\n    const result = await promise;\n    assert.isNull(result);\n  });\n\n  it('does not show the landing page link if the observations experiment is disabled', async function() {\n    const {traceData: traceData1} = await TraceLoader.traceEngine(this, 'web-dev-with-commit.json.gz');\n    historyManager.addRecording(\n        {\n          data: {\n            traceParseDataIndex: 1,\n            type: 'TRACE_INDEX',\n          },\n          filmStripForPreview: null,\n          traceParsedData: traceData1,\n          startTime: null,\n        },\n    );\n    const {traceData: traceData2} = await TraceLoader.traceEngine(this, 'timings-track.json.gz');\n    historyManager.addRecording(\n        {\n          data: {\n            traceParseDataIndex: 2,\n            type: 'TRACE_INDEX',\n          },\n          filmStripForPreview: null,\n          traceParsedData: traceData2,\n          startTime: null,\n        },\n    );\n\n    const showPromise = historyManager.showHistoryDropDown();\n    const glassPane = document.querySelector('div[data-devtools-glass-pane]');\n    const dropdown =\n        glassPane?.shadowRoot?.querySelector('.widget')?.shadowRoot?.querySelector<HTMLElement>('.drop-down');\n    assert.isOk(dropdown);\n\n    const menuItemText = Array.from(dropdown.querySelectorAll<HTMLDivElement>('[role=\"menuitem\"]'), elem => {\n      return elem.innerText.replaceAll('\\n', '');\n    });\n    assert.deepEqual(menuItemText, [\n      'localhost3.16 s',\n      'web.dev5.39 s',\n    ]);\n\n    // Cancel the dropdown, which also resolves the show() promise, meaning we\n    // don't leak it into other tests.\n    historyManager.cancelIfShowing();\n    await showPromise;\n  });\n\n  it('can select from multiple parsed data objects', async function() {\n    // Add two parsed data objects to the history manager.\n    const {traceData: trace1Data} = await TraceLoader.traceEngine(this, 'slow-interaction-button-click.json.gz');\n    historyManager.addRecording(\n        {\n          data: {\n            traceParseDataIndex: 1,\n            type: 'TRACE_INDEX',\n          },\n          filmStripForPreview: null,\n          traceParsedData: trace1Data,\n          startTime: null,\n        },\n    );\n\n    const {traceData: trace2Data} = await TraceLoader.traceEngine(this, 'slow-interaction-keydown.json.gz');\n    historyManager.addRecording({\n      data: {\n        traceParseDataIndex: 2,\n        type: 'TRACE_INDEX',\n      },\n      filmStripForPreview: null,\n      traceParsedData: trace2Data,\n      startTime: null,\n    });\n\n    // Make sure the correct model is returned when\n    // using the history manager to navigate between trace files..\n    const previousRecording = historyManager.navigate(1);\n    assert.strictEqual(previousRecording?.traceParseDataIndex, 1);\n\n    const nextRecording = historyManager.navigate(-1);\n    assert.strictEqual(nextRecording?.traceParseDataIndex, 2);\n  });\n});\n"]}