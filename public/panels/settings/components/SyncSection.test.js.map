{"version":3,"file":"SyncSection.test.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/settings/components/SyncSection.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2021 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Host from '../../../core/host/host.js';\nimport * as Root from '../../../core/root/root.js';\nimport {\n  renderElementIntoDOM,\n} from '../../../testing/DOMHelpers.js';\nimport {describeWithEnvironment, updateHostConfig} from '../../../testing/EnvironmentHelpers.js';\nimport {createViewFunctionStub} from '../../../testing/ViewFunctionHelpers.js';\nimport * as PanelCommon from '../../common/common.js';\n\nimport * as Components from './components.js';\n\ndescribeWithEnvironment('SyncSection', () => {\n  const MOCK_SYNC_INFO_NOT_SIGNED_IN: Host.InspectorFrontendHostAPI.SyncInformation = {\n    isSyncActive: false,\n  };\n\n  const MOCK_SYNC_INFO_SIGNED_IN_SYNC_ON: Host.InspectorFrontendHostAPI.SyncInformation = {\n    isSyncActive: true,\n    arePreferencesSynced: true,\n    accountEmail: 'test@google.com',\n    accountImage: 'data:image/png;base64,test',\n  };\n\n  const MOCK_SYNC_INFO_SIGNED_IN_SYNC_OFF: Host.InspectorFrontendHostAPI.SyncInformation = {\n    ...MOCK_SYNC_INFO_SIGNED_IN_SYNC_ON,\n    isSyncActive: false,\n  };\n\n  const MOCK_SYNC_INFO_SIGNED_IN_PREFERENCES_OFF: Host.InspectorFrontendHostAPI.SyncInformation = {\n    ...MOCK_SYNC_INFO_SIGNED_IN_SYNC_ON,\n    arePreferencesSynced: false,\n  };\n\n  const MOCK_GDP_PROFILE: Host.GdpClient.Profile = {\n    name: 'test',\n    activeSubscription: {\n      subscriptionTier: Host.GdpClient.SubscriptionTier.PREMIUM_ANNUAL,\n      subscriptionStatus: Host.GdpClient.SubscriptionStatus.ENABLED,\n    },\n  };\n\n  let getProfileStub: sinon.SinonStub;\n\n  beforeEach(() => {\n    getProfileStub = sinon.stub(Host.GdpClient.GdpClient.instance(), 'getProfile');\n    // Default to no profile.\n    getProfileStub.resolves(null);\n  });\n\n  async function createWidget() {\n    const view = createViewFunctionStub(Components.SyncSection.SyncSection);\n    const widget = new Components.SyncSection.SyncSection(undefined, view);\n    widget.markAsRoot();\n    renderElementIntoDOM(widget);\n    await view.nextInput;\n    return {view, widget};\n  }\n\n  describe('rendering', () => {\n    it('shows \"not signed in\" when no user is signed into Chrome', async () => {\n      const {view, widget} = await createWidget();\n      widget.syncInfo = MOCK_SYNC_INFO_NOT_SIGNED_IN;\n      const input = await view.nextInput;\n      assert.deepEqual(input.syncInfo, MOCK_SYNC_INFO_NOT_SIGNED_IN);\n      assert.isUndefined(input.gdpProfile);\n    });\n\n    it('shows account info when user is signed in', async () => {\n      const {view, widget} = await createWidget();\n      widget.syncInfo = MOCK_SYNC_INFO_SIGNED_IN_SYNC_ON;\n      const input = await view.nextInput;\n      assert.deepEqual(input.syncInfo, MOCK_SYNC_INFO_SIGNED_IN_SYNC_ON);\n    });\n\n    it('disables sync checkbox when sync is off', async () => {\n      const {view, widget} = await createWidget();\n      widget.syncInfo = MOCK_SYNC_INFO_SIGNED_IN_SYNC_OFF;\n      const input = await view.nextInput;\n      assert.isTrue(input.syncSetting.disabled());\n    });\n\n    it('disables sync checkbox when preferences sync is off', async () => {\n      const {view, widget} = await createWidget();\n      widget.syncInfo = MOCK_SYNC_INFO_SIGNED_IN_PREFERENCES_OFF;\n      const input = await view.nextInput;\n      assert.isTrue(input.syncSetting.disabled());\n    });\n\n    it('enables sync checkbox when sync is fully on', async () => {\n      const {view, widget} = await createWidget();\n      widget.syncInfo = MOCK_SYNC_INFO_SIGNED_IN_SYNC_ON;\n      const input = await view.nextInput;\n      assert.isFalse(input.syncSetting.disabled());\n    });\n\n    it('passes SYNC_DISABLED warning type when sync is off', async () => {\n      const {view, widget} = await createWidget();\n      widget.syncInfo = MOCK_SYNC_INFO_SIGNED_IN_SYNC_OFF;\n      const input = await view.nextInput;\n      assert.strictEqual(input.warningType, Components.SyncSection.WarningType.SYNC_DISABLED);\n    });\n\n    it('passes PREFERENCES_SYNC_DISABLED warning type when preferences sync is off', async () => {\n      const {view, widget} = await createWidget();\n      widget.syncInfo = MOCK_SYNC_INFO_SIGNED_IN_PREFERENCES_OFF;\n      const input = await view.nextInput;\n      assert.strictEqual(input.warningType, Components.SyncSection.WarningType.PREFERENCES_SYNC_DISABLED);\n    });\n\n    it('passes no warning type when sync is fully on', async () => {\n      const {view, widget} = await createWidget();\n      widget.syncInfo = MOCK_SYNC_INFO_SIGNED_IN_SYNC_ON;\n      const input = await view.nextInput;\n      assert.isUndefined(input.warningType);\n    });\n  });\n\n  describe('GDP profile', () => {\n    beforeEach(() => {\n      updateHostConfig({\n        devToolsGdpProfiles: {\n          enabled: true,\n        },\n        devToolsGdpProfilesAvailability: {\n          enabled: true,\n          enterprisePolicyValue: Root.Runtime.GdpProfilesEnterprisePolicyValue.ENABLED,\n        },\n      });\n    });\n\n    it('fetches GDP profile when user is signed in', async () => {\n      const {widget} = await createWidget();\n      widget.syncInfo = MOCK_SYNC_INFO_SIGNED_IN_SYNC_ON;\n      sinon.assert.calledOnce(getProfileStub);\n    });\n\n    it('does not fetch GDP profile when user is not signed in', async () => {\n      const {widget} = await createWidget();\n      widget.syncInfo = MOCK_SYNC_INFO_NOT_SIGNED_IN;\n      sinon.assert.notCalled(getProfileStub);\n    });\n\n    it('shows sign up button if user is eligible and has no profile', async () => {\n      getProfileStub.resolves({profile: null, isEligible: true});\n      const {view, widget} = await createWidget();\n      widget.syncInfo = MOCK_SYNC_INFO_SIGNED_IN_SYNC_ON;\n      const input = await view.nextInput;\n      assert.isTrue(input.isEligibleToCreateGdpProfile);\n      assert.isUndefined(input.gdpProfile);\n    });\n\n    it('shows profile details if user has a profile', async () => {\n      getProfileStub.resolves({profile: MOCK_GDP_PROFILE, isEligible: true});\n      const {view, widget} = await createWidget();\n      widget.syncInfo = MOCK_SYNC_INFO_SIGNED_IN_SYNC_ON;\n      const input = await view.nextInput;\n      assert.isTrue(input.isEligibleToCreateGdpProfile);\n      assert.deepEqual(input.gdpProfile, MOCK_GDP_PROFILE);\n    });\n\n    it('refetches GDP profile on sign-up success', async () => {\n      getProfileStub.resolves({profile: null, isEligible: true});\n      const showStub = sinon.stub(PanelCommon.GdpSignUpDialog, 'show').callsFake(options => {\n        options?.onSuccess?.();\n      });\n\n      const {view, widget} = await createWidget();\n      widget.syncInfo = MOCK_SYNC_INFO_SIGNED_IN_SYNC_ON;\n      const input = await view.nextInput;\n      // The first call happens on render.\n      sinon.assert.calledOnce(getProfileStub);\n      input.onSignUpClick();\n      sinon.assert.calledOnce(showStub);\n      // The second call is triggered by the `onSuccess` callback.\n      sinon.assert.calledTwice(getProfileStub);\n    });\n  });\n});\n"]}