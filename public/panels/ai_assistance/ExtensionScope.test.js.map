{"version":3,"file":"ExtensionScope.test.js","sourceRoot":"","sources":["../../../../../../front_end/panels/ai_assistance/ExtensionScope.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as SDK from '../../core/sdk/sdk.js';\nimport type * as Protocol from '../../generated/protocol.js';\nimport {createCSSStyle, getMatchedStyles, ruleMatch} from '../../testing/StyleHelpers.js';\n\nimport * as ExtensionScope from './ExtensionScope.js';\nimport * as Injected from './injected.js';\n\nfunction createNode(options?: {getAttribute?: (attribute: string) => string | undefined}) {\n  const node = sinon.createStubInstance(SDK.DOMModel.DOMNode);\n  node.id = 1 as Protocol.DOM.NodeId;\n  // Needed to process the inline styles\n  node.nodeType.returns(Node.ELEMENT_NODE);\n  node.localName.returns('div');\n  node.simpleSelector.callThrough();\n  if (options?.getAttribute) {\n    node.getAttribute.callsFake(options.getAttribute);\n  }\n  return node;\n}\n\nasync function getSelector(\n    payload: Partial<SDK.CSSMatchedStyles.CSSMatchedStylesPayload>,\n    node?: SDK.DOMModel.DOMNode,\n) {\n  if (!node) {\n    node = createNode();\n  }\n\n  const matchedStyles = await getMatchedStyles({\n    node,\n    ...payload,\n  });\n\n  return ExtensionScope.ExtensionScope.getSelectorForRule(matchedStyles);\n}\n\ndescribe('ExtensionScope', () => {\n  const MOCK_STYLE = [\n    {\n      name: 'color',\n      value: 'red',\n    },\n  ];\n\n  describe('getSimpleSelector', () => {\n    it('should work with node that has classes', () => {\n      const node = createNode({\n        getAttribute: attribute => {\n          if (attribute === 'class') {\n            return 'my-class-a my-class-b';\n          }\n\n          return undefined;\n        }\n      });\n      const selector = ExtensionScope.ExtensionScope.getSelectorForNode(node);\n      assert.strictEqual(selector, '.my-class-a.my-class-b');\n    });\n\n    it('should exclude ai generated class', () => {\n      const node = createNode({\n        getAttribute: attribute => {\n          if (attribute === 'class') {\n            return `my-class-a my-class-b ${Injected.AI_ASSISTANCE_CSS_CLASS_NAME}-2`;\n          }\n\n          return undefined;\n        }\n      });\n      const selector = ExtensionScope.ExtensionScope.getSelectorForNode(node);\n      assert.strictEqual(selector, '.my-class-a.my-class-b');\n    });\n\n    it('should work with node has classes that need escaping', () => {\n      const node = createNode({\n        getAttribute: attribute => {\n          if (attribute === 'class') {\n            return `my.special-class my-class-b ${Injected.AI_ASSISTANCE_CSS_CLASS_NAME}-2`;\n          }\n\n          return undefined;\n        }\n      });\n      const selector = ExtensionScope.ExtensionScope.getSelectorForNode(node);\n      assert.strictEqual(selector, '.my\\\\.special-class.my-class-b');\n    });\n  });\n\n  describe('getSelectorFromRules', () => {\n    it('should work with empty styles', async () => {\n      const selector = await getSelector({});\n      assert.strictEqual(selector, '');\n    });\n\n    it('should omit inline selectors', async () => {\n      const inlinePayload = createCSSStyle(MOCK_STYLE);\n      const selector = await getSelector({\n        inlinePayload,\n      });\n      assert.strictEqual(selector, '');\n    });\n\n    it('should work with id selector', async () => {\n      const matchedPayload = [\n        ruleMatch('#test', MOCK_STYLE),\n      ];\n      const selector = await getSelector({matchedPayload});\n      assert.strictEqual(selector, '#test');\n    });\n\n    it('should work with class selector', async () => {\n      const matchedPayload = [\n        ruleMatch('.test', MOCK_STYLE),\n      ];\n      const selector = await getSelector({matchedPayload});\n      assert.strictEqual(selector, '.test');\n    });\n\n    it('should work with tag selector', async () => {\n      const matchedPayload = [\n        ruleMatch('div', MOCK_STYLE),\n      ];\n      const selector = await getSelector({matchedPayload});\n      assert.strictEqual(selector, 'div');\n    });\n\n    it('should prefer id selectors', async () => {\n      const matchedPayload = [\n        ruleMatch(\n            {\n              selectors: [\n                {\n                  text: '#my-id',\n                  specificity: {a: 1, b: 0, c: 0},\n                },\n                {\n                  text: '.my-class',\n                  specificity: {a: 0, b: 1, c: 0},\n                },\n                {\n                  text: 'div',\n                  specificity: {a: 0, b: 0, c: 1},\n                },\n              ],\n              text: '#my-id, .my-class, div'\n            },\n            MOCK_STYLE,\n            ),\n      ];\n      const selector = await getSelector({matchedPayload});\n      assert.strictEqual(selector, '#my-id');\n    });\n\n    it('should prefer class selectors over tags', async () => {\n      const matchedPayload = [\n        ruleMatch(\n            {\n              selectors: [\n                {\n                  text: '.my-class',\n                  specificity: {a: 0, b: 1, c: 0},\n                },\n                {\n                  text: 'div',\n                  specificity: {a: 0, b: 0, c: 1},\n                },\n              ],\n              text: '.my-class, div'\n            },\n            MOCK_STYLE,\n            ),\n      ];\n      const selector = await getSelector({matchedPayload});\n      assert.strictEqual(selector, '.my-class');\n    });\n\n    it('should pick first rule from the cascade', async () => {\n      // Order is reversed we know that specificity order will\n      // be returned correctly\n      // front_end/core/sdk/CSSMatchedStyles.ts:373\n      const matchedPayload = [\n        ruleMatch('.test', MOCK_STYLE),\n        ruleMatch('.test-2', MOCK_STYLE),\n      ];\n      const selector = await getSelector({matchedPayload});\n      assert.strictEqual(selector, '.test-2');\n    });\n\n    it('should work with complex selector', async () => {\n      const matchedPayload = [\n        ruleMatch('div.container > .header', MOCK_STYLE),\n      ];\n      const selector = await getSelector({matchedPayload});\n      assert.strictEqual(selector, 'div.container > .header');\n    });\n\n    it('should return nested selector with ai assistance prefix', async () => {\n      // Order is reversed we know that specificity order will\n      // be returned correctly\n      // front_end/core/sdk/CSSMatchedStyles.ts:373\n      const matchedPayload = [\n        ruleMatch('.test', MOCK_STYLE),\n        ruleMatch(\n\n            {\n              selectors: [{text: 'div&'}],\n              text: 'div&',\n            },\n            MOCK_STYLE,\n            {\n              nestingSelectors: [`.${Injected.AI_ASSISTANCE_CSS_CLASS_NAME}-1`],\n            },\n            ),\n      ];\n      const selector = await getSelector({matchedPayload});\n      assert.strictEqual(selector, 'div');\n    });\n  });\n});\n"]}