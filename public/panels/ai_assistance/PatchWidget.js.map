{"version":3,"file":"PatchWidget.js","sourceRoot":"","sources":["../../../../../../front_end/panels/ai_assistance/PatchWidget.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2025 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport '../../ui/components/markdown_view/markdown_view.js';\nimport '../../ui/components/spinners/spinners.js';\nimport '../../ui/components/tooltips/tooltips.js';\nimport '../../ui/legacy/legacy.js';\n\nimport * as Host from '../../core/host/host.js';\nimport * as i18n from '../../core/i18n/i18n.js';\nimport type * as Platform from '../../core/platform/platform.js';\nimport * as Root from '../../core/root/root.js';\nimport * as AiAssistanceModel from '../../models/ai_assistance/ai_assistance.js';\nimport * as Persistence from '../../models/persistence/persistence.js';\nimport * as WorkspaceDiff from '../../models/workspace_diff/workspace_diff.js';\nimport * as Buttons from '../../ui/components/buttons/buttons.js';\nimport * as UI from '../../ui/legacy/legacy.js';\nimport {Directives, html, type LitTemplate, nothing, render} from '../../ui/lit/lit.js';\nimport * as VisualLogging from '../../ui/visual_logging/visual_logging.js';\nimport * as ChangesPanel from '../changes/changes.js';\n\nconst {classMap} = Directives;\n\n/*\n* Strings that don't need to be translated at this time.\n*/\nconst UIStringsNotTranslate = {\n  /**\n   *@description Text displayed for showing patch widget view.\n   */\n  unsavedChanges: 'Unsaved changes',\n  /**\n   *@description Loading text displayed as a summary title when the patch suggestion is getting loaded\n   */\n  applyingToPageTree: 'Applying to page tree…',\n  /**\n   *@description Button text for applying chanes to page tree.\n   */\n  applyToPageTree: 'Apply to page tree',\n  /**\n   *@description Button text to cancel applying to page tree.\n   */\n  cancel: 'Cancel',\n  /**\n   *@description Button text to discard the suggested changes and not save them to file system\n   */\n  discard: 'Discard',\n  /**\n   *@description Button text to save all the suggested changes to the file system\n   */\n  saveToWorkspace: 'Save to workspace',\n  /**\n   *@description Header text after the user saved the changes to the disk.\n   */\n  savedToDisk: 'Saved to disk',\n  /**\n   *@description Disclaimer text shown for using code snippets with caution\n   */\n  codeDisclaimer: 'Use code snippets with caution',\n  /**\n   *@description Tooltip text for the info icon beside the \"Apply to page tree\" button\n   */\n  disclaimerTooltip:\n      'The source code of the inspected page and its assets, and any data the inspected page can access is sent to Google to generate code suggestions.',\n  /**\n   *@description Tooltip text for the info icon beside the \"Apply to page tree\" button when enterprise logging is off\n   */\n  disclaimerTooltipNoLogging:\n      'The source code of the inspected page and its assets, and any data the inspected page can access is sent to Google to generate code suggestions. This data will not be used to improve Google’s AI models.',\n  /**\n   *@description Tooltip link for the navigating to \"AI innovations\" page in settings.\n   */\n  learnMore: 'Learn more',\n  /**\n   * @description Title of the link opening data that was used to\n   * produce a code suggestion.\n   */\n  viewUploadedFiles: 'View data sent to Google',\n  /**\n   * @description Text indicating that a link opens in a new tab (for a11y).\n   */\n  opensInNewTab: '(opens in a new tab)',\n  /**\n   * @description Generic error text for the case the changes were not applied to the page tree.\n   */\n  genericErrorMessage: 'Changes couldn’t be applied to the page tree.',\n} as const;\n\nconst lockedString = i18n.i18n.lockedString;\n\nexport enum PatchSuggestionState {\n  /**\n   * The user did not attempt patching yet\n   */\n  INITIAL = 'initial',\n  /**\n   * Applying to page tree is in progress\n   */\n  LOADING = 'loading',\n  /**\n   * Applying to page tree succeeded\n   */\n  SUCCESS = 'success',\n  /**\n   * Applying to page tree failed\n   */\n  ERROR = 'error',\n}\n\nexport interface ViewInput {\n  workspaceDiff: WorkspaceDiff.WorkspaceDiff.WorkspaceDiffImpl;\n  patchSuggestionState: PatchSuggestionState;\n  changeSummary?: string;\n  sources?: string;\n  savedToDisk?: boolean;\n  disclaimerTooltipText: Platform.UIString.LocalizedString;\n  onLearnMoreTooltipClick: () => void;\n  onApplyToPageTree: () => void;\n  onCancel: () => void;\n  onDiscard: () => void;\n  onSaveToWorkspace?: () => void;\n}\n\nexport interface ViewOutput {\n  tooltipRef?: Directives.Ref<HTMLElement>;\n}\n\ntype View = (input: ViewInput, output: ViewOutput, target: HTMLElement) => void;\n\nexport class PatchWidget extends UI.Widget.Widget {\n  changeSummary = '';\n  changeManager: AiAssistanceModel.ChangeManager|undefined;\n  #view: View;\n  #viewOutput: ViewOutput = {};\n  #aidaClient: Host.AidaClient.AidaClient;\n  #applyPatchAbortController?: AbortController;\n  #patchSources?: string;\n  #savedToDisk?: boolean;\n  #noLogging: boolean;  // Whether the enterprise setting is `ALLOW_WITHOUT_LOGGING` or not.\n  #patchSuggestionState = PatchSuggestionState.INITIAL;\n  #workspaceDiff = WorkspaceDiff.WorkspaceDiff.workspaceDiff();\n  #persistence = Persistence.Persistence.PersistenceImpl.instance();\n\n  constructor(element?: HTMLElement, view?: View, opts?: {\n    aidaClient: Host.AidaClient.AidaClient,\n  }) {\n    super(false, false, element);\n    this.#aidaClient = opts?.aidaClient ?? new Host.AidaClient.AidaClient();\n    this.#noLogging = Root.Runtime.hostConfig.aidaAvailability?.enterprisePolicyValue ===\n        Root.Runtime.GenAiEnterprisePolicyValue.ALLOW_WITHOUT_LOGGING;\n\n    // clang-format off\n    this.#view = view ?? ((input, output, target) => {\n      if (!input.changeSummary) {\n        return;\n      }\n      output.tooltipRef = output.tooltipRef ?? Directives.createRef<HTMLElement>();\n\n      function renderSourcesLink(): LitTemplate {\n        if (!input.sources) {\n          return nothing;\n        }\n\n        return html`<x-link\n          class=\"link sources-link\"\n          title=\"${UIStringsNotTranslate.viewUploadedFiles} ${UIStringsNotTranslate.opensInNewTab}\"\n          href=\"data:text/plain,${encodeURIComponent(input.sources)}\"\n          jslog=${VisualLogging.link('files-used-in-patching').track({click: true})}>\n          ${UIStringsNotTranslate.viewUploadedFiles}\n        </x-link>`;\n      }\n\n      function renderHeader(): LitTemplate {\n        if (input.savedToDisk) {\n          return html`\n            <devtools-icon class=\"green-bright-icon summary-badge\" .name=${'check-circle'}></devtools-icon>\n            <span class=\"header-text\">\n              ${lockedString(UIStringsNotTranslate.savedToDisk)}\n            </span>\n          `;\n        }\n\n        if (input.patchSuggestionState === PatchSuggestionState.SUCCESS) {\n          return html`\n            <devtools-icon class=\"on-tonal-icon summary-badge\" .name=${'difference'}></devtools-icon>\n            <span class=\"header-text\">\n              ${lockedString('File changes in page')}\n            </span>\n            <devtools-icon\n              class=\"arrow\"\n              .name=${'chevron-down'}\n            ></devtools-icon>\n          `;\n        }\n\n        return html`\n          <devtools-icon class=\"on-tonal-icon summary-badge\" .name=${'pen-spark'}></devtools-icon>\n          <span class=\"header-text\">\n            ${lockedString(UIStringsNotTranslate.unsavedChanges)}\n          </span>\n          <devtools-icon\n            class=\"arrow\"\n            .name=${'chevron-down'}\n          ></devtools-icon>\n        `;\n      }\n\n      function renderContent(): LitTemplate {\n        if (!input.changeSummary || input.savedToDisk) {\n          return nothing;\n        }\n\n        if (input.patchSuggestionState === PatchSuggestionState.SUCCESS) {\n          return html`<devtools-widget .widgetConfig=${UI.Widget.widgetConfig(ChangesPanel.CombinedDiffView.CombinedDiffView, {\n            workspaceDiff: input.workspaceDiff,\n          })}></devtools-widget>`;\n        }\n\n        return html`<devtools-code-block\n          .code=${input.changeSummary}\n          .codeLang=${'css'}\n          .displayNotice=${true}\n        ></devtools-code-block>\n        ${input.patchSuggestionState === PatchSuggestionState.ERROR\n          ? html`<div class=\"error-container\">\n              <devtools-icon .name=${'cross-circle-filled'}></devtools-icon>${lockedString(UIStringsNotTranslate.genericErrorMessage)} ${renderSourcesLink()}\n            </div>`\n          : nothing\n        }`;\n      }\n\n      function renderFooter(): LitTemplate {\n        if (input.savedToDisk) {\n          return nothing;\n        }\n\n        if (input.patchSuggestionState === PatchSuggestionState.SUCCESS) {\n          return html`\n          <div class=\"footer\">\n            <x-link class=\"link disclaimer-link\" href=\"https://support.google.com/legal/answer/13505487\" jslog=${\n              VisualLogging.link('code-disclaimer').track({\n                click: true,\n              })}>\n              ${lockedString(UIStringsNotTranslate.codeDisclaimer)}\n            </x-link>\n            ${renderSourcesLink()}\n            <div class=\"save-or-discard-buttons\">\n              <devtools-button\n                @click=${input.onDiscard}\n                .jslogContext=${'patch-widget.discard'}\n                .variant=${Buttons.Button.Variant.OUTLINED}>\n                  ${lockedString(UIStringsNotTranslate.discard)}\n              </devtools-button>\n              ${input.onSaveToWorkspace ? html`\n                <devtools-button\n                  @click=${input.onSaveToWorkspace}\n                  .jslogContext=${'patch-widget.save-to-workspace'}\n                  .variant=${Buttons.Button.Variant.PRIMARY}>\n                    ${lockedString(UIStringsNotTranslate.saveToWorkspace)}\n                </devtools-button>\n              ` : nothing}\n            </div>\n          </div>\n          `;\n        }\n\n        return html`\n        <div class=\"footer\">\n          <div class=\"apply-to-page-tree-container\">\n            ${input.patchSuggestionState === PatchSuggestionState.LOADING ? html`\n              <div class=\"loading-text-container\">\n                <devtools-spinner></devtools-spinner>\n                <span>\n                  ${lockedString(UIStringsNotTranslate.applyingToPageTree)}\n                </span>\n              </div>\n            ` : html`\n              <devtools-button\n                @click=${input.onApplyToPageTree}\n                .jslogContext=${'apply-to-page-tree'}\n                .variant=${Buttons.Button.Variant.OUTLINED}>\n                ${lockedString(UIStringsNotTranslate.applyToPageTree)}\n              </devtools-button>\n            `}\n            ${input.patchSuggestionState === PatchSuggestionState.LOADING ? html`<devtools-button\n              @click=${input.onCancel}\n              .jslogContext=${'cancel'}\n              .variant=${Buttons.Button.Variant.OUTLINED}>\n              ${lockedString(UIStringsNotTranslate.cancel)}\n            </devtools-button>` : nothing}\n            <devtools-button\n              aria-details=\"info-tooltip\"\n              .iconName=${'info'}\n              .variant=${Buttons.Button.Variant.ICON}\n              ></devtools-button>\n            <devtools-tooltip variant=\"rich\" id=\"info-tooltip\" ${Directives.ref(output.tooltipRef)}>\n              <div class=\"info-tooltip-container\">\n                ${input.disclaimerTooltipText}\n                <button\n                  class=\"link tooltip-link\"\n                  role=\"link\"\n                  jslog=${VisualLogging.link('open-ai-settings').track({\n                    click: true,\n                  })}\n                  @click=${input.onLearnMoreTooltipClick}\n                >${lockedString(UIStringsNotTranslate.learnMore)}</button>\n              </div>\n            </devtools-tooltip>\n          </div>\n        </div>`;\n      }\n\n      render(\n        html`\n          <details class=${classMap({\n            'change-summary': true,\n            'saved-to-disk': Boolean(input.savedToDisk)\n          })}>\n            <summary>\n              ${renderHeader()}\n            </summary>\n            ${renderContent()}\n            ${renderFooter()}\n          </details>\n        `,\n        target,\n        {host: target}\n      );\n    });\n    // clang-format on\n    this.requestUpdate();\n  }\n\n  #onLearnMoreTooltipClick(): void {\n    this.#viewOutput.tooltipRef?.value?.hidePopover();\n    void UI.ViewManager.ViewManager.instance().showView('chrome-ai');\n  }\n\n  override performUpdate(): void {\n    this.#view(\n        {\n          workspaceDiff: this.#workspaceDiff,\n          changeSummary: this.changeSummary,\n          patchSuggestionState: this.#patchSuggestionState,\n          sources: this.#patchSources,\n          savedToDisk: this.#savedToDisk,\n          disclaimerTooltipText: this.#noLogging ? lockedString(UIStringsNotTranslate.disclaimerTooltipNoLogging) :\n                                                   lockedString(UIStringsNotTranslate.disclaimerTooltip),\n          onLearnMoreTooltipClick: this.#onLearnMoreTooltipClick.bind(this),\n          onApplyToPageTree: this.#onApplyToPageTree.bind(this),\n          onCancel: () => {\n            this.#applyPatchAbortController?.abort();\n          },\n          onDiscard: this.#onDiscard.bind(this),\n          onSaveToWorkspace: this.#canSaveToWorkspace() ? this.#onSaveToWorkspace.bind(this) : undefined,\n        },\n        this.#viewOutput, this.contentElement);\n  }\n\n  override wasShown(): void {\n    super.wasShown();\n\n    if (isAiAssistancePatchingEnabled()) {\n      // @ts-expect-error temporary global function for local testing.\n      window.aiAssistanceTestPatchPrompt = async (changeSummary: string) => {\n        return await this.#applyPatch(changeSummary);\n      };\n    }\n  }\n\n  async #onApplyToPageTree(): Promise<void> {\n    if (!isAiAssistancePatchingEnabled()) {\n      return;\n    }\n    const changeSummary = this.changeSummary;\n    if (!changeSummary) {\n      throw new Error('Change summary does not exist');\n    }\n\n    this.#patchSuggestionState = PatchSuggestionState.LOADING;\n    this.requestUpdate();\n    const {response, processedFiles} = await this.#applyPatch(changeSummary);\n    if (response?.type === AiAssistanceModel.ResponseType.ANSWER) {\n      await this.changeManager?.stashChanges();\n      this.#patchSuggestionState = PatchSuggestionState.SUCCESS;\n    } else if (\n        response?.type === AiAssistanceModel.ResponseType.ERROR &&\n        response.error === AiAssistanceModel.ErrorType.ABORT) {\n      // If this is an abort error, we're returning back to the initial state.\n      this.#patchSuggestionState = PatchSuggestionState.INITIAL;\n    } else {\n      this.#patchSuggestionState = PatchSuggestionState.ERROR;\n    }\n    this.#patchSources = `Filenames in page.\nFiles:\n${processedFiles.map(filename => `* ${filename}`).join('\\n')}`;\n    this.requestUpdate();\n  }\n\n  #onDiscard(): void {\n    this.#workspaceDiff.modifiedUISourceCodes().forEach(modifiedUISourceCode => {\n      modifiedUISourceCode.resetWorkingCopy();\n    });\n\n    this.#patchSuggestionState = PatchSuggestionState.INITIAL;\n    this.#patchSources = undefined;\n    void this.changeManager?.popStashedChanges();\n    this.requestUpdate();\n  }\n\n  #canSaveToWorkspace(): boolean {\n    if (this.#patchSuggestionState !== PatchSuggestionState.SUCCESS) {\n      return false;\n    }\n    // TODO(crbug.com/406699819): investigate why the inspector-stylesheet shows up here\n    const filteredModifiedUISourceCodes =\n        this.#workspaceDiff.modifiedUISourceCodes().filter(sourceCode => sourceCode.origin() !== 'inspector://');\n    return filteredModifiedUISourceCodes.length > 0 &&\n        filteredModifiedUISourceCodes.every(sourceCode => this.#persistence.binding(sourceCode));\n  }\n\n  #onSaveToWorkspace(): void {\n    this.#workspaceDiff.modifiedUISourceCodes().forEach(modifiedUISourceCode => {\n      const binding = this.#persistence.binding(modifiedUISourceCode);\n      if (binding) {\n        binding.fileSystem.commitWorkingCopy();\n      }\n    });\n\n    this.#savedToDisk = true;\n    void this.changeManager?.dropStashedChanges();\n    this.requestUpdate();\n  }\n\n  async #applyPatch(changeSummary: string): Promise<{\n    response: AiAssistanceModel.ResponseData | undefined,\n    processedFiles: string[],\n  }> {\n    this.#applyPatchAbortController = new AbortController();\n    const agent = new AiAssistanceModel.PatchAgent({\n      aidaClient: this.#aidaClient,\n      serverSideLoggingEnabled: false,\n    });\n    const {responses, processedFiles} =\n        await agent.applyChanges(changeSummary, {signal: this.#applyPatchAbortController.signal});\n    return {\n      response: responses.at(-1),\n      processedFiles,\n    };\n  }\n}\n\nexport function isAiAssistancePatchingEnabled(): boolean {\n  return Boolean(Root.Runtime.hostConfig.devToolsFreestyler?.patching);\n}\n"]}