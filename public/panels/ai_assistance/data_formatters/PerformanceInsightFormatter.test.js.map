{"version":3,"file":"PerformanceInsightFormatter.test.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/ai_assistance/data_formatters/PerformanceInsightFormatter.test.ts"],"names":[],"mappings":"AAAA,4DAA4D;AAC5D,yEAAyE;AACzE,6BAA6B;AAE7B,OAAO,EAAC,uBAAuB,EAAC,MAAM,wCAAwC,CAAC;AAC/E,OAAO,EAAC,eAAe,EAAE,iBAAiB,EAAC,MAAM,oCAAoC,CAAC;AACtF,OAAO,EAAC,WAAW,EAAC,MAAM,iCAAiC,CAAC;AAC5D,OAAO,EAAC,2BAA2B,EAAE,mBAAmB,EAAC,MAAM,qBAAqB,CAAC;AAErF,uBAAuB,CAAC,6BAA6B,EAAE,GAAG,EAAE;IAC1D,QAAQ,CAAC,kBAAkB,EAAE,GAAG,EAAE;QAChC,EAAE,CAAC,gCAAgC,EAAE,KAAK;YACxC,MAAM,EAAC,WAAW,EAAE,QAAQ,EAAC,GAAG,MAAM,WAAW,CAAC,WAAW,CAAC,IAAI,EAAE,6BAA6B,CAAC,CAAC;YACnG,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;YACtB,MAAM,QAAQ,GAAG,eAAe,CAAC,WAAW,CAAC,IAAI,CAAC,yBAAyB,CAAC,MAAM,EAAE,CAAC,CAAC;YACtF,MAAM,OAAO,GAAG,iBAAiB,CAAC,WAAW,EAAE,QAAQ,EAAE,QAAQ,CAAC,CAAC;YAEnE,MAAM,SAAS,GAAG,IAAI,2BAA2B,CAAC,OAAO,CAAC,CAAC;YAC3D,MAAM,MAAM,GAAG,SAAS,CAAC,aAAa,EAAE,CAAC;YAEzC,MAAM,QAAQ,GAAG;;;;;;;;;;;;;;;;;;yBAkBE,CAAC;YACpB,MAAM,CAAC,WAAW,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;QACvC,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,wBAAwB,EAAE,GAAG,EAAE;QACtC,EAAE,CAAC,0BAA0B,EAAE,KAAK;YAClC,MAAM,EAAC,WAAW,EAAC,GAAG,MAAM,WAAW,CAAC,WAAW,CAAC,IAAI,EAAE,oBAAoB,CAAC,CAAC;YAChF,MAAM,UAAU,GAAG,kEAAkE,CAAC;YACtF,MAAM,OAAO,GAAG,WAAW,CAAC,eAAe,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG,KAAK,UAAU,CAAC,CAAC;YAC7F,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YACrB,MAAM,MAAM,GAAG,mBAAmB,CAAC,cAAc,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC;YACxE,MAAM,QAAQ,GAAG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;yCA8BkB,CAAC;YAEpC,MAAM,CAAC,WAAW,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;QACvC,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","sourcesContent":["// Copyright 2025 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport {describeWithEnvironment} from '../../../testing/EnvironmentHelpers.js';\nimport {getFirstOrError, getInsightOrError} from '../../../testing/InsightHelpers.js';\nimport {TraceLoader} from '../../../testing/TraceLoader.js';\nimport {PerformanceInsightFormatter, TraceEventFormatter} from '../ai_assistance.js';\n\ndescribeWithEnvironment('PerformanceInsightFormatter', () => {\n  describe('for LCP by Phase', () => {\n    it('serializes the correct details', async function() {\n      const {parsedTrace, insights} = await TraceLoader.traceEngine(this, 'web-dev-with-commit.json.gz');\n      assert.isOk(insights);\n      const firstNav = getFirstOrError(parsedTrace.Meta.navigationsByNavigationId.values());\n      const insight = getInsightOrError('LCPPhases', insights, firstNav);\n\n      const formatter = new PerformanceInsightFormatter(insight);\n      const output = formatter.formatInsight();\n\n      const expected = `## Insight title: LCP by phase\n\n## Insight Description:\nThis insight is used to analyse the loading of the LCP resource and identify which of the 4 phases are contributing most to the delay in rendering the LCP element. For this insight it can be useful to get a list of all network requests that happened before the LCP time and look for slow requests. You can also look for main thread activity during the phases, in particular the load delay and render delay phases.\n\n## External resources:\n- https://web.dev/articles/lcp\n- https://web.dev/articles/optimize-lcp\n\n## Insight details:\nAll time units given to you are in milliseconds.\nThe actual LCP time is 129.21 ms;\n\nWe can break this time down into the 4 phases that combine to make up the LCP time:\n\n- Time to first byte: 7.94 ms\n- Load delay: 33.16 ms\n- Load time: 14.70 ms\n- Render delay: 73.41 ms`;\n      assert.strictEqual(output, expected);\n    });\n  });\n\n  describe('Formatting TraceEvents', () => {\n    it('formats network requests', async function() {\n      const {parsedTrace} = await TraceLoader.traceEngine(this, 'lcp-images.json.gz');\n      const requestUrl = 'https://fonts.googleapis.com/css2?family=Poppins:ital,wght@1,800';\n      const request = parsedTrace.NetworkRequests.byTime.find(r => r.args.data.url === requestUrl);\n      assert.isOk(request);\n      const output = TraceEventFormatter.networkRequest(request, parsedTrace);\n      const expected = `## Network request: https://fonts.googleapis.com/css2?family=Poppins:ital,wght@1,800\nTimings:\n- Start time: 37.62 ms\n- Queued at: 43.24 ms\n- Request sent at: 41.71 ms\n- Download complete at: 48.04 ms\n- Fully completed at: 51.55 ms\n- Total request duration: 13.93 ms\nStatus code: 200\nMIME Type: text/css\nPriority:\n- Initial: VeryHigh\n- Final: VeryHigh\nRender blocking?: Yes\nFrom a service worker: No\nResponse headers\n- date: Thu, 07 Mar 2024 21:17:02 GMT\n- content-encoding: gzip\n- x-content-type-options: nosniff\n- last-modified: Thu, 07 Mar 2024 21:17:02 GMT\n- server: ESF\n- cross-origin-opener-policy: <redacted>\n- x-frame-options: SAMEORIGIN\n- content-type: text/css; charset=utf-8\n- access-control-allow-origin: *\n- cache-control: private, max-age=86400, stale-while-revalidate=604800\n- cross-origin-resource-policy: <redacted>\n- timing-allow-origin: *\n- link: <https://fonts.gstatic.com>; rel=preconnect; crossorigin\n- x-xss-protection: 0\n- expires: Thu, 07 Mar 2024 21:17:02 GMT`;\n\n      assert.strictEqual(output, expected);\n    });\n  });\n});\n"]}