{"version":3,"file":"PerformanceInsightFormatter.test.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/ai_assistance/data_formatters/PerformanceInsightFormatter.test.ts"],"names":[],"mappings":"AAAA,4DAA4D;AAC5D,yEAAyE;AACzE,6BAA6B;AAE7B,OAAO,EAAC,uBAAuB,EAAC,MAAM,wCAAwC,CAAC;AAC/E,OAAO,EAAC,eAAe,EAAE,iBAAiB,EAAC,MAAM,oCAAoC,CAAC;AACtF,OAAO,EAAC,WAAW,EAAC,MAAM,iCAAiC,CAAC;AAC5D,OAAO,EAAC,2BAA2B,EAAE,mBAAmB,EAAC,MAAM,qBAAqB,CAAC;AAErF,uBAAuB,CAAC,6BAA6B,EAAE,GAAG,EAAE;IAC1D,QAAQ,CAAC,cAAc,EAAE,GAAG,EAAE;QAC5B,EAAE,CAAC,gCAAgC,EAAE,KAAK;YACxC,MAAM,EAAC,WAAW,EAAE,QAAQ,EAAC,GAAG,MAAM,WAAW,CAAC,WAAW,CAAC,IAAI,EAAE,6BAA6B,CAAC,CAAC;YACnG,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;YACtB,MAAM,QAAQ,GAAG,eAAe,CAAC,WAAW,CAAC,IAAI,CAAC,yBAAyB,CAAC,MAAM,EAAE,CAAC,CAAC;YACtF,MAAM,OAAO,GAAG,iBAAiB,CAAC,WAAW,EAAE,QAAQ,EAAE,QAAQ,CAAC,CAAC;YAEnE,MAAM,SAAS,GAAG,IAAI,2BAA2B,CAAC,OAAO,CAAC,CAAC;YAC3D,MAAM,MAAM,GAAG,SAAS,CAAC,aAAa,EAAE,CAAC;YAEzC,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC;YAEhC,MAAM,QAAQ,GAAG;;;;;;;;;;;;wCAYiB,OAAO,CAAC,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG;;;;;;;yBAO/C,CAAC;YACpB,MAAM,CAAC,WAAW,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;QACvC,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,qFAAqF,EAAE,KAAK;YAC7F,MAAM,EAAC,WAAW,EAAE,QAAQ,EAAC,GAAG,MAAM,WAAW,CAAC,WAAW,CAAC,IAAI,EAAE,sBAAsB,CAAC,CAAC;YAC5F,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;YACtB,MAAM,QAAQ,GAAG,eAAe,CAAC,WAAW,CAAC,IAAI,CAAC,yBAAyB,CAAC,MAAM,EAAE,CAAC,CAAC;YACtF,MAAM,OAAO,GAAG,iBAAiB,CAAC,WAAW,EAAE,QAAQ,EAAE,QAAQ,CAAC,CAAC;YAEnE,MAAM,SAAS,GAAG,IAAI,2BAA2B,CAAC,OAAO,CAAC,CAAC;YAC3D,MAAM,MAAM,GAAG,SAAS,CAAC,aAAa,EAAE,CAAC;YACzC,MAAM,QAAQ,GAAG;;;;;;;;;;;;;;;;0BAgBG,CAAC;YACrB,MAAM,CAAC,WAAW,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;QACvC,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,uBAAuB,EAAE,GAAG,EAAE;QACrC,EAAE,CAAC,gCAAgC,EAAE,KAAK;YACxC,MAAM,EAAC,WAAW,EAAE,QAAQ,EAAC,GAAG,MAAM,WAAW,CAAC,WAAW,CAAC,IAAI,EAAE,6BAA6B,CAAC,CAAC;YACnG,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;YACtB,MAAM,QAAQ,GAAG,eAAe,CAAC,WAAW,CAAC,IAAI,CAAC,yBAAyB,CAAC,MAAM,EAAE,CAAC,CAAC;YACtF,MAAM,OAAO,GAAG,iBAAiB,CAAC,cAAc,EAAE,QAAQ,EAAE,QAAQ,CAAC,CAAC;YAEtE,MAAM,SAAS,GAAG,IAAI,2BAA2B,CAAC,OAAO,CAAC,CAAC;YAC3D,MAAM,MAAM,GAAG,SAAS,CAAC,aAAa,EAAE,CAAC;YAEzC,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC;YAEhC,MAAM,QAAQ,GAAG;;;;;;;;;;;;;;;;2BAgBI,OAAO,CAAC,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG;;;;;sDAKL,CAAC;YACjD,MAAM,CAAC,WAAW,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;QACvC,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,wBAAwB,EAAE,GAAG,EAAE;QACtC,EAAE,CAAC,0CAA0C,EAAE,KAAK;YAClD,MAAM,EAAC,WAAW,EAAC,GAAG,MAAM,WAAW,CAAC,WAAW,CAAC,IAAI,EAAE,oBAAoB,CAAC,CAAC;YAChF,MAAM,UAAU,GAAG,kEAAkE,CAAC;YACtF,MAAM,OAAO,GAAG,WAAW,CAAC,eAAe,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG,KAAK,UAAU,CAAC,CAAC;YAC7F,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YACrB,MAAM,MAAM,GAAG,mBAAmB,CAAC,cAAc,CAAC,OAAO,EAAE,WAAW,EAAE,EAAC,OAAO,EAAE,IAAI,EAAC,CAAC,CAAC;YACzF,MAAM,QAAQ,GAAG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;yCA+BkB,CAAC;YAEpC,MAAM,CAAC,WAAW,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;QACvC,CAAC,CAAC,CAAC;QACH,EAAE,CAAC,8CAA8C,EAAE,KAAK;YACtD,MAAM,EAAC,WAAW,EAAC,GAAG,MAAM,WAAW,CAAC,WAAW,CAAC,IAAI,EAAE,oBAAoB,CAAC,CAAC;YAChF,MAAM,UAAU,GAAG,kEAAkE,CAAC;YACtF,MAAM,OAAO,GAAG,WAAW,CAAC,eAAe,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG,KAAK,UAAU,CAAC,CAAC;YAC7F,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YACrB,MAAM,MAAM,GAAG,mBAAmB,CAAC,cAAc,CAAC,OAAO,EAAE,WAAW,EAAE,EAAC,OAAO,EAAE,KAAK,EAAC,CAAC,CAAC;YAC1F,MAAM,QAAQ,GAAG;;;;mCAIY,CAAC;YAE9B,MAAM,CAAC,WAAW,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;QACvC,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","sourcesContent":["// Copyright 2025 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport {describeWithEnvironment} from '../../../testing/EnvironmentHelpers.js';\nimport {getFirstOrError, getInsightOrError} from '../../../testing/InsightHelpers.js';\nimport {TraceLoader} from '../../../testing/TraceLoader.js';\nimport {PerformanceInsightFormatter, TraceEventFormatter} from '../ai_assistance.js';\n\ndescribeWithEnvironment('PerformanceInsightFormatter', () => {\n  describe('LCP by Phase', () => {\n    it('serializes the correct details', async function() {\n      const {parsedTrace, insights} = await TraceLoader.traceEngine(this, 'web-dev-with-commit.json.gz');\n      assert.isOk(insights);\n      const firstNav = getFirstOrError(parsedTrace.Meta.navigationsByNavigationId.values());\n      const insight = getInsightOrError('LCPPhases', insights, firstNav);\n\n      const formatter = new PerformanceInsightFormatter(insight);\n      const output = formatter.formatInsight();\n\n      assert.isOk(insight.lcpRequest);\n\n      const expected = `*IMPORTANT*: all time units given to you are in milliseconds.\n## Insight title: LCP by phase\n\n## Insight Description:\nThis insight is used to analyze the time spent that contributed to the final LCP time and identify which of the 4 phases (or 2 if there was no LCP resource) are contributing most to the delay in rendering the LCP element. For this insight it can be useful to get a list of all network requests that happened before the LCP time and look for slow requests. You can also look for main thread activity during the phases, in particular the load delay and render delay phases.\n\n## External resources:\n- https://web.dev/articles/lcp\n- https://web.dev/articles/optimize-lcp\n\n## Insight details:\nThe actual LCP time is 129.21 ms.\nThe LCP resource was downloaded from: ${insight.lcpRequest.args.data.url}.\n\nWe can break this time down into the 4 phases that combine to make up the LCP time:\n\n- Time to first byte: 7.94 ms\n- Load delay: 33.16 ms\n- Load time: 14.70 ms\n- Render delay: 73.41 ms`;\n      assert.strictEqual(output, expected);\n    });\n\n    it('formats correctly when the LCP is texted based and has no load delay or time phases', async function() {\n      const {parsedTrace, insights} = await TraceLoader.traceEngine(this, 'lcp-web-font.json.gz');\n      assert.isOk(insights);\n      const firstNav = getFirstOrError(parsedTrace.Meta.navigationsByNavigationId.values());\n      const insight = getInsightOrError('LCPPhases', insights, firstNav);\n\n      const formatter = new PerformanceInsightFormatter(insight);\n      const output = formatter.formatInsight();\n      const expected = `*IMPORTANT*: all time units given to you are in milliseconds.\n## Insight title: LCP by phase\n\n## Insight Description:\nThis insight is used to analyze the time spent that contributed to the final LCP time and identify which of the 4 phases (or 2 if there was no LCP resource) are contributing most to the delay in rendering the LCP element. For this insight it can be useful to get a list of all network requests that happened before the LCP time and look for slow requests. You can also look for main thread activity during the phases, in particular the load delay and render delay phases.\n\n## External resources:\n- https://web.dev/articles/lcp\n- https://web.dev/articles/optimize-lcp\n\n## Insight details:\nThe actual LCP time is 106.48 ms.\n\nWe can break this time down into the 2 phases that combine to make up the LCP time:\n\n- Time to first byte: 6.12 ms\n- Render delay: 100.37 ms`;\n      assert.strictEqual(output, expected);\n    });\n  });\n\n  describe('LCP Request discovery', () => {\n    it('serializes the correct details', async function() {\n      const {parsedTrace, insights} = await TraceLoader.traceEngine(this, 'lcp-discovery-delay.json.gz');\n      assert.isOk(insights);\n      const firstNav = getFirstOrError(parsedTrace.Meta.navigationsByNavigationId.values());\n      const insight = getInsightOrError('LCPDiscovery', insights, firstNav);\n\n      const formatter = new PerformanceInsightFormatter(insight);\n      const output = formatter.formatInsight();\n\n      assert.isOk(insight.lcpRequest);\n\n      const expected = `*IMPORTANT*: all time units given to you are in milliseconds.\n## Insight title: LCP request discovery\n\n## Insight Description:\nThis insight analyzes the time taken to discover the LCP resource and request it on the network. It only applies if LCP element was a resource like an image that has to be fetched over the network. There are 3 checks this insight makes:\n1. Did the resource have \\`fetchpriority=high\\` applied?\n2. Was the resource discoverable in the initial document, rather than injected from a script or stylesheet?\n3. The resource was not lazy loaded as this can delay the browser loading the resource.\n\nIt is important that all of these checks pass to minimize the delay between the initial page load and the LCP resource being loaded.\n\n## External resources:\n- https://web.dev/articles/lcp\n- https://web.dev/articles/optimize-lcp\n\n## Insight details:\nThe LCP resource URL is: ${insight.lcpRequest.args.data.url}.\n\nThe result of the checks for this insight are:\n- fetchpriority=high should be applied: FAILED\n- lazy load not applied: PASSED\n- Request is discoverable in initial document: PASSED`;\n      assert.strictEqual(output, expected);\n    });\n  });\n\n  describe('Formatting TraceEvents', () => {\n    it('formats network requests in verbose mode', async function() {\n      const {parsedTrace} = await TraceLoader.traceEngine(this, 'lcp-images.json.gz');\n      const requestUrl = 'https://fonts.googleapis.com/css2?family=Poppins:ital,wght@1,800';\n      const request = parsedTrace.NetworkRequests.byTime.find(r => r.args.data.url === requestUrl);\n      assert.isOk(request);\n      const output = TraceEventFormatter.networkRequest(request, parsedTrace, {verbose: true});\n      const expected = `## Network request: https://fonts.googleapis.com/css2?family=Poppins:ital,wght@1,800\nTimings:\n- Start time: 37.62 ms\n- Queued at: 43.24 ms\n- Request sent at: 41.71 ms\n- Download complete at: 48.04 ms\n- Completed at: 51.55 ms\nDurations:\n- Main thread processing duration: 3.51 ms\n- Total duration: 13.93 ms\nInitiator: https://chromedevtools.github.io/performance-stories/lcp-large-image/index.html\nStatus code: 200\nMIME Type: text/css\nPriority: VeryHigh\nRender blocking: Yes\nFrom a service worker: No\nResponse headers\n- date: Thu, 07 Mar 2024 21:17:02 GMT\n- content-encoding: gzip\n- x-content-type-options: nosniff\n- last-modified: Thu, 07 Mar 2024 21:17:02 GMT\n- server: ESF\n- cross-origin-opener-policy: <redacted>\n- x-frame-options: SAMEORIGIN\n- content-type: text/css; charset=utf-8\n- access-control-allow-origin: *\n- cache-control: private, max-age=86400, stale-while-revalidate=604800\n- cross-origin-resource-policy: <redacted>\n- timing-allow-origin: *\n- link: <https://fonts.gstatic.com>; rel=preconnect; crossorigin\n- x-xss-protection: 0\n- expires: Thu, 07 Mar 2024 21:17:02 GMT`;\n\n      assert.strictEqual(output, expected);\n    });\n    it('formats network requests in non-verbose mode', async function() {\n      const {parsedTrace} = await TraceLoader.traceEngine(this, 'lcp-images.json.gz');\n      const requestUrl = 'https://fonts.googleapis.com/css2?family=Poppins:ital,wght@1,800';\n      const request = parsedTrace.NetworkRequests.byTime.find(r => r.args.data.url === requestUrl);\n      assert.isOk(request);\n      const output = TraceEventFormatter.networkRequest(request, parsedTrace, {verbose: false});\n      const expected = `## Network request: https://fonts.googleapis.com/css2?family=Poppins:ital,wght@1,800\n- Start time: 37.62 ms\n- Duration: 13.93 ms\n- MIME type: text/css\n- This request was render blocking`;\n\n      assert.strictEqual(output, expected);\n    });\n  });\n});\n"]}