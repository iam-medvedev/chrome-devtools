{"version":3,"file":"ExtensionScope.js","sourceRoot":"","sources":["../../../../../../front_end/panels/ai_assistance/ExtensionScope.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../core/common/common.js';\nimport * as SDK from '../../core/sdk/sdk.js';\nimport * as Protocol from '../../generated/protocol.js';\nimport * as UI from '../../ui/legacy/legacy.js';\n\nimport type {ChangeManager} from './ChangeManager.js';\nimport {\n  AI_ASSISTANCE_CSS_CLASS_NAME,\n  type FreestyleCallbackArgs,\n  FREESTYLER_BINDING_NAME,\n  FREESTYLER_WORLD_NAME,\n  freestylerBinding,\n  injectedFunctions\n} from './injected.js';\n\n/**\n * Injects Freestyler extension functions in to the isolated world.\n */\nexport class ExtensionScope {\n  #listeners: Array<(event: {\n                      data: Protocol.Runtime.BindingCalledEvent,\n                    }) => Promise<void>> = [];\n  #changeManager: ChangeManager;\n  #agentId: string;\n  /** Don't use directly use the getter */\n  #frameId?: Protocol.Page.FrameId|null;\n  /** Don't use directly use the getter */\n  #target?: SDK.Target.Target;\n\n  readonly #bindingMutex = new Common.Mutex.Mutex();\n\n  constructor(changes: ChangeManager, agentId: string) {\n    this.#changeManager = changes;\n    const selectedNode = UI.Context.Context.instance().flavor(SDK.DOMModel.DOMNode);\n\n    const frameId = selectedNode?.frameId();\n    const target = selectedNode?.domModel().target();\n    this.#agentId = agentId;\n    this.#target = target;\n    this.#frameId = frameId;\n  }\n\n  get target(): SDK.Target.Target {\n    if (this.#target) {\n      return this.#target;\n    }\n\n    const target = UI.Context.Context.instance().flavor(SDK.Target.Target);\n    if (!target) {\n      throw new Error('Target is not found for executing code');\n    }\n\n    return target;\n  }\n\n  get frameId(): Protocol.Page.FrameId {\n    if (this.#frameId) {\n      return this.#frameId;\n    }\n\n    const resourceTreeModel = this.target.model(SDK.ResourceTreeModel.ResourceTreeModel);\n    if (!resourceTreeModel?.mainFrame) {\n      throw new Error('Main frame is not found for executing code');\n    }\n\n    return resourceTreeModel.mainFrame.id;\n  }\n\n  async install(): Promise<void> {\n    const runtimeModel = this.target.model(SDK.RuntimeModel.RuntimeModel);\n    const pageAgent = this.target.pageAgent();\n\n    // This returns previously created world if it exists for the frame.\n    const {executionContextId} =\n        await pageAgent.invoke_createIsolatedWorld({frameId: this.frameId, worldName: FREESTYLER_WORLD_NAME});\n\n    const isolatedWorldContext = runtimeModel?.executionContext(executionContextId);\n    if (!isolatedWorldContext) {\n      throw new Error('Execution context is not found for executing code');\n    }\n\n    const handler = this.#bindingCalled.bind(this, isolatedWorldContext);\n    runtimeModel?.addEventListener(SDK.RuntimeModel.Events.BindingCalled, handler);\n    this.#listeners.push(handler);\n    await this.target.runtimeAgent().invoke_addBinding({\n      name: FREESTYLER_BINDING_NAME,\n      executionContextId,\n    });\n    await this.#simpleEval(isolatedWorldContext, freestylerBinding);\n    await this.#simpleEval(isolatedWorldContext, injectedFunctions);\n  }\n\n  async uninstall(): Promise<void> {\n    const runtimeModel = this.target.model(SDK.RuntimeModel.RuntimeModel);\n\n    for (const handler of this.#listeners) {\n      runtimeModel?.removeEventListener(SDK.RuntimeModel.Events.BindingCalled, handler);\n    }\n    this.#listeners = [];\n\n    await this.target.runtimeAgent().invoke_removeBinding({\n      name: FREESTYLER_BINDING_NAME,\n    });\n  }\n\n  async #simpleEval(\n      context: SDK.RuntimeModel.ExecutionContext,\n      expression: string,\n      returnByValue = true,\n      ): Promise<{\n    object: SDK.RemoteObject.RemoteObject,\n  }> {\n    const response = await context.evaluate(\n        {\n          expression,\n          replMode: true,\n          includeCommandLineAPI: false,\n          returnByValue,\n          silent: false,\n          generatePreview: false,\n          allowUnsafeEvalBlockedByCSP: true,\n          throwOnSideEffect: false,\n        },\n        /* userGesture */ false, /* awaitPromise */ true);\n\n    if (!response) {\n      throw new Error('Response is not found');\n    }\n    if ('error' in response) {\n      throw new Error(response.error);\n    }\n    if (response.exceptionDetails) {\n      const exceptionDescription = response.exceptionDetails.exception?.description;\n      throw new Error(exceptionDescription || 'JS exception');\n    }\n    return response;\n  }\n\n  static getSelectorForRule(matchedStyles: SDK.CSSMatchedStyles.CSSMatchedStyles): string {\n    let styleRule: SDK.CSSRule.CSSStyleRule|undefined;\n    for (const style of matchedStyles.nodeStyles()) {\n      // Ignore inline as we can't override them\n      if (style.type === 'Inline') {\n        continue;\n      }\n\n      const rule = style.parentRule;\n      if (rule?.origin === Protocol.CSS.StyleSheetOrigin.UserAgent) {\n        // TODO(nvitkov): this may not be true after crbug.com/40280502\n        // All rule after the User Agent one are inherit\n        // We can't use them to build the selector\n        break;\n      }\n      if (rule instanceof SDK.CSSRule.CSSStyleRule) {\n        // If the rule we created was our own return directly\n        if (rule.nestingSelectors?.at(0)?.includes(AI_ASSISTANCE_CSS_CLASS_NAME)) {\n          // We know that the last character will be & so remove it\n          const text = rule.selectors[0].text;\n          return text.at(-1) === '&' ? text.slice(0, -1) : text;\n        }\n        styleRule = rule;\n        break;\n      }\n    }\n\n    if (!styleRule) {\n      return '';\n    }\n\n    const selectorIndexes = matchedStyles.getMatchingSelectors(styleRule);\n    // TODO: Compute the selector when nested selector is present\n    const selectors = styleRule.selectors.filter((_, index) => selectorIndexes.includes(index)).sort((a, b) => {\n      if (!a.specificity) {\n        return -1;\n      }\n\n      if (!b.specificity) {\n        return 1;\n      }\n\n      if (b.specificity.a !== a.specificity.a) {\n        return b.specificity.a - a.specificity.a;\n      }\n\n      if (b.specificity.b !== a.specificity.b) {\n        return b.specificity.b - a.specificity.b;\n      }\n\n      return b.specificity.b - a.specificity.b;\n    });\n\n    // See https://developer.mozilla.org/en-US/docs/Web/CSS/Privacy_and_the_:visited_selector\n    return selectors.at(0)?.text.replace(':visited', '') ?? '';\n  }\n\n  static getSelectorForNode(node: SDK.DOMModel.DOMNode): string {\n    return node.simpleSelector()\n        .split('.')\n        .filter(chunk => {\n          return !chunk.startsWith(AI_ASSISTANCE_CSS_CLASS_NAME);\n        })\n        .join('.');\n  }\n\n  async #computeSelectorFromElement(remoteObject: SDK.RemoteObject.RemoteObject): Promise<string> {\n    if (!remoteObject.objectId) {\n      throw new Error('DOMModel is not found');\n    }\n\n    const cssModel = this.target.model(SDK.CSSModel.CSSModel);\n    if (!cssModel) {\n      throw new Error('CSSModel is not found');\n    }\n\n    const domModel = this.target.model(SDK.DOMModel.DOMModel);\n    if (!domModel) {\n      throw new Error('DOMModel is not found');\n    }\n\n    const node = await domModel.pushNodeToFrontend(remoteObject.objectId);\n    if (!node) {\n      throw new Error('Node is not found');\n    }\n\n    try {\n      const matchedStyles = await cssModel.getMatchedStyles(node.id);\n\n      if (!matchedStyles) {\n        throw new Error('No Matching styles');\n      }\n\n      const selector = ExtensionScope.getSelectorForRule(matchedStyles);\n      if (selector) {\n        return selector;\n      }\n    } catch {\n    }\n\n    return ExtensionScope.getSelectorForNode(node);\n  }\n\n  async #bindingCalled(executionContext: SDK.RuntimeModel.ExecutionContext, event: {\n    data: Protocol.Runtime.BindingCalledEvent,\n  }): Promise<void> {\n    const {data} = event;\n    if (data.name !== FREESTYLER_BINDING_NAME) {\n      return;\n    }\n\n    // We need to clean-up if anything fails here.\n    await this.#bindingMutex.run(async () => {\n      const cssModel = this.target.model(SDK.CSSModel.CSSModel);\n      if (!cssModel) {\n        throw new Error('CSSModel is not found');\n      }\n\n      const id = data.payload;\n      const [args, element] = await Promise.all([\n        this.#simpleEval(executionContext, `freestyler.getArgs(${id})`),\n        this.#simpleEval(executionContext, `freestyler.getElement(${id})`, false)\n      ]);\n\n      const arg = JSON.parse(args.object.value) as Omit<FreestyleCallbackArgs, 'element'>;\n\n      // TODO: Should this a be a *?\n      let selector = '';\n      try {\n        selector = await this.#computeSelectorFromElement(element.object);\n      } catch (err) {\n        console.error(err);\n      } finally {\n        element.object.release();\n      }\n\n      const styleChanges = await this.#changeManager.addChange(cssModel, this.frameId, {\n        groupId: this.#agentId,\n        selector,\n        className: arg.className,\n        styles: arg.styles,\n      });\n      await this.#simpleEval(executionContext, `freestyler.respond(${id}, ${JSON.stringify(styleChanges)})`);\n    });\n  }\n}\n"]}