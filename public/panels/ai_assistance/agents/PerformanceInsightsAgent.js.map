{"version":3,"file":"PerformanceInsightsAgent.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/ai_assistance/agents/PerformanceInsightsAgent.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2025 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Host from '../../../core/host/host.js';\nimport type * as Lit from '../../../ui/lit/lit.js';\nimport * as TimelineUtils from '../../timeline/utils/utils.js';\nimport * as PanelUtils from '../../utils/utils.js';\nimport {PerformanceInsightFormatter, TraceEventFormatter} from '../data_formatters/PerformanceInsightFormatter.js';\n\nimport {\n  type AgentOptions as BaseAgentOptions,\n  AgentType,\n  AiAgent,\n  type ContextDetail,\n  type ContextResponse,\n  ConversationContext,\n  type RequestOptions,\n  type ResponseData,\n  ResponseType,\n} from './AiAgent.js';\n\n/* clang-format off */\nconst preamble = `You are a performance expert deeply integrated within Chrome DevTools. You specialize in analyzing web application behaviour captured by Chrome DevTools Performance Panel.\n\nYou will be provided with an Insight from the Chrome Performance Panel. This Insight will contain information about part of the performance of the web site. It is your task to analyze the data available to you and suggest solutions to improve the performance of the page.\n\nYou will be told the following information about the Insight:\n- The 'Insight name' which is the title of the Insight\n- The 'Insight description' which helps you understand what the insight is for and what the user is hoping to understand.\n- 'Insight details' which will be additional context and information to help you understand what the insight is showing the user. Use this information to suggest opportunities to improve the performance.\n\nYou will also be provided with external resources. Use these to ensure you give correct, accurate and up to date answers.\n\n## Step-by-step instructions\n\n- Think about what the user wants.\n- Call any of the available functions to help you gather more information to inform your suggestions.\n- Make suggestions that you are confident will improve the performance of the page.\n\n## General considerations\n\n- *CRITICAL* never make the same function call twice.\n- *CRITICAL* make sure you are thorough and call the functions you have access to to give yourself the most information possible to make accurate recommendations.\n`;\n/* clang-format on */\n\nexport class InsightContext extends ConversationContext<TimelineUtils.InsightAIContext.ActiveInsight> {\n  readonly #insight: TimelineUtils.InsightAIContext.ActiveInsight;\n\n  constructor(insight: TimelineUtils.InsightAIContext.ActiveInsight) {\n    super();\n    this.#insight = insight;\n  }\n\n  getOrigin(): string {\n    // TODO: probably use the origin of the navigation the insight is\n    // associated with? We can put that into the context.\n    return '';\n  }\n\n  getItem(): TimelineUtils.InsightAIContext.ActiveInsight {\n    return this.#insight;\n  }\n\n  override getIcon(): HTMLElement {\n    const iconData = {\n      iconName: 'performance',\n      color: 'var(--sys-color-on-surface-subtle)',\n    };\n    const icon = PanelUtils.PanelUtils.createIconElement(iconData, 'Performance');\n    icon.classList.add('icon');\n    return icon;\n  }\n\n  override getTitle(): string|ReturnType<typeof Lit.Directives.until> {\n    return this.#insight.title();\n  }\n}\n\nexport class PerformanceInsightsAgent extends AiAgent<TimelineUtils.InsightAIContext.ActiveInsight> {\n  #insight: ConversationContext<TimelineUtils.InsightAIContext.ActiveInsight>|undefined;\n\n  override async *\n      handleContextDetails(activeContext: ConversationContext<TimelineUtils.InsightAIContext.ActiveInsight>|null):\n          AsyncGenerator<ContextResponse, void, void> {\n    if (!activeContext) {\n      return;\n    }\n\n    const title = activeContext.getItem().title();\n    // TODO: Provide proper text with useful context details.\n    const titleDetail: ContextDetail = {title, text: title};\n    yield {type: ResponseType.CONTEXT, title, details: [titleDetail]};\n  }\n\n  override readonly type = AgentType.PERFORMANCE_INSIGHT;\n  readonly preamble = preamble;\n  readonly clientFeature = Host.AidaClient.ClientFeature.CHROME_PERFORMANCE_INSIGHTS_AGENT;\n\n  get userTier(): string|undefined {\n    return 'TESTERS';\n  }\n\n  get options(): RequestOptions {\n    return {\n      temperature: undefined,\n      modelId: undefined,\n    };\n  }\n\n  constructor(opts: BaseAgentOptions) {\n    super(opts);\n\n    this.declareFunction<Record<never, unknown>, {\n      requests: string[],\n    }>('getNetworkActivity', {\n      description: 'Returns relevant network requests for the selected insight',\n      parameters: {\n        type: Host.AidaClient.ParametersTypes.OBJECT,\n        description: '',\n        nullable: true,\n        properties: {},\n      },\n      handler: async () => {\n        if (!this.#insight) {\n          return {error: 'No insight available'};\n        }\n        const activeInsight = this.#insight.getItem();\n        const requests = TimelineUtils.InsightAIContext.AIQueries.networkRequests(\n            activeInsight.insight,\n            activeInsight.parsedTrace,\n        );\n        const formatted = requests.map(r => TraceEventFormatter.networkRequest(r, activeInsight.parsedTrace));\n        return {result: {requests: formatted}};\n      },\n    });\n\n    this.declareFunction<Record<never, unknown>, {activity: string}>('getMainThreadActivity', {\n      description: `Returns the main thread activity for the selected insight.\nThe tree is represented as a call frame with a root task and a series of children.\nThe format of each callframe is:\n\n    Node: $id – $name\n    Selected: true\n    dur: $duration\n    self: $self\n    URL #: $url_number\n    Children:\n      * $child.id – $child.name\n\nThe fields are:\n\n* name:  A short string naming the callframe (e.g. 'Evaluate Script' or the JS function name 'InitializeApp')\n* id:  A numerical identifier for the callframe\n* Selected:  Set to true if this callframe is the one the user selected.\n* url_number:  The number of the URL referenced in the \"All URLs\" list\n* dur:  The total duration of the callframe (includes time spent in its descendants), in milliseconds.\n* self:  The self duration of the callframe (excludes time spent in its descendants), in milliseconds. If omitted, assume the value is 0.\n* children:  An list of child callframes, each denoted by their id and name`,\n      parameters: {\n        type: Host.AidaClient.ParametersTypes.OBJECT,\n        description: '',\n        nullable: true,\n        properties: {},\n      },\n      handler: async () => {\n        if (!this.#insight) {\n          return {error: 'No insight available'};\n        }\n        const activeInsight = this.#insight.getItem();\n        const tree = TimelineUtils.InsightAIContext.AIQueries.mainThreadActivity(\n            activeInsight.insight,\n            activeInsight.parsedTrace,\n        );\n        if (!tree) {\n          return {error: 'No main thread activity found'};\n        }\n        return {result: {activity: tree.serialize()}};\n      },\n\n    });\n  }\n\n  override async enhanceQuery(\n      query: string,\n      selectedInsight: ConversationContext<TimelineUtils.InsightAIContext.ActiveInsight>|null): Promise<string> {\n    if (!selectedInsight) {\n      return query;\n    }\n    const formatter = new PerformanceInsightFormatter(selectedInsight.getItem().insight);\n    const extraQuery = `${formatter.formatInsight()}\\n\\n# User request:\\n`;\n\n    const finalQuery = `${extraQuery}${query}`;\n    return finalQuery;\n  }\n\n  override async * run(initialQuery: string, options: {\n    signal?: AbortSignal, selected: ConversationContext<TimelineUtils.InsightAIContext.ActiveInsight>|null,\n  }): AsyncGenerator<ResponseData, void, void> {\n    this.#insight = options.selected ?? undefined;\n\n    return yield* super.run(initialQuery, options);\n  }\n}\n"]}