{"version":3,"file":"PerformanceAgent.test.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/ai_assistance/agents/PerformanceAgent.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Host from '../../../core/host/host.js';\nimport * as Trace from '../../../models/trace/trace.js';\nimport {mockAidaClient} from '../../../testing/AiAssistanceHelpers.js';\nimport {\n  describeWithEnvironment,\n  restoreUserAgentForTesting,\n  setUserAgentForTesting,\n  updateHostConfig\n} from '../../../testing/EnvironmentHelpers.js';\nimport {TraceLoader} from '../../../testing/TraceLoader.js';\nimport * as TimelineUtils from '../../timeline/utils/utils.js';\nimport {CallTreeContext, PerformanceAgent, ResponseType} from '../ai_assistance.js';\n\ndescribeWithEnvironment('PerformanceAgent', () => {\n  function mockHostConfig(modelId?: string, temperature?: number) {\n    updateHostConfig({\n      devToolsAiAssistancePerformanceAgent: {\n        modelId,\n        temperature,\n      },\n    });\n  }\n\n  describe('getOrigin()', () => {\n    it('calculates the origin of the selected node when it has a URL associated with it', async function() {\n      const {parsedTrace} = await TraceLoader.traceEngine(this, 'web-dev-with-commit.json.gz');\n      // An Evaluate Script event, picked because it has a URL of googletagmanager.com/...\n      const evalScriptEvent = parsedTrace.Renderer.allTraceEntries.find(\n          event => event.name === Trace.Types.Events.Name.EVALUATE_SCRIPT && event.ts === 122411195649);\n      assert.exists(evalScriptEvent);\n      const aiCallTree = TimelineUtils.AICallTree.AICallTree.fromEvent(evalScriptEvent, parsedTrace);\n      assert.isOk(aiCallTree);\n      const callTreeContext = new CallTreeContext(aiCallTree);\n      assert.strictEqual(callTreeContext.getOrigin(), 'https://www.googletagmanager.com');\n    });\n\n    it('returns a random but deterministic \"origin\" for nodes that have no URL associated', async function() {\n      const {parsedTrace} = await TraceLoader.traceEngine(this, 'web-dev-with-commit.json.gz');\n      // A random layout event with no URL associated\n      const layoutEvent = parsedTrace.Renderer.allTraceEntries.find(\n          event => event.name === Trace.Types.Events.Name.LAYOUT && event.ts === 122411130078);\n      assert.exists(layoutEvent);\n      const aiCallTree = TimelineUtils.AICallTree.AICallTree.fromEvent(layoutEvent, parsedTrace);\n      assert.isOk(aiCallTree);\n      const callTreeContext = new CallTreeContext(aiCallTree);\n      assert.strictEqual(callTreeContext.getOrigin(), 'Layout_90829_259_122411130078');\n    });\n  });\n\n  describe('buildRequest', () => {\n    beforeEach(() => {\n      sinon.restore();\n    });\n\n    it('builds a request with a model id', async () => {\n      mockHostConfig('test model');\n      const agent = new PerformanceAgent({\n        aidaClient: {} as Host.AidaClient.AidaClient,\n      });\n      assert.strictEqual(\n          agent.buildRequest({text: 'test input'}, Host.AidaClient.Role.USER).options?.model_id,\n          'test model',\n      );\n    });\n\n    it('builds a request with a temperature', async () => {\n      mockHostConfig('test model', 1);\n      const agent = new PerformanceAgent({\n        aidaClient: {} as Host.AidaClient.AidaClient,\n      });\n      assert.strictEqual(\n          agent.buildRequest({text: 'test input'}, Host.AidaClient.Role.USER).options?.temperature,\n          1,\n      );\n    });\n\n    it('structure matches the snapshot', async () => {\n      mockHostConfig('test model');\n      sinon.stub(crypto, 'randomUUID').returns('sessionId' as `${string}-${string}-${string}-${string}-${string}`);\n      const agent = new PerformanceAgent({\n        aidaClient: mockAidaClient([[{explanation: 'answer'}]]),\n        serverSideLoggingEnabled: true,\n      });\n      sinon.stub(agent, 'preamble').value('preamble');\n\n      await Array.fromAsync(agent.run('question', {selected: null}));\n      setUserAgentForTesting();\n\n      assert.deepEqual(\n          agent.buildRequest(\n              {\n                text: 'test input',\n              },\n              Host.AidaClient.Role.USER),\n          {\n            current_message: {role: Host.AidaClient.Role.USER, parts: [{text: 'test input'}]},\n            client: 'CHROME_DEVTOOLS',\n            preamble: 'preamble',\n            historical_contexts: [\n              {\n                role: 1,\n                parts: [{text: 'question'}],\n              },\n              {\n                role: 2,\n                parts: [{text: 'answer'}],\n              },\n            ],\n            metadata: {\n              disable_user_content_logging: false,\n              string_session_id: 'sessionId',\n              user_tier: 2,\n              client_version: 'unit_test',\n            },\n            options: {\n              model_id: 'test model',\n              temperature: undefined,\n            },\n            client_feature: 8,\n            functionality_type: 1,\n          },\n      );\n      restoreUserAgentForTesting();\n    });\n  });\n  describe('run', function() {\n    it('generates an answer', async function() {\n      const {parsedTrace} = await TraceLoader.traceEngine(this, 'web-dev-outermost-frames.json.gz');\n      // A basic Layout.\n      const layoutEvt = parsedTrace.Renderer.allTraceEntries.find(event => event.ts === 465457096322);\n      assert.exists(layoutEvt);\n      const aiCallTree = TimelineUtils.AICallTree.AICallTree.fromEvent(layoutEvt, parsedTrace);\n      assert.exists(aiCallTree);\n\n      const agent = new PerformanceAgent({\n        aidaClient: mockAidaClient([[{\n          explanation: 'This is the answer',\n          metadata: {\n            rpcGlobalId: 123,\n          },\n        }]]),\n      });\n\n      const responses = await Array.fromAsync(agent.run('test', {selected: new CallTreeContext(aiCallTree)}));\n      const expectedData = '\\n\\n' +\n          `\n\n\n# Call tree:\n\nNode: 1 – Task\ndur: 3\nChildren:\n  * 2 – Layout\n\nNode: 2 – Layout\nSelected: true\ndur: 3\nself: 3\n`.trim();\n\n      assert.deepEqual(responses, [\n        {\n          type: ResponseType.USER_QUERY,\n          query: 'test',\n          imageInput: undefined,\n          imageId: undefined,\n        },\n        {\n          type: ResponseType.CONTEXT,\n          title: 'Analyzing call tree',\n          details: [\n            {title: 'Selected call tree', text: expectedData},\n          ],\n        },\n        {\n          type: ResponseType.QUERYING,\n        },\n        {\n          type: ResponseType.ANSWER,\n          text: 'This is the answer',\n          complete: true,\n          suggestions: undefined,\n          rpcId: 123,\n        },\n      ]);\n\n      assert.deepEqual(agent.buildRequest({text: ''}, Host.AidaClient.Role.USER).historical_contexts, [\n        {\n          role: 1,\n          parts: [{text: `${aiCallTree.serialize()}\\n\\n# User request\\n\\ntest`}],\n        },\n        {\n          role: 2,\n          parts: [{text: 'This is the answer'}],\n        },\n      ]);\n    });\n  });\n\n  describe('enhanceQuery', () => {\n    it('does not send the serialized calltree again if it is a followup chat about the same calltree', async () => {\n      const agent = new PerformanceAgent({\n        aidaClient: {} as Host.AidaClient.AidaClient,\n      });\n\n      const mockAiCallTree = {\n        serialize: () => 'Mock call tree',\n      } as unknown as TimelineUtils.AICallTree.AICallTree;\n\n      const enhancedQuery1 = await agent.enhanceQuery('What is this?', new CallTreeContext(mockAiCallTree));\n      assert.strictEqual(enhancedQuery1, 'Mock call tree\\n\\n# User request\\n\\nWhat is this?');\n\n      const query2 = 'But what about this follow-up question?';\n      const enhancedQuery2 = await agent.enhanceQuery(query2, new CallTreeContext(mockAiCallTree));\n      assert.strictEqual(enhancedQuery2, query2);\n      assert.isFalse(enhancedQuery2.includes(mockAiCallTree.serialize()));\n\n      // Just making sure any subsequent chat doesnt include it either.\n      const query3 = 'And this 3rd question?';\n      const enhancedQuery3 = await agent.enhanceQuery(query3, new CallTreeContext(mockAiCallTree));\n      assert.strictEqual(enhancedQuery3, query3);\n      assert.isFalse(enhancedQuery3.includes(mockAiCallTree.serialize()));\n    });\n  });\n});\n"]}