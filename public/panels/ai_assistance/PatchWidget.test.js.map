{"version":3,"file":"PatchWidget.test.js","sourceRoot":"","sources":["../../../../../../front_end/panels/ai_assistance/PatchWidget.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2025 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Platform from '../../core/platform/platform.js';\nimport * as Root from '../../core/root/root.js';\nimport * as AiAssistanceModel from '../../models/ai_assistance/ai_assistance.js';\nimport * as Workspace from '../../models/workspace/workspace.js';\nimport {\n  cleanup,\n  createPatchWidget,\n  createPatchWidgetWithDiffView,\n  initializePersistenceImplForTests,\n  MockAidaAbortError,\n  mockAidaClient,\n  MockAidaFetchError,\n} from '../../testing/AiAssistanceHelpers.js';\nimport {updateHostConfig} from '../../testing/EnvironmentHelpers.js';\nimport {describeWithMockConnection} from '../../testing/MockConnection.js';\nimport {createContentProviderUISourceCode, createFileSystemUISourceCode} from '../../testing/UISourceCodeHelpers.js';\n\nimport * as AiAssistance from './ai_assistance.js';\n\ndescribeWithMockConnection('PatchWidget', () => {\n  beforeEach(() => {\n    initializePersistenceImplForTests();\n  });\n\n  afterEach(() => {\n    cleanup();\n  });\n\n  describe('applyToPageTree', () => {\n    beforeEach(() => {\n      createContentProviderUISourceCode({\n        url: Platform.DevToolsPath.urlString`file://test/index.html`,\n        content: 'content',\n        mimeType: 'text/javascript',\n        projectType: Workspace.Workspace.projectTypes.Network,\n        metadata: new Workspace.UISourceCode.UISourceCodeMetadata(null, 'content'.length),\n      });\n      updateHostConfig({\n        devToolsFreestyler: {\n          enabled: true,\n          patching: true,\n        },\n      });\n    });\n\n    describe('enterprise text cases', () => {\n      it('should tooltip text include no logging case when the enterprise policy value is ALLOW_WITHOUT_LOGGING',\n         async () => {\n           updateHostConfig({\n             devToolsFreestyler: {\n               enabled: true,\n               patching: true,\n             },\n             aidaAvailability: {enterprisePolicyValue: Root.Runtime.GenAiEnterprisePolicyValue.ALLOW_WITHOUT_LOGGING}\n           });\n           const {view} = await createPatchWidget();\n\n           assert.include(\n               view.input.disclaimerTooltipText, 'This data will not be used to improve Google’s AI models.');\n         });\n\n      it('should tooltip text not include no logging case when the enterprise policy value is ALLOW', async () => {\n        updateHostConfig({\n          devToolsFreestyler: {\n            enabled: true,\n            patching: true,\n          },\n          aidaAvailability: {enterprisePolicyValue: Root.Runtime.GenAiEnterprisePolicyValue.ALLOW}\n        });\n        const {view} = await createPatchWidget();\n\n        assert.notInclude(\n            view.input.disclaimerTooltipText, 'This data will not be used to improve Google’s AI models.');\n      });\n    });\n\n    it('should show files uploaded', async () => {\n      const {view, widget} = await createPatchWidget({\n        aidaClient: mockAidaClient([\n          [{explanation: '', functionCalls: [{name: 'updateFiles', args: {files: ['/index.html']}}]}], [{\n            explanation: 'done',\n          }]\n        ]),\n      });\n      widget.changeSummary = 'body { background-color: red; }';\n\n      view.input.onApplyToPageTree();\n\n      assert.strictEqual((await view.nextInput).sources, `Filenames in page.\nFiles:\n* /index.html`);\n    });\n\n    it('should show error state when applyToPageTree fails', async () => {\n      const {view, widget} = await createPatchWidget({aidaClient: mockAidaClient([[MockAidaFetchError]])});\n      widget.changeSummary = 'body { background-color: red; }';\n\n      view.input.onApplyToPageTree();\n\n      const input = await view.nextInput;\n      assert.strictEqual(input.patchSuggestionState, AiAssistance.PatchWidget.PatchSuggestionState.ERROR);\n    });\n\n    it('should return back to initial state when the user aborts applying to workspace', async () => {\n      const {view, widget} = await createPatchWidget({aidaClient: mockAidaClient([[MockAidaAbortError]])});\n      widget.changeSummary = 'body { background-color: red; }';\n\n      view.input.onApplyToPageTree();\n\n      const input = await view.nextInput;\n      assert.strictEqual(input.patchSuggestionState, AiAssistance.PatchWidget.PatchSuggestionState.INITIAL);\n    });\n  });\n\n  describe('diff view', () => {\n    const origContent = 'window.foo = () => \"foo\";\\n';\n    let fileSystemUISourceCode: Workspace.UISourceCode.UISourceCode;\n    let commitWorkingCopyStub:\n        sinon.SinonStub<Parameters<typeof Workspace.UISourceCode.UISourceCode.prototype.commitWorkingCopy>>;\n    let resetWorkingCopyStub:\n        sinon.SinonStub<Parameters<typeof Workspace.UISourceCode.UISourceCode.prototype.resetWorkingCopy>>;\n\n    beforeEach(() => {\n      updateHostConfig({\n        devToolsFreestyler: {\n          enabled: true,\n          patching: true,\n        },\n      });\n\n      const url = Platform.DevToolsPath.urlString`https://example.com/script.js`;\n      createContentProviderUISourceCode({\n        url,\n        content: origContent,\n        mimeType: 'text/javascript',\n        projectType: Workspace.Workspace.projectTypes.Network,\n        metadata: new Workspace.UISourceCode.UISourceCodeMetadata(null, origContent.length),\n      });\n\n      commitWorkingCopyStub =\n          sinon.stub(Workspace.UISourceCode.UISourceCode.prototype, 'commitWorkingCopy').callThrough();\n      resetWorkingCopyStub =\n          sinon.stub(Workspace.UISourceCode.UISourceCode.prototype, 'resetWorkingCopy').callThrough();\n    });\n\n    const createBoundFileSystemUISourceCode = () => {\n      const localUrl = Platform.DevToolsPath.urlString`file:///var/www/script.js`;\n      ({uiSourceCode: fileSystemUISourceCode} = createFileSystemUISourceCode({\n         url: localUrl,\n         mimeType: 'text/javascript',\n         content: origContent,\n         autoMapping: true,\n         metadata: new Workspace.UISourceCode.UISourceCodeMetadata(null, origContent.length),\n       }));\n    };\n\n    it('on apply should call handle function and stash changes', async () => {\n      const {\n        view,\n        widget,\n      } = await createPatchWidget({aidaClient: mockAidaClient([[{explanation: 'patch applied'}]])});\n      widget.changeSummary = 'body { background-color: red; }';\n      const changeManager = sinon.createStubInstance(AiAssistanceModel.ChangeManager);\n      widget.changeManager = changeManager;\n      view.input.onApplyToPageTree();\n      await view.nextInput;\n      assert.isTrue(changeManager.stashChanges.calledOnce);\n    });\n\n    it('\"save to workspace\" is not available if there is no matching file system mapping', async () => {\n      const {view, widget} = await createPatchWidgetWithDiffView();\n      const changeManager = sinon.createStubInstance(AiAssistanceModel.ChangeManager);\n      widget.changeManager = changeManager;\n      assert.isUndefined(view.input.onSaveToWorkspace);\n    });\n\n    it('\"save to workspace\" should commit the working copy of the files to disk and update the view', async () => {\n      createBoundFileSystemUISourceCode();\n      fileSystemUISourceCode.setWorkingCopy('working copy');\n      const {view, widget} = await createPatchWidgetWithDiffView();\n      const changeManager = sinon.createStubInstance(AiAssistanceModel.ChangeManager);\n      widget.changeManager = changeManager;\n\n      assert.isDefined(view.input.onSaveToWorkspace);\n      view.input.onSaveToWorkspace();\n      const nextInput = await view.nextInput;\n\n      assert.isTrue(nextInput.savedToDisk);\n      assert.isTrue(commitWorkingCopyStub.called, 'Expected commitWorkingCopy to be called but it is not called');\n      assert.isTrue(changeManager.dropStashedChanges.calledOnce);\n    });\n\n    it('discard should discard the working copy and render the view without patchSuggestion', async () => {\n      createBoundFileSystemUISourceCode();\n      const {view, widget} = await createPatchWidgetWithDiffView();\n      const changeManager = sinon.createStubInstance(AiAssistanceModel.ChangeManager);\n      widget.changeManager = changeManager;\n      fileSystemUISourceCode.setWorkingCopy('working copy');\n\n      view.input.onDiscard();\n      const nextInput = await view.nextInput;\n\n      assert.strictEqual(nextInput.patchSuggestionState, AiAssistance.PatchWidget.PatchSuggestionState.INITIAL);\n      assert.isTrue(resetWorkingCopyStub.called, 'Expected resetWorkingCopy to be called but it is not called');\n      assert.isTrue(changeManager.popStashedChanges.calledOnce);\n    });\n  });\n});\n"]}