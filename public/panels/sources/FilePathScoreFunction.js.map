{"version":3,"file":"FilePathScoreFunction.js","sourceRoot":"","sources":["../../../../../../front_end/panels/sources/FilePathScoreFunction.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Copyright (C) 2013 Google Inc. All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without\n * modification, are permitted provided that the following conditions are\n * met:\n *\n *     * Redistributions of source code must retain the above copyright\n * notice, this list of conditions and the following disclaimer.\n *     * Redistributions in binary form must reproduce the above\n * copyright notice, this list of conditions and the following disclaimer\n * in the documentation and/or other materials provided with the\n * distribution.\n *     * Neither the name of Google Inc. nor the names of its\n * contributors may be used to endorse or promote products derived from\n * this software without specific prior written permission.\n *\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n * \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\n * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\n * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT\n * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,\n * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT\n * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,\n * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY\n * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\n * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n */\n\nexport class FilePathScoreFunction {\n  private query: string;\n  private readonly queryUpperCase: string;\n  private score: Int32Array;\n  private sequence: Int32Array;\n  private dataUpperCase: string;\n  private fileNameIndex: number;\n\n  constructor(query: string) {\n    this.query = query;\n    this.queryUpperCase = query.toUpperCase();\n    this.score = new Int32Array(20 * 100);\n    this.sequence = new Int32Array(20 * 100);\n    this.dataUpperCase = '';\n    this.fileNameIndex = 0;\n  }\n\n  /**\n   * Calculates the score of a given data string against the query string.\n   *\n   * The score is calculated by comparing the characters of the query string to\n   * the characters of the data string. Characters that match are given a score\n   * of 10, while characters that don't match are given a score of 0. The score\n   * of a match is also influenced by the context of the match. For example,\n   * matching the beginning of the file name is worth more than matching a\n   * character in the middle of the file name.\n   *\n   * The score of a match is also influenced by the number of consecutive\n   * matches. The more consecutive matches there are, the higher the score.\n   *\n   * @param data The data string to score.\n   * @param matchIndexes An optional array to store the indexes of matching\n   * characters. If provided, it will be filled with the indexes of the matching\n   * characters in the data string.\n   * @returns The score of the data string.\n   */\n  calculateScore(data: string, matchIndexes: number[]|null): number {\n    if (!data || !this.query) {\n      return 0;\n    }\n    const queryLength = this.query.length;\n    const dataLength = data.length;\n    if (!this.score || this.score.length < queryLength * dataLength) {\n      this.score = new Int32Array(queryLength * dataLength * 2);\n      this.sequence = new Int32Array(queryLength * dataLength * 2);\n    }\n    const score = this.score;\n    const sequence = (this.sequence);\n    this.dataUpperCase = data.toUpperCase();\n    this.fileNameIndex = data.lastIndexOf('/');\n    for (let i = 0; i < queryLength; ++i) {\n      for (let j = 0; j < dataLength; ++j) {\n        const scoreIndex = i * dataLength + j;\n        const skipCharScore = j === 0 ? 0 : score[scoreIndex - 1];\n        const prevCharScore = i === 0 || j === 0 ? 0 : score[(i - 1) * dataLength + j - 1];\n        const consecutiveMatch = i === 0 || j === 0 ? 0 : sequence[(i - 1) * dataLength + j - 1];\n        const pickCharScore = this.match(this.query, data, i, j, consecutiveMatch);\n        if (pickCharScore && prevCharScore + pickCharScore >= skipCharScore) {\n          sequence[scoreIndex] = consecutiveMatch + 1;\n          score[scoreIndex] = (prevCharScore + pickCharScore);\n        } else {\n          sequence[scoreIndex] = 0;\n          score[scoreIndex] = skipCharScore;\n        }\n      }\n    }\n    if (matchIndexes) {\n      this.restoreMatchIndexes(sequence, queryLength, dataLength, matchIndexes);\n    }\n    const maxDataLength = 256;\n    return score[queryLength * dataLength - 1] * maxDataLength + (maxDataLength - data.length);\n  }\n\n  private testWordStart(data: string, j: number): boolean {\n    if (j === 0) {\n      return true;\n    }\n\n    const prevChar = data.charAt(j - 1);\n    return prevChar === '_' || prevChar === '-' || prevChar === '/' || prevChar === '.' || prevChar === ' ' ||\n        (data[j - 1] !== this.dataUpperCase[j - 1] && data[j] === this.dataUpperCase[j]);\n  }\n\n  private restoreMatchIndexes(sequence: Int32Array, queryLength: number, dataLength: number, out: number[]): void {\n    let i = queryLength - 1, j = dataLength - 1;\n    while (i >= 0 && j >= 0) {\n      switch (sequence[i * dataLength + j]) {\n        case 0:\n          --j;\n          break;\n        default:\n          out.push(j);\n          --i;\n          --j;\n          break;\n      }\n    }\n    out.reverse();\n  }\n\n  private singleCharScore(query: string, data: string, i: number, j: number): number {\n    const isWordStart = this.testWordStart(data, j);\n    const isFileName = j > this.fileNameIndex;\n    const isPathTokenStart = j === 0 || data[j - 1] === '/';\n    const isCapsMatch = query[i] === data[j] && query[i] === this.queryUpperCase[i];\n    let score = 10;\n    if (isPathTokenStart) {\n      score += 4;\n    }\n    if (isWordStart) {\n      score += 2;\n    }\n    if (isCapsMatch) {\n      score += 6;\n    }\n    if (isFileName) {\n      score += 4;\n    }\n    // promote the case of making the whole match in the filename\n    if (j === this.fileNameIndex + 1 && i === 0) {\n      score += 5;\n    }\n    if (isFileName && isWordStart) {\n      score += 3;\n    }\n    return score;\n  }\n\n  private sequenceCharScore(query: string, data: string, i: number, j: number, sequenceLength: number): number {\n    const isFileName = j > this.fileNameIndex;\n    const isPathTokenStart = j === 0 || data[j - 1] === '/';\n    let score = 10;\n    if (isFileName) {\n      score += 4;\n    }\n    if (isPathTokenStart) {\n      score += 5;\n    }\n    score += sequenceLength * 4;\n    return score;\n  }\n\n  private match(query: string, data: string, i: number, j: number, consecutiveMatch: number): number {\n    if (this.queryUpperCase[i] !== this.dataUpperCase[j]) {\n      return 0;\n    }\n\n    if (!consecutiveMatch) {\n      return this.singleCharScore(query, data, i, j);\n    }\n    return this.sequenceCharScore(query, data, i, j - consecutiveMatch, consecutiveMatch);\n  }\n}\n"]}