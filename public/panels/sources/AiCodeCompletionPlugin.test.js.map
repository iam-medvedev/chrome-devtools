{"version":3,"file":"AiCodeCompletionPlugin.test.js","sourceRoot":"","sources":["../../../../../../front_end/panels/sources/AiCodeCompletionPlugin.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../core/common/common.js';\nimport * as Host from '../../core/host/host.js';\nimport * as Platform from '../../core/platform/platform.js';\nimport * as AiCodeCompletion from '../../models/ai_code_completion/ai_code_completion.js';\nimport * as Workspace from '../../models/workspace/workspace.js';\nimport {renderElementIntoDOM} from '../../testing/DOMHelpers.js';\nimport {describeWithEnvironment, updateHostConfig} from '../../testing/EnvironmentHelpers.js';\nimport * as CodeMirror from '../../third_party/codemirror.next/codemirror.next.js';\nimport * as TextEditor from '../../ui/components/text_editor/text_editor.js';\n\nimport {AiCodeCompletionPlugin} from './sources.js';\n\nconst {urlString} = Platform.DevToolsPath;\n\nfunction createEditorWithPlugin(doc: string, uiSourceCode: Workspace.UISourceCode.UISourceCode):\n    {editor: TextEditor.TextEditor.TextEditor, plugin: AiCodeCompletionPlugin.AiCodeCompletionPlugin} {\n  const plugin = new AiCodeCompletionPlugin.AiCodeCompletionPlugin(uiSourceCode);\n  const editor = new TextEditor.TextEditor.TextEditor(\n      CodeMirror.EditorState.create({\n        doc,\n        extensions: [\n          plugin.editorExtension(),\n        ],\n      }),\n  );\n  plugin.editorInitialized(editor);\n  renderElementIntoDOM(editor);\n  return {editor, plugin};\n}\n\nfunction createUiSourceCodeStub({\n  url = urlString`file://`,\n  contentType = Common.ResourceType.resourceTypes.Script,\n}: {\n  url?: Platform.DevToolsPath.UrlString,\n  contentType?: Common.ResourceType.ResourceType,\n} = {}): sinon.SinonStubbedInstance<Workspace.UISourceCode.UISourceCode> {\n  return sinon.createStubInstance(Workspace.UISourceCode.UISourceCode, {\n    url,\n    contentType,\n  });\n}\n\ndescribeWithEnvironment('AiCodeCompletionPlugin', () => {\n  let clock: sinon.SinonFakeTimers;\n  let checkAccessPreconditionsStub: sinon.SinonStub;\n\n  beforeEach(() => {\n    clock = sinon.useFakeTimers();\n    updateHostConfig({\n      devToolsAiCodeCompletion: {\n        enabled: true,\n      },\n    });\n\n    checkAccessPreconditionsStub = sinon.stub(Host.AidaClient.AidaClient, 'checkAccessPreconditions');\n  });\n\n  afterEach(() => {\n    Common.Settings.Settings.instance().settingForTest('ai-code-completion-teaser-dismissed').set(false);\n    Common.Settings.Settings.instance().settingForTest('ai-code-completion-enabled').set(false);\n    clock.restore();\n  });\n\n  describe('accepts', () => {\n    it('holds true for scripts', () => {\n      assert.isTrue(AiCodeCompletionPlugin.AiCodeCompletionPlugin.accepts(createUiSourceCodeStub({\n        contentType: Common.ResourceType.resourceTypes.Script,\n      })));\n    });\n\n    it('holds true for stylesheets', () => {\n      assert.isTrue(AiCodeCompletionPlugin.AiCodeCompletionPlugin.accepts(\n          createUiSourceCodeStub({contentType: Common.ResourceType.resourceTypes.Stylesheet})));\n    });\n\n    it('holds true for documents', () => {\n      assert.isTrue(AiCodeCompletionPlugin.AiCodeCompletionPlugin.accepts(\n          createUiSourceCodeStub({contentType: Common.ResourceType.resourceTypes.Document})));\n    });\n  });\n\n  describe('teaser decoration', () => {\n    it('shows teaser when cursor is at the end of the line', async () => {\n      const {editor, plugin} = createEditorWithPlugin('Hello', createUiSourceCodeStub());\n      editor.dispatch({changes: {from: 5, insert: 'W'}, selection: {anchor: 6}});\n      await clock.tickAsync(\n          AiCodeCompletion.AiCodeCompletion.AIDA_REQUEST_DEBOUNCE_TIMEOUT_MS +\n          AiCodeCompletion.AiCodeCompletion.DELAY_BEFORE_SHOWING_RESPONSE_MS + 1);\n      assert.isNotNull(editor.editor.dom.querySelector('.cm-placeholder'));\n      plugin.dispose();\n    });\n\n    it('hides teaser when cursor is not at the end of the line', async () => {\n      const {editor} = createEditorWithPlugin('Hello', createUiSourceCodeStub());\n      editor.dispatch({changes: {from: 5, insert: 'W'}, selection: {anchor: 6}});\n      await clock.tickAsync(\n          AiCodeCompletion.AiCodeCompletion.AIDA_REQUEST_DEBOUNCE_TIMEOUT_MS +\n          AiCodeCompletion.AiCodeCompletion.DELAY_BEFORE_SHOWING_RESPONSE_MS + 1);\n      assert.isNotNull(editor.editor.dom.querySelector('.cm-placeholder'));\n\n      editor.dispatch({changes: {from: 0, insert: '!'}, selection: {anchor: 1}});\n      await clock.tickAsync(\n          AiCodeCompletion.AiCodeCompletion.AIDA_REQUEST_DEBOUNCE_TIMEOUT_MS +\n          AiCodeCompletion.AiCodeCompletion.DELAY_BEFORE_SHOWING_RESPONSE_MS + 1);\n      assert.isNull(editor.editor.dom.querySelector('.cm-placeholder'));\n    });\n\n    it('hides teaser when text is selected', async () => {\n      const {editor, plugin} = createEditorWithPlugin('Hello', createUiSourceCodeStub());\n      editor.dispatch({changes: {from: 5, insert: 'W'}, selection: {anchor: 6}});\n      await clock.tickAsync(\n          AiCodeCompletion.AiCodeCompletion.AIDA_REQUEST_DEBOUNCE_TIMEOUT_MS +\n          AiCodeCompletion.AiCodeCompletion.DELAY_BEFORE_SHOWING_RESPONSE_MS + 1);\n      assert.isNotNull(editor.editor.dom.querySelector('.cm-placeholder'));\n\n      editor.dispatch({selection: {anchor: 2, head: 4}});\n      assert.isNull(editor.editor.dom.querySelector('.cm-placeholder'));\n      plugin.dispose();\n    });\n  });\n\n  it('triggers code completion on text change', async () => {\n    Common.Settings.Settings.instance().settingForTest('ai-code-completion-enabled').set(true);\n    const {editor, plugin} = createEditorWithPlugin('', createUiSourceCodeStub());\n    const onTextChangedStub = sinon.stub(AiCodeCompletion.AiCodeCompletion.AiCodeCompletion.prototype, 'onTextChanged');\n\n    editor.dispatch({changes: {from: 0, insert: 'Hello'}, selection: {anchor: 5}});\n    sinon.assert.called(onTextChangedStub);\n    assert.deepEqual(onTextChangedStub.firstCall.args, ['Hello', '', 5, undefined]);\n    plugin.dispose();\n  });\n\n  it('triggers code completion when AIDA becomes available', async () => {\n    checkAccessPreconditionsStub.resolves(Host.AidaClient.AidaAccessPreconditions.NO_ACCOUNT_EMAIL);\n    const onTextChangedStub = sinon.stub(AiCodeCompletion.AiCodeCompletion.AiCodeCompletion.prototype, 'onTextChanged');\n    Common.Settings.Settings.instance().settingForTest('ai-code-completion-enabled').set(true);\n    const {editor, plugin} = createEditorWithPlugin('', createUiSourceCodeStub());\n    await clock.tickAsync(0);  // for the initial onAidaAvailabilityChange call\n\n    editor.dispatch({changes: {from: 0, insert: 'Hello'}, selection: {anchor: 5}});\n\n    sinon.assert.notCalled(onTextChangedStub);\n\n    checkAccessPreconditionsStub.resolves(Host.AidaClient.AidaAccessPreconditions.AVAILABLE);\n    await Host.AidaClient.HostConfigTracker.instance().dispatchEventToListeners(\n        Host.AidaClient.Events.AIDA_AVAILABILITY_CHANGED);\n    await clock.tickAsync(0);\n\n    editor.dispatch({changes: {from: 5, insert: 'Bye'}, selection: {anchor: 8}});\n\n    sinon.assert.calledOnce(onTextChangedStub);\n    assert.deepEqual(onTextChangedStub.firstCall.args, ['HelloBye', '', 8, undefined]);\n    plugin.dispose();\n  });\n\n  it('does not trigger code completion when AIDA becomes unavailable', async () => {\n    checkAccessPreconditionsStub.resolves(Host.AidaClient.AidaAccessPreconditions.AVAILABLE);\n    const onTextChangedStub = sinon.stub(AiCodeCompletion.AiCodeCompletion.AiCodeCompletion.prototype, 'onTextChanged');\n    Common.Settings.Settings.instance().settingForTest('ai-code-completion-enabled').set(true);\n    const {editor, plugin} = createEditorWithPlugin('', createUiSourceCodeStub());\n    await clock.tickAsync(0);  // for the initial onAidaAvailabilityChange call\n\n    editor.dispatch({changes: {from: 0, insert: 'Hello'}, selection: {anchor: 5}});\n\n    sinon.assert.calledOnce(onTextChangedStub);\n\n    checkAccessPreconditionsStub.resolves(Host.AidaClient.AidaAccessPreconditions.NO_ACCOUNT_EMAIL);\n    await Host.AidaClient.HostConfigTracker.instance().dispatchEventToListeners(\n        Host.AidaClient.Events.AIDA_AVAILABILITY_CHANGED);\n    await clock.tickAsync(0);\n\n    editor.dispatch({changes: {from: 5, insert: 'Bye'}, selection: {anchor: 8}});\n\n    sinon.assert.calledOnce(onTextChangedStub);\n    assert.deepEqual(onTextChangedStub.firstCall.args, ['Hello', '', 5, undefined]);\n    plugin.dispose();\n  });\n\n  it('should use CONSOLE context flavor for snippets', async () => {\n    checkAccessPreconditionsStub.resolves(Host.AidaClient.AidaAccessPreconditions.AVAILABLE);\n    const aidaClient = sinon.createStubInstance(Host.AidaClient.AidaClient);\n\n    const plugin = new AiCodeCompletionPlugin.AiCodeCompletionPlugin(createUiSourceCodeStub({\n      url: urlString`snippet://`,\n    }));\n    plugin.setAidaClientForTest(aidaClient);\n    const editor = new TextEditor.TextEditor.TextEditor(CodeMirror.EditorState.create({\n      doc: 'console.log(\"',\n      extensions: [\n        plugin.editorExtension(),\n      ],\n    }));\n    plugin.editorInitialized(editor);\n    renderElementIntoDOM(editor);\n\n    Common.Settings.Settings.instance().settingForTest('ai-code-completion-enabled').set(true);\n    await clock.tickAsync(0);\n\n    editor.dispatch({changes: {from: 13, insert: 'a'}, selection: {anchor: 14}});\n    await clock.tickAsync(AiCodeCompletion.AiCodeCompletion.AIDA_REQUEST_DEBOUNCE_TIMEOUT_MS + 1);\n\n    sinon.assert.calledOnce(aidaClient.completeCode);\n    const args = aidaClient.completeCode.lastCall.args[0];\n    assert.lengthOf(args.additional_files!, 1);\n    assert.strictEqual(args.additional_files![0].path, 'devtools-console-context.js');\n    plugin.dispose();\n  });\n\n  it('should use SOURCES context flavor for non-snippets', async () => {\n    checkAccessPreconditionsStub.resolves(Host.AidaClient.AidaAccessPreconditions.AVAILABLE);\n    const aidaClient = sinon.createStubInstance(Host.AidaClient.AidaClient);\n\n    const plugin = new AiCodeCompletionPlugin.AiCodeCompletionPlugin(createUiSourceCodeStub({\n      url: urlString`file://script.js`,\n    }));\n    plugin.setAidaClientForTest(aidaClient);\n    const editor = new TextEditor.TextEditor.TextEditor(CodeMirror.EditorState.create({\n      doc: 'console.log(\"',\n      extensions: [\n        plugin.editorExtension(),\n      ],\n    }));\n    plugin.editorInitialized(editor);\n    renderElementIntoDOM(editor);\n\n    Common.Settings.Settings.instance().settingForTest('ai-code-completion-enabled').set(true);\n    await clock.tickAsync(0);\n\n    editor.dispatch({changes: {from: 13, insert: 'a'}, selection: {anchor: 14}});\n    await clock.tickAsync(AiCodeCompletion.AiCodeCompletion.AIDA_REQUEST_DEBOUNCE_TIMEOUT_MS + 1);\n\n    sinon.assert.calledOnce(aidaClient.completeCode);\n    const args = aidaClient.completeCode.lastCall.args[0];\n    assert.isUndefined(args.additional_files);\n    plugin.dispose();\n  });\n});\n"]}