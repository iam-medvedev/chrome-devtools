{"version":3,"file":"AiCodeCompletionPlugin.test.js","sourceRoot":"","sources":["../../../../../../front_end/panels/sources/AiCodeCompletionPlugin.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../core/common/common.js';\nimport * as Host from '../../core/host/host.js';\nimport * as Platform from '../../core/platform/platform.js';\nimport * as Workspace from '../../models/workspace/workspace.js';\nimport {describeWithEnvironment, updateHostConfig} from '../../testing/EnvironmentHelpers.js';\nimport * as TextEditor from '../../ui/components/text_editor/text_editor.js';\nimport * as SourceFrame from '../../ui/legacy/components/source_frame/source_frame.js';\nimport * as PanelCommon from '../common/common.js';\n\nimport {AiCodeCompletionPlugin} from './sources.js';\n\nconst {urlString} = Platform.DevToolsPath;\n\nfunction createUiSourceCodeStub({\n  url = urlString`file://`,\n  contentType = Common.ResourceType.resourceTypes.Script,\n}: {\n  url?: Platform.DevToolsPath.UrlString,\n  contentType?: Common.ResourceType.ResourceType,\n} = {}): sinon.SinonStubbedInstance<Workspace.UISourceCode.UISourceCode> {\n  return sinon.createStubInstance(Workspace.UISourceCode.UISourceCode, {\n    url,\n    contentType,\n  });\n}\n\ndescribeWithEnvironment('AiCodeCompletionPlugin', () => {\n  describe('accepts', () => {\n    it('holds true for scripts', () => {\n      assert.isTrue(AiCodeCompletionPlugin.AiCodeCompletionPlugin.accepts(createUiSourceCodeStub({\n        contentType: Common.ResourceType.resourceTypes.Script,\n      })));\n    });\n\n    it('holds true for stylesheets', () => {\n      assert.isTrue(AiCodeCompletionPlugin.AiCodeCompletionPlugin.accepts(\n          createUiSourceCodeStub({contentType: Common.ResourceType.resourceTypes.Stylesheet})));\n    });\n\n    it('holds true for documents', () => {\n      assert.isTrue(AiCodeCompletionPlugin.AiCodeCompletionPlugin.accepts(\n          createUiSourceCodeStub({contentType: Common.ResourceType.resourceTypes.Document})));\n    });\n  });\n\n  it('does not create a plugin when the feature is disabled', () => {\n    updateHostConfig({\n      devToolsAiCodeCompletion: {\n        enabled: false,\n      },\n    });\n    const uiSourceCode = createUiSourceCodeStub();\n    assert.throws(\n        () => new AiCodeCompletionPlugin.AiCodeCompletionPlugin(uiSourceCode),\n        'AI code completion feature is not enabled.');\n  });\n\n  describe('provider callbacks', () => {\n    let clock: sinon.SinonFakeTimers;\n    beforeEach(() => {\n      clock = sinon.useFakeTimers();\n      updateHostConfig({\n        devToolsAiCodeCompletion: {\n          enabled: true,\n        },\n        aidaAvailability: {\n          enabled: true,\n          blockedByAge: false,\n          blockedByGeo: false,\n        }\n      });\n      sinon.stub(TextEditor.AiCodeCompletionProvider.AiCodeCompletionProvider, 'createInstance')\n          .returns(sinon.createStubInstance(TextEditor.AiCodeCompletionProvider.AiCodeCompletionProvider));\n      sinon.stub(Host.AidaClient.HostConfigTracker, 'instance').returns({\n        addEventListener: () => {},\n        removeEventListener: () => {},\n        dispose: () => {},\n      } as unknown as Host.AidaClient.HostConfigTracker);\n    });\n\n    afterEach(() => {\n      clock.restore();\n    });\n\n    function setupPlugin() {\n      const uiSourceCode = createUiSourceCodeStub();\n      const plugin = new AiCodeCompletionPlugin.AiCodeCompletionPlugin(uiSourceCode);\n      return plugin;\n    }\n\n    it('initializes toolbar when the feature is enabled', async () => {\n      const plugin = setupPlugin();\n      await clock.tickAsync(0);\n      const providerConfig = plugin.aiCodeCompletionConfig;\n\n      providerConfig.onFeatureEnabled();\n\n      const toolbarItems = plugin.rightToolbarItems();\n      assert.lengthOf(toolbarItems, 1);\n      assert.isTrue(toolbarItems[0].element.classList.contains('ai-code-completion-disclaimer-container'));\n      assert.deepEqual(toolbarItems[0].element.childElementCount, 1);\n    });\n\n    it('cleans up toolbar when the feature is disabled', async () => {\n      const plugin = setupPlugin();\n      await clock.tickAsync(0);\n      const providerConfig = plugin.aiCodeCompletionConfig;\n      providerConfig.onFeatureEnabled();\n      let toolbarItems = plugin.rightToolbarItems();\n      assert.deepEqual(toolbarItems[0].element.childElementCount, 1);\n\n      providerConfig.onFeatureDisabled();\n\n      toolbarItems = plugin.rightToolbarItems();\n      assert.deepEqual(toolbarItems[0].element.childElementCount, 0);\n    });\n\n    it('shows a loading state when a request is triggered', async () => {\n      const fakeLoadingSetter = sinon.fake();\n      sinon.stub(PanelCommon.AiCodeCompletionDisclaimer.prototype, 'loading').set(fakeLoadingSetter);\n      const plugin = setupPlugin();\n      await clock.tickAsync(0);\n      const providerConfig = plugin.aiCodeCompletionConfig;\n      providerConfig.onFeatureEnabled();\n\n      providerConfig.onRequestTriggered();\n\n      sinon.assert.calledOnce(fakeLoadingSetter);\n      assert.isTrue(fakeLoadingSetter.firstCall.args[0]);\n    });\n\n    it('hides the loading indicator when a response is received', async () => {\n      const fakeLoadingSetter = sinon.fake();\n      sinon.stub(PanelCommon.AiCodeCompletionDisclaimer.prototype, 'loading').set(fakeLoadingSetter);\n      const plugin = setupPlugin();\n      await clock.tickAsync(0);\n      const providerConfig = plugin.aiCodeCompletionConfig;\n      providerConfig.onFeatureEnabled();\n      providerConfig.onRequestTriggered();\n      sinon.assert.calledOnce(fakeLoadingSetter);\n      assert.isTrue(fakeLoadingSetter.firstCall.args[0]);\n\n      providerConfig.onResponseReceived();\n\n      sinon.assert.calledTwice(fakeLoadingSetter);\n      assert.isFalse(fakeLoadingSetter.secondCall.args[0]);\n    });\n\n    it('attaches the citations toolbar when a suggestion with citations is accepted', async () => {\n      const updateCitationsSpy = sinon.spy(PanelCommon.AiCodeCompletionSummaryToolbar.prototype, 'updateCitations');\n      const plugin = setupPlugin();\n      await clock.tickAsync(0);\n      const providerConfig = plugin.aiCodeCompletionConfig;\n      const editor = new TextEditor.TextEditor.TextEditor();\n      const editorDispatchSpy = sinon.spy(editor, 'dispatch');\n\n      plugin.editorInitialized(editor);\n      providerConfig.onFeatureEnabled();\n      providerConfig.onResponseReceived();\n\n      providerConfig.onSuggestionAccepted([{uri: 'https://example.com/source'}]);\n\n      sinon.assert.calledOnce(updateCitationsSpy);\n      assert.deepEqual(updateCitationsSpy.firstCall.args, [['https://example.com/source']]);\n      sinon.assert.calledWith(editorDispatchSpy, {\n        effects: sinon.match(effect => effect.is(SourceFrame.SourceFrame.addSourceFrameInfobar)),\n      });\n    });\n\n    it('does not attach the citations toolbar if there are no citations', async () => {\n      const updateCitationsSpy = sinon.spy(PanelCommon.AiCodeCompletionSummaryToolbar.prototype, 'updateCitations');\n      const plugin = setupPlugin();\n      await clock.tickAsync(0);\n      const providerConfig = plugin.aiCodeCompletionConfig;\n      const editor = new TextEditor.TextEditor.TextEditor();\n      const editorDispatchSpy = sinon.spy(editor, 'dispatch');\n\n      plugin.editorInitialized(editor);\n      providerConfig.onFeatureEnabled();\n      providerConfig.onResponseReceived();\n\n      providerConfig.onSuggestionAccepted([]);\n\n      sinon.assert.notCalled(updateCitationsSpy);\n      sinon.assert.notCalled(editorDispatchSpy);\n    });\n  });\n});\n"]}