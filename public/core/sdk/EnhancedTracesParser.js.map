{"version":3,"file":"EnhancedTracesParser.js","sourceRoot":"","sources":["../../../../../../front_end/core/sdk/EnhancedTracesParser.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport type * as Protocol from '../../generated/protocol.js';\nimport * as Common from '../common/common.js';\nimport type * as Platform from '../platform/platform.js';\nimport {UserVisibleError} from '../platform/platform.js';\n\nimport type {\n  HydratingDataPerTarget, RehydratingExecutionContext, RehydratingScript, RehydratingTarget, TraceFile} from\n  './RehydratingObject.js';\nimport type {SourceMapV3} from './SourceMap.js';\n\ninterface RehydratingTraceBase {\n  cat: string;\n  pid: number;\n  args: {data: object};\n}\n\ninterface TraceEventTargetRundown extends RehydratingTraceBase {\n  cat: 'disabled-by-default-devtools.target-rundown';\n  args: {\n    data: {\n      frame: Protocol.Page.FrameId,\n      frameType: string,\n      url: string,\n      isolate: string,\n      v8context: string,\n      origin: string,\n      scriptId: Protocol.Runtime.ScriptId,\n      isDefault?: boolean,\n      contextType?: string,\n    },\n  };\n}\n\ninterface TraceEventScriptRundown extends RehydratingTraceBase {\n  cat: 'disabled-by-default-devtools.v8-source-rundown';\n  args: {\n    data: {\n      isolate: string,\n      executionContextId: Protocol.Runtime.ExecutionContextId,\n      scriptId: Protocol.Runtime.ScriptId,\n      startLine: number,\n      startColumn: number,\n      endLine: number,\n      endColumn: number,\n      url: string,\n      hash: string,\n      isModule: boolean,\n      hasSourceUrl: boolean,\n      sourceUrl?: string,\n      sourceMapUrl?: string,\n    },\n  };\n}\n\ninterface TraceEventScriptRundownSource extends RehydratingTraceBase {\n  cat: 'disabled-by-default-devtools.v8-source-rundown-sources';\n  args: {\n    data: {\n      isolate: string,\n      scriptId: Protocol.Runtime.ScriptId,\n      length?: number,\n      sourceText?: string,\n    },\n  };\n}\n\nexport class EnhancedTracesParser {\n  #trace: TraceFile;\n  #scriptRundownEvents: TraceEventScriptRundown[] = [];\n  #scriptToV8Context: Map<string, string> = new Map<string, string>();\n  #scriptToFrame: Map<string, string> = new Map<string, string>();\n  #scriptToScriptSource: Map<string, string> = new Map<string, string>();\n  #largeScriptToScriptSource: Map<string, string[]> = new Map<string, string[]>();\n  #scriptToSourceLength: Map<string, number> = new Map<string, number>();\n  #targets: RehydratingTarget[] = [];\n  #executionContexts: RehydratingExecutionContext[] = [];\n  #scripts: RehydratingScript[] = [];\n  static readonly enhancedTraceVersion: number = 1;\n\n  constructor(trace: TraceFile) {\n    this.#trace = trace;\n\n    // Initialize with the trace provided.\n    try {\n      this.parseEnhancedTrace();\n    } catch (e) {\n      throw new UserVisibleError.UserVisibleError(e);\n    }\n  }\n\n  parseEnhancedTrace(): void {\n    for (const event of this.#trace.traceEvents) {\n      if (this.isTargetRundownEvent(event)) {\n        // Set up script to v8 context mapping\n        const data = event.args?.data;\n        this.#scriptToV8Context.set(this.getScriptIsolateId(data.isolate, data.scriptId), data.v8context);\n        this.#scriptToFrame.set(this.getScriptIsolateId(data.isolate, data.scriptId), data.frame);\n        // Add target\n        if (!this.#targets.find(target => target.targetId === data.frame)) {\n          this.#targets.push({\n            targetId: data.frame,\n            type: data.frameType,\n            isolate: data.isolate,\n            pid: event.pid,\n            url: data.url,\n          });\n        }\n        // Add execution context, need to put back execution context id with info from other traces\n        if (!this.#executionContexts.find(executionContext => executionContext.v8Context === data.v8context)) {\n          this.#executionContexts.push({\n            id: -1 as Protocol.Runtime.ExecutionContextId,\n            origin: data.origin,\n            v8Context: data.v8context,\n            auxData: {\n              frameId: data.frame,\n              isDefault: data.isDefault,\n              type: data.contextType,\n            },\n            isolate: data.isolate,\n          });\n        }\n      } else if (this.isScriptRundownEvent(event)) {\n        this.#scriptRundownEvents.push(event);\n        const data = event.args.data;\n        // Add script\n        if (!this.#scripts.find(script => script.scriptId === data.scriptId && script.isolate === data.isolate)) {\n          this.#scripts.push({\n            scriptId: data.scriptId,\n            isolate: data.isolate,\n            executionContextId: data.executionContextId,\n            startLine: data.startLine,\n            startColumn: data.startColumn,\n            endLine: data.endLine,\n            endColumn: data.endColumn,\n            hash: data.hash,\n            isModule: data.isModule,\n            url: data.url,\n            hasSourceURL: data.hasSourceUrl,\n            sourceURL: data.sourceUrl,\n            sourceMapURL: data.sourceMapUrl,\n          });\n        }\n      } else if (this.isScriptRundownSourceEvent(event)) {\n        // Set up script to source text and length mapping\n        const data = event.args.data;\n        const scriptIsolateId = this.getScriptIsolateId(data.isolate, data.scriptId);\n        if ('splitIndex' in data && 'splitCount' in data) {\n          if (!this.#largeScriptToScriptSource.has(scriptIsolateId)) {\n            this.#largeScriptToScriptSource.set(scriptIsolateId, new Array(data.splitCount).fill('') as string[]);\n          }\n          const splittedSource = this.#largeScriptToScriptSource.get(scriptIsolateId);\n          if (splittedSource && data.sourceText) {\n            splittedSource[data.splitIndex as number] = data.sourceText;\n          }\n        } else {\n          if (data.sourceText) {\n            this.#scriptToScriptSource.set(scriptIsolateId, data.sourceText);\n          }\n          if (data.length) {\n            this.#scriptToSourceLength.set(scriptIsolateId, data.length);\n          }\n        }\n      }\n    }\n  }\n\n  data(): HydratingDataPerTarget {\n    // Put back execution context id\n    const v8ContextToExecutionContextId: Map<string, Protocol.Runtime.ExecutionContextId> =\n        new Map<string, Protocol.Runtime.ExecutionContextId>();\n    this.#scriptRundownEvents.forEach(scriptRundownEvent => {\n      const data = scriptRundownEvent.args.data;\n      const v8Context = this.#scriptToV8Context.get(this.getScriptIsolateId(data.isolate, data.scriptId));\n      if (v8Context) {\n        v8ContextToExecutionContextId.set(v8Context, data.executionContextId);\n      }\n    });\n    this.#executionContexts.forEach(executionContext => {\n      if (executionContext.v8Context) {\n        const id = v8ContextToExecutionContextId.get(executionContext.v8Context);\n        if (id) {\n          executionContext.id = id;\n        }\n      }\n    });\n\n    // Put back script source text and length\n    this.#scripts.forEach(script => {\n      const scriptIsolateId = this.getScriptIsolateId(script.isolate, script.scriptId);\n      if (this.#scriptToScriptSource.has(scriptIsolateId)) {\n        script.sourceText = this.#scriptToScriptSource.get(scriptIsolateId);\n        script.length = this.#scriptToSourceLength.get(scriptIsolateId);\n      } else if (this.#largeScriptToScriptSource.has(scriptIsolateId)) {\n        const splittedSources = this.#largeScriptToScriptSource.get(scriptIsolateId);\n        if (splittedSources) {\n          script.sourceText = splittedSources.join('');\n          script.length = script.sourceText.length;\n        }\n      }\n      // put in the aux data\n      script.auxData =\n          this.#executionContexts\n              .find(context => context.id === script.executionContextId && context.isolate === script.isolate)\n              ?.auxData;\n    });\n\n    for (const script of this.#scripts) {\n      // Resolve the source map from the provided metadata.\n      // If no map is found for a given source map url, no source map is passed to the debugger model.\n      // Encoded as a data url so that the debugger model makes no network request.\n      // NOTE: consider passing directly as object and hacking `parsedScriptSource` in DebuggerModel.ts to handle\n      // this fake event. Would avoid a lot of wasteful (de)serialization. Maybe add SDK.Script.hydratedSourceMap.\n      script.sourceMapURL = this.getEncodedSourceMapUrl(script);\n    }\n\n    const data = new Map<RehydratingTarget, [RehydratingExecutionContext[], RehydratingScript[]]>();\n    for (const target of this.#targets) {\n      data.set(target, this.groupContextsAndScriptsUnderTarget(target, this.#executionContexts, this.#scripts));\n    }\n    return data;\n  }\n\n  private getEncodedSourceMapUrl(script: RehydratingScript): string|undefined {\n    if (script.sourceMapURL?.startsWith('data:')) {\n      return script.sourceMapURL;\n    }\n\n    const sourceMap = this.getSourceMapFromMetadata(script);\n    if (!sourceMap) {\n      return;\n    }\n\n    return `data:text/plain;base64,${btoa(JSON.stringify(sourceMap))}`;\n  }\n\n  private getSourceMapFromMetadata(script: RehydratingScript): SourceMapV3|undefined {\n    const {hasSourceURL, sourceURL, url, sourceMapURL, isolate, scriptId} = script;\n\n    if (!sourceMapURL || !this.#trace.metadata.sourceMaps) {\n      return;\n    }\n\n    const frame = this.#scriptToFrame.get(this.getScriptIsolateId(isolate, scriptId));\n    if (!frame) {\n      return;\n    }\n\n    const target = this.#targets.find(t => t.targetId === frame);\n    if (!target) {\n      return;\n    }\n\n    let resolvedSourceUrl = url;\n    if (hasSourceURL && sourceURL) {\n      const targetUrl = target.url as Platform.DevToolsPath.UrlString;\n      resolvedSourceUrl = Common.ParsedURL.ParsedURL.completeURL(targetUrl, sourceURL) ?? sourceURL;\n    }\n\n    // Resolve the source map url. The value given by v8 may be relative, so resolve it here.\n    // This process should match the one in `SourceMapManager.attachSourceMap`.\n    const resolvedSourceMapUrl =\n        Common.ParsedURL.ParsedURL.completeURL(resolvedSourceUrl as Platform.DevToolsPath.UrlString, sourceMapURL);\n    if (!resolvedSourceMapUrl) {\n      return;\n    }\n\n    const {sourceMap} = this.#trace.metadata.sourceMaps.find(m => m.sourceMapUrl === resolvedSourceMapUrl) ?? {};\n    return sourceMap;\n  }\n\n  private getScriptIsolateId(isolate: string, scriptId: Protocol.Runtime.ScriptId): string {\n    return scriptId + '@' + isolate;\n  }\n\n  private isTraceEvent(event: unknown): event is RehydratingTraceBase {\n    return 'cat' in (event as RehydratingTraceBase) && 'pid' in (event as RehydratingTraceBase) &&\n        'args' in (event as RehydratingTraceBase) && 'data' in (event as RehydratingTraceBase).args;\n  }\n\n  private isTargetRundownEvent(event: unknown): event is TraceEventTargetRundown {\n    return this.isTraceEvent(event) && event.cat === 'disabled-by-default-devtools.target-rundown';\n  }\n\n  private isScriptRundownEvent(event: unknown): event is TraceEventScriptRundown {\n    return this.isTraceEvent(event) && event.cat === 'disabled-by-default-devtools.v8-source-rundown';\n  }\n\n  private isScriptRundownSourceEvent(event: unknown): event is TraceEventScriptRundownSource {\n    return this.isTraceEvent(event) && event.cat === 'disabled-by-default-devtools.v8-source-rundown-sources';\n  }\n\n  private groupContextsAndScriptsUnderTarget(\n      target: RehydratingTarget, executionContexts: RehydratingExecutionContext[],\n      scripts: RehydratingScript[]): [RehydratingExecutionContext[], RehydratingScript[]] {\n    const filteredExecutionContexts: RehydratingExecutionContext[] = [];\n    const filteredScripts: RehydratingScript[] = [];\n    for (const executionContext of executionContexts) {\n      if (executionContext.auxData?.frameId === target.targetId) {\n        filteredExecutionContexts.push(executionContext);\n      }\n    }\n    for (const script of scripts) {\n      if (script.auxData === null) {\n        console.error(script + ' missing aux data');\n      }\n      if (script.auxData?.frameId === target.targetId) {\n        filteredScripts.push(script);\n      }\n    }\n    return [filteredExecutionContexts, filteredScripts];\n  }\n}\n"]}