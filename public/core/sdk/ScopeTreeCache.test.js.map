{"version":3,"file":"ScopeTreeCache.test.js","sourceRoot":"","sources":["../../../../../../front_end/core/sdk/ScopeTreeCache.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2023 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Formatter from '../../models/formatter/formatter.js';\nimport * as TextUtils from '../../models/text_utils/text_utils.js';\n\nimport * as SDK from './sdk.js';\n\ndescribe('ScopeTreeCache', () => {\n  describe('scopeTreeForScript', () => {\n    const {scopeTreeForScript} = SDK.ScopeTreeCache;\n    let javaScriptScopeTreeStub: sinon.SinonStub;\n    let script: SDK.Script.Script;\n\n    beforeEach(() => {\n      javaScriptScopeTreeStub = sinon.stub(Formatter.FormatterWorkerPool.formatterWorkerPool(), 'javaScriptScopeTree');\n      script = sinon.createStubInstance(\n          SDK.Script.Script,\n          {requestContentData: Promise.resolve(new TextUtils.ContentData.ContentData('', false, 'text/javascript'))});\n    });\n\n    it('requests the scope tree once for a script', async () => {\n      const scopeTree =\n          {start: 0, end: 20, kind: Formatter.FormatterWorkerPool.ScopeKind.GLOBAL, variables: [], children: []};\n      javaScriptScopeTreeStub.returns(Promise.resolve(scopeTree));\n\n      const actualScopeTree1 = await scopeTreeForScript(script);\n      const actualScopeTree2 = await scopeTreeForScript(script);\n\n      sinon.assert.calledOnce(javaScriptScopeTreeStub);\n      assert.strictEqual(actualScopeTree1?.scopeTree, scopeTree);\n      assert.strictEqual(actualScopeTree2?.scopeTree, scopeTree);\n    });\n\n    it('requests the scope tree once for a script that fails to parse', async () => {\n      javaScriptScopeTreeStub.returns(Promise.reject('some error'));\n\n      const actualScopeTree1 = await scopeTreeForScript(script);\n      const actualScopeTree2 = await scopeTreeForScript(script);\n\n      sinon.assert.calledOnce(javaScriptScopeTreeStub);\n      assert.isNull(actualScopeTree1);\n      assert.isNull(actualScopeTree2);\n    });\n\n    it('requests the scope tree once for a script, even if the first request is not done yet', async () => {\n      const scopeTree =\n          {start: 0, end: 20, kind: Formatter.FormatterWorkerPool.ScopeKind.GLOBAL, variables: [], children: []};\n      const {promise: scopeTreePromise, resolve: scopeTreeResolve} =\n          Promise.withResolvers<Formatter.FormatterWorkerPool.ScopeTreeNode|null>();\n      javaScriptScopeTreeStub.returns(scopeTreePromise);\n\n      const scopeTreePromise1 = scopeTreeForScript(script);\n      const scopeTreePromise2 = scopeTreeForScript(script);\n\n      scopeTreeResolve(scopeTree);\n      const [actualScopeTree1, actualScopeTree2] = await Promise.all([scopeTreePromise1, scopeTreePromise2]);\n\n      sinon.assert.calledOnce(javaScriptScopeTreeStub);\n      assert.strictEqual(actualScopeTree1?.scopeTree, scopeTree);\n      assert.strictEqual(actualScopeTree2?.scopeTree, scopeTree);\n    });\n  });\n});\n"]}