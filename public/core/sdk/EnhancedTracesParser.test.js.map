{"version":3,"file":"EnhancedTracesParser.test.js","sourceRoot":"","sources":["../../../../../../front_end/core/sdk/EnhancedTracesParser.test.ts"],"names":[],"mappings":"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","sourcesContent":["\n// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\nimport type * as Protocol from '../../generated/protocol.js';\nimport {TraceLoader} from '../../testing/TraceLoader.js';\n\nimport * as EnhancedTraces from './EnhancedTracesParser.js';\nimport type {RehydratingExecutionContext, RehydratingScript, RehydratingTarget} from './RehydratingObject.js';\n\ndescribe('EnhancedTracesParser', () => {\n  let enhancedTracesParser: EnhancedTraces.EnhancedTracesParser;\n  const target1: RehydratingTarget = {\n    targetId: '21D58E83A5C17916277166140F6A464B' as Protocol.Page.FrameId,\n    type: 'page',\n    isolate: '12345',\n    pid: 8050,\n    url: 'http://localhost:8080/index.html',\n  };\n  const target2: RehydratingTarget = {\n    targetId: '3E1717BE677B75D0536E292E00D6A34A' as Protocol.Page.FrameId,\n    type: 'page',\n    isolate: '6789',\n    pid: 8051,\n    url: 'http://localhost:8080/index.html',\n  };\n\n  const executionContext1: RehydratingExecutionContext = {\n    id: 1 as Protocol.Runtime.ExecutionContextId,\n    origin: 'http://localhost:8080',\n    v8Context: 'example context 1',\n    auxData: {\n      frameId: '21D58E83A5C17916277166140F6A464B' as Protocol.Page.FrameId,\n      isDefault: true,\n      type: 'type',\n    },\n    isolate: '12345',\n  };\n\n  const executionContext2: RehydratingExecutionContext = {\n    id: 2 as Protocol.Runtime.ExecutionContextId,\n    origin: 'http://localhost:8080',\n    v8Context: 'example context 2',\n    auxData: {\n      frameId: '21D58E83A5C17916277166140F6A464B' as Protocol.Page.FrameId,\n      isDefault: true,\n      type: 'type',\n    },\n    isolate: '12345',\n  };\n\n  const executionContext3: RehydratingExecutionContext = {\n    id: 1 as Protocol.Runtime.ExecutionContextId,\n    origin: 'http://localhost:8080',\n    v8Context: 'example context 3',\n    auxData: {\n      frameId: '3E1717BE677B75D0536E292E00D6A34A' as Protocol.Page.FrameId,\n      isDefault: true,\n      type: 'type',\n    },\n    isolate: '6789',\n  };\n\n  const script1: RehydratingScript = {\n    scriptId: '1' as Protocol.Runtime.ScriptId,\n    isolate: '12345',\n    executionContextId: 1 as Protocol.Runtime.ExecutionContextId,\n    startLine: 0,\n    startColumn: 0,\n    endLine: 1,\n    endColumn: 10,\n    hash: '',\n    isModule: false,\n    url: 'http://localhost:8080/index.html',\n    hasSourceURL: false,\n    sourceURL: undefined,\n    sourceMapURL: 'http://localhost:8080/source.map.json',\n    length: 13,\n    sourceText: 'source text 1',\n    auxData: {\n      frameId: '21D58E83A5C17916277166140F6A464B' as Protocol.Page.FrameId,\n      isDefault: true,\n      type: 'type',\n    },\n  };\n\n  const script2: RehydratingScript = {\n    scriptId: '2' as Protocol.Runtime.ScriptId,\n    isolate: '12345',\n    executionContextId: 2 as Protocol.Runtime.ExecutionContextId,\n    startLine: 0,\n    startColumn: 0,\n    endLine: 1,\n    endColumn: 10,\n    hash: '',\n    isModule: false,\n    url: 'http://localhost:8080/index.html',\n    hasSourceURL: false,\n    sourceURL: undefined,\n    sourceMapURL: undefined,\n    length: 13,\n    sourceText: 'source text 2',\n    auxData: {\n      frameId: '21D58E83A5C17916277166140F6A464B' as Protocol.Page.FrameId,\n      isDefault: true,\n      type: 'type',\n    },\n  };\n\n  const script3: RehydratingScript = {\n    scriptId: '1' as Protocol.Runtime.ScriptId,\n    isolate: '6789',\n    executionContextId: 1 as Protocol.Runtime.ExecutionContextId,\n    startLine: 0,\n    startColumn: 0,\n    endLine: 1,\n    endColumn: 10,\n    hash: '',\n    isModule: false,\n    url: 'http://localhost:8080/index.html',\n    hasSourceURL: false,\n    sourceURL: undefined,\n    sourceMapURL: undefined,\n    length: 13,\n    sourceText: 'source text 3',\n    auxData: {\n      frameId: '3E1717BE677B75D0536E292E00D6A34A' as Protocol.Page.FrameId,\n      isDefault: true,\n      type: 'type',\n    },\n  };\n\n  beforeEach(async function() {\n    const events = await TraceLoader.rawEvents(this, 'enhanced-traces.json.gz');\n    enhancedTracesParser = new EnhancedTraces.EnhancedTracesParser({traceEvents: events as object[], metadata: {}});\n  });\n\n  it('captures targets from target rundown events', async function() {\n    const data = enhancedTracesParser.data();\n    const targets: RehydratingTarget[] = [];\n    for (const target of data.keys()) {\n      targets.push(target);\n      if (target.pid === 8050) {\n        assert.deepEqual(target, target1);\n      } else if (target.pid === 8051) {\n        assert.deepEqual(target, target2);\n      }\n    }\n    assert.lengthOf(targets, 2);\n  });\n\n  it('captures execution context info', async function() {\n    const data = enhancedTracesParser.data();\n    let executionContexts: RehydratingExecutionContext[] = [];\n    for (const target of data.keys()) {\n      const contextsAndScripts = data.get(target);\n      if (contextsAndScripts) {\n        executionContexts = [...executionContexts, ...contextsAndScripts[0]];\n      } else {\n        assert.fail('Contexts and Scripts should not be null or undefined');\n      }\n    }\n    assert.lengthOf(executionContexts, 3);\n    for (const executionContext of executionContexts) {\n      if (executionContext.id === 1 && executionContext.isolate === '12345') {\n        assert.deepEqual(executionContext, executionContext1);\n      } else if (executionContext.id === 2 && executionContext.isolate === '12345') {\n        assert.deepEqual(executionContext, executionContext2);\n      } else if (executionContext.id === 1 && executionContext.isolate === '6789') {\n        assert.deepEqual(executionContext, executionContext3);\n      }\n    }\n  });\n\n  it('captures script info and source text', async function() {\n    const data = enhancedTracesParser.data();\n    let scripts: RehydratingScript[] = [];\n    for (const target of data.keys()) {\n      const contextsAndScripts = data.get(target);\n      if (contextsAndScripts) {\n        scripts = [...scripts, ...contextsAndScripts[1]];\n      } else {\n        assert.fail('Contexts and Scripts should not be null or undefined');\n      }\n    }\n    assert.lengthOf(scripts, 3);\n    for (const script of scripts) {\n      if (script.scriptId === '1' && script.isolate === '12345') {\n        assert.deepEqual(script, {...script1, sourceMapURL: undefined});\n      } else if (script.scriptId === '2' && script.isolate === '12345') {\n        assert.deepEqual(script, script2);\n      } else if (script.scriptId === '1' && script.isolate === '6789') {\n        assert.deepEqual(script, script3);\n      }\n    }\n  });\n\n  it('grouped contexts and scripts under the right target', async function() {\n    const data = enhancedTracesParser.data();\n    for (const target of data.keys()) {\n      const contextsAndScripts = data.get(target);\n      if (contextsAndScripts) {\n        const executionContexts = contextsAndScripts[0];\n        const scripts = contextsAndScripts[1];\n        if (target.pid === 8050) {\n          assert.lengthOf(executionContexts, 2);\n          for (const executionContext of executionContexts) {\n            // We should be able to get the correct execution context without specifying isolate\n            // as the contexts and scripts are grouped under its repsective target already.\n            if (executionContext.id === 1) {\n              assert.deepEqual(executionContext, executionContext1);\n            } else if (executionContext.id === 2) {\n              assert.deepEqual(executionContext, executionContext2);\n            }\n          }\n          assert.lengthOf(scripts, 2);\n          for (const script of scripts) {\n            if (script.scriptId === '1') {\n              assert.deepEqual(script, {...script1, sourceMapURL: undefined});\n            } else if (script.scriptId === '2') {\n              assert.deepEqual(script, script2);\n            }\n          }\n        } else if (target.pid === 8051) {\n          assert.lengthOf(executionContexts, 1);\n          assert.lengthOf(scripts, 1);\n          assert.deepEqual(executionContexts[0], executionContext3);\n          assert.deepEqual(scripts[0], script3);\n        }\n      } else {\n        assert.fail('Contexts and Scripts should not be null or undefined');\n      }\n    }\n  });\n});\n"]}