{"version":3,"file":"DispatchHttpRequestClient.test.js","sourceRoot":"","sources":["../../../../../../front_end/core/host/DispatchHttpRequestClient.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport {\n  describeWithEnvironment,\n} from '../../testing/EnvironmentHelpers.js';\n\nimport * as Host from './host.js';\n\ndescribeWithEnvironment('DispatchHttpRequestClient', () => {\n  const defaultRequest: Host.InspectorFrontendHostAPI.DispatchHttpRequestRequest = {\n    service: 'testService',\n    path: '/test',\n    method: 'POST',\n    body: JSON.stringify({foo: 'bar'}),\n  };\n\n  it('handles successful requests', async () => {\n    sinon.stub(Host.InspectorFrontendHost.InspectorFrontendHostInstance, 'dispatchHttpRequest')\n        .callsFake(async (_, callback) => {\n          callback({statusCode: 200, response: JSON.stringify({result: 'ok'})});\n        });\n\n    const result = await Host.DispatchHttpRequestClient.makeHttpRequest(defaultRequest);\n\n    assert.deepEqual(result, {result: 'ok'});\n  });\n\n  it('handles 404 errors', async () => {\n    sinon.stub(Host.InspectorFrontendHost.InspectorFrontendHostInstance, 'dispatchHttpRequest')\n        .callsFake(async (_, callback) => {\n          callback({error: 'Error', statusCode: 404});\n        });\n\n    try {\n      await Host.DispatchHttpRequestClient.makeHttpRequest(defaultRequest);\n      expect.fail('makeHttpRequest did not throw');\n    } catch (err) {\n      assert.instanceOf(err, Host.DispatchHttpRequestClient.DispatchHttpRequestError);\n      assert.strictEqual(err.type, Host.DispatchHttpRequestClient.ErrorType.NOT_FOUND);\n    }\n  });\n\n  it('handles other HTTP errors', async () => {\n    sinon.stub(Host.InspectorFrontendHost.InspectorFrontendHostInstance, 'dispatchHttpRequest')\n        .callsFake(async (_, callback) => {\n          callback({error: 'Error', statusCode: 500});\n        });\n\n    try {\n      await Host.DispatchHttpRequestClient.makeHttpRequest(defaultRequest);\n      expect.fail('makeHttpRequest did not throw');\n    } catch (err) {\n      assert.instanceOf(err, Host.DispatchHttpRequestClient.DispatchHttpRequestError);\n      assert.strictEqual(err.type, Host.DispatchHttpRequestClient.ErrorType.HTTP_RESPONSE_UNAVAILABLE);\n    }\n  });\n\n  it('handles invalid JSON response', async () => {\n    sinon.stub(Host.InspectorFrontendHost.InspectorFrontendHostInstance, 'dispatchHttpRequest')\n        .callsFake(async (_, callback) => {\n          callback({statusCode: 200, response: 'invalid json'});\n        });\n\n    try {\n      await Host.DispatchHttpRequestClient.makeHttpRequest(defaultRequest);\n      expect.fail('makeHttpRequest did not throw');\n    } catch (err) {\n      assert.instanceOf(err, Host.DispatchHttpRequestClient.DispatchHttpRequestError);\n      assert.strictEqual(err.type, Host.DispatchHttpRequestClient.ErrorType.HTTP_RESPONSE_UNAVAILABLE);\n    }\n  });\n\n  it('aborts the request when the signal is aborted before request execution', async () => {\n    const promiseWithResolvers = Promise.withResolvers<void>();\n    sinon.stub(Host.InspectorFrontendHost.InspectorFrontendHostInstance, 'dispatchHttpRequest')\n        .callsFake(async (_, callback) => {\n          await promiseWithResolvers.promise;\n          callback({statusCode: 200, response: JSON.stringify({result: 'ok'})});\n        });\n\n    const controller = new AbortController();\n    controller.abort();\n    const result = Host.DispatchHttpRequestClient.makeHttpRequest(\n        defaultRequest,\n        {signal: controller.signal},\n    );\n    try {\n      await result;\n      expect.fail('makeHttpRequest did not throw');\n    } catch (err) {\n      assert.instanceOf(err, Host.DispatchHttpRequestClient.DispatchHttpRequestError);\n      assert.strictEqual(err.type, Host.DispatchHttpRequestClient.ErrorType.ABORT);\n    } finally {\n      promiseWithResolvers.resolve();\n    }\n  });\n\n  it('aborts the request when the signal is aborted during request execution', async () => {\n    const promiseWithResolvers = Promise.withResolvers<void>();\n    sinon.stub(Host.InspectorFrontendHost.InspectorFrontendHostInstance, 'dispatchHttpRequest')\n        .callsFake(async (_, callback) => {\n          await promiseWithResolvers.promise;\n          callback({statusCode: 200, response: JSON.stringify({result: 'ok'})});\n        });\n\n    const controller = new AbortController();\n    const result = Host.DispatchHttpRequestClient.makeHttpRequest(\n        defaultRequest,\n        {signal: controller.signal},\n    );\n    controller.abort();\n    try {\n      await result;\n      expect.fail('makeHttpRequest did not throw');\n    } catch (err) {\n      assert.instanceOf(err, Host.DispatchHttpRequestClient.DispatchHttpRequestError);\n      assert.strictEqual(err.type, Host.DispatchHttpRequestClient.ErrorType.ABORT);\n    } finally {\n      promiseWithResolvers.resolve();\n    }\n  });\n});\n"]}