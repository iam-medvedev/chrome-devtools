{"version":3,"file":"AnnotationsManager.js","sourceRoot":"","sources":["../../../../../../front_end/services/annotations_manager/AnnotationsManager.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2023 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as TraceEngine from '../../models/trace/trace.js';\nimport * as TimelineComponents from '../../panels/timeline/components/components.js';\n\nlet instance: AnnotationsManager|null = null;\ntype EntryToNodeMap =\n    Map<TraceEngine.Types.TraceEvents.SyntheticTraceEntry, TraceEngine.Helpers.TreeHelpers.TraceEntryNode>;\n\nexport class AnnotationsManager {\n  /**\n   * An Array with all trace entries.\n   * We save annotations into the trace file by saving their id in the allEntries Array.\n   **/\n  #allEntries: TraceEngine.Types.TraceEvents.SyntheticTraceEntry[];\n  #entriesFilter: TraceEngine.EntriesFilter.EntriesFilter;\n  #timelineBreadcrumbs: TimelineComponents.Breadcrumbs.Breadcrumbs;\n\n  /**\n   * A new instance is create each time a trace is recorded or loaded from a file.\n   * Both entryToNodeMap and wholeTraceBounds are mandatory to support all annotations and if one of them\n   * is not present, something has gone wrong so let's load the trace without the annotations support.\n   **/\n  static maybeInstance(opts: {\n    entryToNodeMap: EntryToNodeMap|null,\n    wholeTraceBounds: TraceEngine.Types.Timing.TraceWindowMicroSeconds|null|undefined,\n  } = {entryToNodeMap: null, wholeTraceBounds: null}): AnnotationsManager|null {\n    if (opts.entryToNodeMap && opts.wholeTraceBounds) {\n      instance = new AnnotationsManager(opts.entryToNodeMap, opts.wholeTraceBounds);\n    }\n    return instance;\n  }\n\n  static removeInstance(): void {\n    instance = null;\n  }\n\n  private constructor(\n      entryToNodeMap: EntryToNodeMap, wholeTraceBounds: TraceEngine.Types.Timing.TraceWindowMicroSeconds) {\n    this.#entriesFilter = new TraceEngine.EntriesFilter.EntriesFilter(entryToNodeMap);\n    this.#timelineBreadcrumbs = new TimelineComponents.Breadcrumbs.Breadcrumbs(wholeTraceBounds);\n    this.#allEntries = Array.from(entryToNodeMap.keys());\n  }\n\n  getEntriesFilter(): TraceEngine.EntriesFilter.EntriesFilter {\n    return this.#entriesFilter;\n  }\n\n  getTimelineBreadcrumbs(): TimelineComponents.Breadcrumbs.Breadcrumbs {\n    return this.#timelineBreadcrumbs;\n  }\n\n  getEntryIndex(entry: TraceEngine.Types.TraceEvents.SyntheticTraceEntry): number {\n    return this.#allEntries.indexOf(entry);\n  }\n\n  /**\n   * Builds all annotations and returns the object written into the 'annotations' trace file metada field.\n   */\n  getAnnotations(): TraceEngine.Types.File.Annotations {\n    const indexesOfSynteticEntries: number[] = [];\n    const hiddenEntries = this.#entriesFilter.invisibleEntries();\n    if (hiddenEntries) {\n      for (const entry of hiddenEntries) {\n        indexesOfSynteticEntries.push(this.getEntryIndex(entry));\n      }\n    }\n\n    const indexesOfModifiedEntries: number[] = [];\n    const modifiedEntries = this.#entriesFilter.modifiedEntries();\n    if (modifiedEntries) {\n      for (const entry of modifiedEntries) {\n        indexesOfModifiedEntries.push(this.getEntryIndex(entry));\n      }\n    }\n\n    return {\n      entriesFilterAnnotations: {\n        hiddenEntriesIndexes: indexesOfSynteticEntries,\n        modifiedEntriesIndexes: indexesOfModifiedEntries,\n      },\n      initialBreadcrumb: this.#timelineBreadcrumbs.initialBreadcrumb,\n    };\n  }\n\n  applyAnnotations(annotations: TraceEngine.Types.File.Annotations): void {\n    this.applyEntriesFilterAnnotations(\n        annotations.entriesFilterAnnotations.hiddenEntriesIndexes,\n        annotations.entriesFilterAnnotations.modifiedEntriesIndexes);\n    this.#timelineBreadcrumbs.setInitialBreadcrumbFromLoadedAnnotations(annotations.initialBreadcrumb);\n  }\n\n  applyEntriesFilterAnnotations(hiddenEntriesIndexes: number[], modifiedEntriesIndexes: number[]): void {\n    // Build the hidden events array by getting the entries by their index in the allEntries array.\n    const hiddenEntries: TraceEngine.Types.TraceEvents.SyntheticTraceEntry[] = [];\n    hiddenEntriesIndexes.map(hiddenEntryHash => {\n      const hiddenEntry = this.#allEntries[hiddenEntryHash];\n      if (hiddenEntry) {\n        hiddenEntries.push(hiddenEntry);\n      }\n    });\n    const modifiedEntries: TraceEngine.Types.TraceEvents.SyntheticTraceEntry[] = [];\n    modifiedEntriesIndexes.map(hiddenEntryHash => {\n      const modifiedEntry = this.#allEntries[hiddenEntryHash];\n      if (modifiedEntry) {\n        modifiedEntries.push(modifiedEntry);\n      }\n    });\n    this.#entriesFilter.setInvisibleAndModifiedEntries(hiddenEntries, modifiedEntries);\n  }\n}\n"]}