{"version":3,"file":"PuppeteerConnection.js","sourceRoot":"","sources":["../../../../../../front_end/services/puppeteer/PuppeteerConnection.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2022 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport type * as ProtocolClient from '../../core/protocol_client/protocol_client.js';\nimport type {ProtocolMapping} from '../../generated/protocol-mapping.js';\nimport type * as Protocol from '../../generated/protocol.js';\nimport * as puppeteer from '../../third_party/puppeteer/puppeteer.js';\n\n/**\n * This class serves as a puppeteer.Connection while sending/receiving CDP messages\n * over DevTools' own SessionRouter.\n *\n * The only oddity is that we attached to a concrete target with a sessionId but make\n * it look to puppeteer like it's the default session (no session ID).\n *\n * Since we see all CDPEvents, we filter out the ones whose session we don't know about.\n */\nclass PuppeteerConnectionAdapter extends puppeteer.Connection implements\n    ProtocolClient.CDPConnection.CDPConnectionObserver {\n  readonly #connection: ProtocolClient.CDPConnection.CDPConnection;\n  readonly #sessionId: Protocol.Target.SessionID;\n\n  constructor(connection: ProtocolClient.CDPConnection.CDPConnection, sessionId: Protocol.Target.SessionID) {\n    // url is an empty string in this case parallel to:\n    // https://github.com/puppeteer/puppeteer/blob/f63a123ecef86693e6457b07437a96f108f3e3c5/src/common/BrowserConnector.ts#L72\n    // Pass a 'null' transport, it should never actually be used, otherwise we do something wrong overwriting connection.\n    super('', {close: () => undefined} as puppeteer.ConnectionTransport);\n    this.#connection = connection;\n    this.#connection.observe(this);\n    this.#sessionId = sessionId;\n  }\n\n  // eslint-disable-next-line @devtools/no-underscored-properties\n  override _rawSend(\n      _callbacks: unknown, method: string|number|symbol, params: unknown, sessionId?: string,\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      _options?: unknown): Promise<any> {\n    return this.#connection\n        .send(\n            method as ProtocolClient.CDPConnection.Command,\n            params as ProtocolClient.CDPConnection.CommandParams<ProtocolClient.CDPConnection.Command>,\n            sessionId ?? this.#sessionId)\n        .then(response => 'result' in response ? response.result : {});\n  }\n\n  onEvent<T extends keyof ProtocolMapping.Events>(event: ProtocolClient.CDPConnection.CDPEvent<T>): void {\n    const {sessionId} = event;\n    if (sessionId === this.#sessionId) {\n      // Puppeteer is expecting to use the default session, but we give it a non-default session in #connection.\n      // Replace that sessionId with undefined so Puppeteer treats it as default.\n      event.sessionId = undefined;\n    } else if (!sessionId || !this._sessions.has(sessionId)) {\n      // Ignore the root session, or sessions puppeteer doesn't know about.\n      return;\n    }\n\n    void super.onMessage(JSON.stringify(event));\n  }\n\n  onDisconnect(): void {\n    this.dispose();\n  }\n\n  override dispose(): void {\n    super.dispose();\n    this.#connection.unobserve(this);\n    void this.#connection.send('Target.detachFromTarget', {sessionId: this.#sessionId}, this.#sessionId);\n  }\n}\n\nexport class PuppeteerConnectionHelper {\n  static async connectPuppeteerToConnectionViaTab(options: {\n    connection: ProtocolClient.CDPConnection.CDPConnection,\n    targetId: Protocol.Target.TargetID,\n    sessionId: Protocol.Target.SessionID,\n    isPageTargetCallback: (targetInfo: Protocol.Target.TargetInfo) => boolean,\n  }): Promise<{\n    page: puppeteer.Page | null,\n    browser: puppeteer.Browser,\n    puppeteerConnection: puppeteer.Connection,\n  }> {\n    const {connection, targetId, sessionId, isPageTargetCallback} = options;\n    const puppeteerConnection = new PuppeteerConnectionAdapter(connection, sessionId);\n    const browserPromise = puppeteer.Browser._create(\n        puppeteerConnection,\n        [] /* contextIds */,\n        false /* ignoreHTTPSErrors */,\n        undefined /* defaultViewport */,\n        undefined /* DownloadBehavior */,\n        undefined /* process */,\n        undefined /* closeCallback */,\n        undefined /* targetFilterCallback */,\n        target => isPageTargetCallback((target as puppeteer.Target)._getTargetInfo()),\n        false /* waitForInitiallyDiscoveredTargets */,\n    );\n\n    const [, browser] = await Promise.all([\n      puppeteerConnection._createSession({targetId}, /* emulateAutoAttach= */ true),\n      browserPromise,\n    ]);\n\n    await browser.waitForTarget(t => t.type() === 'page');\n\n    const pages = await browser.pages();\n\n    return {page: pages[0] as puppeteer.Page, browser, puppeteerConnection};\n  }\n}\n"]}