{"version":3,"file":"MarkdownView.js","sourceRoot":"","sources":["../../../../../../../front_end/ui/components/markdown_view/MarkdownView.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2020 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport './CodeBlock.js';\nimport './MarkdownImage.js';\nimport './MarkdownLink.js';\n\nimport type * as Marked from '../../../third_party/marked/marked.js';\nimport * as Lit from '../../lit/lit.js';\nimport * as VisualLogging from '../../visual_logging/visual_logging.js';\n\nimport markdownViewStylesRaw from './markdownView.css.js';\n\n// TODO(crbug.com/391381439): Fully migrate off of constructed style sheets.\nconst markdownViewStyles = new CSSStyleSheet();\nmarkdownViewStyles.replaceSync(markdownViewStylesRaw.cssContent);\n\nconst html = Lit.html;\nconst render = Lit.render;\n\nexport interface MarkdownViewData {\n  tokens: Marked.Marked.Token[];\n  renderer?: MarkdownLitRenderer;\n  animationEnabled?: boolean;\n}\n\nexport class MarkdownView extends HTMLElement {\n  readonly #shadow = this.attachShadow({mode: 'open'});\n\n  #tokenData: readonly Marked.Marked.Token[] = [];\n  #renderer = new MarkdownLitRenderer();\n  #animationEnabled = false;\n  #isAnimating = false;\n\n  connectedCallback(): void {\n    this.#shadow.adoptedStyleSheets = [markdownViewStyles];\n  }\n\n  set data(data: MarkdownViewData) {\n    this.#tokenData = data.tokens;\n    if (data.renderer) {\n      this.#renderer = data.renderer;\n    }\n\n    if (data.animationEnabled) {\n      this.#animationEnabled = true;\n      this.#renderer.addCustomClasses({\n        paragraph: 'pending',\n        heading: 'pending',\n        list_item: 'pending',\n        code: 'pending',\n      });\n    } else {\n      this.#finishAnimations();\n    }\n\n    this.#update();\n  }\n\n  #finishAnimations(): void {\n    const animatingElements = this.#shadow.querySelectorAll('.animating');\n    for (const element of animatingElements) {\n      element.classList.remove('animating');\n    }\n\n    const pendingElements = this.#shadow.querySelectorAll('.pending');\n    for (const element of pendingElements) {\n      element.classList.remove('pending');\n    }\n    this.#isAnimating = false;\n    this.#animationEnabled = false;\n    this.#renderer.removeCustomClasses({\n      paragraph: 'pending',\n      heading: 'pending',\n      list_item: 'pending',\n      code: 'pending',\n    });\n  }\n\n  #animate(): void {\n    if (this.#isAnimating) {\n      return;\n    }\n\n    this.#isAnimating = true;\n    const reveal = (): void => {\n      const pendingElement = this.#shadow.querySelector('.pending');\n      if (!pendingElement) {\n        this.#isAnimating = false;\n        return;\n      }\n\n      pendingElement.addEventListener('animationend', () => {\n        pendingElement.classList.remove('animating');\n        reveal();\n      }, {once: true});\n\n      pendingElement.classList.remove('pending');\n      pendingElement.classList.add('animating');\n    };\n\n    reveal();\n  }\n\n  #update(): void {\n    this.#render();\n\n    if (this.#animationEnabled) {\n      this.#animate();\n    }\n  }\n\n  #render(): void {\n    // Disabled until https://crbug.com/1079231 is fixed.\n    // clang-format off\n    render(html`\n      <div class='message'>\n        ${this.#tokenData.map(token => this.#renderer.renderToken(token))}\n      </div>\n    `, this.#shadow, {host: this});\n    // clang-format on\n  }\n}\n\ncustomElements.define('devtools-markdown-view', MarkdownView);\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'devtools-markdown-view': MarkdownView;\n  }\n}\n\n/**\n * Default renderer is used for the IssuesPanel and allows only well-known images and links to be embedded.\n */\nexport class MarkdownLitRenderer {\n  #customClasses: Record<string, Set<string>> = {};\n\n  addCustomClasses(customClasses: Record<Marked.Marked.Token['type'], string>): void {\n    for (const [type, className] of Object.entries(customClasses)) {\n      if (!this.#customClasses[type]) {\n        this.#customClasses[type] = new Set();\n      }\n      this.#customClasses[type].add(className);\n    }\n  }\n\n  removeCustomClasses(customClasses: Record<Marked.Marked.Token['type'], string>): void {\n    for (const [type, className] of Object.entries(customClasses)) {\n      if (this.#customClasses[type]) {\n        this.#customClasses[type].delete(className);\n      }\n    }\n  }\n\n  protected customClassMapForToken(type: Marked.Marked.Token['type']): Lit.Directive.DirectiveResult {\n    const classNames = this.#customClasses[type] || new Set();\n    const classInfo = Object.fromEntries([...classNames].map(className => [className, true]));\n    return Lit.Directives.classMap(classInfo);\n  }\n\n  renderChildTokens(token: Marked.Marked.Token): Lit.TemplateResult[] {\n    if ('tokens' in token && token.tokens) {\n      return token.tokens.map(token => this.renderToken(token));\n    }\n    throw new Error('Tokens not found');\n  }\n\n  /**\n   * Unescape will get rid of the escaping done by Marked to avoid double escaping due to escaping it also with lit.\n   * Table taken from: front_end/third_party/marked/package/src/helpers.js\n   */\n  unescape(text: string): string {\n    const escapeReplacements = new Map<string, string>([\n      ['&amp;', '&'],\n      ['&lt;', '<'],\n      ['&gt;', '>'],\n      ['&quot;', '\"'],\n      ['&#39;', '\\''],\n    ]);\n    return text.replace(/&(amp|lt|gt|quot|#39);/g, (matchedString: string) => {\n      const replacement = escapeReplacements.get(matchedString);\n      return replacement ? replacement : matchedString;\n    });\n  }\n\n  renderText(token: Marked.Marked.Token): Lit.TemplateResult {\n    if ('tokens' in token && token.tokens) {\n      return html`${this.renderChildTokens(token)}`;\n    }\n    // Due to unescaping, unescaped html entities (see escapeReplacements' keys) will be rendered\n    // as their corresponding symbol while the rest will be rendered as verbatim.\n    // Marked's escape function can be found in front_end/third_party/marked/package/src/helpers.js\n    return html`${this.unescape('text' in token ? token.text : '')}`;\n  }\n\n  renderHeading(heading: Marked.Marked.Tokens.Heading): Lit.TemplateResult {\n    const customClass = this.customClassMapForToken('heading');\n    switch (heading.depth) {\n      case 1:\n        return html`<h1 class=${customClass}>${this.renderText(heading)}</h1>`;\n      case 2:\n        return html`<h2 class=${customClass}>${this.renderText(heading)}</h2>`;\n      case 3:\n        return html`<h3 class=${customClass}>${this.renderText(heading)}</h3>`;\n      case 4:\n        return html`<h4 class=${customClass}>${this.renderText(heading)}</h4>`;\n      case 5:\n        return html`<h5 class=${customClass}>${this.renderText(heading)}</h5>`;\n      default:\n        return html`<h6 class=${customClass}>${this.renderText(heading)}</h6>`;\n    }\n  }\n\n  renderCodeBlock(token: Marked.Marked.Tokens.Code): Lit.TemplateResult {\n    // clang-format off\n    return html`<devtools-code-block\n      class=${this.customClassMapForToken('code')}\n      .code=${this.unescape(token.text)}\n      .codeLang=${token.lang || ''}>\n    </devtools-code-block>`;\n    // clang-format on\n  }\n\n  templateForToken(token: Marked.Marked.MarkedToken): Lit.TemplateResult|null {\n    switch (token.type) {\n      case 'paragraph':\n        return html`<p class=${this.customClassMapForToken('paragraph')}>${this.renderChildTokens(token)}</p>`;\n      case 'list':\n        return html`<ul class=${this.customClassMapForToken('list')}>${token.items.map(token => {\n          return this.renderToken(token);\n        })}</ul>`;\n      case 'list_item':\n        return html`<li class=${this.customClassMapForToken('list_item')}>${this.renderChildTokens(token)}</li>`;\n      case 'text':\n        return this.renderText(token);\n      case 'codespan':\n        return html`<code class=${this.customClassMapForToken('codespan')}>${this.unescape(token.text)}</code>`;\n      case 'code':\n        return this.renderCodeBlock(token);\n      case 'space':\n        return html``;\n      case 'link':\n        return html`<devtools-markdown-link\n        class=${this.customClassMapForToken('link')}\n        .data=${{\n        key:\n          token.href, title: token.text,\n        }\n        }></devtools-markdown-link>`;\n      case 'image':\n        return html`<devtools-markdown-image\n        class=${this.customClassMapForToken('image')}\n        .data=${{\n        key:\n          token.href, title: token.text,\n        }\n        }></devtools-markdown-image>`;\n      case 'heading':\n        return this.renderHeading(token);\n      case 'strong':\n        return html`<strong class=${this.customClassMapForToken('strong')}>${this.renderText(token)}</strong>`;\n      case 'em':\n        return html`<em class=${this.customClassMapForToken('em')}>${this.renderText(token)}</em>`;\n      default:\n        return null;\n    }\n  }\n\n  renderToken(token: Marked.Marked.Token): Lit.TemplateResult {\n    const template = this.templateForToken(token as Marked.Marked.MarkedToken);\n    if (template === null) {\n      throw new Error(`Markdown token type '${token.type}' not supported.`);\n    }\n    return template;\n  }\n}\n\n/**\n * Renderer used in Console Insights and AI assistance for the text generated by an LLM.\n */\nexport class MarkdownInsightRenderer extends MarkdownLitRenderer {\n  #citationClickHandler: (index: number) => void;\n\n  constructor(citationClickHandler?: (index: number) => void) {\n    super();\n    this.#citationClickHandler = citationClickHandler || (() => {});\n    this.addCustomClasses({heading: 'insight'});\n  }\n\n  override renderToken(token: Marked.Marked.Token): Lit.TemplateResult {\n    const template = this.templateForToken(token as Marked.Marked.MarkedToken);\n    if (template === null) {\n      return html`${token.raw}`;\n    }\n    return template;\n  }\n\n  sanitizeUrl(maybeUrl: string): string|null {\n    try {\n      const url = new URL(maybeUrl);\n      if (url.protocol === 'https:' || url.protocol === 'http:') {\n        return url.toString();\n      }\n      return null;\n    } catch {\n      return null;\n    }\n  }\n\n  detectCodeLanguage(token: Marked.Marked.Tokens.Code): string {\n    if (token.lang) {\n      return token.lang;\n    }\n\n    if (/^(\\.|#)?[\\w:\\[\\]=\"'-\\.]* ?{/m.test(token.text) || /^@import/.test(token.text)) {\n      return 'css';\n    }\n    if (/^(var|const|let|function|async|import)\\s/.test(token.text)) {\n      return 'js';\n    }\n\n    return '';\n  }\n\n  override templateForToken(token: Marked.Marked.Token): Lit.TemplateResult|null {\n    switch (token.type) {\n      case 'heading':\n        return this.renderHeading(token as Marked.Marked.Tokens.Heading);\n      case 'link':\n      case 'image': {\n        const sanitizedUrl = this.sanitizeUrl(token.href);\n        if (!sanitizedUrl) {\n          return null;\n        }\n        // Only links pointing to resources within DevTools can be rendered here.\n        return html`${token.text ?? token.href}`;\n      }\n      case 'code':\n        return html`<devtools-code-block\n          class=${this.customClassMapForToken('code')}\n          .code=${this.unescape(token.text)}\n          .codeLang=${this.detectCodeLanguage(token as Marked.Marked.Tokens.Code)}\n          .displayNotice=${true}>\n        </devtools-code-block>`;\n      case 'citation':\n        // clang-format off\n        return html`<sup><button\n            class=\"citation\"\n            jslog=${VisualLogging.link('inline-citation').track({click: true})}\n            @click=${this.#citationClickHandler.bind(this, Number(token.linkText))}\n          >[${token.linkText}]</button></sup>`;\n        // clang-format on\n    }\n    return super.templateForToken(token as Marked.Marked.MarkedToken);\n  }\n}\n"]}