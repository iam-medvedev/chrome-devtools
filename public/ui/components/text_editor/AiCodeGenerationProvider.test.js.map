{"version":3,"file":"AiCodeGenerationProvider.test.js","sourceRoot":"","sources":["../../../../../../../front_end/ui/components/text_editor/AiCodeGenerationProvider.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../../core/common/common.js';\nimport * as Host from '../../../core/host/host.js';\nimport * as PanelCommon from '../../../panels/common/common.js';\nimport {renderElementIntoDOM} from '../../../testing/DOMHelpers.js';\nimport {describeWithEnvironment, updateHostConfig} from '../../../testing/EnvironmentHelpers.js';\nimport * as CodeMirror from '../../../third_party/codemirror.next/codemirror.next.js';\n\nimport {AiCodeGenerationProvider, TextEditor} from './text_editor.js';\n\nfunction createEditorWithProvider(doc: string):\n    {editor: TextEditor.TextEditor, provider: AiCodeGenerationProvider.AiCodeGenerationProvider} {\n  const provider = AiCodeGenerationProvider.AiCodeGenerationProvider.createInstance();\n  const editor = new TextEditor.TextEditor(\n      CodeMirror.EditorState.create({\n        doc,\n        extensions: [\n          provider.extension(),\n        ],\n      }),\n  );\n  renderElementIntoDOM(editor);\n  provider.editorInitialized(editor);\n  return {editor, provider};\n}\n\ndescribeWithEnvironment('AiCodeGenerationProvider', () => {\n  let clock: sinon.SinonFakeTimers;\n\n  beforeEach(() => {\n    clock = sinon.useFakeTimers();\n    updateHostConfig({\n      devToolsAiCodeGeneration: {\n        enabled: true,\n      },\n      aidaAvailability: {\n        enabled: true,\n        blockedByAge: false,\n        blockedByGeo: false,\n      }\n    });\n    sinon.stub(Host.AidaClient.AidaClient, 'checkAccessPreconditions')\n        .resolves(Host.AidaClient.AidaAccessPreconditions.AVAILABLE);\n    sinon.stub(Host.AidaClient.HostConfigTracker, 'instance').returns({\n      addEventListener: () => {},\n      removeEventListener: () => {},\n      dispose: () => {},\n    } as unknown as Host.AidaClient.HostConfigTracker);\n    Common.Settings.Settings.instance().settingForTest('ai-code-completion-enabled').set(true);\n  });\n\n  afterEach(() => {\n    clock.restore();\n  });\n\n  it('does not create a provider when the feature is disabled', () => {\n    updateHostConfig({\n      devToolsAiCodeGeneration: {\n        enabled: false,\n      },\n    });\n    assert.throws(() => createEditorWithProvider(''), 'AI code generation feature is not enabled.');\n  });\n\n  describe('Teaser decoration', () => {\n    it('shows teaser when cursor is at the end of a comment line', async () => {\n      const {editor, provider} = createEditorWithProvider('// Hello');\n      editor.dispatch({selection: {anchor: 8}});\n      await clock.tickAsync(0);\n      assert.isNotNull(editor.editor.dom.querySelector('.cm-placeholder'));\n      provider.dispose();\n    });\n\n    it('hides teaser when cursor is not at the end of the line', async () => {\n      const {editor, provider} = createEditorWithProvider('// Hello');\n      editor.dispatch({selection: {anchor: 5}});\n      await clock.tickAsync(0);\n      assert.isNull(editor.editor.dom.querySelector('.cm-placeholder'));\n      provider.dispose();\n    });\n\n    it('hides teaser when the line is not a comment', async () => {\n      const {editor, provider} = createEditorWithProvider('console');\n      editor.dispatch({selection: {anchor: 7}});\n      await clock.tickAsync(0);\n      assert.isNull(editor.editor.dom.querySelector('.cm-placeholder'));\n      provider.dispose();\n    });\n\n    it('hides teaser when mode is DISMISSED', async () => {\n      const {editor, provider} = createEditorWithProvider('// Hello');\n      editor.dispatch({selection: {anchor: 8}});\n      await clock.tickAsync(0);\n      assert.isNotNull(editor.editor.dom.querySelector('.cm-placeholder'));\n\n      editor.dispatch({\n        effects: AiCodeGenerationProvider.setAiCodeGenerationTeaserMode.of(\n            AiCodeGenerationProvider.AiCodeGenerationTeaserMode.DISMISSED)\n      });\n      await clock.tickAsync(0);\n      assert.isNull(editor.editor.dom.querySelector('.cm-placeholder'));\n      provider.dispose();\n    });\n\n    it('shows teaser again after a document change', async () => {\n      const {editor, provider} = createEditorWithProvider('// Hello');\n      editor.dispatch({selection: {anchor: 8}});\n      await clock.tickAsync(0);\n      assert.isNotNull(editor.editor.dom.querySelector('.cm-placeholder'));\n\n      editor.dispatch({\n        effects: AiCodeGenerationProvider.setAiCodeGenerationTeaserMode.of(\n            AiCodeGenerationProvider.AiCodeGenerationTeaserMode.DISMISSED)\n      });\n      await clock.tickAsync(0);\n      assert.isNull(editor.editor.dom.querySelector('.cm-placeholder'));\n\n      editor.dispatch({changes: {from: 8, insert: 'W'}, selection: {anchor: 9}});\n      await clock.tickAsync(0);\n      assert.isNotNull(editor.editor.dom.querySelector('.cm-placeholder'));\n      provider.dispose();\n    });\n  });\n\n  describe('Editor keymap', () => {\n    it('dismisses teaser on Escape when loading', async () => {\n      const {editor, provider} = createEditorWithProvider('// Hello');\n      sinon.stub(PanelCommon.AiCodeGenerationTeaser.prototype, 'loading').value(true);\n      sinon.stub(PanelCommon.AiCodeGenerationTeaser.prototype, 'isShowing').returns(true);\n      editor.dispatch({selection: {anchor: 8}});\n      await clock.tickAsync(0);\n\n      const dispatchSpy = sinon.spy(editor, 'dispatch');\n      editor.editor.contentDOM.dispatchEvent(new KeyboardEvent('keydown', {key: 'Escape'}));\n\n      sinon.assert.calledOnce(dispatchSpy);\n      sinon.assert.calledWith(dispatchSpy, {\n        effects: AiCodeGenerationProvider.setAiCodeGenerationTeaserMode.of(\n            AiCodeGenerationProvider.AiCodeGenerationTeaserMode.DISMISSED)\n      });\n      provider.dispose();\n    });\n\n    it('triggers loading state on Ctrl+I', async () => {\n      const {editor, provider} = createEditorWithProvider('// Hello');\n      const generationTeaser = sinon.spy(PanelCommon.AiCodeGenerationTeaser.prototype, 'loading', ['set']);\n      sinon.stub(PanelCommon.AiCodeGenerationTeaser.prototype, 'isShowing').returns(true);\n      editor.dispatch({selection: {anchor: 8}});\n      await clock.tickAsync(0);\n\n      const event = new KeyboardEvent('keydown', {\n        key: 'i',\n        ctrlKey: Host.Platform.isMac() ? false : true,\n        metaKey: Host.Platform.isMac() ? true : false,\n      });\n      editor.editor.contentDOM.dispatchEvent(event);\n\n      sinon.assert.calledOnce(generationTeaser.set);\n      sinon.assert.calledWith(generationTeaser.set, true);\n      provider.dispose();\n    });\n  });\n});\n"]}