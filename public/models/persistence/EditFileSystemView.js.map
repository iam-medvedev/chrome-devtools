{"version":3,"file":"EditFileSystemView.js","sourceRoot":"","sources":["../../../../../../front_end/models/persistence/EditFileSystemView.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Copyright (C) 2013 Google Inc. All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without\n * modification, are permitted provided that the following conditions are\n * met:\n *\n *     * Redistributions of source code must retain the above copyright\n * notice, this list of conditions and the following disclaimer.\n *     * Redistributions in binary form must reproduce the above\n * copyright notice, this list of conditions and the following disclaimer\n * in the documentation and/or other materials provided with the\n * distribution.\n *     * Neither the name of Google Inc. nor the names of its\n * contributors may be used to endorse or promote products derived from\n * this software without specific prior written permission.\n *\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n * \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\n * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\n * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT\n * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,\n * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT\n * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,\n * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY\n * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\n * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n */\n\nimport '../../ui/legacy/components/data_grid/data_grid.js';\n\nimport * as i18n from '../../core/i18n/i18n.js';\nimport * as Platform from '../../core/platform/platform.js';\n// TODO(crbug.com/442509324): remove UI dependency\n// eslint-disable-next-line rulesdir/no-imports-in-directory\nimport * as UI from '../../ui/legacy/legacy.js';\n// TODO(crbug.com/442509324): remove UI dependency\n// eslint-disable-next-line rulesdir/no-imports-in-directory\nimport {Directives, html, render} from '../../ui/lit/lit.js';\n\nimport editFileSystemViewStyles from './editFileSystemView.css.js';\nimport type {PlatformFileSystem} from './PlatformFileSystem.js';\n\nconst {styleMap} = Directives;\n\nconst UIStrings = {\n  /**\n   * @description Text in Edit File System View of the Workspace settings in Settings to indicate that the following string is a folder URL\n   */\n  url: 'URL',\n  /**\n   * @description Text in Edit File System View of the Workspace settings in Settings\n   */\n  excludedFolders: 'Excluded sub-folders',\n  /**\n   * @description Error message when a file system path is an empty string.\n   */\n  enterAPath: 'Enter a path',\n  /**\n   * @description Error message when a file system path is identical to an existing path.\n   */\n  enterAUniquePath: 'Enter a unique path',\n} as const;\nconst str_ = i18n.i18n.registerUIStrings('models/persistence/EditFileSystemView.ts', UIStrings);\nconst i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\n\nexport const enum ExcludedFolderStatus {\n  VALID = 1,\n  ERROR_NOT_A_PATH = 2,\n  ERROR_NOT_UNIQUE = 3,\n}\n\nfunction statusString(status: ExcludedFolderStatus): Platform.UIString.LocalizedString {\n  switch (status) {\n    case ExcludedFolderStatus.ERROR_NOT_A_PATH:\n      return i18nString(UIStrings.enterAPath);\n    case ExcludedFolderStatus.ERROR_NOT_UNIQUE:\n      return i18nString(UIStrings.enterAUniquePath);\n    case ExcludedFolderStatus.VALID:\n      throw new Error('unreachable');\n  }\n}\n\nexport interface PathWithStatus {\n  path: Platform.DevToolsPath.EncodedPathString;\n  status: ExcludedFolderStatus;\n}\n\nexport interface EditFileSystemViewInput {\n  fileSystemPath: Platform.DevToolsPath.UrlString;\n  excludedFolderPaths: PathWithStatus[];\n  onCreate: (event: CustomEvent<{url?: string}>) => void;\n  onEdit:\n      (event: CustomEvent<{node: HTMLElement, columnId: string, valueBeforeEditing: string, newText: string}>) => void;\n  onDelete: (event: CustomEvent<HTMLElement>) => void;\n}\n\nexport type View = (input: EditFileSystemViewInput, output: object, target: HTMLElement) => void;\n\nexport const DEFAULT_VIEW: View = (input, _output, target) => {\n  // clang-format off\n  render(html`\n      <style>${editFileSystemViewStyles}</style>\n      <div class=\"excluded-folder-header\">\n        <span>${i18nString(UIStrings.url)}</span>\n        <span class=\"excluded-folder-url\">${input.fileSystemPath}</span>\n        <devtools-data-grid\n          @create=${input.onCreate}\n          @edit=${input.onEdit}\n          @delete=${input.onDelete}\n          class=\"exclude-subfolders-table\"\n          parts=\"excluded-folder-row-with-error\"\n          inline striped>\n          <table>\n            <thead>\n              <tr>\n                <th id=\"url\" editable>${i18nString(UIStrings.excludedFolders)}</th>\n              </tr>\n            </thead>\n            <tbody>\n            ${input.excludedFolderPaths.map((path, index) => html`\n              <tr data-url=${path.path} data-index=${index}>\n                <td style=${styleMap({backgroundColor: path.status !== ExcludedFolderStatus.VALID ? 'var(--sys-color-error-container)' : undefined})}>${path.path}</td>\n              </tr>\n            `)}\n            <tr placeholder></tr>\n            </tbody>\n          </table>\n        </devtools-data-grid>\n        ${input.excludedFolderPaths.filter(({status}) => status !== ExcludedFolderStatus.VALID).map(({status}) =>\n          html`<span class=\"excluded-folder-error\">${statusString(status)}</span>`)}\n    </div>`, target);\n  // clang-format on\n};\n\nexport class EditFileSystemView extends UI.Widget.VBox {\n  #fileSystem?: PlatformFileSystem;\n  #excludedFolderPaths: PathWithStatus[] = [];\n  readonly #view: View;\n\n  constructor(element: HTMLElement|undefined, view: View = DEFAULT_VIEW) {\n    super(element);\n    this.#view = view;\n  }\n\n  set fileSystem(fileSystem: PlatformFileSystem) {\n    this.#fileSystem = fileSystem;\n    this.#resyncExcludedFolderPaths();\n    this.requestUpdate();\n  }\n\n  override wasShown(): void {\n    this.#resyncExcludedFolderPaths();\n    this.requestUpdate();\n  }\n\n  #resyncExcludedFolderPaths(): void {\n    this.#excludedFolderPaths = this.#fileSystem?.excludedFolders()\n                                    .values()\n                                    .map(path => ({path, status: ExcludedFolderStatus.VALID}))\n                                    .toArray() ??\n        [];\n  }\n\n  override performUpdate(): void {\n    const input: EditFileSystemViewInput = {\n      fileSystemPath: this.#fileSystem?.path() ?? Platform.DevToolsPath.urlString``,\n      excludedFolderPaths: this.#excludedFolderPaths,\n      onCreate: e => this.#onCreate(e.detail.url),\n      onEdit: e => this.#onEdit(e.detail.node.dataset.index ?? '-1', e.detail.valueBeforeEditing, e.detail.newText),\n      onDelete: e => this.#onDelete(e.detail.dataset.index ?? '-1'),\n    };\n    this.#view(input, {}, this.contentElement);\n  }\n\n  #onCreate(url?: string): void {\n    if (url === undefined) {\n      // The data grid fires onCreate even when the user just selects and then deselects the\n      // creation row. Ignore those occurrences.\n      return;\n    }\n\n    const pathWithStatus = this.#validateFolder(url);\n    this.#excludedFolderPaths.push(pathWithStatus);\n    if (pathWithStatus.status === ExcludedFolderStatus.VALID) {\n      this.#fileSystem?.addExcludedFolder(pathWithStatus.path);\n    }\n\n    this.requestUpdate();\n  }\n\n  #onEdit(idx: string, valueBeforeEditing: string, newText: string): void {\n    const index = Number.parseInt(idx, 10);\n    if (index < 0 || index >= this.#excludedFolderPaths.length) {\n      return;\n    }\n\n    const pathWithStatus = this.#validateFolder(newText);\n    const oldPathWithStatus = this.#excludedFolderPaths[index];\n    this.#excludedFolderPaths[index] = pathWithStatus;\n\n    if (oldPathWithStatus.status === ExcludedFolderStatus.VALID) {\n      this.#fileSystem?.removeExcludedFolder(valueBeforeEditing as Platform.DevToolsPath.EncodedPathString);\n    }\n\n    if (pathWithStatus.status === ExcludedFolderStatus.VALID) {\n      this.#fileSystem?.addExcludedFolder(pathWithStatus.path);\n    }\n\n    this.requestUpdate();\n  }\n\n  #onDelete(idx: string): void {\n    const index = Number.parseInt(idx, 10);\n    if (index < 0 || index >= this.#excludedFolderPaths.length) {\n      return;\n    }\n\n    this.#fileSystem?.removeExcludedFolder(this.#excludedFolderPaths[index].path);\n    this.#excludedFolderPaths.splice(index, 1);\n\n    this.requestUpdate();\n  }\n\n  #validateFolder(rawInput: string): PathWithStatus {\n    const path = EditFileSystemView.#normalizePrefix(rawInput.trim()) as Platform.DevToolsPath.EncodedPathString;\n    if (!path) {\n      return {path, status: ExcludedFolderStatus.ERROR_NOT_A_PATH};\n    }\n\n    if (this.#excludedFolderPaths.findIndex(({path: p}) => p === path) !== -1) {\n      return {path, status: ExcludedFolderStatus.ERROR_NOT_UNIQUE};\n    }\n\n    return {path, status: ExcludedFolderStatus.VALID};\n  }\n\n  static #normalizePrefix(prefix: string): string {\n    if (!prefix) {\n      return '';\n    }\n    return prefix + (prefix[prefix.length - 1] === '/' ? '' : '/');\n  }\n}\n"]}