{"version":3,"file":"WarningsHandler.test.js","sourceRoot":"","sources":["../../../../../../../front_end/models/trace/handlers/WarningsHandler.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2023 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport {describeWithEnvironment} from '../../../testing/EnvironmentHelpers.js';\nimport {TraceLoader} from '../../../testing/TraceLoader.js';\nimport * as Trace from '../trace.js';\n\ndescribeWithEnvironment('WarningsHandler', function() {\n  beforeEach(() => {\n    Trace.Handlers.ModelHandlers.Warnings.reset();\n  });\n\n  it('identifies long tasks', async function() {\n    // We run the entire model here as the WarningsHandler actually depends on the WorkersHandler.\n    const {parsedTrace} = await TraceLoader.traceEngine(this, 'slow-interaction-keydown.json.gz');\n    const {perWarning} = parsedTrace.Warnings;\n    const events = perWarning.get('LONG_TASK');\n    // We expect one long task.\n    assert.strictEqual(events?.length, 1);\n    const event = events?.at(0);\n    assert.strictEqual(event?.name, Trace.Types.Events.Name.RUN_TASK);\n  });\n\n  it('does not identify worker long tasks', async function() {\n    // We run the entire model here as the WarningsHandler actually depends on the WorkersHandler.\n    const {parsedTrace} = await TraceLoader.traceEngine(this, 'long-task-from-worker-thread.json.gz');\n    const {perWarning} = parsedTrace.Warnings;\n    const events = perWarning.get('LONG_TASK');\n    // We expect no long task warnings (because worker tasks don't count).\n    assert.isUndefined(events?.length);\n  });\n\n  it('identifies idle callbacks that ran over the allotted time', async function() {\n    const events = await TraceLoader.rawEvents(this, 'idle-callback.json.gz');\n    for (const event of events) {\n      Trace.Handlers.ModelHandlers.Warnings.handleEvent(event);\n    }\n    const data = Trace.Handlers.ModelHandlers.Warnings.data();\n    const longIdleCallbacks = data.perWarning.get('IDLE_CALLBACK_OVER_TIME') || [];\n    assert.lengthOf(longIdleCallbacks, 1);\n    const event = longIdleCallbacks[0];\n    assert.deepEqual(data.perEvent.get(event), ['IDLE_CALLBACK_OVER_TIME']);\n  });\n\n  it('identifies reflows that take over 30ms', async function() {\n    const events = await TraceLoader.rawEvents(this, 'large-layout-small-recalc.json.gz');\n    for (const event of events) {\n      Trace.Handlers.ModelHandlers.Warnings.handleEvent(event);\n    }\n    const data = Trace.Handlers.ModelHandlers.Warnings.data();\n    const forcedReflow = data.perWarning.get('FORCED_REFLOW') || [];\n    assert.lengthOf(forcedReflow, 2);\n    const stylesRecalc = forcedReflow[0];\n    const layout = forcedReflow[1];\n    assert.deepEqual(data.perEvent.get(stylesRecalc), ['FORCED_REFLOW']);\n    assert.deepEqual(data.perEvent.get(layout), ['FORCED_REFLOW']);\n    assert.strictEqual(stylesRecalc.name, Trace.Types.Events.Name.UPDATE_LAYOUT_TREE);\n    assert.strictEqual(layout.name, Trace.Types.Events.Name.LAYOUT);\n  });\n\n  it('ignores reflows that are not forced by JS', async function() {\n    const events = await TraceLoader.rawEvents(this, 'large-recalc-style.json.gz');\n    for (const event of events) {\n      Trace.Handlers.ModelHandlers.Warnings.handleEvent(event);\n    }\n    const data = Trace.Handlers.ModelHandlers.Warnings.data();\n    const forcedStyle = data.perWarning.get('FORCED_REFLOW') || [];\n    assert.lengthOf(forcedStyle, 0);\n  });\n\n  it('identifies long interactions', async function() {\n    // We run the entire model here as the WarningsHandler actually depends on the UserInteractionsHandler to fetch this data\n    const {parsedTrace} = await TraceLoader.traceEngine(this, 'one-second-interaction.json.gz');\n\n    // These events do exist on the UserInteractionsHandler, but we also put\n    // them into the WarningsHandler so that the warnings handler can be the\n    // source of truth and the way to look up all warnings for a given event.\n    const {interactionsOverThreshold} = parsedTrace.UserInteractions;\n\n    for (const interaction of interactionsOverThreshold) {\n      const warnings = parsedTrace.Warnings.perEvent.get(interaction);\n      assert.deepEqual(warnings, ['LONG_INTERACTION']);\n    }\n  });\n});\n"]}