{"version":3,"file":"SelectorStatsHandler.js","sourceRoot":"","sources":["../../../../../../../front_end/models/trace/handlers/SelectorStatsHandler.ts"],"names":[],"mappings":"AAAA,sCAAsC;AACtC,yEAAyE;AACzE,6BAA6B;AAG7B,OAAO,KAAK,KAAK,MAAM,mBAAmB,CAAC;AAmB3C,IAAI,oBAAoB,GAAkC,IAAI,CAAC;AAC/D,IAAI,mBAAmB,GAAyB,IAAI,CAAC;AAErD,IAAI,0BAA0B,GAAG,IAAI,GAAG,EAEpC,CAAC;AAEL,IAAI,mBAAmB,GAAG,IAAI,KAAK,EAAmB,CAAC;AAEvD,MAAM,UAAU,KAAK;IACnB,oBAAoB,GAAG,IAAI,CAAC;IAC5B,mBAAmB,GAAG,IAAI,CAAC;IAC3B,0BAA0B,GAAG,IAAI,GAAG,EAAE,CAAC;IACvC,mBAAmB,GAAG,EAAE,CAAC;AAC3B,CAAC;AAED,MAAM,UAAU,WAAW,CAAC,KAAyB;IACnD,IAAI,KAAK,CAAC,MAAM,CAAC,iCAAiC,CAAC,KAAK,CAAC,EAAE,CAAC;QAC1D;;;;;;WAMG;QACH,IAAI,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO;YACvB,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,6FAAkE;YACxF,mBAAmB,IAAI,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,KAAK,mBAAmB,CAAC,aAAa,EAAE,CAAC;YACxF,mBAAmB,CAAC,OAAO,GAAG,IAAI,CAAC;YACnC,OAAO;QACT,CAAC;IACH,CAAC;IAED,IAAI,KAAK,CAAC,MAAM,CAAC,eAAe,CAAC,KAAK,CAAC,IAAI,oBAAoB,IAAI,KAAK,CAAC,IAAI,CAAC,cAAc,EAAE,CAAC;QAC7F,0BAA0B,CAAC,GAAG,CAAC,oBAAoB,EAAE;YACnD,OAAO,EAAE,KAAK,CAAC,IAAI,CAAC,cAAc,CAAC,gBAAgB;SACpD,CAAC,CAAC;QACH,OAAO;IACT,CAAC;IAED,IAAI,KAAK,CAAC,MAAM,CAAC,sCAAsC,CAAC,KAAK,CAAC,EAAE,CAAC;QAC/D,MAAM,YAAY,GAAG,IAAI,KAAK,EAA4B,CAAC;QAC3D,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,EAAE,OAAO,CAAC,QAAQ,CAAC,EAAE;YAC5C,YAAY,CAAC,IAAI,CAAC;gBAChB,QAAQ,EAAE,QAAQ,CAAC,QAAQ;gBAC3B,YAAY,EAAE,QAAQ,CAAC,cAAc;aACtC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,IAAI,YAAY,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;YAC5B,mBAAmB,GAAG;gBACpB,KAAK,EAAE,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,KAAK;gBAC5B,aAAa,EAAE,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM;gBACrC,IAAI,sHAAyE;gBAC7E,YAAY;gBACZ,EAAE,EAAE,KAAK,CAAC,EAAE;gBACZ,GAAG,EAAE,KAAK,CAAC,GAAG;gBACd,OAAO,EAAE,KAAK;gBACd,sBAAsB,EAAE,oBAAoB,CAAC,CAAC,CAAC,oBAAoB,CAAC,EAAE,CAAC,CAAC,CAAC,KAAK,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC;aAC/F,CAAC;YACF,mBAAmB,CAAC,IAAI,CAAC,mBAAmB,CAAC,CAAC;QAChD,CAAC;IACH,CAAC;IAED,IAAI,KAAK,CAAC,MAAM,CAAC,aAAa,CAAC,KAAK,CAAC,EAAE,CAAC;QACtC,oBAAoB,GAAG,KAAK,CAAC;QAC7B,OAAO;IACT,CAAC;AACH,CAAC;AAED,MAAM,CAAC,KAAK,UAAU,QAAQ;AAC9B,CAAC;AASD,MAAM,UAAU,IAAI;IAClB,OAAO;QACL,uBAAuB,EAAE,0BAA0B;QACnD,mBAAmB;KACpB,CAAC;AACJ,CAAC","sourcesContent":["// Copyright 2024 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport type * as Protocol from '../../../generated/protocol.js';\nimport * as Types from '../types/types.js';\n\ninterface SelectorWithStyleSheedId {\n  selector: string;\n  styleSheetId: string;\n}\n\ninterface InvalidatedNode {\n  frame: string;\n  backendNodeId: Protocol.DOM.BackendNodeId;\n  type: Types.Events.InvalidationEventType;\n  selectorList: SelectorWithStyleSheedId[];\n  ts: Types.Timing.Micro;\n  tts?: Types.Timing.Micro;\n  subtree:\n      boolean;  // Indicates if the invalidation applies solely to the node (false) or extends to all its descendants (true)\n  lastRecalcStyleEventTs: Types.Timing.Micro;\n}\n\nlet lastRecalcStyleEvent: Types.Events.RecalcStyle|null = null;\nlet lastInvalidatedNode: InvalidatedNode|null = null;\n\nlet selectorDataForRecalcStyle = new Map<Types.Events.RecalcStyle, {\n  timings: Types.Events.SelectorTiming[],\n}>();\n\nlet invalidatedNodeList = new Array<InvalidatedNode>();\n\nexport function reset(): void {\n  lastRecalcStyleEvent = null;\n  lastInvalidatedNode = null;\n  selectorDataForRecalcStyle = new Map();\n  invalidatedNodeList = [];\n}\n\nexport function handleEvent(event: Types.Events.Event): void {\n  if (Types.Events.isStyleRecalcInvalidationTracking(event)) {\n    /**\n     * CSS Style substree invalidation\n     * A subtree invalidation comes with two records, 1) a StyleInvalidatorInvalidationTracking\n     * event 2) following with a StyleRecalcInvalidationTracking event. List of selectors and style\n     * sheet ID information is stored in the 1st event. Subtree flag is stored in the 2nd\n     * event.\n     */\n    if (event.args.data.subtree &&\n        event.args.data.reason === Types.Events.StyleRecalcInvalidationReason.RELATED_STYLE_RULE &&\n        lastInvalidatedNode && event.args.data.nodeId === lastInvalidatedNode.backendNodeId) {\n      lastInvalidatedNode.subtree = true;\n      return;\n    }\n  }\n\n  if (Types.Events.isSelectorStats(event) && lastRecalcStyleEvent && event.args.selector_stats) {\n    selectorDataForRecalcStyle.set(lastRecalcStyleEvent, {\n      timings: event.args.selector_stats.selector_timings,\n    });\n    return;\n  }\n\n  if (Types.Events.isStyleInvalidatorInvalidationTracking(event)) {\n    const selectorList = new Array<SelectorWithStyleSheedId>();\n    event.args.data.selectors?.forEach(selector => {\n      selectorList.push({\n        selector: selector.selector,\n        styleSheetId: selector.style_sheet_id,\n      });\n    });\n\n    if (selectorList.length > 0) {\n      lastInvalidatedNode = {\n        frame: event.args.data.frame,\n        backendNodeId: event.args.data.nodeId,\n        type: Types.Events.InvalidationEventType.StyleInvalidatorInvalidationTracking,\n        selectorList,\n        ts: event.ts,\n        tts: event.tts,\n        subtree: false,\n        lastRecalcStyleEventTs: lastRecalcStyleEvent ? lastRecalcStyleEvent.ts : Types.Timing.Micro(0),\n      };\n      invalidatedNodeList.push(lastInvalidatedNode);\n    }\n  }\n\n  if (Types.Events.isRecalcStyle(event)) {\n    lastRecalcStyleEvent = event;\n    return;\n  }\n}\n\nexport async function finalize(): Promise<void> {\n}\n\nexport interface SelectorStatsData {\n  dataForRecalcStyleEvent: Map<Types.Events.RecalcStyle, {\n    timings: Types.Events.SelectorTiming[],\n  }>;\n  invalidatedNodeList: InvalidatedNode[];\n}\n\nexport function data(): SelectorStatsData {\n  return {\n    dataForRecalcStyleEvent: selectorDataForRecalcStyle,\n    invalidatedNodeList,\n  };\n}\n"]}