{"version":3,"file":"ImageDelivery.test.js","sourceRoot":"","sources":["../../../../../../../front_end/models/trace/insights/ImageDelivery.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport {describeWithEnvironment} from '../../../testing/EnvironmentHelpers.js';\nimport {getFirstOrError, getInsightOrError, processTrace} from '../../../testing/InsightHelpers.js';\n\nimport * as Insights from './insights.js';\n\nconst {ImageOptimizationType} = Insights.Models.ImageDelivery;\n\ndescribeWithEnvironment('ImageDelivery', function() {\n  it('finds requests for remote fonts', async () => {\n    // See the following for a description of each test case:\n    // https://gist.github.com/adamraine/397e2bd08665f9e45f6072e446715115\n    const {data, insights} = await processTrace(this, 'image-delivery.json.gz');\n\n    const imageRequests = data.NetworkRequests.byTime.filter(r => r.args.data.resourceType === 'Image');\n    assert.deepEqual(imageRequests.map(r => r.args.data.url), [\n      'https://images.ctfassets.net/u275ja1nivmq/6T6z40ay5GFCUtwV7DONgh/0e23606ed1692d9721ab0f39a8d8a99e/yeti_cover.jpg',\n      'https://raw.githubusercontent.com/GoogleChrome/lighthouse/refs/heads/main/cli/test/fixtures/dobetterweb/lighthouse-rotating.gif',\n      'https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/f/5d52a2ab-7be3-4931-9e82-8728d1f55620/d51jfzi-b0efc925-7704-44bb-a3b8-8d98545af693.gif?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1cm46YXBwOjdlMGQxODg5ODIyNjQzNzNhNWYwZDQxNWVhMGQyNmUwIiwiaXNzIjoidXJuOmFwcDo3ZTBkMTg4OTgyMjY0MzczYTVmMGQ0MTVlYTBkMjZlMCIsIm9iaiI6W1t7InBhdGgiOiJcL2ZcLzVkNTJhMmFiLTdiZTMtNDkzMS05ZTgyLTg3MjhkMWY1NTYyMFwvZDUxamZ6aS1iMGVmYzkyNS03NzA0LTQ0YmItYTNiOC04ZDk4NTQ1YWY2OTMuZ2lmIn1dXSwiYXVkIjpbInVybjpzZXJ2aWNlOmZpbGUuZG93bmxvYWQiXX0.T898HUlAbGFPboxRE43H5JujnDGl0zd_T128PnGLlpg',\n      'https://images.ctfassets.net/u275ja1nivmq/6T6z40ay5GFCUtwV7DONgh/0e23606ed1692d9721ab0f39a8d8a99e/yeti_cover.jpg?fm=webp',\n      'https://images.ctfassets.net/u275ja1nivmq/6T6z40ay5GFCUtwV7DONgh/0e23606ed1692d9721ab0f39a8d8a99e/yeti_cover.jpg?fm=avif',\n      'https://raw.githubusercontent.com/GoogleChrome/lighthouse/refs/heads/main/cli/test/fixtures/byte-efficiency/lighthouse-2048x1356.webp',\n      'https://raw.githubusercontent.com/GoogleChrome/lighthouse/refs/heads/main/cli/test/fixtures/byte-efficiency/lighthouse-480x320.webp',\n      'https://onlinepngtools.com/images/examples-onlinepngtools/elephant-hd-quality.png',\n      'https://raw.githubusercontent.com/GoogleChrome/lighthouse/refs/heads/main/cli/test/fixtures/dobetterweb/lighthouse-480x318.jpg',\n    ]);\n\n    const insight =\n        getInsightOrError('ImageDelivery', insights, getFirstOrError(data.Meta.navigationsByNavigationId.values()));\n    assert.strictEqual(insight.totalByteSavings, 2007125);\n    assert.strictEqual(insight.metricSavings!.FCP, 0);\n    assert.strictEqual(insight.metricSavings!.LCP, 100);\n    assert.deepEqual(\n        insight.optimizableImages.map(\n            o => ({url: o.request.args.data.url, optimizations: o.optimizations, byteSavings: o.byteSavings})),\n        [\n          {\n            byteSavings: 1057876,\n            optimizations: [\n              {\n                byteSavings: 1057876,\n                type: ImageOptimizationType.MODERN_FORMAT_OR_COMPRESSION,\n              },\n            ],\n            url:\n                'https://images.ctfassets.net/u275ja1nivmq/6T6z40ay5GFCUtwV7DONgh/0e23606ed1692d9721ab0f39a8d8a99e/yeti_cover.jpg',\n          },\n          {\n            byteSavings: 682028,\n            optimizations: [\n              {\n                byteSavings: 682028,\n                type: ImageOptimizationType.VIDEO_FORMAT,\n              },\n            ],\n            url:\n                'https://raw.githubusercontent.com/GoogleChrome/lighthouse/refs/heads/main/cli/test/fixtures/dobetterweb/lighthouse-rotating.gif',\n          },\n          {\n            byteSavings: 176040,\n            optimizations: [\n              {\n                byteSavings: 134075,\n                type: ImageOptimizationType.MODERN_FORMAT_OR_COMPRESSION,\n              },\n              {\n                byteSavings: 162947,\n                type: ImageOptimizationType.RESPONSIVE_SIZE,\n                fileDimensions: {width: 640, height: 436},\n                displayDimensions: {width: 200, height: 136},\n              },\n            ],\n            url: 'https://onlinepngtools.com/images/examples-onlinepngtools/elephant-hd-quality.png',\n          },\n          {\n            byteSavings: 49760,\n            optimizations: [\n              {\n                byteSavings: 49760,\n                type: ImageOptimizationType.ADJUST_COMPRESSION,\n              },\n            ],\n            url:\n                'https://images.ctfassets.net/u275ja1nivmq/6T6z40ay5GFCUtwV7DONgh/0e23606ed1692d9721ab0f39a8d8a99e/yeti_cover.jpg?fm=webp',\n          },\n          {\n            byteSavings: 41421,\n            optimizations: [\n              {\n                byteSavings: 41421,\n                type: ImageOptimizationType.RESPONSIVE_SIZE,\n                fileDimensions: {width: 2048, height: 1356},\n                displayDimensions: {width: 200, height: 132},\n              },\n            ],\n            url:\n                'https://raw.githubusercontent.com/GoogleChrome/lighthouse/refs/heads/main/cli/test/fixtures/byte-efficiency/lighthouse-2048x1356.webp',\n          },\n        ],\n    );\n  });\n\n  it('handles responsive image exceptions', async () => {\n    const {data, insights} = await processTrace(this, 'byte-efficiency.json.gz');\n\n    const insight =\n        getInsightOrError('ImageDelivery', insights, getFirstOrError(data.Meta.navigationsByNavigationId.values()));\n    assert.deepEqual(\n        insight.optimizableImages.map(o => o.request.args.data.url).sort(),\n        [\n          // Several additional images would be in this list if we did not ignore them\n          // - A <picture> image\n          // - An image with `srcset`\n          // - CSS background images\n          'http://localhost:10200/byte-efficiency/lighthouse-1024x680.jpg',\n          'http://localhost:10200/byte-efficiency/lighthouse-480x320.jpg',\n          'http://localhost:10200/byte-efficiency/lighthouse-480x320.jpg?attributesized',\n          'http://localhost:10200/byte-efficiency/lighthouse-480x320.webp',\n          // TODO(b/400518751): Assume 2 viewport size for image that isn't rendered.\n          // https://github.com/GoogleChrome/lighthouse/issues/7236\n          // 'localhost:10200/byte-efficiency/lighthouse-2048x1356.webp?size0'\n        ],\n    );\n  });\n});\n"]}