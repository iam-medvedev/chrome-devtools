{"version":3,"file":"ThirdParties.test.js","sourceRoot":"","sources":["../../../../../../../front_end/models/trace/insights/ThirdParties.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport {describeWithEnvironment} from '../../../testing/EnvironmentHelpers.js';\nimport {getFirstOrError, getInsightOrError, processTrace} from '../../../testing/InsightHelpers.js';\nimport * as Trace from '../../trace/trace.js';\n\ndescribeWithEnvironment('ThirdParties', function() {\n  it('categorizes third party web requests (simple)', async () => {\n    const {data, insights} = await processTrace(this, 'load-simple.json.gz');\n    assert.strictEqual(insights.size, 2);\n    const insight =\n        getInsightOrError('ThirdParties', insights, getFirstOrError(data.Meta.navigationsByNavigationId.values()));\n\n    const entityNames = [...insight.summaryByEntity.keys()].map(entity => entity.name).sort();\n    assert.deepEqual([...new Set(entityNames)], [\n      'Google Fonts',\n      'localhost',\n    ]);\n\n    const results = [...insight.eventsByEntity.entries()].map(([entity, events]) => {\n      const requests = events.filter(event => Trace.Types.Events.isSyntheticNetworkRequest(event));\n      return [\n        entity.name,\n        [\n          `Total events: ${events.length}`,\n          ...requests.map(request => request.args.data.url).sort(),\n        ]\n      ];\n    });\n    assert.deepEqual(\n        results,\n        [\n          [\n            'localhost',\n            [\n              'Total events: 17',\n              'http://localhost:8080/',\n              'http://localhost:8080/blocking.js',\n              'http://localhost:8080/module.js',\n              'http://localhost:8080/styles.css',\n            ],\n          ],\n          [\n            'Google Fonts',\n            [\n              'Total events: 2',\n              'https://fonts.googleapis.com/css2?family=Orelega+One&display=swap',\n              'https://fonts.gstatic.com/s/orelegaone/v1/3qTpojOggD2XtAdFb-QXZFt93kY.woff2',\n            ],\n          ],\n        ],\n    );\n\n    const summaryResult = [...insight.summaryByEntity.entries()].map(([entity, summary]) => {\n      return [entity.name, summary];\n    });\n    assert.deepEqual(summaryResult, [\n      ['localhost', {transferSize: 751, mainThreadTime: 26381}],\n      ['Google Fonts', {transferSize: 0, mainThreadTime: 0}],\n    ]);\n  });\n\n  it('categorizes third party web requests (complex)', async () => {\n    const {data, insights} = await processTrace(this, 'lantern/paul/trace.json.gz');\n    assert.strictEqual(insights.size, 1);\n    const insight =\n        getInsightOrError('ThirdParties', insights, getFirstOrError(data.Meta.navigationsByNavigationId.values()));\n\n    const entityNames = [...insight.summaryByEntity.keys()].map(entity => entity.name).sort();\n    assert.deepEqual([...new Set(entityNames)], [\n      'Disqus',\n      'Firebase',\n      'Google Analytics',\n      'Google Fonts',\n      'Google Tag Manager',\n      'paulirish.com',\n    ]);\n\n    const results = [...insight.eventsByEntity.entries()].map(([entity, events]) => {\n      const requests = events.filter(event => Trace.Types.Events.isSyntheticNetworkRequest(event));\n      return [\n        entity.name,\n        [\n          `Total events: ${events.length}`,\n          ...requests.map(request => request.args.data.url).sort(),\n        ]\n      ];\n    });\n    assert.deepEqual(\n        results,\n        [\n          [\n            'paulirish.com',\n            [\n              'Total events: 1460',\n              'https://www.paulirish.com/',\n              'https://www.paulirish.com/assets/wikipedia-flamechart.jpg',\n              'https://www.paulirish.com/avatar150.jpg',\n              'https://www.paulirish.com/favicon.ico',\n              'https://www.paulirish.com/images/code_bg.png?1418840251',\n              'https://www.paulirish.com/images/noise.png?1418840251',\n              'https://www.paulirish.com/javascripts/ender.js',\n              'https://www.paulirish.com/javascripts/firebase-performance-standalone.js',\n              'https://www.paulirish.com/javascripts/modernizr-2.0.js',\n              'https://www.paulirish.com/javascripts/octopress.js',\n            ],\n          ],\n          [\n            'Google Tag Manager',\n            [\n              'Total events: 25',\n              'https://www.googletagmanager.com/gtag/js?id=G-PGXNGYWP8E',\n            ],\n          ],\n          [\n            'Disqus',\n            [\n              'Total events: 3',\n              'https://paulirish.disqus.com/count.js',\n            ],\n          ],\n          [\n            'Google Analytics',\n            [\n              'Total events: 13',\n              'https://www.google-analytics.com/analytics.js',\n              'https://www.google-analytics.com/g/collect?v=2&tid=G-PGXNGYWP8E&gtm=45je4580v880158425za200&_p=1715625261583&gcd=13l3l3l3l1&npa=0&dma=0&cid=414801335.1715625262&ul=en-us&sr=412x823&uaa=&uab=64&uafvl=Not%252FA)Brand%3B8.0.0.0%7CChromium%3B126.0.6475.0%7CGoogle%2520Chrome%3B126.0.6475.0&uamb=1&uam=moto%20g%20power%20(2022)&uap=Android&uapv=11.0&uaw=0&are=1&frm=0&pscdl=noapi&_s=1&sid=1715625261&sct=1&seg=0&dl=https%3A%2F%2Fwww.paulirish.com%2F&dt=Paul%20Irish&en=page_view&_fv=1&_nsi=1&_ss=1&_ee=1&tfd=353',\n              'https://www.google-analytics.com/j/collect?v=1&_v=j101&a=272264939&t=pageview&_s=1&dl=https%3A%2F%2Fwww.paulirish.com%2F&ul=en-us&de=UTF-8&dt=Paul%20Irish&sd=30-bit&sr=412x823&vp=412x823&je=0&_u=IADAAEABAAAAACAAI~&jid=1388679807&gjid=654531532&cid=414801335.1715625262&tid=UA-692547-2&_gid=1964734610.1715625262&_r=1&_slc=1&z=1746264594',\n            ],\n          ],\n          [\n            'Google Fonts',\n            [\n              'Total events: 7',\n              'https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold|PT+Sans:regular,italic,bold|Droid+Sans:400,700|Lato:700,900',\n              'https://fonts.gstatic.com/s/droidsans/v18/SlGVmQWMvZQIdix7AFxXkHNSbRYXags.woff2',\n              'https://fonts.gstatic.com/s/droidsans/v18/SlGWmQWMvZQIdix7AFxXmMh3eDs1ZyHKpWg.woff2',\n              'https://fonts.gstatic.com/s/lato/v24/S6u9w4BMUTPHh6UVSwiPGQ3q5d0.woff2',\n              'https://fonts.gstatic.com/s/ptsans/v17/jizaRExUiTo99u79D0KExcOPIDU.woff2',\n              'https://fonts.gstatic.com/s/ptsans/v17/jizfRExUiTo99u79B_mh0O6tLR8a8zI.woff2',\n              'https://fonts.gstatic.com/s/ptserif/v18/EJRVQgYoZZY2vCFuvAFWzr-_dSb_.woff2',\n            ],\n          ],\n          [\n            'Firebase',\n            [\n              'Total events: 2',\n              'https://firebaseinstallations.googleapis.com/v1/projects/paulirishcom/installations',\n              'https://firebaseremoteconfig.googleapis.com/v1/projects/paulirishcom/namespaces/fireperf:fetch?key=AIzaSyCGxLbbFQxH4BV1fY0RODlxTos9nJa2l_g',\n            ],\n          ],\n        ],\n    );\n\n    const summaryResult = [...insight.summaryByEntity.entries()].map(([entity, summary]) => {\n      return [entity.name, summary];\n    });\n    assert.deepEqual(summaryResult, [\n      ['paulirish.com', {transferSize: 157130, mainThreadTime: 6626}],\n      ['Google Tag Manager', {transferSize: 95375, mainThreadTime: 83}],\n      ['Disqus', {transferSize: 1551, mainThreadTime: 23}],\n      ['Google Analytics', {transferSize: 20865, mainThreadTime: 97}],\n      ['Google Fonts', {transferSize: 80003, mainThreadTime: 0}],\n      ['Firebase', {transferSize: 2847, mainThreadTime: 0}],\n    ]);\n  });\n});\n"]}