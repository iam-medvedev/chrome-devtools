{"version":3,"file":"LiveMetrics.test.js","sourceRoot":"","sources":["../../../../../../front_end/models/live-metrics/LiveMetrics.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2026 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as SDK from '../../core/sdk/sdk.js';\nimport type * as Trace from '../../models/trace/trace.js';\nimport {createTarget} from '../../testing/EnvironmentHelpers.js';\nimport {describeWithMockConnection} from '../../testing/MockConnection.js';\n\nimport * as LiveMetrics from './live-metrics.js';\n\ntype Milli = Trace.Types.Timing.Milli;\n\ndescribeWithMockConnection('LiveMetrics', () => {\n  let liveMetrics: LiveMetrics.LiveMetrics;\n  let primaryTarget: SDK.Target.Target;\n  let tabTarget: SDK.Target.Target;\n\n  beforeEach(() => {\n    tabTarget = createTarget({type: SDK.Target.Type.TAB});\n    primaryTarget = createTarget({\n      parentTarget: tabTarget,\n      type: SDK.Target.Type.FRAME,\n    });\n    liveMetrics = LiveMetrics.LiveMetrics.instance({forceNew: true});\n  });\n\n  describe('prerender navigation', () => {\n    it('handles target removal gracefully', async () => {\n      await liveMetrics.targetRemoved(primaryTarget);\n\n      assert.strictEqual(liveMetrics.interactions.size, 0);\n      assert.lengthOf(liveMetrics.layoutShifts, 0);\n    });\n\n    it('re-enables on a new target after target removal', async () => {\n      await liveMetrics.targetRemoved(primaryTarget);\n\n      const newPrimaryTarget = createTarget({\n        parentTarget: tabTarget,\n        type: SDK.Target.Type.FRAME,\n      });\n\n      await liveMetrics.targetAdded(newPrimaryTarget);\n\n      assert.isUndefined(liveMetrics.lcpValue);\n      assert.isUndefined(liveMetrics.clsValue);\n      assert.isUndefined(liveMetrics.inpValue);\n    });\n\n    it('handles rapid target swap during prerender activation', async () => {\n      const removePromise = liveMetrics.targetRemoved(primaryTarget);\n\n      const prerenderTarget = createTarget({\n        parentTarget: tabTarget,\n        type: SDK.Target.Type.FRAME,\n      });\n\n      await removePromise;\n      await liveMetrics.targetAdded(prerenderTarget);\n\n      assert.strictEqual(liveMetrics.interactions.size, 0);\n      assert.lengthOf(liveMetrics.layoutShifts, 0);\n    });\n  });\n\n  describe('status updates', () => {\n    it('dispatches status events', () => {\n      let statusReceived = false;\n      liveMetrics.addEventListener(LiveMetrics.Events.STATUS, () => {\n        statusReceived = true;\n      });\n\n      liveMetrics.setStatusForTesting({\n        interactions: new Map(),\n        layoutShifts: [],\n      });\n\n      assert.isTrue(statusReceived);\n    });\n\n    it('clears interactions via clearInteractions', () => {\n      const interactionId = 'interaction-1-1' as LiveMetrics.InteractionId;\n      const interaction: LiveMetrics.Interaction = {\n        interactionId,\n        interactionType: 'pointer',\n        eventNames: ['click'],\n        duration: 100,\n        startTime: 0,\n        nextPaintTime: 100,\n        phases: {inputDelay: 10 as Milli, processingDuration: 80 as Milli, presentationDelay: 10 as Milli},\n        longAnimationFrameTimings: [],\n      };\n\n      liveMetrics.setStatusForTesting({\n        interactions: new Map([[interactionId, interaction]]),\n        layoutShifts: [],\n      });\n\n      assert.strictEqual(liveMetrics.interactions.size, 1);\n\n      liveMetrics.clearInteractions();\n\n      assert.strictEqual(liveMetrics.interactions.size, 0);\n    });\n\n    it('clears layout shifts via clearLayoutShifts', () => {\n      liveMetrics.setStatusForTesting({\n        interactions: new Map(),\n        layoutShifts: [\n          {score: 0.1, uniqueLayoutShiftId: 'layout-shift-1-1', affectedNodeRefs: []},\n        ],\n      });\n\n      assert.lengthOf(liveMetrics.layoutShifts, 1);\n\n      liveMetrics.clearLayoutShifts();\n\n      assert.lengthOf(liveMetrics.layoutShifts, 0);\n    });\n  });\n});\n"]}