{"version":3,"file":"LiveMetrics.js","sourceRoot":"","sources":["../../../../../../front_end/models/live-metrics/LiveMetrics.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../core/common/common.js';\nimport * as Host from '../../core/host/host.js';\nimport * as i18n from '../../core/i18n/i18n.js';\nimport * as Platform from '../../core/platform/platform.js';\nimport * as SDK from '../../core/sdk/sdk.js';\nimport type * as Protocol from '../../generated/protocol.js';\nimport * as EmulationModel from '../../models/emulation/emulation.js';\n\nimport * as Spec from './web-vitals-injected/spec/spec.js';\n\nconst UIStrings = {\n  /**\n   * @description Warning text indicating that the Largest Contentful Paint (LCP) performance metric was affected by the user changing the simulated device.\n   */\n  lcpEmulationWarning:\n      'Simulating a new device after the page loads can affect LCP. Reload the page after simulating a new device for accurate LCP data.',\n  /**\n   * @description Warning text indicating that the Largest Contentful Paint (LCP) performance metric was affected by the page loading in the background.\n   */\n  lcpVisibilityWarning: 'LCP value may be inflated because the page started loading in the background.',\n} as const;\n\nconst str_ = i18n.i18n.registerUIStrings('models/live-metrics/LiveMetrics.ts', UIStrings);\nconst i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\n\nconst LIVE_METRICS_WORLD_NAME = 'DevTools Performance Metrics';\n\nlet liveMetricsInstance: LiveMetrics;\n\nclass InjectedScript {\n  static #injectedScript?: string;\n  static async get(): Promise<string> {\n    if (!this.#injectedScript) {\n      const url = new URL('./web-vitals-injected/web-vitals-injected.generated.js', import.meta.url);\n      const result = await fetch(url);\n      this.#injectedScript = await result.text();\n    }\n    return this.#injectedScript;\n  }\n}\n\nexport type InteractionMap = Map<InteractionId, Interaction>;\n\nexport class LiveMetrics extends Common.ObjectWrapper.ObjectWrapper<EventTypes> implements SDK.TargetManager.Observer {\n  #enabled = false;\n  #target?: SDK.Target.Target;\n  #scriptIdentifier?: Protocol.Page.ScriptIdentifier;\n  #lastResetContextId?: Protocol.Runtime.ExecutionContextId;\n  #lcpValue?: LcpValue;\n  #clsValue?: ClsValue;\n  #inpValue?: InpValue;\n  #interactions: InteractionMap = new Map();\n  #interactionsByGroupId = new Map<Spec.InteractionEntryGroupId, Interaction[]>();\n  #layoutShifts: LayoutShift[] = [];\n  #lastEmulationChangeTime?: number;\n  #mutex = new Common.Mutex.Mutex();\n  #deviceModeModel = EmulationModel.DeviceModeModel.DeviceModeModel.tryInstance();\n\n  private constructor() {\n    super();\n    SDK.TargetManager.TargetManager.instance().observeTargets(this);\n  }\n\n  static instance(opts: {forceNew?: boolean} = {forceNew: false}): LiveMetrics {\n    const {forceNew} = opts;\n    if (!liveMetricsInstance || forceNew) {\n      liveMetricsInstance = new LiveMetrics();\n    }\n\n    return liveMetricsInstance;\n  }\n\n  get lcpValue(): LcpValue|undefined {\n    return this.#lcpValue;\n  }\n\n  get clsValue(): ClsValue|undefined {\n    return this.#clsValue;\n  }\n\n  get inpValue(): InpValue|undefined {\n    return this.#inpValue;\n  }\n\n  get interactions(): InteractionMap {\n    return this.#interactions;\n  }\n\n  get layoutShifts(): LayoutShift[] {\n    return this.#layoutShifts;\n  }\n\n  /**\n   * Will create a log message describing the interaction's LoAF scripts.\n   * Returns true if the message is successfully logged.\n   */\n  async logInteractionScripts(interaction: Interaction): Promise<boolean> {\n    if (!this.#target) {\n      return false;\n    }\n\n    const executionContextId = this.#lastResetContextId;\n    if (!executionContextId) {\n      return false;\n    }\n\n    const scriptsTable = [];\n    for (const loaf of interaction.longAnimationFrameTimings) {\n      for (const script of loaf.scripts) {\n        const scriptEndTime = script.startTime + script.duration;\n        if (scriptEndTime < interaction.startTime) {\n          continue;\n        }\n\n        const blockingDuration = Math.round(scriptEndTime - Math.max(interaction.startTime, script.startTime));\n\n        // TODO: Use translated strings for the table\n        scriptsTable.push({\n          'Blocking duration': blockingDuration,\n          'Invoker type': script.invokerType || null,\n          Invoker: script.invoker || null,\n          Function: script.sourceFunctionName || null,\n          Source: script.sourceURL || null,\n          'Char position': script.sourceCharPosition || null,\n        });\n      }\n    }\n\n    try {\n      const scriptsLimit = Spec.LOAF_LIMIT * Spec.SCRIPTS_PER_LOAF_LIMIT;\n      const scriptLimitText = scriptsTable.length === scriptsLimit ? ` (limited to ${scriptsLimit})` : '';\n      const loafLimitText = interaction.longAnimationFrameTimings.length === Spec.LOAF_LIMIT ?\n          ` (limited to last ${Spec.LOAF_LIMIT})` :\n          '';\n      await this.#target.runtimeAgent().invoke_evaluate({\n        expression: `\n          console.group('[DevTools] Long animation frames for ${interaction.duration}ms ${\n            interaction.interactionType} interaction');\n          console.log('Scripts${scriptLimitText}:');\n          console.table(${JSON.stringify(scriptsTable)});\n          console.log('Intersecting long animation frame events${loafLimitText}:', ${\n            JSON.stringify(interaction.longAnimationFrameTimings)});\n          console.groupEnd();\n        `,\n        contextId: executionContextId,\n      });\n    } catch {\n      return false;\n    }\n\n    return true;\n  }\n\n  #onEmulationChanged(): void {\n    this.#lastEmulationChangeTime = Date.now();\n  }\n\n  /**\n   * DOM nodes can't be sent over a runtime binding, so we have to retrieve\n   * them separately.\n   */\n  async #resolveNodeRef(index: number, executionContextId: Protocol.Runtime.ExecutionContextId): Promise<NodeRef|null> {\n    if (!this.#target) {\n      return null;\n    }\n\n    const runtimeModel = this.#target.model(SDK.RuntimeModel.RuntimeModel);\n    if (!runtimeModel) {\n      return null;\n    }\n\n    const domModel = this.#target.model(SDK.DOMModel.DOMModel);\n    if (!domModel) {\n      return null;\n    }\n\n    const {result} = await this.#target.runtimeAgent().invoke_evaluate({\n      expression: `window.getNodeForIndex(${index})`,\n      contextId: executionContextId,\n    });\n\n    if (!result) {\n      return null;\n    }\n\n    let remoteObject;\n    try {\n      remoteObject = runtimeModel.createRemoteObject(result);\n      const node = await domModel.pushObjectAsNodeToFrontend(remoteObject);\n      if (!node) {\n        return null;\n      }\n\n      const link = await Common.Linkifier.Linkifier.linkify(node);\n      return {node, link};\n    } catch {\n      return null;\n    } finally {\n      remoteObject?.release();\n    }\n  }\n\n  #sendStatusUpdate(): void {\n    this.dispatchEventToListeners(Events.STATUS, {\n      lcp: this.#lcpValue,\n      cls: this.#clsValue,\n      inp: this.#inpValue,\n      interactions: this.#interactions,\n      layoutShifts: this.#layoutShifts,\n    });\n  }\n\n  setStatusForTesting(status: StatusEvent): void {\n    this.#lcpValue = status.lcp;\n    this.#clsValue = status.cls;\n    this.#inpValue = status.inp;\n    this.#interactions = status.interactions;\n    this.#layoutShifts = status.layoutShifts;\n    this.#sendStatusUpdate();\n  }\n\n  /**\n   * If there is a document update then any node handles we have already resolved will be invalid.\n   * This function should re-resolve any relevant DOM nodes after a document update.\n   */\n  async #onDocumentUpdate(event: Common.EventTarget.EventTargetEvent<SDK.DOMModel.DOMModel>): Promise<void> {\n    const domModel = event.data;\n\n    const toRefresh = [\n      this.#lcpValue?.nodeRef,\n      ...this.#interactions.values().map(i => i.nodeRef),\n      ...this.#layoutShifts.flatMap(shift => shift.affectedNodeRefs),\n    ].filter((nodeRef): nodeRef is NodeRef => Boolean(nodeRef));\n\n    const idsToRefresh = new Set(toRefresh.map(nodeRef => nodeRef.node.backendNodeId()));\n    const nodes = await domModel.pushNodesByBackendIdsToFrontend(idsToRefresh);\n    if (!nodes) {\n      return;\n    }\n\n    const allPromises = toRefresh.map(async nodeRef => {\n      const refreshedNode = nodes.get(nodeRef.node.backendNodeId());\n\n      // It is possible for the refreshed node to be undefined even though it was defined previously.\n      // We should keep the affected nodes consistent from the user perspective, so we will just keep the stale node instead of removing it.\n      if (!refreshedNode) {\n        return;\n      }\n\n      nodeRef.node = refreshedNode;\n      nodeRef.link = await Common.Linkifier.Linkifier.linkify(refreshedNode);\n    });\n\n    await Promise.all(allPromises);\n\n    this.#sendStatusUpdate();\n  }\n\n  async #handleWebVitalsEvent(\n      webVitalsEvent: Spec.WebVitalsEvent, executionContextId: Protocol.Runtime.ExecutionContextId): Promise<void> {\n    switch (webVitalsEvent.name) {\n      case 'LCP': {\n        const warnings: string[] = [];\n        const lcpEvent: LcpValue = {\n          value: webVitalsEvent.value,\n          phases: webVitalsEvent.phases,\n          warnings,\n        };\n        if (webVitalsEvent.nodeIndex !== undefined) {\n          const nodeRef = await this.#resolveNodeRef(webVitalsEvent.nodeIndex, executionContextId);\n          if (nodeRef) {\n            lcpEvent.nodeRef = nodeRef;\n          }\n        }\n\n        if (this.#lastEmulationChangeTime && Date.now() - this.#lastEmulationChangeTime < 500) {\n          warnings.push(i18nString(UIStrings.lcpEmulationWarning));\n        }\n\n        if (webVitalsEvent.startedHidden) {\n          warnings.push(i18nString(UIStrings.lcpVisibilityWarning));\n        }\n\n        this.#lcpValue = lcpEvent;\n        break;\n      }\n      case 'CLS': {\n        const event: ClsValue = {\n          value: webVitalsEvent.value,\n          clusterShiftIds: webVitalsEvent.clusterShiftIds,\n        };\n        this.#clsValue = event;\n        break;\n      }\n      case 'INP': {\n        const inpEvent: InpValue = {\n          value: webVitalsEvent.value,\n          phases: webVitalsEvent.phases,\n          interactionId: `interaction-${webVitalsEvent.entryGroupId}-${webVitalsEvent.startTime}`,\n        };\n        this.#inpValue = inpEvent;\n        break;\n      }\n      case 'InteractionEntry': {\n        const groupInteractions =\n            Platform.MapUtilities.getWithDefault(this.#interactionsByGroupId, webVitalsEvent.entryGroupId, () => []);\n\n        // `nextPaintTime` uses the event duration which is rounded to the nearest 8ms. The best we can do\n        // is check if the `nextPaintTime`s are within 8ms.\n        // https://developer.mozilla.org/en-US/docs/Web/API/PerformanceEntry/duration#event\n        let interaction = groupInteractions.find(\n            interaction => Math.abs(interaction.nextPaintTime - webVitalsEvent.nextPaintTime) < 8);\n\n        if (!interaction) {\n          interaction = {\n            interactionId: `interaction-${webVitalsEvent.entryGroupId}-${webVitalsEvent.startTime}`,\n            interactionType: webVitalsEvent.interactionType,\n            duration: webVitalsEvent.duration,\n            eventNames: [],\n            phases: webVitalsEvent.phases,\n            startTime: webVitalsEvent.startTime,\n            nextPaintTime: webVitalsEvent.nextPaintTime,\n            longAnimationFrameTimings: webVitalsEvent.longAnimationFrameEntries,\n          };\n\n          groupInteractions.push(interaction);\n          this.#interactions.set(interaction.interactionId, interaction);\n        }\n\n        // We can get multiple instances of the first input interaction since web-vitals.js installs\n        // an extra listener for events of type `first-input`. This is a simple way to de-dupe those\n        // events without adding complexity to the injected code.\n        if (!interaction.eventNames.includes(webVitalsEvent.eventName)) {\n          interaction.eventNames.push(webVitalsEvent.eventName);\n        }\n\n        if (webVitalsEvent.nodeIndex !== undefined) {\n          const node = await this.#resolveNodeRef(webVitalsEvent.nodeIndex, executionContextId);\n          if (node) {\n            interaction.nodeRef = node;\n          }\n        }\n        break;\n      }\n      case 'LayoutShift': {\n        const nodePromises = webVitalsEvent.affectedNodeIndices.map(nodeIndex => {\n          return this.#resolveNodeRef(nodeIndex, executionContextId);\n        });\n\n        const affectedNodes =\n            (await Promise.all(nodePromises)).filter((nodeRef): nodeRef is NodeRef => Boolean(nodeRef));\n\n        const layoutShift: LayoutShift = {\n          score: webVitalsEvent.score,\n          uniqueLayoutShiftId: webVitalsEvent.uniqueLayoutShiftId,\n          affectedNodeRefs: affectedNodes,\n        };\n        this.#layoutShifts.push(layoutShift);\n        break;\n      }\n      case 'reset': {\n        this.#lcpValue = undefined;\n        this.#clsValue = undefined;\n        this.#inpValue = undefined;\n        this.#interactions.clear();\n        this.#layoutShifts = [];\n        break;\n      }\n    }\n\n    this.#sendStatusUpdate();\n  }\n\n  async #getFrameForExecutionContextId(executionContextId: Protocol.Runtime.ExecutionContextId):\n      Promise<SDK.ResourceTreeModel.ResourceTreeFrame|null> {\n    if (!this.#target) {\n      return null;\n    }\n\n    const runtimeModel = this.#target.model(SDK.RuntimeModel.RuntimeModel);\n    if (!runtimeModel) {\n      return null;\n    }\n\n    const executionContext = runtimeModel.executionContext(executionContextId);\n    if (!executionContext) {\n      return null;\n    }\n\n    const frameId = executionContext.frameId;\n    if (!frameId) {\n      return null;\n    }\n\n    const frameManager = SDK.FrameManager.FrameManager.instance();\n    return await frameManager.getOrWaitForFrame(frameId);\n  }\n\n  async #onBindingCalled(event: {data: Protocol.Runtime.BindingCalledEvent}): Promise<void> {\n    const {data} = event;\n    if (data.name !== Spec.EVENT_BINDING_NAME) {\n      return;\n    }\n\n    // Async tasks can be performed while handling an event (e.g. resolving DOM node)\n    // Use a mutex here to ensure the events are handled in the order they are received.\n    await this.#mutex.run(async () => {\n      const webVitalsEvent = JSON.parse(data.payload) as Spec.WebVitalsEvent;\n\n      // This ensures that `#lastResetContextId` will always be an execution context on the\n      // primary frame. If we receive events from this execution context then we automatically\n      // know that they are for the primary frame.\n      if (this.#lastResetContextId !== data.executionContextId) {\n        if (webVitalsEvent.name !== 'reset') {\n          return;\n        }\n\n        // We should avoid calling this function for every event.\n        // If an interaction triggers a pre-rendered navigation then the old primary frame could\n        // be removed before we reach this point, and then it will hang forever.\n        const frame = await this.#getFrameForExecutionContextId(data.executionContextId);\n        if (!frame?.isPrimaryFrame()) {\n          return;\n        }\n\n        this.#lastResetContextId = data.executionContextId;\n      }\n\n      await this.#handleWebVitalsEvent(webVitalsEvent, data.executionContextId);\n    });\n  }\n\n  async #killAllLiveMetricContexts(): Promise<void> {\n    const target = this.#target;\n    if (!target) {\n      return;\n    }\n\n    const runtimeModel = target.model(SDK.RuntimeModel.RuntimeModel);\n    if (!runtimeModel) {\n      return;\n    }\n\n    const killPromises = runtimeModel.executionContexts()\n                             .filter(e => e.name === LIVE_METRICS_WORLD_NAME && !e.isDefault)\n                             .map(e => target.runtimeAgent().invoke_evaluate({\n                               // On the off chance something else creates execution contexts with the exact same name\n                               // this expression should just be a noop.\n                               expression: `window?.${Spec.INTERNAL_KILL_SWITCH}?.()`,\n                               contextId: e.id,\n                             }));\n\n    await Promise.all(killPromises);\n  }\n\n  clearInteractions(): void {\n    this.#interactions.clear();\n    this.#sendStatusUpdate();\n  }\n\n  clearLayoutShifts(): void {\n    this.#layoutShifts = [];\n    this.#sendStatusUpdate();\n  }\n\n  async targetAdded(target: SDK.Target.Target): Promise<void> {\n    if (target !== SDK.TargetManager.TargetManager.instance().primaryPageTarget()) {\n      return;\n    }\n    this.#target = target;\n    await this.enable();\n  }\n\n  async targetRemoved(target: SDK.Target.Target): Promise<void> {\n    if (target !== this.#target) {\n      return;\n    }\n    await this.disable();\n    this.#target = undefined;\n\n    // If the user navigates to a page that was pre-rendered then the primary page target\n    // will be swapped and the old target will be removed. We should ensure live metrics\n    // remain enabled on the new primary page target.\n    const primaryPageTarget = SDK.TargetManager.TargetManager.instance().primaryPageTarget();\n    if (primaryPageTarget) {\n      this.#target = primaryPageTarget;\n      await this.enable();\n    }\n  }\n\n  async enable(): Promise<void> {\n    if (Host.InspectorFrontendHost.isUnderTest()) {\n      // Enabling this impacts a lot of layout tests; we will work on fixing\n      // them but for now it is easier to not run this page in layout tests.\n      // b/360064852\n      return;\n    }\n\n    if (!this.#target || this.#enabled) {\n      return;\n    }\n\n    // Only frame targets will actually give us CWV\n    if (this.#target.type() !== SDK.Target.Type.FRAME) {\n      return;\n    }\n\n    const domModel = this.#target.model(SDK.DOMModel.DOMModel);\n    if (!domModel) {\n      return;\n    }\n\n    domModel.addEventListener(SDK.DOMModel.Events.DocumentUpdated, this.#onDocumentUpdate, this);\n\n    const runtimeModel = this.#target.model(SDK.RuntimeModel.RuntimeModel);\n    if (!runtimeModel) {\n      return;\n    }\n\n    runtimeModel.addEventListener(SDK.RuntimeModel.Events.BindingCalled, this.#onBindingCalled, this);\n\n    await runtimeModel.addBinding({\n      name: Spec.EVENT_BINDING_NAME,\n      executionContextName: LIVE_METRICS_WORLD_NAME,\n    });\n\n    // If DevTools is closed and reopened, the live metrics context from the previous\n    // session will persist. We should ensure any old live metrics contexts are killed\n    // before starting a new one.\n    await this.#killAllLiveMetricContexts();\n\n    const source = await InjectedScript.get();\n\n    const {identifier} = await this.#target.pageAgent().invoke_addScriptToEvaluateOnNewDocument({\n      source,\n      worldName: LIVE_METRICS_WORLD_NAME,\n      runImmediately: true,\n    });\n    this.#scriptIdentifier = identifier;\n\n    this.#deviceModeModel?.addEventListener(\n        EmulationModel.DeviceModeModel.Events.UPDATED, this.#onEmulationChanged, this);\n\n    this.#enabled = true;\n  }\n\n  async disable(): Promise<void> {\n    if (!this.#target || !this.#enabled) {\n      return;\n    }\n\n    await this.#killAllLiveMetricContexts();\n\n    const runtimeModel = this.#target.model(SDK.RuntimeModel.RuntimeModel);\n    if (runtimeModel) {\n      await runtimeModel.removeBinding({\n        name: Spec.EVENT_BINDING_NAME,\n      });\n\n      runtimeModel.removeEventListener(SDK.RuntimeModel.Events.BindingCalled, this.#onBindingCalled, this);\n    }\n\n    const domModel = this.#target.model(SDK.DOMModel.DOMModel);\n    if (domModel) {\n      domModel.removeEventListener(SDK.DOMModel.Events.DocumentUpdated, this.#onDocumentUpdate, this);\n    }\n\n    if (this.#scriptIdentifier) {\n      await this.#target.pageAgent().invoke_removeScriptToEvaluateOnNewDocument({\n        identifier: this.#scriptIdentifier,\n      });\n    }\n    this.#scriptIdentifier = undefined;\n\n    this.#deviceModeModel?.removeEventListener(\n        EmulationModel.DeviceModeModel.Events.UPDATED, this.#onEmulationChanged, this);\n\n    this.#enabled = false;\n  }\n}\n\nexport const enum Events {\n  STATUS = 'status',\n}\n\nexport type InteractionId = `interaction-${number}-${number}`;\n\nexport interface MetricValue {\n  value: number;\n  warnings?: string[];\n}\n\nexport interface NodeRef {\n  node: SDK.DOMModel.DOMNode;\n  link: Node;\n}\n\nexport interface LcpValue extends MetricValue {\n  phases: Spec.LcpPhases;\n  nodeRef?: NodeRef;\n}\n\nexport interface InpValue extends MetricValue {\n  phases: Spec.InpPhases;\n  interactionId: InteractionId;\n}\n\nexport interface ClsValue extends MetricValue {\n  clusterShiftIds: Spec.UniqueLayoutShiftId[];\n}\n\nexport interface LayoutShift {\n  score: number;\n  uniqueLayoutShiftId: Spec.UniqueLayoutShiftId;\n  affectedNodeRefs: NodeRef[];\n}\n\nexport interface Interaction {\n  interactionId: InteractionId;\n  interactionType: Spec.InteractionEntryEvent['interactionType'];\n  eventNames: string[];\n  duration: number;\n  startTime: number;\n  nextPaintTime: number;\n  phases: Spec.InpPhases;\n  longAnimationFrameTimings: Spec.PerformanceLongAnimationFrameTimingJSON[];\n  nodeRef?: NodeRef;\n}\n\nexport interface StatusEvent {\n  lcp?: LcpValue;\n  cls?: ClsValue;\n  inp?: InpValue;\n  interactions: InteractionMap;\n  layoutShifts: LayoutShift[];\n}\n\ninterface EventTypes {\n  [Events.STATUS]: StatusEvent;\n}\n"]}