{"version":3,"file":"AiCodeCompletion.test.js","sourceRoot":"","sources":["../../../../../../front_end/models/ai_code_completion/AiCodeCompletion.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Host from '../../core/host/host.js';\nimport {\n  describeWithEnvironment,\n  updateHostConfig,\n} from '../../testing/EnvironmentHelpers.js';\nimport * as TextEditor from '../../ui/components/text_editor/text_editor.js';\n\nimport * as AiCodeCompletion from './ai_code_completion.js';\n\nconst DEFAULT_CURSOR_POSITION = 0;\n\nfunction createCallbacks(editor: TextEditor.TextEditor.TextEditor): AiCodeCompletion.AiCodeCompletion.Callbacks {\n  return {\n    getSelectionHead: () => editor.editor.state.selection.main.head,\n    getCompletionHint: () => editor.editor.plugin(TextEditor.Config.showCompletionHint)?.currentHint,\n    setAiAutoCompletion: (args: {\n      text: string,\n      from: number,\n      startTime: number,\n      onImpression: (rpcGlobalId: Host.AidaClient.RpcGlobalId, latency: number, sampleId?: number) => void,\n      clearCachedRequest: () => void,\n      rpcGlobalId?: Host.AidaClient.RpcGlobalId,\n      sampleId?: number,\n    }|null) => editor.dispatch({\n      effects: TextEditor.Config.setAiAutoCompleteSuggestion.of(args as unknown as TextEditor.Config.ActiveSuggestion)\n    }),\n  };\n}\n\ndescribeWithEnvironment('AiCodeCompletion', () => {\n  let clock: sinon.SinonFakeTimers;\n\n  beforeEach(() => {\n    clock = sinon.useFakeTimers();\n    updateHostConfig({\n      devToolsAiCodeCompletion: {\n        enabled: true,\n        temperature: 0.5,\n        modelId: 'test-model',\n        userTier: 'BETA',\n      },\n    });\n  });\n\n  afterEach(() => {\n    clock.restore();\n  });\n\n  it('builds a request and calls the AIDA client on text changed', async () => {\n    const completeCodeResponse = {\n      generatedSamples: [{\n        generationString: 'suggestion',\n        sampleId: 1,\n        score: 1,\n        attributionMetadata: {\n          attributionAction: Host.AidaClient.RecitationAction.CITE,\n          citations: [{uri: 'https://example.com'}],\n        },\n      }],\n      metadata: {rpcGlobalId: 1},\n    };\n    const mockAidaClient = sinon.createStubInstance(Host.AidaClient.AidaClient, {\n      completeCode: Promise.resolve(completeCodeResponse),\n    });\n    const aiCodeCompletion = new AiCodeCompletion.AiCodeCompletion.AiCodeCompletion(\n        {aidaClient: mockAidaClient},\n        AiCodeCompletion.AiCodeCompletion.ContextFlavor.CONSOLE,\n        createCallbacks(sinon.createStubInstance(TextEditor.TextEditor.TextEditor)),\n        ['\\n'],\n    );\n\n    const actualResponse = await aiCodeCompletion.completeCode('prefix', 'suffix', 6);\n\n    sinon.assert.calledOnce(mockAidaClient.completeCode);\n    const request = mockAidaClient.completeCode.firstCall.args[0];\n    assert.strictEqual(request.client, 'CHROME_DEVTOOLS');\n    assert.strictEqual(request.prefix, '\\nprefix');\n    assert.strictEqual(request.suffix, 'suffix');\n    assert.deepEqual(request.options, {\n      temperature: 0.5,\n      model_id: 'test-model',\n      inference_language: Host.AidaClient.AidaInferenceLanguage.JAVASCRIPT,\n      stop_sequences: ['\\n'],\n    });\n    assert.isFalse(actualResponse.fromCache);\n    assert.deepEqual(actualResponse.response, completeCodeResponse);\n  });\n\n  it('caches suggestions from AIDA', async () => {\n    const mockAidaClient = sinon.createStubInstance(Host.AidaClient.AidaClient, {\n      completeCode: Promise.resolve({\n        generatedSamples: [{\n          generationString: 'suggestion',\n          sampleId: 1,\n          score: 1,\n        }],\n        metadata: {\n          rpcGlobalId: 1,\n        },\n      }),\n    });\n    const aiCodeCompletion = new AiCodeCompletion.AiCodeCompletion.AiCodeCompletion(\n        {aidaClient: mockAidaClient},\n        AiCodeCompletion.AiCodeCompletion.ContextFlavor.CONSOLE,\n        createCallbacks(sinon.createStubInstance(TextEditor.TextEditor.TextEditor)),\n    );\n\n    await aiCodeCompletion.completeCode('prefix', 'suffix', DEFAULT_CURSOR_POSITION);\n    await aiCodeCompletion.completeCode('prefix', 'suffix', DEFAULT_CURSOR_POSITION);\n\n    sinon.assert.calledOnce(mockAidaClient.completeCode);\n  });\n\n  it('does not use cache for different requests', async () => {\n    const mockAidaClient = sinon.createStubInstance(Host.AidaClient.AidaClient, {\n      completeCode: Promise.resolve({\n        generatedSamples: [{\n          generationString: 'suggestion',\n          sampleId: 1,\n          score: 1,\n        }],\n        metadata: {},\n      }),\n    });\n    const aiCodeCompletion = new AiCodeCompletion.AiCodeCompletion.AiCodeCompletion(\n        {aidaClient: mockAidaClient},\n        AiCodeCompletion.AiCodeCompletion.ContextFlavor.CONSOLE,\n        createCallbacks(sinon.createStubInstance(TextEditor.TextEditor.TextEditor)),\n    );\n\n    await aiCodeCompletion.completeCode('prefix', 'suffix', DEFAULT_CURSOR_POSITION);\n    await aiCodeCompletion.completeCode('prefix re', 'suffix', DEFAULT_CURSOR_POSITION);\n\n    sinon.assert.calledTwice(mockAidaClient.completeCode);\n  });\n\n  it('does not use cache for different suffix', async () => {\n    const mockAidaClient = sinon.createStubInstance(Host.AidaClient.AidaClient, {\n      completeCode: Promise.resolve({\n        generatedSamples: [{\n          generationString: 'suggestion',\n          sampleId: 1,\n          score: 1,\n        }],\n        metadata: {},\n      }),\n    });\n    const aiCodeCompletion = new AiCodeCompletion.AiCodeCompletion.AiCodeCompletion(\n        {aidaClient: mockAidaClient},\n        AiCodeCompletion.AiCodeCompletion.ContextFlavor.CONSOLE,\n        createCallbacks(sinon.createStubInstance(TextEditor.TextEditor.TextEditor)),\n    );\n\n    await aiCodeCompletion.completeCode('prefix', 'suffix', DEFAULT_CURSOR_POSITION);\n    await aiCodeCompletion.completeCode('prefix', 'suffixes', DEFAULT_CURSOR_POSITION);\n\n    sinon.assert.calledTwice(mockAidaClient.completeCode);\n  });\n});\n"]}