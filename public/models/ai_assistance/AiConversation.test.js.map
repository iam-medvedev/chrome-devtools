{"version":3,"file":"AiConversation.test.js","sourceRoot":"","sources":["../../../../../../front_end/models/ai_assistance/AiConversation.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2026 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../core/common/common.js';\nimport * as Platform from '../../core/platform/platform.js';\nimport * as SDK from '../../core/sdk/sdk.js';\nimport {mockAidaClient} from '../../testing/AiAssistanceHelpers.js';\nimport {\n  describeWithEnvironment,\n  updateHostConfig,\n} from '../../testing/EnvironmentHelpers.js';\nimport * as Bindings from '../bindings/bindings.js';\nimport type * as NetworkTimeCalculator from '../network_time_calculator/network_time_calculator.js';\nimport * as Workspace from '../workspace/workspace.js';\n\nimport * as AiAssistance from './ai_assistance.js';\n\ndescribeWithEnvironment('AiConversation', () => {\n  beforeEach(() => {\n    const workspace = Workspace.Workspace.WorkspaceImpl.instance();\n    const targetManager = SDK.TargetManager.TargetManager.instance();\n    const resourceMapping = new Bindings.ResourceMapping.ResourceMapping(targetManager, workspace);\n    const ignoreListManager = Workspace.IgnoreListManager.IgnoreListManager.instance({forceNew: true});\n    Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance({\n      forceNew: true,\n      resourceMapping,\n      targetManager,\n      ignoreListManager,\n      workspace,\n    });\n  });\n\n  it('should be able to switch agent type based on context', async () => {\n    updateHostConfig({devToolsAiAssistanceContextSelectionAgent: {enabled: true}});\n\n    const conversation =\n        new AiAssistance.AiConversation.AiConversation(AiAssistance.AiHistoryStorage.ConversationType.STYLING);\n    const networkRequest = new AiAssistance.NetworkAgent.RequestContext(\n        {} as SDK.NetworkRequest.NetworkRequest, {} as NetworkTimeCalculator.NetworkTransferTimeCalculator);\n\n    conversation.setContext(networkRequest);\n\n    assert(conversation.type === AiAssistance.AiHistoryStorage.ConversationType.NETWORK);\n  });\n\n  it('should be able to switch agent type when context is removed', async () => {\n    updateHostConfig({devToolsAiAssistanceContextSelectionAgent: {enabled: true}});\n\n    const conversation =\n        new AiAssistance.AiConversation.AiConversation(AiAssistance.AiHistoryStorage.ConversationType.STYLING);\n\n    conversation.setContext(null);\n\n    assert(conversation.type === AiAssistance.AiHistoryStorage.ConversationType.NONE);\n  });\n\n  it('should update context when agent returns CONTEXT_CHANGE', async () => {\n    updateHostConfig({devToolsAiAssistanceContextSelectionAgent: {enabled: true}});\n    const workspace = Workspace.Workspace.WorkspaceImpl.instance();\n    const project = {\n      id: () => 'test-project',\n      type: () => Workspace.Workspace.projectTypes.Network,\n      uiSourceCodes: () => [file],\n      fullDisplayName: () => 'script.js',\n    } as unknown as Workspace.Workspace.Project;\n    const file = new Workspace.UISourceCode.UISourceCode(\n        project, Platform.DevToolsPath.urlString`https://example.com/script.js`,\n        Common.ResourceType.resourceTypes.Script);\n    sinon.stub(workspace, 'projects').returns([project]);\n\n    const conversation = new AiAssistance.AiConversation.AiConversation(\n        AiAssistance.AiHistoryStorage.ConversationType.NONE, [], 'test-id', false, mockAidaClient([\n          [{\n            functionCalls: [{\n              name: 'selectSourceFile',\n              args: {\n                name: 'script.js',\n              },\n            }],\n            explanation: '',\n          }],\n          [{explanation: 'Done'}],\n        ]));\n\n    await Array.fromAsync(conversation.run('test'));\n\n    assert.exists(conversation.selectedContext);\n    assert.instanceOf(conversation.selectedContext, AiAssistance.FileAgent.FileContext);\n  });\n\n  it('should yield UserQuery when run is called', async () => {\n    const conversation = new AiAssistance.AiConversation.AiConversation(\n        AiAssistance.AiHistoryStorage.ConversationType.NONE, [], 'test-id', false, mockAidaClient([\n          [{explanation: 'Answer'}],\n        ]));\n\n    const result = await Array.fromAsync(conversation.run('test query'));\n\n    assert.deepEqual(result[0], {\n      type: AiAssistance.AiAgent.ResponseType.USER_QUERY,\n      query: 'test query',\n      imageId: undefined,\n      imageInput: undefined,\n    });\n  });\n\n  it('should add UserQuery to history when run is called', async () => {\n    const conversation = new AiAssistance.AiConversation.AiConversation(\n        AiAssistance.AiHistoryStorage.ConversationType.NONE, [], 'test-id', false, mockAidaClient([\n          [{explanation: 'Answer'}],\n        ]));\n\n    await Array.fromAsync(conversation.run('test query'));\n\n    assert.deepEqual(conversation.history[0], {\n      type: AiAssistance.AiAgent.ResponseType.USER_QUERY,\n      query: 'test query',\n      imageId: undefined,\n      imageInput: undefined,\n    });\n  });\n});\n"]}