{"version":3,"file":"BuiltInAi.js","sourceRoot":"","sources":["../../../../../../front_end/models/ai_assistance/BuiltInAi.ts"],"names":[],"mappings":"AAAA,4DAA4D;AAC5D,yEAAyE;AACzE,6BAA6B;AAE7B,OAAO,KAAK,IAAI,MAAM,yBAAyB,CAAC;AAEhD,IAAI,iBAAsC,CAAC;AAC3C,IAAI,YAAY,GAAG,EAAE,CAAC;AAEtB,MAAM,eAAe,GAAG;IACtB,IAAI,EAAE,QAAQ;IACd,UAAU,EAAE;QACV,MAAM,EAAE,EAAC,IAAI,EAAE,QAAQ,EAAE,SAAS,EAAE,EAAE,EAAE,WAAW,EAAE,uDAAuD,EAAC;QAC7G,mHAAmH;QACnH,+DAA+D;QAC/D,WAAW,EAAE;YACX,IAAI,EAAE,QAAQ;YACd,WAAW,EAAE,0DAA0D;SACxE;KACF;IACD,QAAQ,EAAE,CAAC,QAAQ,EAAE,aAAa,CAAC;IACnC,oBAAoB,EAAE,KAAK;CAC5B,CAAC;AAWF,MAAM,OAAO,SAAS;IACpB,uBAAuB,CAAgB;IAEvC,MAAM,CAAC,KAAK,CAAC,WAAW;QACtB,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,mBAAmB,EAAE,OAAO,EAAE,CAAC;YAC1D,OAAO,KAAK,CAAC;QACf,CAAC;QACD,mBAAmB;QACnB,YAAY,GAAG,MAAM,MAAM,CAAC,aAAa,CAAC,YAAY,CAAC,EAAC,eAAe,EAAE,CAAC,EAAC,IAAI,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC,IAAI,CAAC,EAAC,CAAC,EAAC,CAAC,CAAC;QAC/G,OAAO,YAAY,KAAK,WAAW,CAAC;IACtC,CAAC;IAED,MAAM,CAAC,iBAAiB;QACtB,OAAO,YAAY,KAAK,WAAW,CAAC;IACtC,CAAC;IAED,YAAoB,sBAAqC;QACvD,IAAI,CAAC,uBAAuB,GAAG,sBAAsB,CAAC;IACxD,CAAC;IAED,MAAM,CAAC,KAAK,CAAC,QAAQ;QACnB,IAAI,iBAAiB,KAAK,SAAS,EAAE,CAAC;YACpC,IAAI,CAAC,CAAC,MAAM,SAAS,CAAC,WAAW,EAAE,CAAC,EAAE,CAAC;gBACrC,OAAO,SAAS,CAAC;YACnB,CAAC;YACD,mBAAmB;YACnB,MAAM,sBAAsB,GAAG,MAAM,MAAM,CAAC,aAAa,CAAC,MAAM,CAAC;gBAC/D,cAAc,EAAE,CAAC;wBACf,IAAI,EAAE,QAAQ;wBACd,OAAO,EAAE;;;;;;;;;;;;;;;WAeR;qBACF,CAAC;gBACF,cAAc,EAAE,CAAC;wBACf,IAAI,EAAE,MAAM;wBACZ,SAAS,EAAE,CAAC,IAAI,CAAC;qBAClB,CAAC;gBACF,eAAe,EAAE,CAAC;wBAChB,IAAI,EAAE,MAAM;wBACZ,SAAS,EAAE,CAAC,IAAI,CAAC;qBAClB,CAAC;aACH,CAAkB,CAAC;YACpB,iBAAiB,GAAG,IAAI,SAAS,CAAC,sBAAsB,CAAC,CAAC;QAC5D,CAAC;QACD,OAAO,iBAAiB,CAAC;IAC3B,CAAC;IAED,MAAM,CAAC,cAAc;QACnB,iBAAiB,GAAG,SAAS,CAAC;IAChC,CAAC;IAED,KAAK,CAAC,CAAE,iBAAiB,CAAC,MAAc,EAAE,eAAgC;QACxE,6EAA6E;QAC7E,wEAAwE;QACxE,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,uBAAuB,CAAC,KAAK,EAAE,CAAC;QAC3D,MAAM,MAAM,GAAG,OAAO,CAAC,eAAe,CAAC,MAAM,EAAE;YAC7C,MAAM,EAAE,eAAe,CAAC,MAAM;YAC9B,kBAAkB,EAAE,eAAe;SACpC,CAAC,CAAC;QACH,IAAI,KAAK,EAAE,MAAM,KAAK,IAAI,MAAM,EAAE,CAAC;YACjC,MAAM,KAAK,CAAC;QACd,CAAC;QACD,OAAO,CAAC,OAAO,EAAE,CAAC;IACpB,CAAC;CACF","sourcesContent":["// Copyright 2025 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Root from '../../core/root/root.js';\n\nlet builtInAiInstance: BuiltInAi|undefined;\nlet availability = '';\n\nconst RESPONSE_SCHEMA = {\n  type: 'object',\n  properties: {\n    header: {type: 'string', maxLength: 60, description: 'Label for the console message which is being analyzed'},\n    // No hard `maxLength` for `explanation`. This would often result in responses which are cut off in the middle of a\n    // sentence. Instead provide a soft `maxLength` via the prompt.\n    explanation: {\n      type: 'string',\n      description: 'Actual explanation of the console message being analyzed',\n    },\n  },\n  required: ['header', 'explanation'],\n  additionalProperties: false,\n};\n\nexport interface LanguageModel {\n  promptStreaming: (arg0: string, opts?: {\n    responseConstraint: Object,\n    signal?: AbortSignal,\n  }) => AsyncGenerator<string>;\n  clone: () => LanguageModel;\n  destroy: () => void;\n}\n\nexport class BuiltInAi {\n  #consoleInsightsSession: LanguageModel;\n\n  static async isAvailable(): Promise<boolean> {\n    if (!Root.Runtime.hostConfig.devToolsAiPromptApi?.enabled) {\n      return false;\n    }\n    // @ts-expect-error\n    availability = await window.LanguageModel.availability({expectedOutputs: [{type: 'text', languages: ['en']}]});\n    return availability === 'available';\n  }\n\n  static cachedIsAvailable(): boolean {\n    return availability === 'available';\n  }\n\n  private constructor(consoleInsightsSession: LanguageModel) {\n    this.#consoleInsightsSession = consoleInsightsSession;\n  }\n\n  static async instance(): Promise<BuiltInAi|undefined> {\n    if (builtInAiInstance === undefined) {\n      if (!(await BuiltInAi.isAvailable())) {\n        return undefined;\n      }\n      // @ts-expect-error\n      const consoleInsightsSession = await window.LanguageModel.create({\n        initialPrompts: [{\n          role: 'system',\n          content: `\nYou are an expert web developer. Your goal is to help a human web developer who\nis using Chrome DevTools to debug a web site or web app. The Chrome DevTools\nconsole is showing a message which is either an error or a warning. Please help\nthe user understand the problematic console message.\n\nYour instructions are as follows:\n  - Explain the reason why the error or warning is showing up.\n  - The explanation has a maximum length of 200 characters. Anything beyond this\n    length will be cut off. Make sure that your explanation is at most 200 characters long.\n  - Your explanation should not end in the middle of a sentence.\n  - Your explanation should consist of a single paragraph only. Do not include any\n    headings or code blocks. Only write a single paragraph of text.\n  - Your response should be concise and to the point. Avoid lengthy explanations\n    or unnecessary details.\n          `\n        }],\n        expectedInputs: [{\n          type: 'text',\n          languages: ['en'],\n        }],\n        expectedOutputs: [{\n          type: 'text',\n          languages: ['en'],\n        }],\n      }) as LanguageModel;\n      builtInAiInstance = new BuiltInAi(consoleInsightsSession);\n    }\n    return builtInAiInstance;\n  }\n\n  static removeInstance(): void {\n    builtInAiInstance = undefined;\n  }\n\n  async * getConsoleInsight(prompt: string, abortController: AbortController): AsyncGenerator<string> {\n    // Clone the session to start a fresh conversation for each answer. Otherwise\n    // previous dialog would pollute the context resulting in worse answers.\n    const session = await this.#consoleInsightsSession.clone();\n    const stream = session.promptStreaming(prompt, {\n      signal: abortController.signal,\n      responseConstraint: RESPONSE_SCHEMA,\n    });\n    for await (const chunk of stream) {\n      yield chunk;\n    }\n    session.destroy();\n  }\n}\n"]}