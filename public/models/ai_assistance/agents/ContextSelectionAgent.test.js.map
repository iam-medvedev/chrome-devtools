{"version":3,"file":"ContextSelectionAgent.test.js","sourceRoot":"","sources":["../../../../../../../front_end/models/ai_assistance/agents/ContextSelectionAgent.test.ts"],"names":[],"mappings":"AAAA,sCAAsC;AACtC,yEAAyE;AACzE,6BAA6B;AAE7B,OAAO,KAAK,IAAI,MAAM,4BAA4B,CAAC;AACnD,OAAO,KAAK,QAAQ,MAAM,oCAAoC,CAAC;AAC/D,OAAO,KAAK,GAAG,MAAM,0BAA0B,CAAC;AAEhD,OAAO,EAAC,cAAc,EAAC,MAAM,yCAAyC,CAAC;AACvE,OAAO,EACL,0BAA0B,EAC1B,sBAAsB,EACtB,gBAAgB,GACjB,MAAM,wCAAwC,CAAC;AAChD,OAAO,EAAC,0BAA0B,EAAC,MAAM,oCAAoC,CAAC;AAC9E,OAAO,EAAC,cAAc,EAAC,MAAM,oCAAoC,CAAC;AAClE,OAAO,KAAK,QAAQ,MAAM,4BAA4B,CAAC;AACvD,OAAO,KAAK,IAAI,MAAM,oBAAoB,CAAC;AAC3C,OAAO,KAAK,SAAS,MAAM,8BAA8B,CAAC;AAC1D,OAAO,EAAU,qBAAqB,EAAC,MAAM,qBAAqB,CAAC;AAEnE,MAAM,EAAC,SAAS,EAAC,GAAG,QAAQ,CAAC,YAAY,CAAC;AAE1C,0BAA0B,CAAC,uBAAuB,EAAE;IAClD,MAAM,cAAc,GAAG,IAAI,cAAc,CAAC,IAAI,EAAE,MAAM,CAAC,IAAI,CAAC,CAAC;IAE7D,SAAS,cAAc;QACrB,gBAAgB,CAAC;YACf,yCAAyC,EAAE;gBACzC,OAAO,EAAE,IAAI;aACd;SACF,CAAC,CAAC;IACL,CAAC;IAED,UAAU,CAAC,GAAG,EAAE;QACd,MAAM,SAAS,GAAG,SAAS,CAAC,SAAS,CAAC,aAAa,CAAC,QAAQ,EAAE,CAAC;QAC/D,MAAM,aAAa,GAAG,GAAG,CAAC,aAAa,CAAC,aAAa,CAAC,QAAQ,EAAE,CAAC;QACjE,MAAM,eAAe,GAAG,IAAI,QAAQ,CAAC,eAAe,CAAC,eAAe,CAAC,aAAa,EAAE,SAAS,CAAC,CAAC;QAC/F,MAAM,iBAAiB,GAAG,SAAS,CAAC,iBAAiB,CAAC,iBAAiB,CAAC,QAAQ,CAAC,EAAC,QAAQ,EAAE,IAAI,EAAC,CAAC,CAAC;QACnG,QAAQ,CAAC,wBAAwB,CAAC,wBAAwB,CAAC,QAAQ,CAAC;YAClE,QAAQ,EAAE,IAAI;YACd,eAAe;YACf,aAAa;YACb,iBAAiB;YACjB,SAAS;SACV,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,cAAc,EAAE,GAAG,EAAE;QAC5B,EAAE,CAAC,gCAAgC,EAAE,KAAK;YACxC,cAAc,EAAE,CAAC;YACjB,KAAK,CAAC,IAAI,CAAC,MAAM,EAAE,YAAY,CAAC,CAAC,OAAO,CAAC,WAAkE,CAAC,CAAC;YAC7G,MAAM,KAAK,GAAG,IAAI,qBAAqB,CAAC,qBAAqB,CAAC;gBAC5D,UAAU,EAAE,cAAc,CAAC,CAAC,CAAC,EAAC,WAAW,EAAE,QAAQ,EAAC,CAAC,CAAC,CAAC;gBACvD,wBAAwB,EAAE,IAAI;aAC/B,CAAC,CAAC;YACH,MAAM,KAAK,CAAC,SAAS,CAAC,KAAK,CAAC,GAAG,CAAC,UAAU,EAAE,EAAC,QAAQ,EAAE,IAAI,EAAC,CAAC,CAAC,CAAC;YAE/D,sBAAsB,EAAE,CAAC;YACzB,MAAM,OAAO,GAAG,KAAK,CAAC,YAAY,CAAC,EAAC,IAAI,EAAE,YAAY,EAAC,EAAE,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACpF,cAAc,CAAC,MAAM,CAAC,IAAI,EAAE,IAAI,CAAC,SAAS,CAAC,OAAO,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC,CAAC;YAE9D,0BAA0B,EAAE,CAAC;QAC/B,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,KAAK,EAAE,GAAG,EAAE;QACnB,EAAE,CAAC,qBAAqB,EAAE,KAAK,IAAI,EAAE;YACnC,MAAM,KAAK,GAAG,IAAI,qBAAqB,CAAC,qBAAqB,CAAC;gBAC5D,UAAU,EAAE,cAAc,CAAC,CAAC,CAAC;4BAC3B,WAAW,EAAE,oBAAoB;4BACjC,QAAQ,EAAE;gCACR,WAAW,EAAE,GAAG;6BACjB;yBACF,CAAC,CAAC,CAAC;aACL,CAAC,CAAC;YAEH,MAAM,SAAS,GAAG,MAAM,KAAK,CAAC,SAAS,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM,EAAE,EAAC,QAAQ,EAAE,IAAI,EAAC,CAAC,CAAC,CAAC;YAE7E,MAAM,CAAC,SAAS,CAAC,SAAS,EAAE;gBAC1B;oBACE,IAAI,oDAAiC;oBACrC,KAAK,EAAE,MAAM;oBACb,UAAU,EAAE,SAAS;oBACrB,OAAO,EAAE,SAAS;iBACnB;gBACD;oBACE,IAAI,gDAA+B;iBACpC;gBACD;oBACE,IAAI,4CAA6B;oBACjC,IAAI,EAAE,oBAAoB;oBAC1B,QAAQ,EAAE,IAAI;oBACd,WAAW,EAAE,SAAS;oBACtB,KAAK,EAAE,GAAG;iBACX;aACF,CAAC,CAAC;YAEH,MAAM,CAAC,SAAS,CAAC,KAAK,CAAC,YAAY,CAAC,EAAC,IAAI,EAAE,EAAE,EAAC,EAAE,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,mBAAmB,EAAE;gBAC9F;oBACE,IAAI,EAAE,CAAC;oBACP,KAAK,EAAE,CAAC;4BACN,IAAI,EAAE,MAAM;yBACb,CAAC;iBACH;gBACD;oBACE,IAAI,EAAE,CAAC;oBACP,KAAK,EAAE,CAAC,EAAC,IAAI,EAAE,oBAAoB,EAAC,CAAC;iBACtC;aACF,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,qBAAqB,EAAE,GAAG,EAAE;QACnC,EAAE,CAAC,wBAAwB,EAAE,KAAK,IAAI,EAAE;YACtC,MAAM,OAAO,GAAG,GAAG,CAAC,cAAc,CAAC,cAAc,CAAC,MAAM,CACpD,WAAyC,EACzC,SAAS,CAAA,sBAAsB,EAC/B,SAAS,CAAA,sBAAsB,EAC/B,IAAI,EACJ,IAAI,EACJ,IAAI,CACP,CAAC;YACF,OAAO,CAAC,UAAU,GAAG,GAAG,CAAC;YACzB,OAAO,CAAC,YAAY,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;YAC3B,OAAO,CAAC,OAAO,GAAG,CAAC,CAAC;YAEpB,MAAM,UAAU,GAAG,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC,QAAQ,EAAE,CAAC;YACzD,KAAK,CAAC,IAAI,CAAC,UAAU,EAAE,UAAU,CAAC,CAAC,OAAO,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC;YAEtD,MAAM,KAAK,GAAG,IAAI,qBAAqB,CAAC,qBAAqB,CAAC;gBAC5D,UAAU,EAAE,cAAc,CAAC;oBACzB,CAAC;4BACC,aAAa,EAAE,CAAC;oCACd,IAAI,EAAE,qBAAqB;oCAC3B,IAAI,EAAE,EAAE;iCACT,CAAC;4BACF,WAAW,EAAE,EAAE;yBAChB,CAAC;oBACF,CAAC,EAAC,WAAW,EAAE,MAAM,EAAC,CAAC;iBACxB,CAAC;aACH,CAAC,CAAC;YAEH,MAAM,KAAK,CAAC,SAAS,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM,EAAE,EAAC,QAAQ,EAAE,IAAI,EAAC,CAAC,CAAC,CAAC;YAE3D,MAAM,aAAa,GAAG,KAAK,CAAC,YAAY,CAAC,EAAC,IAAI,EAAE,EAAE,EAAC,EAAE,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAChF,MAAM,CAAC,SAAS,CAAC,aAAa,CAAC,mBAAmB,EAAE;gBAClD;oBACE,IAAI,EAAE,CAAC;oBACP,KAAK,EAAE,CAAC,EAAC,IAAI,EAAE,MAAM,EAAC,CAAC;iBACxB;gBACD;oBACE,IAAI,EAAE,CAAC;oBACP,KAAK,EAAE,CAAC;4BACN,YAAY,EAAE;gCACZ,IAAI,EAAE,qBAAqB;gCAC3B,IAAI,EAAE,EAAE;6BACT;yBACF,CAAC;iBACH;gBACD;oBACE,IAAI,EAAE,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,gBAAgB;oBAC3C,KAAK,EAAE,CAAC;4BACN,gBAAgB,EAAE;gCAChB,IAAI,EAAE,qBAAqB;gCAC3B,QAAQ,EAAE;oCACR,MAAM,EAAE;wCACN;4CACE,GAAG,EAAE,sBAAsB;4CAC3B,UAAU,EAAE,GAAG;4CACf,QAAQ,EAAE,CAAC;yCACZ;qCACF;iCACF;6BACF;yBACF,CAAC;iBACH;gBACD;oBACE,IAAI,EAAE,CAAC;oBACP,KAAK,EAAE,CAAC,EAAC,IAAI,EAAE,MAAM,EAAC,CAAC;iBACxB;aACF,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,6CAA6C,EAAE,KAAK,IAAI,EAAE;YAC3D,MAAM,MAAM,GAAG,SAAS,CAAA,qBAAqB,CAAC;YAC9C,MAAM,WAAW,GAAG,SAAS,CAAA,mBAAmB,CAAC;YAEjD,MAAM,MAAM,GAAG,KAAK,CAAC,kBAAkB,CAAC,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;YAC3D,MAAM,CAAC,YAAY,CAAC,OAAO,CAAC,SAAS,CAAA,GAAG,MAAM,GAAG,CAAC,CAAC;YACnD,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC,aAAa,CAAC,aAAa,CAAC,QAAQ,EAAE,EAAE,mBAAmB,CAAC,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;YAE5F,MAAM,iBAAiB,GAAG,GAAG,CAAC,cAAc,CAAC,cAAc,CAAC,MAAM,CAC9D,YAA0C,EAC1C,SAAS,CAAA,GAAG,MAAM,MAAM,EACxB,SAAS,CAAA,GAAG,MAAM,MAAM,EACxB,IAAI,EACJ,IAAI,EACJ,IAAI,CACP,CAAC;YACF,iBAAiB,CAAC,UAAU,GAAG,GAAG,CAAC;YAEnC,MAAM,kBAAkB,GAAG,GAAG,CAAC,cAAc,CAAC,cAAc,CAAC,MAAM,CAC/D,YAA0C,EAC1C,SAAS,CAAA,GAAG,WAAW,MAAM,EAC7B,SAAS,CAAA,GAAG,WAAW,MAAM,EAC7B,IAAI,EACJ,IAAI,EACJ,IAAI,CACP,CAAC;YACF,kBAAkB,CAAC,UAAU,GAAG,GAAG,CAAC;YAEpC,MAAM,UAAU,GAAG,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC,QAAQ,EAAE,CAAC;YACzD,KAAK,CAAC,IAAI,CAAC,UAAU,EAAE,UAAU,CAAC,CAAC,OAAO,CAAC,CAAC,iBAAiB,EAAE,kBAAkB,CAAC,CAAC,CAAC;YAEpF,MAAM,KAAK,GAAG,IAAI,qBAAqB,CAAC,qBAAqB,CAAC;gBAC5D,UAAU,EAAE,cAAc,CAAC;oBACzB,CAAC;4BACC,aAAa,EAAE,CAAC;oCACd,IAAI,EAAE,qBAAqB;oCAC3B,IAAI,EAAE,EAAE;iCACT,CAAC;4BACF,WAAW,EAAE,EAAE;yBAChB,CAAC;oBACF,CAAC,EAAC,WAAW,EAAE,MAAM,EAAC,CAAC;iBACxB,CAAC;aACH,CAAC,CAAC;YAEH,MAAM,KAAK,CAAC,SAAS,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM,EAAE,EAAC,QAAQ,EAAE,IAAI,EAAC,CAAC,CAAC,CAAC;YAE3D,MAAM,aAAa,GAAG,KAAK,CAAC,YAAY,CAAC,EAAC,IAAI,EAAE,EAAE,EAAC,EAAE,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAChF,MAAM,IAAI,GAAG,aAAa,CAAC,mBAAmB,EAAE,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;YAE7D,MAAM,CAAC,IAAI,IAAI,kBAAkB,IAAI,IAAI,EAAE,gCAAgC,CAAC,CAAC;YAC7E,MAAM,CAAC,WAAW,CAAC,IAAI,CAAC,gBAAgB,CAAC,IAAI,EAAE,qBAAqB,CAAC,CAAC;YACtE,MAAM,CAAC,SAAS,CAAC,IAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC,MAAM,EAAE;gBACtD;oBACE,GAAG,EAAE,GAAG,MAAM,MAAM;oBACpB,UAAU,EAAE,GAAG;oBACf,QAAQ,EAAE,CAAC,CAAC;iBACb;aACF,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","sourcesContent":["// Copyright 2026 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Host from '../../../core/host/host.js';\nimport * as Platform from '../../../core/platform/platform.js';\nimport * as SDK from '../../../core/sdk/sdk.js';\nimport type * as Protocol from '../../../generated/protocol.js';\nimport {mockAidaClient} from '../../../testing/AiAssistanceHelpers.js';\nimport {\n  restoreUserAgentForTesting,\n  setUserAgentForTesting,\n  updateHostConfig,\n} from '../../../testing/EnvironmentHelpers.js';\nimport {describeWithMockConnection} from '../../../testing/MockConnection.js';\nimport {SnapshotTester} from '../../../testing/SnapshotTester.js';\nimport * as Bindings from '../../bindings/bindings.js';\nimport * as Logs from '../../logs/logs.js';\nimport * as Workspace from '../../workspace/workspace.js';\nimport {AiAgent, ContextSelectionAgent} from '../ai_assistance.js';\n\nconst {urlString} = Platform.DevToolsPath;\n\ndescribeWithMockConnection('ContextSelectionAgent', function() {\n  const snapshotTester = new SnapshotTester(this, import.meta);\n\n  function mockHostConfig() {\n    updateHostConfig({\n      devToolsAiAssistanceContextSelectionAgent: {\n        enabled: true,\n      },\n    });\n  }\n\n  beforeEach(() => {\n    const workspace = Workspace.Workspace.WorkspaceImpl.instance();\n    const targetManager = SDK.TargetManager.TargetManager.instance();\n    const resourceMapping = new Bindings.ResourceMapping.ResourceMapping(targetManager, workspace);\n    const ignoreListManager = Workspace.IgnoreListManager.IgnoreListManager.instance({forceNew: true});\n    Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance({\n      forceNew: true,\n      resourceMapping,\n      targetManager,\n      ignoreListManager,\n      workspace,\n    });\n  });\n\n  describe('buildRequest', () => {\n    it('structure matches the snapshot', async function() {\n      mockHostConfig();\n      sinon.stub(crypto, 'randomUUID').returns('sessionId' as `${string}-${string}-${string}-${string}-${string}`);\n      const agent = new ContextSelectionAgent.ContextSelectionAgent({\n        aidaClient: mockAidaClient([[{explanation: 'answer'}]]),\n        serverSideLoggingEnabled: true,\n      });\n      await Array.fromAsync(agent.run('question', {selected: null}));\n\n      setUserAgentForTesting();\n      const request = agent.buildRequest({text: 'test input'}, Host.AidaClient.Role.USER);\n      snapshotTester.assert(this, JSON.stringify(request, null, 2));\n\n      restoreUserAgentForTesting();\n    });\n  });\n\n  describe('run', () => {\n    it('generates an answer', async () => {\n      const agent = new ContextSelectionAgent.ContextSelectionAgent({\n        aidaClient: mockAidaClient([[{\n          explanation: 'This is the answer',\n          metadata: {\n            rpcGlobalId: 123,\n          },\n        }]]),\n      });\n\n      const responses = await Array.fromAsync(agent.run('test', {selected: null}));\n\n      assert.deepEqual(responses, [\n        {\n          type: AiAgent.ResponseType.USER_QUERY,\n          query: 'test',\n          imageInput: undefined,\n          imageId: undefined,\n        },\n        {\n          type: AiAgent.ResponseType.QUERYING,\n        },\n        {\n          type: AiAgent.ResponseType.ANSWER,\n          text: 'This is the answer',\n          complete: true,\n          suggestions: undefined,\n          rpcId: 123,\n        },\n      ]);\n\n      assert.deepEqual(agent.buildRequest({text: ''}, Host.AidaClient.Role.USER).historical_contexts, [\n        {\n          role: 1,\n          parts: [{\n            text: `test`,\n          }],\n        },\n        {\n          role: 2,\n          parts: [{text: 'This is the answer'}],\n        },\n      ]);\n    });\n  });\n\n  describe('listNetworkRequests', () => {\n    it('lists network requests', async () => {\n      const request = SDK.NetworkRequest.NetworkRequest.create(\n          'requestId' as Protocol.Network.RequestId,\n          urlString`https://example.com/`,\n          urlString`https://example.com/`,\n          null,\n          null,\n          null,\n      );\n      request.statusCode = 200;\n      request.setIssueTime(0, 0);\n      request.endTime = 2;\n\n      const networkLog = Logs.NetworkLog.NetworkLog.instance();\n      sinon.stub(networkLog, 'requests').returns([request]);\n\n      const agent = new ContextSelectionAgent.ContextSelectionAgent({\n        aidaClient: mockAidaClient([\n          [{\n            functionCalls: [{\n              name: 'listNetworkRequests',\n              args: {},\n            }],\n            explanation: '',\n          }],\n          [{explanation: 'Done'}],\n        ]),\n      });\n\n      await Array.fromAsync(agent.run('test', {selected: null}));\n\n      const requestToAida = agent.buildRequest({text: ''}, Host.AidaClient.Role.USER);\n      assert.deepEqual(requestToAida.historical_contexts, [\n        {\n          role: 1,\n          parts: [{text: 'test'}],\n        },\n        {\n          role: 2,\n          parts: [{\n            functionCall: {\n              name: 'listNetworkRequests',\n              args: {},\n            },\n          }],\n        },\n        {\n          role: Host.AidaClient.Role.ROLE_UNSPECIFIED,\n          parts: [{\n            functionResponse: {\n              name: 'listNetworkRequests',\n              response: {\n                result: [\n                  {\n                    url: 'https://example.com/',\n                    statusCode: 200,\n                    duration: 2,\n                  },\n                ],\n              },\n            },\n          }],\n        },\n        {\n          role: 2,\n          parts: [{text: 'Done'}],\n        },\n      ]);\n    });\n\n    it('filters network requests by security origin', async () => {\n      const origin = urlString`https://example.com`;\n      const otherOrigin = urlString`https://other.com`;\n\n      const target = sinon.createStubInstance(SDK.Target.Target);\n      target.inspectedURL.returns(urlString`${origin}/`);\n      sinon.stub(SDK.TargetManager.TargetManager.instance(), 'primaryPageTarget').returns(target);\n\n      const sameOriginRequest = SDK.NetworkRequest.NetworkRequest.create(\n          'requestId1' as Protocol.Network.RequestId,\n          urlString`${origin}/foo`,\n          urlString`${origin}/foo`,\n          null,\n          null,\n          null,\n      );\n      sameOriginRequest.statusCode = 200;\n\n      const crossOriginRequest = SDK.NetworkRequest.NetworkRequest.create(\n          'requestId2' as Protocol.Network.RequestId,\n          urlString`${otherOrigin}/bar`,\n          urlString`${otherOrigin}/bar`,\n          null,\n          null,\n          null,\n      );\n      crossOriginRequest.statusCode = 200;\n\n      const networkLog = Logs.NetworkLog.NetworkLog.instance();\n      sinon.stub(networkLog, 'requests').returns([sameOriginRequest, crossOriginRequest]);\n\n      const agent = new ContextSelectionAgent.ContextSelectionAgent({\n        aidaClient: mockAidaClient([\n          [{\n            functionCalls: [{\n              name: 'listNetworkRequests',\n              args: {},\n            }],\n            explanation: '',\n          }],\n          [{explanation: 'Done'}],\n        ]),\n      });\n\n      await Array.fromAsync(agent.run('test', {selected: null}));\n\n      const requestToAida = agent.buildRequest({text: ''}, Host.AidaClient.Role.USER);\n      const part = requestToAida.historical_contexts?.[2].parts[0];\n\n      assert(part && 'functionResponse' in part, 'Expected functionResponse part');\n      assert.strictEqual(part.functionResponse.name, 'listNetworkRequests');\n      assert.deepEqual(part.functionResponse.response.result, [\n        {\n          url: `${origin}/foo`,\n          statusCode: 200,\n          duration: -1,\n        },\n      ]);\n    });\n  });\n});\n"]}