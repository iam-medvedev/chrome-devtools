{"version":3,"file":"ContextSelectionAgent.test.js","sourceRoot":"","sources":["../../../../../../../front_end/models/ai_assistance/agents/ContextSelectionAgent.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2026 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Host from '../../../core/host/host.js';\nimport * as SDK from '../../../core/sdk/sdk.js';\nimport {mockAidaClient} from '../../../testing/AiAssistanceHelpers.js';\nimport {\n  restoreUserAgentForTesting,\n  setUserAgentForTesting,\n  updateHostConfig,\n} from '../../../testing/EnvironmentHelpers.js';\nimport {describeWithMockConnection} from '../../../testing/MockConnection.js';\nimport {SnapshotTester} from '../../../testing/SnapshotTester.js';\nimport * as Bindings from '../../bindings/bindings.js';\nimport * as Workspace from '../../workspace/workspace.js';\nimport {AiAgent, ContextSelectionAgent} from '../ai_assistance.js';\n\ndescribeWithMockConnection('FileAgent', function() {\n  const snapshotTester = new SnapshotTester(this, import.meta);\n\n  function mockHostConfig() {\n    updateHostConfig({\n      devToolsAiAssistanceContextSelectionAgent: {\n        enabled: true,\n      },\n    });\n  }\n\n  beforeEach(() => {\n    const workspace = Workspace.Workspace.WorkspaceImpl.instance();\n    const targetManager = SDK.TargetManager.TargetManager.instance();\n    const resourceMapping = new Bindings.ResourceMapping.ResourceMapping(targetManager, workspace);\n    const ignoreListManager = Workspace.IgnoreListManager.IgnoreListManager.instance({forceNew: true});\n    Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance({\n      forceNew: true,\n      resourceMapping,\n      targetManager,\n      ignoreListManager,\n      workspace,\n    });\n  });\n\n  describe('buildRequest', () => {\n    it('structure matches the snapshot', async function() {\n      mockHostConfig();\n      sinon.stub(crypto, 'randomUUID').returns('sessionId' as `${string}-${string}-${string}-${string}-${string}`);\n      const agent = new ContextSelectionAgent.ContextSelectionAgent({\n        aidaClient: mockAidaClient([[{explanation: 'answer'}]]),\n        serverSideLoggingEnabled: true,\n      });\n      await Array.fromAsync(agent.run('question', {selected: null}));\n\n      setUserAgentForTesting();\n      const request = agent.buildRequest({text: 'test input'}, Host.AidaClient.Role.USER);\n      snapshotTester.assert(this, JSON.stringify(request, null, 2));\n\n      restoreUserAgentForTesting();\n    });\n  });\n\n  describe('run', () => {\n    it('generates an answer', async () => {\n      const agent = new ContextSelectionAgent.ContextSelectionAgent({\n        aidaClient: mockAidaClient([[{\n          explanation: 'This is the answer',\n          metadata: {\n            rpcGlobalId: 123,\n          },\n        }]]),\n      });\n\n      const responses = await Array.fromAsync(agent.run('test', {selected: null}));\n\n      assert.deepEqual(responses, [\n        {\n          type: AiAgent.ResponseType.USER_QUERY,\n          query: 'test',\n          imageInput: undefined,\n          imageId: undefined,\n        },\n        {\n          type: AiAgent.ResponseType.QUERYING,\n        },\n        {\n          type: AiAgent.ResponseType.ANSWER,\n          text: 'This is the answer',\n          complete: true,\n          suggestions: undefined,\n          rpcId: 123,\n        },\n      ]);\n\n      assert.deepEqual(agent.buildRequest({text: ''}, Host.AidaClient.Role.USER).historical_contexts, [\n        {\n          role: 1,\n          parts: [{\n            text: `test`,\n          }],\n        },\n        {\n          role: 2,\n          parts: [{text: 'This is the answer'}],\n        },\n      ]);\n    });\n  });\n});\n"]}