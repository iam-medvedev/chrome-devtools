{"version":3,"file":"StylingAgent.test.js","sourceRoot":"","sources":["../../../../../../../front_end/models/ai_assistance/agents/StylingAgent.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Host from '../../../core/host/host.js';\nimport * as Root from '../../../core/root/root.js';\nimport * as SDK from '../../../core/sdk/sdk.js';\nimport {mockAidaClient} from '../../../testing/AiAssistanceHelpers.js';\nimport {\n  describeWithEnvironment,\n  restoreUserAgentForTesting,\n  setUserAgentForTesting,\n  updateHostConfig,\n} from '../../../testing/EnvironmentHelpers.js';\nimport {SnapshotTester} from '../../../testing/SnapshotTester.js';\nimport * as AiAssistance from '../ai_assistance.js';\n\nconst {StylingAgent, AiAgent} = AiAssistance;\n\ndescribeWithEnvironment('StylingAgent', function() {\n  const snapshotTester = new SnapshotTester(this, import.meta);\n\n  function mockHostConfig(\n      modelId?: string, temperature?: number, userTier?: string,\n      executionMode?: Root.Runtime.HostConfigFreestylerExecutionMode, multimodal?: boolean) {\n    updateHostConfig({\n      devToolsFreestyler: {\n        modelId,\n        temperature,\n        userTier,\n        executionMode,\n        multimodal,\n      },\n    });\n  }\n\n  function createExtensionScope() {\n    return {\n      async install() {\n\n      },\n      async uninstall() {\n\n      },\n    };\n  }\n\n  let element: sinon.SinonStubbedInstance<SDK.DOMModel.DOMNode>;\n  let target: sinon.SinonStubbedInstance<SDK.Target.Target>;\n  let domModel: sinon.SinonStubbedInstance<SDK.DOMModel.DOMModel>;\n\n  beforeEach(() => {\n    mockHostConfig();\n    target = sinon.createStubInstance(SDK.Target.Target);\n    target.model.returns(null);\n\n    domModel = sinon.createStubInstance(SDK.DOMModel.DOMModel);\n    domModel.target.returns(target);\n\n    element = sinon.createStubInstance(SDK.DOMModel.DOMNode);\n    element.domModel.returns(domModel);\n    element.backendNodeId.returns(99 as unknown as ReturnType<SDK.DOMModel.DOMNode['backendNodeId']>);\n  });\n\n  describe('describeElement', () => {\n    it('should describe an element with no children, siblings, or parent', async function() {\n      element.simpleSelector.returns('div#myElement');\n      element.getChildNodesPromise.resolves(null);\n\n      const result = await StylingAgent.StylingAgent.describeElement(element);\n\n      snapshotTester.assert(this, result);\n    });\n\n    it('should describe an element with child element and text nodes', async function() {\n      const childNodes: Array<sinon.SinonStubbedInstance<SDK.DOMModel.DOMNode>> = [\n        sinon.createStubInstance(SDK.DOMModel.DOMNode),\n        sinon.createStubInstance(SDK.DOMModel.DOMNode),\n        sinon.createStubInstance(SDK.DOMModel.DOMNode),\n      ];\n      childNodes[0].nodeType.returns(Node.ELEMENT_NODE);\n      childNodes[0].simpleSelector.returns('span.child1');\n      childNodes[1].nodeType.returns(Node.TEXT_NODE);\n      childNodes[2].nodeType.returns(Node.ELEMENT_NODE);\n      childNodes[2].simpleSelector.returns('span.child2');\n\n      element.simpleSelector.returns('div#parentElement');\n      element.getChildNodesPromise.resolves(childNodes);\n      element.nextSibling = null;\n      element.previousSibling = null;\n      element.parentNode = null;\n\n      const result = await StylingAgent.StylingAgent.describeElement(element);\n      snapshotTester.assert(this, result);\n    });\n\n    it('should describe an element with siblings and a parent', async function() {\n      const nextSibling = sinon.createStubInstance(SDK.DOMModel.DOMNode);\n      nextSibling.nodeType.returns(Node.ELEMENT_NODE);\n      const previousSibling = sinon.createStubInstance(SDK.DOMModel.DOMNode);\n      previousSibling.nodeType.returns(Node.TEXT_NODE);\n\n      const parentNode = sinon.createStubInstance(SDK.DOMModel.DOMNode);\n      parentNode.simpleSelector.returns('div#grandparentElement');\n      const parentChildNodes: Array<sinon.SinonStubbedInstance<SDK.DOMModel.DOMNode>> = [\n        sinon.createStubInstance(SDK.DOMModel.DOMNode),\n        sinon.createStubInstance(SDK.DOMModel.DOMNode),\n      ];\n      parentChildNodes[0].nodeType.returns(Node.ELEMENT_NODE);\n      parentChildNodes[0].simpleSelector.returns('span.sibling1');\n      parentChildNodes[1].nodeType.returns(Node.TEXT_NODE);\n      parentNode.getChildNodesPromise.resolves(parentChildNodes);\n\n      element.simpleSelector.returns('div#parentElement');\n      element.getChildNodesPromise.resolves(null);\n      element.nextSibling = nextSibling;\n      element.previousSibling = previousSibling;\n      element.parentNode = parentNode;\n\n      const result = await StylingAgent.StylingAgent.describeElement(element);\n      snapshotTester.assert(this, result);\n    });\n  });\n\n  describe('buildRequest', () => {\n    beforeEach(() => {\n      sinon.stub(crypto, 'randomUUID').returns('sessionId' as `${string}-${string}-${string}-${string}-${string}`);\n    });\n\n    it('builds a request with a model id', async () => {\n      mockHostConfig('test model');\n      const agent = new StylingAgent.StylingAgent({\n        aidaClient: {} as Host.AidaClient.AidaClient,\n      });\n      assert.strictEqual(\n          agent.buildRequest({text: 'test input'}, Host.AidaClient.Role.USER).options?.model_id,\n          'test model',\n      );\n    });\n\n    it('builds a request with a temperature', async () => {\n      mockHostConfig('test model', 1);\n      const agent = new StylingAgent.StylingAgent({\n        aidaClient: {} as Host.AidaClient.AidaClient,\n      });\n      assert.strictEqual(\n          agent.buildRequest({text: 'test input'}, Host.AidaClient.Role.USER).options?.temperature,\n          1,\n      );\n    });\n\n    it('builds a request with a user tier', async () => {\n      mockHostConfig('test model', 1, 'PUBLIC');\n      const agent = new StylingAgent.StylingAgent({\n        aidaClient: {} as Host.AidaClient.AidaClient,\n      });\n      assert.strictEqual(\n          agent.buildRequest({text: 'test input'}, Host.AidaClient.Role.USER).metadata?.user_tier,\n          3,\n      );\n    });\n\n    it('structure matches the snapshot', async function() {\n      mockHostConfig('test model');\n      const agent = new StylingAgent.StylingAgent({\n        aidaClient: mockAidaClient([[{\n          explanation: 'answer',\n        }]]),\n        serverSideLoggingEnabled: true,\n      });\n      await Array.fromAsync(agent.run('question', {selected: null}));\n\n      setUserAgentForTesting();\n      try {\n        snapshotTester.assert(\n            this,\n            JSON.stringify(\n                agent.buildRequest(\n                    {\n                      text: 'test input',\n                    },\n                    Host.AidaClient.Role.USER),\n                null, 2));\n      } finally {\n        restoreUserAgentForTesting();\n      }\n    });\n\n    it('builds a request with aborted query in history before a real request', async function() {\n      const execJs = sinon.mock().once();\n      execJs.onCall(0).returns('result2');\n      const agent = new StylingAgent.StylingAgent({\n        aidaClient: mockAidaClient([\n          [{\n            functionCalls: [{name: 'executeJavaScript', args: {title: 'title2', thought: 'thought2', code: 'action2'}}],\n            explanation: '',\n          }],\n          [{explanation: 'answer2'}]\n        ]),\n        createExtensionScope,\n        execJs,\n      });\n\n      sinon.stub(StylingAgent.StylingAgent, 'describeElement').resolves('element-description');\n\n      const controller = new AbortController();\n      controller.abort();\n      await Array.fromAsync(agent.run('test', {\n        selected: new AiAssistance.StylingAgent.NodeContext(element),\n        signal: controller.signal,\n      }));\n      await Array.fromAsync(agent.run('test2', {selected: new AiAssistance.StylingAgent.NodeContext(element)}));\n\n      const request = agent.buildRequest({text: 'test input'}, Host.AidaClient.Role.USER);\n      assert.deepEqual(request.current_message?.parts[0], {text: 'test input'});\n      snapshotTester.assert(this, JSON.stringify(request.historical_contexts, null, 2));\n    });\n  });\n\n  describe('run', () => {\n    describe('side effect handling', () => {\n      it('calls confirmSideEffect when the code execution contains a side effect', async () => {\n        const promise = Promise.withResolvers();\n        const stub = sinon.stub().returns(promise);\n        const execJs = sinon.mock().throws(\n            new AiAssistance.EvaluateAction.SideEffectError('EvalError: Possible side-effect in debug-evaluate'));\n        const agent = new StylingAgent.StylingAgent({\n          aidaClient: mockAidaClient([\n            [{\n              functionCalls: [{name: 'executeJavaScript', args: {code: '$0.style.backgroundColor = \\'red\\''}}],\n              explanation: '',\n            }],\n            [{\n              explanation: 'This is the answer',\n            }]\n          ]),\n          createExtensionScope,\n          confirmSideEffectForTest: stub,\n          execJs,\n\n        });\n\n        promise.resolve(true);\n        await Array.fromAsync(agent.run('test', {selected: new AiAssistance.StylingAgent.NodeContext(element)}));\n\n        sinon.assert.match(execJs.getCall(0).args[1], sinon.match({throwOnSideEffect: true}));\n      });\n\n      it('calls execJs with allowing side effects when confirmSideEffect resolves to true', async () => {\n        const promise = Promise.withResolvers();\n        const stub = sinon.stub().returns(promise);\n        const execJs = sinon.mock().twice();\n        execJs.onCall(0).throws(\n            new AiAssistance.EvaluateAction.SideEffectError('EvalError: Possible side-effect in debug-evaluate'));\n        execJs.onCall(1).resolves('value');\n        const agent = new StylingAgent.StylingAgent({\n          aidaClient: mockAidaClient([\n            [{\n              functionCalls: [{name: 'executeJavaScript', args: {code: '$0.style.backgroundColor = \\'red\\''}}],\n              explanation: '',\n            }],\n            [{\n              explanation: 'This is the answer',\n            }]\n          ]),\n          createExtensionScope,\n          confirmSideEffectForTest: stub,\n          execJs,\n\n        });\n        promise.resolve(true);\n        await Array.fromAsync(agent.run('test', {selected: new AiAssistance.StylingAgent.NodeContext(element)}));\n\n        assert.lengthOf(execJs.getCalls(), 2);\n        sinon.assert.match(execJs.getCall(1).args[1], sinon.match({throwOnSideEffect: false}));\n      });\n\n      it('returns side effect error when confirmSideEffect resolves to false', async () => {\n        const promise = Promise.withResolvers();\n        const stub = sinon.stub().returns(promise);\n        const execJs = sinon.mock().once();\n        execJs.onCall(0).throws(\n            new AiAssistance.EvaluateAction.SideEffectError('EvalError: Possible side-effect in debug-evaluate'));\n        const agent = new StylingAgent.StylingAgent({\n          aidaClient: mockAidaClient([\n            [{\n              functionCalls: [{name: 'executeJavaScript', args: {code: '$0.style.backgroundColor = \\'red\\''}}],\n              explanation: '',\n            }],\n            [{\n              explanation: 'This is the answer',\n            }]\n          ]),\n          createExtensionScope,\n          confirmSideEffectForTest: stub,\n          execJs,\n\n        });\n        promise.resolve(false);\n        const responses =\n            await Array.fromAsync(agent.run('test', {selected: new AiAssistance.StylingAgent.NodeContext(element)}));\n        const actionStep = responses.findLast(response => response.type === AiAssistance.AiAgent.ResponseType.ACTION)!;\n\n        assert.strictEqual(actionStep.output, 'Error: User denied code execution with side effects.');\n        assert.lengthOf(execJs.getCalls(), 1);\n      });\n\n      it('returns error when side effect is aborted', async () => {\n        const selected = new AiAssistance.StylingAgent.NodeContext(element);\n        const execJs = sinon.mock().once().throws(\n            new AiAssistance.EvaluateAction.SideEffectError('EvalError: Possible side-effect in debug-evaluate'));\n        const sideEffectConfirmationPromise = Promise.withResolvers();\n        const agent = new StylingAgent.StylingAgent({\n          aidaClient: mockAidaClient([[{\n            functionCalls: [{name: 'executeJavaScript', args: {code: '$0.style.backgroundColor = \\'red\\''}}],\n            explanation: '',\n          }]]),\n          createExtensionScope,\n          confirmSideEffectForTest: sinon.stub().returns(sideEffectConfirmationPromise),\n          execJs,\n        });\n\n        const responses: AiAssistance.AiAgent.ResponseData[] = [];\n        const controller = new AbortController();\n        for await (const result of agent.run('test', {selected, signal: controller.signal})) {\n          responses.push(result);\n          if (result.type === 'side-effect') {\n            // Initial code invocation resulting in a side-effect\n            // happened.\n            sinon.assert.calledOnce(execJs);\n            // Emulate abort when waiting for the side-effect confirmation.\n            controller.abort();\n          }\n        }\n\n        const errorStep = responses.at(-1) as AiAssistance.AiAgent.ErrorResponse;\n        assert.exists(errorStep);\n        assert.strictEqual(errorStep.error, AiAgent.ErrorType.ABORT);\n        assert.isFalse(await sideEffectConfirmationPromise.promise);\n      });\n    });\n\n    describe('long `Observation` text handling', () => {\n      it('errors with too long input', async () => {\n        const execJs = sinon.mock().returns(new Array(10_000).fill('<div>...</div>').join());\n        const agent = new StylingAgent.StylingAgent({\n          aidaClient: mockAidaClient([\n            [{\n              functionCalls: [{\n                name: 'executeJavaScript',\n                args: {code: '$0.style.backgroundColor = \\'red\\';'},\n              }],\n              explanation: '',\n            }],\n            [{\n              explanation: 'This is the answer',\n            }]\n          ]),\n          createExtensionScope,\n          execJs,\n        });\n\n        const result =\n            await Array.fromAsync(agent.run('test', {selected: new AiAssistance.StylingAgent.NodeContext(element)}));\n        const actionSteps = result.filter(step => {\n          return step.type === AiAssistance.AiAgent.ResponseType.ACTION;\n        });\n        assert.lengthOf(actionSteps, 1, 'Found non or multiple action steps');\n        const actionStep = actionSteps.at(0)!;\n        assert(actionStep.output!.includes('Error: Output exceeded the maximum allowed length.'));\n      });\n    });\n\n    it('generates an answer immediately', async function() {\n      const execJs = sinon.spy();\n      const agent = new StylingAgent.StylingAgent({\n        aidaClient: mockAidaClient([[{explanation: 'this is the answer'}]]),\n        execJs,\n      });\n\n      const responses =\n          await Array.fromAsync(agent.run('test', {selected: new AiAssistance.StylingAgent.NodeContext(element)}));\n      snapshotTester.assert(this, JSON.stringify(responses, null, 2));\n      sinon.assert.notCalled(execJs);\n    });\n\n    it('generates an answer immediately with correct historical contexts in the new request', async function() {\n      const execJs = sinon.spy();\n      const agent = new StylingAgent.StylingAgent({\n        aidaClient: mockAidaClient([[{explanation: 'this is the answer'}]]),\n        execJs,\n      });\n\n      await Array.fromAsync(agent.run('test', {selected: new AiAssistance.StylingAgent.NodeContext(element)}));\n      snapshotTester.assert(\n          this, JSON.stringify(agent.buildRequest({text: ''}, Host.AidaClient.Role.USER).historical_contexts, null, 2));\n    });\n\n    it('correctly handles historical_contexts in AIDA requests', async function() {\n      const execJs = sinon.mock().once();\n      execJs.onCall(0).returns('test data');\n      const aidaClient = mockAidaClient([\n        [{\n          functionCalls: [{\n            name: 'executeJavaScript',\n            args: {code: 'const data = {\"test\": \"observation\"}', thought: 'I am thinking.', title: 'thinking'},\n          }],\n          explanation: '',\n        }],\n        [{\n          explanation: 'this is the actual answer',\n        }]\n      ]);\n      const agent = new StylingAgent.StylingAgent({\n        aidaClient,\n        createExtensionScope,\n        execJs,\n      });\n\n      await Array.fromAsync(agent.run('test', {selected: new AiAssistance.StylingAgent.NodeContext(element)}));\n\n      const requests: Host.AidaClient.DoConversationRequest[] =\n          (aidaClient.doConversation as sinon.SinonStub).args.map(arg => arg[0]);\n\n      const snapshot = [];\n\n      assert.lengthOf(requests, 2, 'Unexpected number of AIDA requests');\n      assert.isUndefined(requests[0].historical_contexts, 'Unexpected historical contexts in the initial request');\n      assert.exists(requests[0].current_message);\n      assert.lengthOf(requests[0].current_message.parts, 1);\n      snapshot.push(requests[0].current_message.parts[0]);\n      assert.strictEqual(requests[0].current_message.role, Host.AidaClient.Role.USER);\n      snapshot.push(requests[1].historical_contexts);\n      snapshotTester.assert(this, JSON.stringify(snapshot, null, 2));\n      assert.exists(requests[1].current_message);\n      assert.lengthOf(requests[1].current_message.parts, 1);\n      assert.deepEqual(\n          requests[1].current_message.parts[0], {\n            functionResponse: {\n              name: 'executeJavaScript',\n              response: {\n                result: 'test data',\n              }\n            }\n          },\n          'Unexpected input in the follow-up request');\n    });\n\n    it('generates an rpcId for the answer', async function() {\n      const agent = new StylingAgent.StylingAgent({\n        aidaClient: mockAidaClient([[{\n          explanation: 'this is the answer',\n          metadata: {\n            rpcGlobalId: 123,\n          },\n        }]]),\n        execJs: sinon.spy(),\n      });\n\n      const responses =\n          await Array.fromAsync(agent.run('test', {selected: new AiAssistance.StylingAgent.NodeContext(element)}));\n      snapshotTester.assert(this, JSON.stringify(responses, null, 2));\n    });\n\n    it('throws an error based on the attribution metadata including RecitationAction.BLOCK', async function() {\n      const agent = new StylingAgent.StylingAgent({\n        aidaClient: mockAidaClient([[\n          {\n            explanation: 'this is the partial answer',\n          },\n          {\n            explanation: 'this is the partial answer and now it\\'s complete',\n            metadata: {\n              attributionMetadata: {\n                attributionAction: Host.AidaClient.RecitationAction.BLOCK,\n                citations: [],\n              },\n            },\n          }\n        ]]),\n        execJs: sinon.spy(),\n      });\n\n      const responses =\n          await Array.fromAsync(agent.run('test', {selected: new AiAssistance.StylingAgent.NodeContext(element)}));\n      snapshotTester.assert(this, JSON.stringify(responses, null, 2));\n    });\n\n    it('does not throw an error based on attribution metadata not including RecitationAction.BLOCK', async function() {\n      const agent = new StylingAgent.StylingAgent({\n        aidaClient: mockAidaClient([[{\n          explanation: 'this is the answer',\n          metadata: {\n            rpcGlobalId: 123,\n            attributionMetadata: {\n              attributionAction: Host.AidaClient.RecitationAction.ACTION_UNSPECIFIED,\n              citations: [],\n            },\n          },\n        }]]),\n        execJs: sinon.spy(),\n\n      });\n\n      const responses =\n          await Array.fromAsync(agent.run('test', {selected: new AiAssistance.StylingAgent.NodeContext(element)}));\n      snapshotTester.assert(this, JSON.stringify(responses, null, 2));\n    });\n\n    it('generates a response if nothing is returned', async function() {\n      const execJs = sinon.spy();\n      const agent = new StylingAgent.StylingAgent({\n        aidaClient: mockAidaClient([[{explanation: ''}]]),\n        execJs,\n      });\n      const responses =\n          await Array.fromAsync(agent.run('test', {selected: new AiAssistance.StylingAgent.NodeContext(element)}));\n      snapshotTester.assert(this, JSON.stringify(responses, null, 2));\n      sinon.assert.notCalled(execJs);\n      assert.isUndefined(agent.buildRequest({text: ''}, Host.AidaClient.Role.USER).historical_contexts);\n    });\n\n    it('generates an action response if action and answer both present', async function() {\n      const execJs = sinon.mock().once();\n      execJs.onCall(0).returns('hello');\n      const agent = new StylingAgent.StylingAgent({\n        aidaClient: mockAidaClient([\n          [{\n            functionCalls: [{\n              name: 'executeJavaScript',\n              args: {thought: 'I am thinking.', code: 'console.log(\\'hello\\');'},\n            }],\n            explanation: 'this is my text before the actual answer',\n          }],\n          [{\n            explanation: 'this is the actual answer',\n            metadata: {},\n          }]\n        ]),\n        createExtensionScope,\n        execJs,\n\n      });\n      const responses =\n          await Array.fromAsync(agent.run('test', {selected: new AiAssistance.StylingAgent.NodeContext(element)}));\n      snapshotTester.assert(this, JSON.stringify(responses, null, 2));\n      sinon.assert.calledOnce(execJs);\n    });\n\n    it('generates history for multiple actions', async function() {\n      const execJs = sinon.spy(async () => 'undefined');\n      const agent = new StylingAgent.StylingAgent({\n        aidaClient: mockAidaClient([\n          [{\n            functionCalls: [{\n              name: 'executeJavaScript',\n              args: {thought: 'thought 1', title: 'test', code: 'console.log(\\'test\\')'},\n            }],\n            explanation: '',\n          }],\n          [{\n            functionCalls: [{\n              name: 'executeJavaScript',\n              args: {thought: 'thought 2', title: 'test', code: 'console.log(\\'test\\')'},\n            }],\n            explanation: '',\n          }],\n          [{\n            functionCalls: [{\n              name: 'executeJavaScript',\n              args: {thought: 'thought 3', title: 'test', code: 'console.log(\\'test\\')'},\n            }],\n            explanation: '',\n          }],\n          [{explanation: 'this is the answer'}]\n        ]),\n        createExtensionScope,\n        execJs,\n\n      });\n\n      await Array.fromAsync(agent.run('test', {selected: new AiAssistance.StylingAgent.NodeContext(element)}));\n\n      snapshotTester.assert(\n          this, JSON.stringify(agent.buildRequest({text: ''}, Host.AidaClient.Role.USER).historical_contexts, null, 2));\n    });\n\n    it('stops when aborted', async () => {\n      const execJs = sinon.spy();\n      const agent = new StylingAgent.StylingAgent({\n        aidaClient: mockAidaClient([\n          [{\n            functionCalls: [{\n              name: 'executeJavaScript',\n              args: {thought: 'thought 1', title: 'test', code: 'console.log(\\'test\\')'},\n            }],\n            explanation: '',\n          }],\n          [{\n            functionCalls: [{\n              name: 'executeJavaScript',\n              args: {thought: 'thought 2', title: 'test', code: 'console.log(\\'test\\')'},\n            }],\n            explanation: '',\n          }],\n          [{\n            functionCalls: [{\n              name: 'executeJavaScript',\n              args: {thought: 'thought 3', title: 'test', code: 'console.log(\\'test\\')'},\n            }],\n            explanation: '',\n          }],\n          [{explanation: 'this is the answer'}]\n        ]),\n        createExtensionScope,\n        execJs,\n      });\n\n      const controller = new AbortController();\n      controller.abort();\n      await Array.fromAsync(\n          agent.run('test', {selected: new AiAssistance.StylingAgent.NodeContext(element), signal: controller.signal}));\n\n      assert.isUndefined(agent.buildRequest({text: ''}, Host.AidaClient.Role.USER).historical_contexts);\n    });\n  });\n\n  describe('enhanceQuery', () => {\n    let agent: AiAssistance.StylingAgent.StylingAgent;\n\n    beforeEach(() => {\n      agent = new StylingAgent.StylingAgent({\n        aidaClient: mockAidaClient(),\n      });\n      element.simpleSelector.returns('div#myElement');\n      element.getChildNodesPromise.resolves(null);\n    });\n\n    it('does not add multimodal input evaluation prompt when multimodal is disabled', async function() {\n      mockHostConfig('test model');\n      const enhancedQuery = await agent.enhanceQuery(\n          'test query', new AiAssistance.StylingAgent.NodeContext(element),\n          AiAssistance.AiAgent.MultimodalInputType.SCREENSHOT);\n\n      snapshotTester.assert(this, enhancedQuery);\n    });\n\n    it('does not add multimodal input evaluation prompt when multimodal is enabled but multimodalInputType is missing',\n       async function() {\n         mockHostConfig('test model', 1, 'PUBLIC', Root.Runtime.HostConfigFreestylerExecutionMode.NO_SCRIPTS, true);\n         const enhancedQuery =\n             await agent.enhanceQuery('test query', new AiAssistance.StylingAgent.NodeContext(element));\n\n         snapshotTester.assert(this, enhancedQuery);\n       });\n\n    it('adds multimodal input evaluation prompt when multimodal is enabled and multimodalInputType is screenshot',\n       async function() {\n         mockHostConfig('test model', 1, 'PUBLIC', Root.Runtime.HostConfigFreestylerExecutionMode.NO_SCRIPTS, true);\n         const enhancedQuery = await agent.enhanceQuery(\n             'test query', new AiAssistance.StylingAgent.NodeContext(element),\n             AiAssistance.AiAgent.MultimodalInputType.SCREENSHOT);\n\n         snapshotTester.assert(this, enhancedQuery);\n       });\n\n    it('adds multimodal input evaluation prompt when multimodal is enabled and multimodalInputType is uploaded image',\n       async function() {\n         mockHostConfig('test model', 1, 'PUBLIC', Root.Runtime.HostConfigFreestylerExecutionMode.NO_SCRIPTS, true);\n         const enhancedQuery = await agent.enhanceQuery(\n             'test query', new AiAssistance.StylingAgent.NodeContext(element),\n             AiAssistance.AiAgent.MultimodalInputType.UPLOADED_IMAGE);\n\n         snapshotTester.assert(this, enhancedQuery);\n       });\n  });\n\n  describe('HostConfigFreestylerExecutionMode', () => {\n    function getMockClient() {\n      return mockAidaClient([\n        [{\n          functionCalls: [{name: 'executeJavaScript', args: {code: '$0.style.backgroundColor = \\'red\\''}}],\n          explanation: '',\n        }],\n        [{\n          explanation: 'This is the answer',\n        }]\n      ]);\n    }\n\n    describe('NO_SCRIPTS', () => {\n      beforeEach(() => {\n        mockHostConfig(undefined, undefined, undefined, Root.Runtime.HostConfigFreestylerExecutionMode.NO_SCRIPTS);\n      });\n\n      it('returns an error if scripts are disabled', async () => {\n        const execJs = sinon.mock();\n        const agent = new StylingAgent.StylingAgent({\n          aidaClient: getMockClient(),\n          createExtensionScope,\n          execJs,\n        });\n        const responses =\n            await Array.fromAsync(agent.run('test', {selected: new AiAssistance.StylingAgent.NodeContext(element)}));\n        const actionStep = responses.find(response => response.type === AiAssistance.AiAgent.ResponseType.ACTION)!;\n        assert.strictEqual(actionStep.output, 'Error: JavaScript execution is currently disabled.');\n        assert.lengthOf(execJs.getCalls(), 0);\n      });\n    });\n\n    describe('SIDE_EFFECT_FREE_SCRIPTS_ONLY', () => {\n      beforeEach(() => {\n        mockHostConfig(\n            undefined, undefined, undefined,\n            Root.Runtime.HostConfigFreestylerExecutionMode.SIDE_EFFECT_FREE_SCRIPTS_ONLY);\n      });\n\n      it('returns an error if a script causes a side effect', async () => {\n        const execJs = sinon.mock().throws(\n            new AiAssistance.EvaluateAction.SideEffectError('EvalError: Possible side-effect in debug-evaluate'));\n        const agent = new StylingAgent.StylingAgent({\n          aidaClient: getMockClient(),\n          createExtensionScope,\n          execJs,\n        });\n        const responses =\n            await Array.fromAsync(agent.run('test', {selected: new AiAssistance.StylingAgent.NodeContext(element)}));\n        const actionStep = responses.find(response => response.type === AiAssistance.AiAgent.ResponseType.ACTION)!;\n        assert.strictEqual(\n            actionStep.output, 'Error: JavaScript execution that modifies the page is currently disabled.');\n        assert.lengthOf(execJs.getCalls(), 1);\n      });\n    });\n  });\n});\n"]}