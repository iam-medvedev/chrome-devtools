{"version":3,"file":"ConversationHandler.test.js","sourceRoot":"","sources":["../../../../../../front_end/models/ai_assistance/ConversationHandler.test.ts"],"names":[],"mappings":"AAAA,sCAAsC;AACtC,yEAAyE;AACzE,6BAA6B;AAE7B,OAAO,KAAK,MAAM,MAAM,6BAA6B,CAAC;AACtD,OAAO,KAAK,IAAI,MAAM,yBAAyB,CAAC;AAChD,OAAO,KAAK,GAAG,MAAM,uBAAuB,CAAC;AAC7C,OAAO,KAAK,iBAAiB,MAAM,6CAA6C,CAAC;AACjF,OAAO,KAAK,SAAS,MAAM,uCAAuC,CAAC;AACnE,OAAO,EACL,OAAO,EACP,oBAAoB,EACpB,cAAc,GACf,MAAM,sCAAsC,CAAC;AAC9C,OAAO,EAAC,YAAY,EAAE,mBAAmB,EAAE,gBAAgB,EAAC,MAAM,qCAAqC,CAAC;AACxG,OAAO,EAAC,0BAA0B,EAAC,MAAM,iCAAiC,CAAC;AAC3E,OAAO,EAAC,mCAAmC,EAAC,MAAM,iCAAiC,CAAC;AAEpF,0BAA0B,CAAC,qBAAqB,EAAE,GAAG,EAAE;IACrD,QAAQ,CAAC,uBAAuB,EAAE,GAAG,EAAE;QACrC,MAAM,WAAW,GAAG,yBAAyB,CAAC;QAC9C,IAAI,iBAAkC,CAAC;QAEvC,UAAU,CAAC,KAAK,IAAI,EAAE;YACpB,iBAAiB,CAAC,mBAAmB,CAAC,mBAAmB,CAAC,cAAc,EAAE,CAAC;YAC3E,mBAAmB,CAAC;gBAClB,gCAAgC,EAAE,wBAAwB,EAAE,2BAA2B;gBACvF,uBAAuB,EAAE,4BAA4B;aACtD,CAAC,CAAC;YACH,MAAM,CAAC,QAAQ,CAAC,aAAa,CAAC,uBAAuB,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;YACjE,gBAAgB,CAAC;gBACf,kBAAkB,EAAE;oBAClB,OAAO,EAAE,IAAI;iBAEd;gBACD,gCAAgC,EAAE;oBAChC,OAAO,EAAE,IAAI;iBACd;aACF,CAAC,CAAC;YAEH,MAAM,MAAM,GAAG,YAAY,EAAE,CAAC;YAC9B,iBAAiB,GAAG,KAAK,CAAC,IAAI,CAAC,MAAM,CAAC,QAAQ,EAAE,EAAE,sBAAsB,CAAC;iBAChD,QAAQ,CAAC,EAAC,QAAQ,EAAE,UAAU,EAAE,WAAW,EAAE,CAAC,EAAE,QAAQ,EAAE,GAAG,EAAE,CAAC,SAAS,EAAC,CAAC,CAAC;QACvG,CAAC,CAAC,CAAC;QAEH,SAAS,CAAC,OAAO,CAAC,CAAC;QAEnB,QAAQ,CAAC,gBAAgB,EAAE,GAAG,EAAE;YAC9B,EAAE,CAAC,cAAc,EAAE,KAAK,IAAI,EAAE;gBAC5B,MAAM,CAAC,QAAQ,CAAC,aAAa,CAAC,uBAAuB,CAAC,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;gBAClE,MAAM,mBAAmB,GAAG,iBAAiB,CAAC,mBAAmB,CAAC,mBAAmB,CAAC,QAAQ,CAAC;oBAC7F,UAAU,EAAE,cAAc,CAAC,CAAC,CAAC,EAAC,WAAW,EAAC,CAAC,CAAC,CAAC;oBAC7C,gBAAgB,qEAAmD;iBACpE,CAAC,CAAC;gBACH,MAAM,SAAS,GAAG,MAAM,mBAAmB,CAAC,qBAAqB,CAAC;oBAChE,MAAM,EAAE,mCAAmC;oBAC3C,gBAAgB,gFAA6D;iBAC9E,CAAC,CAAC;gBACH,MAAM,QAAQ,GAAG,MAAM,SAAS,CAAC,IAAI,EAAE,CAAC;gBACxC,MAAM,CAAC,WAAW,CAAC,QAAQ,CAAC,KAAK,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC;gBACjD,MAAM,CAAC,WAAW,CACd,QAAQ,CAAC,KAAK,CAAC,OAAO,EACtB,yFAAyF,CAAC,CAAC;YACjG,CAAC,CAAC,CAAC;YAEH,EAAE,CAAC,yBAAyB,EAAE,KAAK,IAAI,EAAE;gBACvC,MAAM,mBAAmB,GAAG,iBAAiB,CAAC,mBAAmB,CAAC,mBAAmB,CAAC,QAAQ,CAAC;oBAC7F,UAAU,EAAE,cAAc,CAAC,CAAC,CAAC,EAAC,WAAW,EAAC,CAAC,CAAC,CAAC;oBAC7C,gBAAgB,+EAAwD;iBACzE,CAAC,CAAC;gBACH,MAAM,SAAS,GAAG,MAAM,mBAAmB,CAAC,qBAAqB,CAAC;oBAChE,MAAM,EAAE,mCAAmC;oBAC3C,gBAAgB,gFAA6D;iBAC9E,CAAC,CAAC;gBACH,MAAM,QAAQ,GAAG,MAAM,SAAS,CAAC,IAAI,EAAE,CAAC;gBACxC,MAAM,CAAC,WAAW,CAAC,QAAQ,CAAC,KAAK,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC;gBACjD,MAAM,CAAC,WAAW,CACd,QAAQ,CAAC,KAAK,CAAC,OAAO,EACtB,oFAAoF,CAAC,CAAC;YAC5F,CAAC,CAAC,CAAC;YAEH,EAAE,CAAC,aAAa,EAAE,KAAK,IAAI,EAAE;gBAC3B,gBAAgB,CAAC;oBACf,gBAAgB,EAAE;wBAChB,YAAY,EAAE,IAAI;qBACnB;oBACD,kBAAkB,EAAE;wBAClB,OAAO,EAAE,IAAI;qBACd;iBACF,CAAC,CAAC;gBACH,MAAM,mBAAmB,GAAG,iBAAiB,CAAC,mBAAmB,CAAC,mBAAmB,CAAC,QAAQ,CAAC;oBAC7F,UAAU,EAAE,cAAc,CAAC,CAAC,CAAC,EAAC,WAAW,EAAC,CAAC,CAAC,CAAC;oBAC7C,gBAAgB,qEAAmD;iBACpE,CAAC,CAAC;gBACH,MAAM,SAAS,GAAG,MAAM,mBAAmB,CAAC,qBAAqB,CAAC;oBAChE,MAAM,EAAE,mCAAmC;oBAC3C,gBAAgB,gFAA6D;iBAC9E,CAAC,CAAC;gBACH,MAAM,QAAQ,GAAG,MAAM,SAAS,CAAC,IAAI,EAAE,CAAC;gBACxC,MAAM,CAAC,WAAW,CAAC,QAAQ,CAAC,KAAK,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC;gBACjD,MAAM,CAAC,WAAW,CACd,QAAQ,CAAC,KAAK,CAAC,OAAO,EAAE,2EAA2E,CAAC,CAAC;YAC3G,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,wDAAwD,EAAE,KAAK,IAAI,EAAE;YACtE,MAAM,mBAAmB,GAAG,iBAAiB,CAAC,mBAAmB,CAAC,mBAAmB,CAAC,QAAQ,CAAC;gBAC7F,UAAU,EAAE,cAAc,CAAC,CAAC,CAAC,EAAC,WAAW,EAAC,CAAC,CAAC,CAAC;gBAC7C,gBAAgB,qEAAmD;aACpE,CAAC,CAAC;YACH,MAAM,kBAAkB,GAAG,KAAK,CAAC,GAAG,EAAE,CAAC;YACvC,mBAAmB,CAAC,gBAAgB,4HAEhC,kBAAkB,CAAC,CAAC;YACxB,MAAM,SAAS,GAAG,MAAM,mBAAmB,CAAC,qBAAqB,CAAC;gBAChE,MAAM,EAAE,mCAAmC;gBAC3C,gBAAgB,gFAA6D;aAC9E,CAAC,CAAC;YACH,MAAM,QAAQ,GAAG,MAAM,SAAS,CAAC,IAAI,EAAE,CAAC;YACxC,MAAM,CAAC,WAAW,CAAC,QAAQ,CAAC,KAAK,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC;YACxD,KAAK,CAAC,MAAM,CAAC,UAAU,CAAC,kBAAkB,CAAC,CAAC;QAC9C,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,8DAA8D,EAAE,KAAK,IAAI,EAAE;YAC5E,MAAM,mBAAmB,GAAG,iBAAiB,CAAC,mBAAmB,CAAC,mBAAmB,CAAC,QAAQ,CAAC;gBAC7F,UAAU,EAAE,cAAc,CAAC,CAAC,CAAC,EAAC,WAAW,EAAC,CAAC,CAAC,CAAC;gBAC7C,gBAAgB,qEAAmD;aACpE,CAAC,CAAC;YACH,MAAM,SAAS,GAAG,MAAM,mBAAmB,CAAC,qBAAqB,CAAC;gBAChE,MAAM,EAAE,mCAAmC;gBAC3C,gBAAgB,gFAA6D;gBAC7E,QAAQ,EAAE,IAAI;aACf,CAAC,CAAC;YACH,MAAM,QAAQ,GAAG,MAAM,SAAS,CAAC,IAAI,EAAE,CAAC;YACxC,MAAM,CAAC,WAAW,CAAC,QAAQ,CAAC,KAAK,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC;YACxD,KAAK,CAAC,MAAM,CAAC,UAAU,CAAC,iBAAiB,CAAC,CAAC;YAC3C,MAAM,CAAC,WAAW,CAAC,iBAAiB,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,KAAK,EAAE,IAAI,CAAC,CAAC;QACvE,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,kDAAkD,EAAE,KAAK,IAAI,EAAE;YAChE,MAAM,mBAAmB,GAAG,iBAAiB,CAAC,mBAAmB,CAAC,mBAAmB,CAAC,QAAQ,CAAC;gBAC7F,UAAU,EAAE,cAAc,CAAC;oBACzB,CAAC;4BACC,aAAa,EAAE,CAAC;oCACd,IAAI,EAAE,mBAAmB;oCACzB,IAAI,EAAE,EAAC,IAAI,EAAE,qCAAqC,EAAC;iCACpD,CAAC;4BACF,WAAW,EAAE,EAAE;yBAChB,CAAC;iBACH,CAAC;gBACF,gBAAgB,qEAAmD;aACpE,CAAC,CAAC;YACH,MAAM,SAAS,GAAG,MAAM,mBAAmB,CAAC,qBAAqB,CAAC;gBAChE,MAAM,EAAE,mCAAmC;gBAC3C,gBAAgB,gFAA6D;aAC9E,CAAC,CAAC;YACH,MAAM,QAAQ,GAAG,MAAM,SAAS,CAAC,IAAI,EAAE,CAAC;YACxC,MAAM,CAAC,WAAW,CAAC,QAAQ,CAAC,KAAK,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC;YACjD,MAAM,CAAC,WAAW,CAAC,QAAQ,CAAC,KAAK,CAAC,OAAO,EAAE,gDAAgD,CAAC,CAAC;QAC/F,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,4CAA4C,EAAE,KAAK,IAAI,EAAE;YAC1D,MAAM,UAAU,GAAG,cAAc,CAAC,CAAC,CAAC,EAAC,WAAW,EAAC,CAAC,CAAC,CAAC,CAAC;YACrD,MAAM,iBAAiB,CAAC,gBAAgB,CAAC,gBAAgB,CAAC,QAAQ,EAAE,CAAC,SAAS,EAAE,CAAC;YACjF,MAAM,mBAAmB,GAAG,iBAAiB,CAAC,mBAAmB,CAAC,mBAAmB,CAAC,QAAQ,CAAC;gBAC7F,UAAU;gBACV,gBAAgB,qEAAmD;aACpE,CAAC,CAAC;YACH,MAAM,SAAS,GAAG,MAAM,mBAAmB,CAAC,qBAAqB,CAAC;gBAChE,MAAM,EAAE,mCAAmC;gBAC3C,gBAAgB,gFAA6D;aAC9E,CAAC,CAAC;YACH,MAAM,SAAS,CAAC,IAAI,EAAE,CAAC;YACvB,MAAM,uBAAuB,GAAG,iBAAiB,CAAC,gBAAgB,CAAC,gBAAgB,CAAC,QAAQ,EAAE,CAAC,UAAU,EAAE,CAAC;YAC5G,MAAM,CAAC,QAAQ,CAAC,uBAAuB,EAAE,CAAC,CAAC,CAAC;YAC5C,MAAM,CAAC,WAAW,CAAC,uBAAuB,CAAC,CAAC,CAAC,CAAC,IAAI,iFAA8D,CAAC;YACjH,MAAM,CAAC,MAAM,CAAC,uBAAuB,CAAC,CAAC,CAAC,CAAC,UAAU,CAAC,CAAC;YACrD,MAAM,CAAC,WAAW,CACd,IAAI,CAAC,SAAS,CAAC,uBAAuB,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,EAClD,4JAA4J,CAAC,CAAC;QACpK,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,wDAAwD,EAAE,KAAK,IAAI,EAAE;YACtE,MAAM,mCAAmC,EAAE,CAAC;YAC5C,MAAM,CAAC,QAAQ,CAAC,aAAa,CAAC,uBAAuB,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;YACjE,MAAM,mBAAmB,GAAG,iBAAiB,CAAC,mBAAmB,CAAC,mBAAmB,CAAC,QAAQ,CAAC;gBAC7F,UAAU,EAAE,cAAc,CAAC,CAAC,CAAC,EAAC,WAAW,EAAC,CAAC,CAAC,CAAC;gBAC7C,gBAAgB,qEAAmD;aACpE,CAAC,CAAC;YACH,MAAM,kBAAkB,GAAG,KAAK,CAAC,GAAG,EAAE,CAAC;YACvC,mBAAmB,CAAC,gBAAgB,4HAEhC,kBAAkB,CAAC,CAAC;YAExB,MAAM,OAAO,GAAG,oBAAoB,EAAE,CAAC;YACvC,KAAK,CAAC,IAAI,CAAC,OAAO,EAAE,oBAAoB,CAAC;iBACpC,QAAQ,CAAC,IAAI,SAAS,CAAC,WAAW,CAAC,WAAW,CAAC,EAAE,EAAE,KAAK,EAAE,YAAY,CAAC,CAAC,CAAC;YAE9E,MAAM,cAAc,GAAG,KAAK,CAAC,kBAAkB,CAAC,GAAG,CAAC,cAAc,CAAC,cAAc,EAAE;gBACjF,aAAa,EAAE,OAAO;aACvB,CAAC,CAAC;YACH,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC,aAAa,CAAC,aAAa,CAAC,QAAQ,EAAE,EAAE,QAAQ,CAAC,CAAC,OAAO,CAAC,CAAC,cAAc,CAAC,CAAC,CAAC;YAE3F,MAAM,SAAS,GAAG,MAAM,mBAAmB,CAAC,qBAAqB,CAAC;gBAChE,MAAM,EAAE,mCAAmC;gBAC3C,gBAAgB,6FAA6D;gBAC7E,UAAU,EAAE,yBAAyB;aACtC,CAAC,CAAC;YACH,IAAI,QAAQ,GAAG,MAAM,SAAS,CAAC,IAAI,EAAE,CAAC;YACtC,MAAM,CAAC,WAAW,CAAC,QAAQ,CAAC,KAAK,CAAC,OAAO,EAAE,wBAAwB,CAAC,CAAC;YACrE,QAAQ,GAAG,MAAM,SAAS,CAAC,IAAI,EAAE,CAAC;YAClC,MAAM,CAAC,WAAW,CAAC,QAAQ,CAAC,KAAK,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC;YACxD,KAAK,CAAC,MAAM,CAAC,UAAU,CAAC,kBAAkB,CAAC,CAAC;QAC9C,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","sourcesContent":["// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../core/common/common.js';\nimport * as Host from '../../core/host/host.js';\nimport * as SDK from '../../core/sdk/sdk.js';\nimport * as AiAssistanceModel from '../../models/ai_assistance/ai_assistance.js';\nimport * as TextUtils from '../../models/text_utils/text_utils.js';\nimport {\n  cleanup,\n  createNetworkRequest,\n  mockAidaClient,\n} from '../../testing/AiAssistanceHelpers.js';\nimport {createTarget, registerNoopActions, updateHostConfig} from '../../testing/EnvironmentHelpers.js';\nimport {describeWithMockConnection} from '../../testing/MockConnection.js';\nimport {createNetworkPanelForMockConnection} from '../../testing/NetworkHelpers.js';\n\ndescribeWithMockConnection('ConversationHandler', () => {\n  describe('handleExternalRequest', () => {\n    const explanation = 'I need more information';\n    let performSearchStub: sinon.SinonStub;\n\n    beforeEach(async () => {\n      AiAssistanceModel.ConversationHandler.ConversationHandler.removeInstance();\n      registerNoopActions([\n        'elements.toggle-element-search', 'timeline.record-reload', 'timeline.toggle-recording',\n        'timeline.show-history', 'components.collect-garbage'\n      ]);\n      Common.Settings.moduleSetting('ai-assistance-enabled').set(true);\n      updateHostConfig({\n        devToolsFreestyler: {\n          enabled: true,\n\n        },\n        devToolsAiAssistanceNetworkAgent: {\n          enabled: true,\n        }\n      });\n\n      const target = createTarget();\n      performSearchStub = sinon.stub(target.domAgent(), 'invoke_performSearch')\n                              .resolves({searchId: 'uniqueId', resultCount: 0, getError: () => undefined});\n    });\n\n    afterEach(cleanup);\n\n    describe('can be blocked', () => {\n      it('by a setting', async () => {\n        Common.Settings.moduleSetting('ai-assistance-enabled').set(false);\n        const conversationHandler = AiAssistanceModel.ConversationHandler.ConversationHandler.instance({\n          aidaClient: mockAidaClient([[{explanation}]]),\n          aidaAvailability: Host.AidaClient.AidaAccessPreconditions.AVAILABLE,\n        });\n        const generator = await conversationHandler.handleExternalRequest({\n          prompt: 'Please help me debug this problem',\n          conversationType: AiAssistanceModel.AiHistoryStorage.ConversationType.STYLING,\n        });\n        const response = await generator.next();\n        assert.strictEqual(response.value.type, 'error');\n        assert.strictEqual(\n            response.value.message,\n            'For AI features to be available, you need to enable AI assistance in DevTools settings.');\n      });\n\n      it('by feature availability', async () => {\n        const conversationHandler = AiAssistanceModel.ConversationHandler.ConversationHandler.instance({\n          aidaClient: mockAidaClient([[{explanation}]]),\n          aidaAvailability: Host.AidaClient.AidaAccessPreconditions.SYNC_IS_PAUSED,\n        });\n        const generator = await conversationHandler.handleExternalRequest({\n          prompt: 'Please help me debug this problem',\n          conversationType: AiAssistanceModel.AiHistoryStorage.ConversationType.STYLING,\n        });\n        const response = await generator.next();\n        assert.strictEqual(response.value.type, 'error');\n        assert.strictEqual(\n            response.value.message,\n            'This feature is only available when you sign into Chrome with your Google account.');\n      });\n\n      it('by user age', async () => {\n        updateHostConfig({\n          aidaAvailability: {\n            blockedByAge: true,\n          },\n          devToolsFreestyler: {\n            enabled: true,\n          },\n        });\n        const conversationHandler = AiAssistanceModel.ConversationHandler.ConversationHandler.instance({\n          aidaClient: mockAidaClient([[{explanation}]]),\n          aidaAvailability: Host.AidaClient.AidaAccessPreconditions.AVAILABLE,\n        });\n        const generator = await conversationHandler.handleExternalRequest({\n          prompt: 'Please help me debug this problem',\n          conversationType: AiAssistanceModel.AiHistoryStorage.ConversationType.STYLING\n        });\n        const response = await generator.next();\n        assert.strictEqual(response.value.type, 'error');\n        assert.strictEqual(\n            response.value.message, 'This feature is only available to users who are 18 years of age or older.');\n      });\n    });\n\n    it('returns an explanation for styling assistance requests', async () => {\n      const conversationHandler = AiAssistanceModel.ConversationHandler.ConversationHandler.instance({\n        aidaClient: mockAidaClient([[{explanation}]]),\n        aidaAvailability: Host.AidaClient.AidaAccessPreconditions.AVAILABLE,\n      });\n      const requestReceivedSpy = sinon.spy();\n      conversationHandler.addEventListener(\n          AiAssistanceModel.ConversationHandler.ConversationHandlerEvents.EXTERNAL_REQUEST_RECEIVED,\n          requestReceivedSpy);\n      const generator = await conversationHandler.handleExternalRequest({\n        prompt: 'Please help me debug this problem',\n        conversationType: AiAssistanceModel.AiHistoryStorage.ConversationType.STYLING\n      });\n      const response = await generator.next();\n      assert.strictEqual(response.value.message, explanation);\n      sinon.assert.calledOnce(requestReceivedSpy);\n    });\n\n    it('handles styling assistance requests which contain a selector', async () => {\n      const conversationHandler = AiAssistanceModel.ConversationHandler.ConversationHandler.instance({\n        aidaClient: mockAidaClient([[{explanation}]]),\n        aidaAvailability: Host.AidaClient.AidaAccessPreconditions.AVAILABLE,\n      });\n      const generator = await conversationHandler.handleExternalRequest({\n        prompt: 'Please help me debug this problem',\n        conversationType: AiAssistanceModel.AiHistoryStorage.ConversationType.STYLING,\n        selector: 'h1'\n      });\n      const response = await generator.next();\n      assert.strictEqual(response.value.message, explanation);\n      sinon.assert.calledOnce(performSearchStub);\n      assert.strictEqual(performSearchStub.getCall(0).args[0].query, 'h1');\n    });\n\n    it('returns an error if no answer could be generated', async () => {\n      const conversationHandler = AiAssistanceModel.ConversationHandler.ConversationHandler.instance({\n        aidaClient: mockAidaClient([\n          [{\n            functionCalls: [{\n              name: 'executeJavaScript',\n              args: {code: '$0.style.backgroundColor = \\'red\\';'},\n            }],\n            explanation: '',\n          }],\n        ]),\n        aidaAvailability: Host.AidaClient.AidaAccessPreconditions.AVAILABLE,\n      });\n      const generator = await conversationHandler.handleExternalRequest({\n        prompt: 'Please help me debug this problem',\n        conversationType: AiAssistanceModel.AiHistoryStorage.ConversationType.STYLING\n      });\n      const response = await generator.next();\n      assert.strictEqual(response.value.type, 'error');\n      assert.strictEqual(response.value.message, 'Something went wrong. No answer was generated.');\n    });\n\n    it('persists external conversations to history', async () => {\n      const aidaClient = mockAidaClient([[{explanation}]]);\n      await AiAssistanceModel.AiHistoryStorage.AiHistoryStorage.instance().deleteAll();\n      const conversationHandler = AiAssistanceModel.ConversationHandler.ConversationHandler.instance({\n        aidaClient,\n        aidaAvailability: Host.AidaClient.AidaAccessPreconditions.AVAILABLE,\n      });\n      const generator = await conversationHandler.handleExternalRequest({\n        prompt: 'Please help me debug this problem',\n        conversationType: AiAssistanceModel.AiHistoryStorage.ConversationType.STYLING\n      });\n      await generator.next();\n      const historicalConversations = AiAssistanceModel.AiHistoryStorage.AiHistoryStorage.instance().getHistory();\n      assert.lengthOf(historicalConversations, 1);\n      assert.strictEqual(historicalConversations[0].type, AiAssistanceModel.AiHistoryStorage.ConversationType.STYLING);\n      assert.isTrue(historicalConversations[0].isExternal);\n      assert.strictEqual(\n          JSON.stringify(historicalConversations[0].history),\n          '[{\"type\":\"user-query\",\"query\":\"Please help me debug this problem\"},{\"type\":\"querying\"},{\"type\":\"answer\",\"text\":\"I need more information\",\"complete\":true}]');\n    });\n\n    it('returns an explanation for network assistance requests', async () => {\n      await createNetworkPanelForMockConnection();\n      Common.Settings.moduleSetting('ai-assistance-enabled').set(true);\n      const conversationHandler = AiAssistanceModel.ConversationHandler.ConversationHandler.instance({\n        aidaClient: mockAidaClient([[{explanation}]]),\n        aidaAvailability: Host.AidaClient.AidaAccessPreconditions.AVAILABLE,\n      });\n      const requestReceivedSpy = sinon.spy();\n      conversationHandler.addEventListener(\n          AiAssistanceModel.ConversationHandler.ConversationHandlerEvents.EXTERNAL_REQUEST_RECEIVED,\n          requestReceivedSpy);\n\n      const request = createNetworkRequest();\n      sinon.stub(request, 'requestContentData')\n          .resolves(new TextUtils.ContentData.ContentData('', false, 'text/plain'));\n\n      const networkManager = sinon.createStubInstance(SDK.NetworkManager.NetworkManager, {\n        requestForURL: request,\n      });\n      sinon.stub(SDK.TargetManager.TargetManager.instance(), 'models').returns([networkManager]);\n\n      const generator = await conversationHandler.handleExternalRequest({\n        prompt: 'Please help me debug this problem',\n        conversationType: AiAssistanceModel.AiHistoryStorage.ConversationType.NETWORK,\n        requestUrl: 'https://localhost:8080/'\n      });\n      let response = await generator.next();\n      assert.strictEqual(response.value.message, 'Analyzing network data');\n      response = await generator.next();\n      assert.strictEqual(response.value.message, explanation);\n      sinon.assert.calledOnce(requestReceivedSpy);\n    });\n  });\n});\n"]}