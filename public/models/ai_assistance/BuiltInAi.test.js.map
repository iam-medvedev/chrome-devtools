{"version":3,"file":"BuiltInAi.test.js","sourceRoot":"","sources":["../../../../../../front_end/models/ai_assistance/BuiltInAi.test.ts"],"names":[],"mappings":"AAAA,sCAAsC;AACtC,yEAAyE;AACzE,6BAA6B;AAE7B,OAAO,EAAC,gBAAgB,EAAC,MAAM,qCAAqC,CAAC;AACrE,OAAO,KAAK,iBAAiB,MAAM,mCAAmC,CAAC;AAEvE,QAAQ,CAAC,WAAW,EAAE,GAAG,EAAE;IACzB,EAAE,CAAC,uCAAuC,EAAE,KAAK,IAAI,EAAE;QACrD,gBAAgB,CAAC;YACf,mBAAmB,EAAE;gBACnB,OAAO,EAAE,IAAI;gBACb,eAAe,EAAE,IAAI;aACtB;SACF,CAAC,CAAC;QAEH,KAAK,SAAS,CAAC,CAAC,eAAe;YAC7B,MAAM,SAAS,CAAC;YAChB,MAAM,kBAAkB,CAAC;QAC3B,CAAC;QAED,MAAM,iBAAiB,GAAG;YACxB,OAAO,EAAE,GAAG,EAAE,GAAE,CAAC;YACjB,KAAK,EAAE,GAAG,EAAE,CAAC,iBAAiB;YAC9B,eAAe;SAChB,CAAC;QACF,mBAAmB;QACnB,MAAM,CAAC,aAAa,GAAG;YACrB,YAAY,EAAE,GAAG,EAAE,CAAC,WAAW;YAC/B,MAAM,EAAE,GAAG,EAAE,CAAC,iBAAiB;SAChC,CAAC;QAEF,MAAM,SAAS,GAAG,IAAI,iBAAiB,CAAC,SAAS,CAAC,SAAS,EAAE,CAAC;QAC9D,MAAM,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC;QAC5B,MAAM,SAAS,CAAC,kBAAkB,CAAC;QACnC,MAAM,CAAC,MAAM,CAAC,SAAS,CAAC,UAAU,EAAE,CAAC,CAAC;QACtC,MAAM,eAAe,GAAG,IAAI,eAAe,EAAE,CAAC;QAC9C,MAAM,MAAM,GAAG,SAAS,CAAC,iBAAiB,CAAC,oBAAoB,EAAE,eAAe,CAAC,CAAC;QAClF,IAAI,QAAQ,GAAG,EAAE,CAAC;QAClB,IAAI,KAAK,EAAE,MAAM,KAAK,IAAI,MAAM,EAAE,CAAC;YACjC,QAAQ,IAAI,KAAK,CAAC;QACpB,CAAC;QACD,MAAM,CAAC,WAAW,CAAC,QAAQ,EAAE,yBAAyB,CAAC,CAAC;QACxD,iBAAiB,CAAC,SAAS,CAAC,SAAS,CAAC,cAAc,EAAE,CAAC;IACzD,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,+CAA+C,EAAE,KAAK,IAAI,EAAE;QAC7D,gBAAgB,CAAC;YACf,mBAAmB,EAAE;gBACnB,OAAO,EAAE,IAAI;gBACb,eAAe,EAAE,KAAK;aACvB;SACF,CAAC,CAAC;QAEH,mBAAmB;QACnB,MAAM,CAAC,aAAa,GAAG;YACrB,YAAY,EAAE,GAAG,EAAE,CAAC,WAAW;YAC/B,MAAM,EAAE,GAAG,EAAE,GAAE,CAAC;SACjB,CAAC;QAEF,MAAM,SAAS,GAAG,IAAI,iBAAiB,CAAC,SAAS,CAAC,SAAS,EAAE,CAAC;QAC9D,MAAM,SAAS,CAAC,kBAAkB,CAAC;QACnC,MAAM,CAAC,OAAO,CAAC,SAAS,CAAC,qBAAqB,EAAE,CAAC,CAAC;IACpD,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,2BAA2B,EAAE,KAAK,IAAI,EAAE;QACzC,gBAAgB,CAAC;YACf,mBAAmB,EAAE;gBACnB,OAAO,EAAE,IAAI;gBACb,eAAe,EAAE,IAAI;aACtB;SACF,CAAC,CAAC;QAEH,mBAAmB;QACnB,MAAM,CAAC,aAAa,GAAG;YACrB,YAAY,EAAE,GAAG,EAAE,CAAC,cAAc;YAClC,MAAM,EAAE,CAAC,MAA4C,EAAE,EAAE;gBACvD,MAAM,WAAW,GAAG,IAAI,WAAW,EAAE,CAAC;gBACtC,MAAM,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC;gBAC5B,WAAW,CAAC,aAAa,CAAC,IAAI,aAAa,CAAC,kBAAkB,EAAE,EAAC,MAAM,EAAE,GAAG,EAAC,CAAC,CAAC,CAAC;gBAChF,OAAO,EAAE,CAAC;YACZ,CAAC;SACF,CAAC;QAEF,MAAM,SAAS,GAAG,IAAI,iBAAiB,CAAC,SAAS,CAAC,SAAS,EAAE,CAAC;QAC9D,MAAM,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC;QAC5B,MAAM,SAAS,CAAC,kBAAkB,CAAC;QACnC,MAAM,CAAC,OAAO,CAAC,SAAS,CAAC,UAAU,EAAE,CAAC,CAAC;QACvC,MAAM,CAAC,MAAM,CAAC,SAAS,CAAC,qBAAqB,EAAE,CAAC,CAAC;QAEjD,MAAM,uBAAuB,GAAG,IAAI,OAAO,CAAO,OAAO,CAAC,EAAE;YAC1D,SAAS,CAAC,gBAAgB,+FAA+D,GAAG,EAAE;gBAC5F,MAAM,CAAC,WAAW,CAAC,SAAS,CAAC,mBAAmB,EAAE,EAAE,GAAG,CAAC,CAAC;gBACzD,OAAO,EAAE,CAAC;YACZ,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,MAAM,qBAAqB,GAAG,IAAI,OAAO,CAAO,OAAO,CAAC,EAAE;YACxD,SAAS,CAAC,gBAAgB,wGAAoE,GAAG,EAAE;gBACjG,OAAO,EAAE,CAAC;YACZ,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,SAAS,CAAC,qBAAqB,EAAE,CAAC;QAClC,MAAM,uBAAuB,CAAC;QAC9B,MAAM,qBAAqB,CAAC;QAC5B,MAAM,CAAC,MAAM,CAAC,SAAS,CAAC,UAAU,EAAE,CAAC,CAAC;IACxC,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","sourcesContent":["// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport {updateHostConfig} from '../../testing/EnvironmentHelpers.js';\nimport * as AiAssistanceModel from '../ai_assistance/ai_assistance.js';\n\ndescribe('BuiltInAi', () => {\n  it('can generate a console insight teaser', async () => {\n    updateHostConfig({\n      devToolsAiPromptApi: {\n        enabled: true,\n        allowWithoutGpu: true,\n      },\n    });\n\n    async function* promptStreaming() {\n      yield 'This is';\n      yield ' an explanation.';\n    }\n\n    const mockLanguageModel = {\n      destroy: () => {},\n      clone: () => mockLanguageModel,\n      promptStreaming,\n    };\n    // @ts-expect-error\n    window.LanguageModel = {\n      availability: () => 'available',\n      create: () => mockLanguageModel,\n    };\n\n    const builtInAi = new AiAssistanceModel.BuiltInAi.BuiltInAi();\n    assert.isDefined(builtInAi);\n    await builtInAi.initDoneForTesting;\n    assert.isTrue(builtInAi.hasSession());\n    const abortController = new AbortController();\n    const stream = builtInAi.getConsoleInsight('explain this error', abortController);\n    let response = '';\n    for await (const chunk of stream) {\n      response += chunk;\n    }\n    assert.strictEqual(response, 'This is an explanation.');\n    AiAssistanceModel.BuiltInAi.BuiltInAi.removeInstance();\n  });\n\n  it('is not available if there is no dedicated GPU', async () => {\n    updateHostConfig({\n      devToolsAiPromptApi: {\n        enabled: true,\n        allowWithoutGpu: false,\n      },\n    });\n\n    // @ts-expect-error\n    window.LanguageModel = {\n      availability: () => 'available',\n      create: () => {},\n    };\n\n    const builtInAi = new AiAssistanceModel.BuiltInAi.BuiltInAi();\n    await builtInAi.initDoneForTesting;\n    assert.isFalse(builtInAi.isEventuallyAvailable());\n  });\n\n  it('can download the AI model', async () => {\n    updateHostConfig({\n      devToolsAiPromptApi: {\n        enabled: true,\n        allowWithoutGpu: true,\n      },\n    });\n\n    // @ts-expect-error\n    window.LanguageModel = {\n      availability: () => 'downloadable',\n      create: (params: {monitor: (et: EventTarget) => void}) => {\n        const eventTarget = new EventTarget();\n        params.monitor(eventTarget);\n        eventTarget.dispatchEvent(new ProgressEvent('downloadprogress', {loaded: 0.4}));\n        return {};\n      },\n    };\n\n    const builtInAi = new AiAssistanceModel.BuiltInAi.BuiltInAi();\n    assert.isDefined(builtInAi);\n    await builtInAi.initDoneForTesting;\n    assert.isFalse(builtInAi.hasSession());\n    assert.isTrue(builtInAi.isEventuallyAvailable());\n\n    const downloadProgressPromise = new Promise<void>(resolve => {\n      builtInAi.addEventListener(AiAssistanceModel.BuiltInAi.Events.DOWNLOAD_PROGRESS_CHANGED, () => {\n        assert.strictEqual(builtInAi.getDownloadProgress(), 0.4);\n        resolve();\n      });\n    });\n\n    const sessionCreatedPromise = new Promise<void>(resolve => {\n      builtInAi.addEventListener(AiAssistanceModel.BuiltInAi.Events.DOWNLOADED_AND_SESSION_CREATED, () => {\n        resolve();\n      });\n    });\n\n    builtInAi.startDownloadingModel();\n    await downloadProgressPromise;\n    await sessionCreatedPromise;\n    assert.isTrue(builtInAi.hasSession());\n  });\n});\n"]}