{"version":3,"file":"GlobalAiButton.test.js","sourceRoot":"","sources":["../../../../../../front_end/entrypoints/main/GlobalAiButton.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2025 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../core/common/common.js';\nimport {\n  renderElementIntoDOM,\n} from '../../testing/DOMHelpers.js';\nimport {describeWithEnvironment, updateHostConfig} from '../../testing/EnvironmentHelpers.js';\nimport {createViewFunctionStub} from '../../testing/ViewFunctionHelpers.js';\nimport * as UI from '../../ui/legacy/legacy.js';\n\nimport * as Main from './main.js';\n\nconst CLICK_COUNT_LIMIT = 2;\nconst DELAY_BEFORE_PROMOTION_COLLAPSE_IN_MS = 5000;\n\nconst {GlobalAiButton} = Main.GlobalAiButton;\n\ndescribeWithEnvironment('GlobalAiButton', () => {\n  let clock: sinon.SinonFakeTimers;\n  beforeEach(() => {\n    Common.Settings.Settings.instance().settingForTest('global-ai-button-click-count').set(0);\n  });\n\n  afterEach(() => {\n    clock?.restore();\n  });\n\n  async function createWidget() {\n    const view = createViewFunctionStub(GlobalAiButton);\n    const widget = new GlobalAiButton(undefined, view);\n    widget.markAsRoot();\n    renderElementIntoDOM(widget);\n    await view.nextInput;\n    return {view, widget};\n  }\n\n  it('renders in its DEFAULT state initially', async () => {\n    const {view} = await createWidget();\n\n    assert.strictEqual(view.input.state, Main.GlobalAiButton.GlobalAiButtonState.DEFAULT);\n  });\n\n  it('shows freestyler in drawer and increases click count on click', async () => {\n    const {view} = await createWidget();\n    const showViewStub = sinon.stub(UI.ViewManager.ViewManager.instance(), 'showViewInLocation');\n    const setting = Common.Settings.Settings.instance().settingForTest('global-ai-button-click-count');\n    setting.set(0);\n\n    view.input.onClick();\n\n    sinon.assert.calledOnceWithExactly(showViewStub, 'freestyler', 'drawer-view');\n    assert.strictEqual(setting.get(), 1);\n  });\n\n  describe('promotion lifecycle', () => {\n    it('transitions to PROMOTION state when promotion should be triggered', async () => {\n      updateHostConfig({\n        devToolsGlobalAiButton: {\n          promotionEnabled: true,\n        },\n      });\n      clock = sinon.useFakeTimers({now: new Date('2025-01-01'), toFake: ['setTimeout', 'Date']});\n      Common.Settings.Settings.instance().settingForTest('global-ai-button-click-count').set(CLICK_COUNT_LIMIT - 1);\n\n      const {view} = await createWidget();\n\n      assert.strictEqual(view.input.state, Main.GlobalAiButton.GlobalAiButtonState.PROMOTION);\n    });\n\n    it('reverts from PROMOTION to DEFAULT state after a delay', async () => {\n      updateHostConfig({\n        devToolsGlobalAiButton: {\n          promotionEnabled: true,\n        },\n      });\n      clock = sinon.useFakeTimers({now: new Date('2025-01-01'), toFake: ['setTimeout', 'Date']});\n      Common.Settings.Settings.instance().settingForTest('global-ai-button-click-count').set(CLICK_COUNT_LIMIT - 1);\n\n      const {view} = await createWidget();\n      clock.tick(DELAY_BEFORE_PROMOTION_COLLAPSE_IN_MS);\n\n      const finalInput = await view.nextInput;\n      assert.strictEqual(finalInput.state, Main.GlobalAiButton.GlobalAiButtonState.DEFAULT);\n    });\n\n    it('does not trigger promotion if the feature flag is off', async () => {\n      updateHostConfig({\n        devToolsGlobalAiButton: {\n          promotionEnabled: false,\n        },\n      });\n      clock = sinon.useFakeTimers({now: new Date('2025-01-01'), toFake: ['setTimeout', 'Date']});\n      Common.Settings.Settings.instance().settingForTest('global-ai-button-click-count').set(CLICK_COUNT_LIMIT - 1);\n\n      const {view} = await createWidget();\n\n      assert.strictEqual(view.input.state, Main.GlobalAiButton.GlobalAiButtonState.DEFAULT);\n    });\n\n    it('does not trigger promotion if the date has expired', async () => {\n      updateHostConfig({\n        devToolsGlobalAiButton: {\n          promotionEnabled: true,\n        },\n      });\n      clock = sinon.useFakeTimers({\n        now: new Date('2026-10-01'),  // After 2026-09-30\n        toFake: ['setTimeout', 'Date']\n      });\n      Common.Settings.Settings.instance().settingForTest('global-ai-button-click-count').set(CLICK_COUNT_LIMIT - 1);\n\n      const {view} = await createWidget();\n\n      assert.strictEqual(view.input.state, Main.GlobalAiButton.GlobalAiButtonState.DEFAULT);\n    });\n\n    it('does not trigger promotion if the click count is more than or equal to 2', async () => {\n      updateHostConfig({\n        devToolsGlobalAiButton: {\n          promotionEnabled: true,\n        },\n      });\n      clock = sinon.useFakeTimers({now: new Date('2025-01-01'), toFake: ['setTimeout', 'Date']});\n      Common.Settings.Settings.instance().settingForTest('global-ai-button-click-count').set(CLICK_COUNT_LIMIT);\n\n      const {view} = await createWidget();\n\n      assert.strictEqual(view.input.state, Main.GlobalAiButton.GlobalAiButtonState.DEFAULT);\n    });\n  });\n\n  describe('promotion lifecycle with toolbar hover', () => {\n    let headerElement: HTMLElement;\n    beforeEach(() => {\n      headerElement = document.createElement('div');\n      sinon.stub(UI.InspectorView.InspectorView.instance().tabbedPane, 'headerElement').returns(headerElement);\n    });\n\n    it('does not revert from PROMOTION to DEFAULT state while the toolbar is hovered', async () => {\n      updateHostConfig({\n        devToolsGlobalAiButton: {\n          promotionEnabled: true,\n        },\n      });\n      clock = sinon.useFakeTimers({now: new Date('2025-01-01'), toFake: ['setTimeout', 'Date']});\n      Common.Settings.Settings.instance().settingForTest('global-ai-button-click-count').set(CLICK_COUNT_LIMIT - 1);\n\n      const {view} = await createWidget();\n      assert.strictEqual(view.input.state, Main.GlobalAiButton.GlobalAiButtonState.PROMOTION);\n\n      // Simulate hovering over the toolbar.\n      headerElement.dispatchEvent(new MouseEvent('mouseenter'));\n      clock.tick(DELAY_BEFORE_PROMOTION_COLLAPSE_IN_MS);\n\n      // The button should still be in the promotion state.\n      assert.strictEqual(view.input.state, Main.GlobalAiButton.GlobalAiButtonState.PROMOTION);\n\n      // Simulate hovering out of the toolbar.\n      headerElement.dispatchEvent(new MouseEvent('mouseleave'));\n      clock.tick(DELAY_BEFORE_PROMOTION_COLLAPSE_IN_MS);\n\n      // The button should now be in the default state.\n      const finalInput = await view.nextInput;\n      assert.strictEqual(finalInput.state, Main.GlobalAiButton.GlobalAiButtonState.DEFAULT);\n    });\n  });\n});\n"]}